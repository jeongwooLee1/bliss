<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/><meta http-equiv="Pragma" content="no-cache"/><meta http-equiv="Expires" content="0"/>
<title>Bliss 관리시스템</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>*{margin:0;padding:0;box-sizing:border-box}body,#root{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-touch-callout:none}input,textarea,select,[contenteditable]{-webkit-user-select:text;-moz-user-select:text;user-select:text}</style>
</head><body><div id="root"></div><script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;
// React hooks provided by HTML wrapper

// ─── Supabase Config ───
const SB_URL = "https://dpftlrsuqxqqeouwbfjd.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwZnRscnN1cXhxcWVvdXdiZmpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MDU4MjQsImV4cCI6MjA4NzQ4MTgyNH0.iydEkjtPjZ0jXpUUPJben4IWWneDqLomv-HDlcFayE4";
const sbHeaders = {"apikey":SB_KEY,"Authorization":`Bearer ${SB_KEY}`,"Content-Type":"application/json","Prefer":"return=representation"};
const _supaClient = typeof window !== "undefined" && window.supabase ? window.supabase.createClient(SB_URL, SB_KEY, {auth:{persistSession:false}, realtime:{params:{eventsPerSecond:10}, heartbeatIntervalMs:15000, timeout:20000, reconnectAfterMs:(tries)=>Math.min(1000*Math.pow(2,tries),30000)}}) : null;
const sb = {
  async get(table, filter="") { 
    const hasSortCol = ["services","products","service_tags","service_categories"].includes(table);
    const hasCreatedAt = !["rooms","services","products","service_categories","service_tags"].includes(table);
    const order = hasSortCol ? "order=sort.asc.nullsfirst" : (hasCreatedAt ? "order=created_at.asc.nullsfirst" : "order=id.asc");
    const r=await fetch(`${SB_URL}/rest/v1/${table}?select=*&${order}${filter}`,{headers:sbHeaders}); 
    if(!r.ok){const e=await r.text();console.error(`DB get ${table} failed:`,r.status,e);}
    return r.ok?r.json():[]; 
  },
  async getByBiz(table, bizId) { return this.get(table, `&business_id=eq.${bizId}`); },
  async upsert(table,rows) { if(!rows?.length)return; console.log(`DB upsert ${table}:`,JSON.stringify(rows[0]).slice(0,200)); const r=await fetch(`${SB_URL}/rest/v1/${table}`,{method:"POST",headers:{...sbHeaders,"Prefer":"resolution=merge-duplicates,return=representation"},body:JSON.stringify(rows)}); if(!r.ok){const e=await r.text();console.error(`DB upsert ${table} FAILED [${r.status}]:`,e);alert(`DB저장 실패(${table}): ${e}`);} else {console.log(`DB upsert ${table} OK`);} },
  async insert(table,row) { console.log(`DB insert ${table}:`,JSON.stringify(row).slice(0,300)); const r=await fetch(`${SB_URL}/rest/v1/${table}`,{method:"POST",headers:sbHeaders,body:JSON.stringify(row)}); if(!r.ok){const e=await r.text();console.error(`DB insert ${table} FAILED [${r.status}]:`,e);alert(`DB저장 실패(${table}): ${e}`);return null;} console.log(`DB insert ${table} OK`); return r.json(); },
  async update(table,id,row) { console.log(`DB update ${table} ${id}:`,JSON.stringify(row).slice(0,200)); const r=await fetch(`${SB_URL}/rest/v1/${table}?id=eq.${id}`,{method:"PATCH",headers:sbHeaders,body:JSON.stringify(row)}); if(!r.ok){const e=await r.text();console.error(`DB update ${table} FAILED [${r.status}]:`,e);alert(`DB수정 실패(${table}): ${e}`);} },
  async del(table,id) { await fetch(`${SB_URL}/rest/v1/${table}?id=eq.${id}`,{method:"DELETE",headers:sbHeaders}); },
  async delWhere(table,col,val) { await fetch(`${SB_URL}/rest/v1/${table}?${col}=eq.${val}`,{method:"DELETE",headers:sbHeaders}); },
};
// snake_case <-> camelCase column mapping per table
const DBMAP = {
  reservations:{business_id:"businessId",room_id:"roomId",cust_id:"custId",cust_name:"custName",cust_phone:"custPhone",cust_gender:"custGender",staff_id:"staffId",service_id:"serviceId",is_schedule:"isSchedule",is_new_cust:"isNewCust",selected_tags:"selectedTags",selected_services:"selectedServices",repeat_group_id:"repeatSourceId",repeat_until:"repeatUntil",reservation_id:"reservationId",updated_at:"_ua"},
  sales:{business_id:"businessId",cust_id:"custId",cust_name:"custName",cust_phone:"custPhone",cust_gender:"custGender",cust_num:"custNum",staff_id:"staffId",staff_name:"staffName",service_id:"serviceId",service_name:"serviceName",product_id:"productId",product_name:"productName",svc_cash:"svcCash",svc_transfer:"svcTransfer",svc_card:"svcCard",svc_point:"svcPoint",prod_cash:"prodCash",prod_transfer:"prodTransfer",prod_card:"prodCard",prod_point:"prodPoint",order_num:"orderNum",reservation_id:"reservationId"},
  customers:{business_id:"businessId",last_visit:"lastVisit",cust_num:"custNum"},
  service_tags:{business_id:"businessId",schedule_yn:"scheduleYn",use_yn:"useYn"},
  services:{business_id:"businessId",price_f:"priceF",price_m:"priceM"},
  app_users:{business_id:"businessId",login_id:"loginId",branch_ids:"branches",password:"pw",view_branch_ids:"viewBranches"},
  branches:{business_id:"businessId",use_yn:"useYn",naver_email:"naverEmail",naver_biz_id:"naverBizId",naver_col_count:"naverColCount"},
};
function fromDb(table,rows){const m=DBMAP[table];if(!m)return rows;return rows.map(row=>{const r={};for(const[k,v]of Object.entries(row)){if(k==="created_at"){r.createdAt=v;continue;}const mk=m[k]||k;r[mk]=v;} 
  // Parse JSON string arrays for app_users
  if(table==="app_users"){try{if(typeof r.branches==="string")r.branches=JSON.parse(r.branches);}catch(e){r.branches=[];}try{if(typeof r.viewBranches==="string")r.viewBranches=JSON.parse(r.viewBranches);}catch(e){r.viewBranches=[];}if(!Array.isArray(r.branches))r.branches=[];if(!Array.isArray(r.viewBranches))r.viewBranches=[];}
  // Parse JSON string arrays for reservations
  if(table==="reservations"){try{if(typeof r.selectedTags==="string")r.selectedTags=JSON.parse(r.selectedTags);}catch(e){r.selectedTags=[];}if(!Array.isArray(r.selectedTags))r.selectedTags=[];try{if(typeof r.selectedServices==="string")r.selectedServices=JSON.parse(r.selectedServices);}catch(e){r.selectedServices=[];}if(!Array.isArray(r.selectedServices))r.selectedServices=[];
    // Auto-detect gender from naver memo (옵션: 여) or 남))
    if(!r.custGender && r.memo){const ml=r.memo.toLowerCase();if(/여\)/.test(r.memo))r.custGender="F";else if(/남\)/.test(r.memo))r.custGender="M";}
  }
  // Convert booleans to Y/N for service_tags
  if(table==="service_tags"){r.scheduleYn=(r.scheduleYn===true||r.scheduleYn==="Y")?"Y":"N";r.useYn=r.useYn!==false;}
  return r;});}
// Valid DB columns per table (to filter out extra JS fields)
const DB_COLS={
  reservations:["id","business_id","bid","room_id","cust_id","cust_name","cust_phone","cust_gender","staff_id","service_id","date","time","dur","status","memo","type","is_schedule","is_new_cust","selected_tags","selected_services","repeat","repeat_until","repeat_group_id","reservation_id","updated_at"],
  sales:["id","business_id","bid","cust_id","cust_name","cust_phone","cust_gender","cust_num","staff_id","staff_name","date","service_id","service_name","product_id","product_name","svc_cash","svc_transfer","svc_card","svc_point","prod_cash","prod_transfer","prod_card","prod_point","gift","order_num","memo","reservation_id"],
  customers:["id","business_id","bid","name","phone","gender","visits","last_visit","memo","cust_num"],
  service_tags:["id","business_id","name","dur","schedule_yn","color","use_yn","sort"],
  services:["id","business_id","cat","name","dur","price_f","price_m","note","sort"],
  app_users:["id","business_id","login_id","password","name","role","branch_ids","view_branch_ids"],
};
// Global active business context - auto-injected into DB writes
let _activeBizId = null;
const setActiveBiz = (bizId) => { _activeBizId = bizId; };

// Excel utility (uses SheetJS/XLSX global)
const XL = {
  download(rows, filename, sheetName="Sheet1", headers) {
    if(typeof XLSX==="undefined"){alert("SheetJS 로드 중...");return;}
    let ws;
    if(rows.length===0 && headers){
      ws=XLSX.utils.aoa_to_sheet([headers]);
    } else {
      ws=XLSX.utils.json_to_sheet(rows);
    }
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,sheetName); XLSX.writeFile(wb,filename);
  },
  readFile(file) {
    return new Promise((resolve) => {
      const reader=new FileReader();
      reader.onload=ev=>{const wb=XLSX.read(ev.target.result,{type:"array"});resolve(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));};
      reader.readAsArrayBuffer(file);
    });
  }
};

function toDb(table,obj){const m=DBMAP[table];if(!m){const r={...obj};delete r.created_at;return r;}const rev={};for(const[k,v]of Object.entries(m))rev[v]=k;const r={};for(const[k,v]of Object.entries(obj)){if(k==="created_at"||k==="_ua")continue;r[rev[k]||k]=v;}
  // Stringify arrays for app_users
  if(table==="app_users"){if(Array.isArray(r.branch_ids))r.branch_ids=JSON.stringify(r.branch_ids);if(Array.isArray(r.view_branch_ids))r.view_branch_ids=JSON.stringify(r.view_branch_ids);}
  const cols=DB_COLS[table];if(cols){const f={};for(const c of cols)if(r[c]!==undefined)f[c]=r[c];
  // Auto-inject business_id if active and column exists
  if(_activeBizId && cols.includes("business_id") && !f.business_id) f.business_id=_activeBizId;
  if(table==="reservations"||table==="sales") console.log(`toDb(${table}) final keys:`,Object.keys(f).join(","));
  return f;}return r;}

// Load all data from Supabase (filtered by business_id)
async function loadAllFromDb(bizId) {
  if (!bizId) {
    // Super admin: load meta tables only
    const [businesses, groups, groupMembers, users] = await Promise.all([
      sb.get("businesses"), sb.get("business_groups"),
      sb.get("business_group_members"), sb.get("app_users"),
    ]);
    return { businesses, groups, groupMembers, users:fromDb("app_users",users) };
  }
  const [branches,rooms,users,customers,reservations,sales,serviceTags,services,products,cats] = await Promise.all([
    sb.getByBiz("branches",bizId), sb.getByBiz("rooms",bizId),
    sb.get("app_users",`&business_id=eq.${bizId}`), sb.getByBiz("customers",bizId),
    sb.getByBiz("reservations",bizId), sb.getByBiz("sales",bizId), sb.getByBiz("service_tags",bizId),
    sb.getByBiz("services",bizId), sb.getByBiz("products",bizId), sb.getByBiz("service_categories",bizId),
  ]);
  return { branches:fromDb("branches",branches), rooms, users:fromDb("app_users",users), customers:fromDb("customers",customers),
    reservations:fromDb("reservations",reservations), sales:fromDb("sales",sales),
    serviceTags:fromDb("service_tags",serviceTags), services:fromDb("services",services),
    products, cats };
  console.log("Data loaded:", {branches:branches.length, rooms:rooms.length, services:services.length, cats:cats.length, serviceTags:serviceTags.length, reservations:reservations.length});
}

// ─── Constants ───
const BLISS_V = "2.52.1";
const uid = () => Math.random().toString(36).substr(2, 9);
const fmt = n => (n || 0).toLocaleString("ko-KR");
const fmtLocal = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const todayStr = () => fmtLocal(new Date());
const TIMES = [];
for (let h = 8; h <= 22; h++) for (let m = 0; m < 60; m += 5)
  TIMES.push(`${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`);
const HOUR_TIMES = [];
for (let h = 10; h <= 21; h++) { HOUR_TIMES.push(`${String(h).padStart(2,"0")}:00`); HOUR_TIMES.push(`${String(h).padStart(2,"0")}:30`); }

const PAY_KEYS = ["cash","transfer","card","point"];
const PAY_LABEL = { cash:"현금", transfer:"입금", card:"카드", point:"포인트", gift:"상품권" };
const PAY_CLR = { cash:"#6bab9e", transfer:"#ef5350", card:"#7c7cc8", point:"#d0d0d0", gift:"#ef5350" };
const STATUS_LABEL = { confirmed:"진행", completed:"완료", cancelled:"취소", no_show:"노쇼", pending:"확정대기", naver_cancelled:"네이버취소" };
const STATUS_KEYS = ["confirmed","completed","cancelled","no_show"];
const STATUS_CLR_DEFAULT = { confirmed:"#5B9BD5", completed:"#6AB56A", cancelled:"#E8B830", no_show:"#E05252" };
const getStatusClr = () => { try { const v = localStorage.getItem("tl_sc"); return v ? {...STATUS_CLR_DEFAULT,...JSON.parse(v)} : {...STATUS_CLR_DEFAULT}; } catch(e) { return {...STATUS_CLR_DEFAULT}; } };
const BLOCK_COLORS = { reservation:"#7c7cc8", memo:"#ef5350", clockin:"#d0d0d0", cleaning:"#5cb5c5", break:"#9e9ec8" };

// Lucide-style SVG icons
const I = ({name,size=16,color="currentColor",style={},...p}) => {
  const s = {width:size,height:size,display:"inline-block",verticalAlign:"middle",flexShrink:0,...style};
  const a = {xmlns:"http://www.w3.org/2000/svg",width:size,height:size,viewBox:"0 0 24 24",fill:"none",stroke:color,strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",style:s,...p};
  const icons = {
    calendar:<svg {...a}><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    clipboard:<svg {...a}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>,
    wallet:<svg {...a}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>,
    chart:<svg {...a}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
    users:<svg {...a}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
    user:<svg {...a}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
    settings:<svg {...a}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>,
    menu:<svg {...a}><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>,
    chevL:<svg {...a}><polyline points="15 18 9 12 15 6"/></svg>,
    chevR:<svg {...a}><polyline points="9 18 15 12 9 6"/></svg>,
    chevU:<svg {...a}><polyline points="18 15 12 9 6 15"/></svg>,
    chevD:<svg {...a}><polyline points="6 9 12 15 18 9"/></svg>,
    bell:<svg {...a}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
    trash:<svg {...a}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
    edit:<svg {...a}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
    search:<svg {...a}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
    plus:<svg {...a}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    x:<svg {...a}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
    scissors:<svg {...a}><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></svg>,
    pkg:<svg {...a}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>,
    tag:<svg {...a}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>,
    loader:<svg {...a}><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>,
    arrowL:<svg {...a}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
    fileText:<svg {...a}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>,
    clock:<svg {...a}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
    sparkles:<svg {...a}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
    msgSq:<svg {...a}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
    alert:<svg {...a}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
    building:<svg {...a}><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>,
    eye:<svg {...a}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
    check:<svg {...a}><polyline points="20 6 9 17 4 12"/></svg>,
    download:<svg {...a}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
    upload:<svg {...a}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
    diamond:<svg {...a}><path d="M2.7 10.3a2.41 2.41 0 0 0 0 3.41l7.59 7.59a2.41 2.41 0 0 0 3.41 0l7.59-7.59a2.41 2.41 0 0 0 0-3.41l-7.59-7.59a2.41 2.41 0 0 0-3.41 0Z"/></svg>,
    naver:<svg {...a} fill="#03C75A" stroke="none"><circle cx="12" cy="12" r="10"/><text x="12" y="16" textAnchor="middle" fill="#fff" fontSize="12" fontWeight="700" fontFamily="sans-serif">N</text></svg>,
    calPick:<svg {...a}><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/></svg>,
    grip:<svg {...a}><circle cx="9" cy="6" r="1" fill={color}/><circle cx="15" cy="6" r="1" fill={color}/><circle cx="9" cy="12" r="1" fill={color}/><circle cx="15" cy="12" r="1" fill={color}/><circle cx="9" cy="18" r="1" fill={color}/><circle cx="15" cy="18" r="1" fill={color}/></svg>,
    minus:<svg {...a}><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  };
  return icons[name] || null;
};
const BLOCK_LABELS = { reservation:"예약", memo:"메모", clockin:"출근", cleaning:"청소", break:"휴식" };

// ─── Modal close animation utility ───
function _mc(cb) {
  const os = [...document.querySelectorAll('.ov')];
  const o = os[os.length - 1];
  if (!o) { cb(); return; }
  const m = o.children[0];
  o.style.transition = 'opacity .25s';
  o.style.opacity = '0';
  if (m) {
    m.style.transition = 'transform .25s cubic-bezier(.4,0,.6,1), opacity .2s';
    m.style.transform = 'scale(.88)';
    m.style.opacity = '0';
  }
  setTimeout(cb, 260);
}

// ─── App ───
function App() {
  const [phase, setPhase] = useState("loading"); // loading, login, super, app
  const [allUsers, setAllUsers] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [currentBizId, setCurrentBizId] = useState(null);
  const [currentBiz, setCurrentBiz] = useState(null);
  const [data, setData] = useState(null);
  const [superData, setSuperData] = useState(null);
  const [role, setRole] = useState("staff");
  const [userBranches, setUserBranches] = useState([]);
  const [viewBranches, setViewBranches] = useState([]);
  const [page, setPageRaw] = useState(() => {
    try { const p = sessionStorage.getItem("bliss_page"); console.log("[SESSION] page restore:", p); return p || "timeline"; } catch(e){ return "timeline"; }
  });
  const setPage = useCallback((p) => {
    console.log("[SESSION] page save:", p);
    setPageRaw(p);
    try { sessionStorage.setItem("bliss_page", p); } catch(e){}
  }, []);
  const [sideOpen, setSideOpen] = useState(false);
  const [loadMsg, setLoadMsg] = useState("연결 중...");

  // Page is persisted directly via setPage → sessionStorage.setItem("bliss_page")

  // Safe version check (runs after React mount, no DOM conflict)
  useEffect(() => {
    let timer;
    const check = () => {
      fetch("/bliss/version.txt?t=" + Date.now()).then(r => r.text()).then(remote => {
        remote = remote.trim();
        if (remote && remote !== BLISS_V) {
          const lastReload = sessionStorage.getItem("bliss_reload_v");
          if (lastReload === remote) return; // already reloaded for this version
          console.log("New version:", remote);
          sessionStorage.setItem("bliss_reload_v", remote);
          location.reload();
        }
      }).catch(() => {});
      timer = setTimeout(check, 60000);
    };
    timer = setTimeout(check, 3000); // first check 3s after mount
    return () => clearTimeout(timer);
  }, []);

  // Phase 1: Load all users on mount + auto-login from saved session
  const initRef = useRef(false);
  useEffect(() => {
    if (initRef.current) return;
    initRef.current = true;
    (async () => {
      try {
        const users = fromDb("app_users", await sb.get("app_users"));
        if (users.length === 0) {
          setAllUsers([{id:"acc_super", loginId:"admin", pw:"1234", name:"Bliss 관리자", role:"super", branches:[], viewBranches:[]}]);
          setPhase("login");
        } else {
          setAllUsers(users);
          // Check saved session for auto-login
          try {
            const saved = JSON.parse(sessionStorage.getItem("bliss_session")||"null");
            console.log("Session restore:", saved);
            if (saved?.userId) {
              const u = users.find(u => u.id === saved.userId);
              if (u) {
                console.log("Auto-login:", u.role, "bizId:", saved.bizId);
                handleLogin(u, true); return;
              }
            }
          } catch(e){}
          setPhase("login");
        }
      } catch(e) {
        console.error("DB 연결 실패:", e);
        setAllUsers([{id:"acc_super", loginId:"admin", pw:"1234", name:"Bliss 관리자", role:"super", branches:[], viewBranches:[]}]);
        setPhase("login");
      }
    })();
  }, []);

  // Handle login → route to super dashboard or business app
  const handleLogin = async (user, isAutoLogin) => {
    setCurrentUser(user);
    setRole(user.role);
    // Save session only on manual login (auto-login already has session)
    if (!isAutoLogin) {
      try{sessionStorage.setItem("bliss_session",JSON.stringify({userId:user.id,loginId:user.loginId||user.login_id}));}catch(e){}
    }
    if (user.role === "super") {
      setLoadMsg("관리자 데이터 로딩 중...");
      setPhase("loading");
      try {
        const sd = await loadAllFromDb(null);
        setSuperData(sd);
        // Auto re-enter business if saved in session
        let pendingBiz;
        try { pendingBiz = JSON.parse(sessionStorage.getItem("bliss_session")||"{}").bizId; } catch(e){}
        if (pendingBiz) { handleEnterBiz(pendingBiz); return; }
        setPhase("super");
      } catch(e) {
        console.error(e);
        setSuperData({ businesses:[], groups:[], groupMembers:[], users:[] });
        setPhase("super");
      }
    } else {
      const bizId = user.businessId;
      if (!bizId) { alert("사업자 연결 정보가 없습니다."); setPhase("login"); return; }
      setCurrentBizId(bizId);
      setActiveBiz(bizId);
      setLoadMsg("매장 데이터 로딩 중...");
      setPhase("loading");
      try {
        // Load business info
        const bizList = await sb.get("businesses", `&id=eq.${bizId}`);
        setCurrentBiz(bizList[0] || { name: "매장" });
        // Load business data
        const db = await loadAllFromDb(bizId);
        const staff = db.rooms.map(r => ({ id: r.id, dn: r.name, bid: r.branch_id }));
        setData({
          branches: db.branches, rooms: db.rooms, services: db.services, products: db.products,
          categories: db.cats, serviceTags: db.serviceTags,
          branchSettings: db.branches.map(b => ({...b, useYn: b.use_yn !== false})),
          users: db.users, customers: db.customers, reservations: db.reservations, sales: db.sales,
          staff,
        });
        setUserBranches(user.role === "owner" ? db.branches.map(b=>b.id) : (user.branches || []));
        setViewBranches(user.viewBranches || []);
        // page is already restored from sessionStorage("bliss_page") via useState initializer
        setPhase("app");
      } catch(e) {
        console.error("Data load error:", e);
        setLoadMsg("데이터 로딩 실패");
      }
    }
  };

  // Super admin: enter a specific business
  const handleEnterBiz = async (bizId) => {
    try{const s=JSON.parse(sessionStorage.getItem("bliss_session")||"{}");s.bizId=bizId;sessionStorage.setItem("bliss_session",JSON.stringify(s));}catch(e){}
    setLoadMsg("매장 데이터 로딩 중...");
    setPhase("loading");
    try {
      const bizList = await sb.get("businesses", `&id=eq.${bizId}`);
      setCurrentBiz(bizList[0] || { name: "매장" });
      setCurrentBizId(bizId);
      setActiveBiz(bizId);
      const db = await loadAllFromDb(bizId);
      const staff = db.rooms.map(r => ({ id: r.id, dn: r.name, bid: r.branch_id }));
      setData({
        branches: db.branches, rooms: db.rooms, services: db.services, products: db.products,
        categories: db.cats, serviceTags: db.serviceTags,
        branchSettings: db.branches.map(b => ({...b, useYn: b.use_yn !== false})),
        users: db.users, customers: db.customers, reservations: db.reservations, sales: db.sales,
        staff,
      });
      setRole("owner"); // super acts as owner inside a business
      setUserBranches(db.branches.map(b => b.id));
      setViewBranches([]);
      // page is already restored from sessionStorage("bliss_page") via useState initializer
      setPhase("app");
    } catch(e) { console.error(e); setPhase("super"); }
  };

  const handleLogout = () => {
    try{sessionStorage.removeItem("bliss_session");sessionStorage.removeItem("bliss_page");sessionStorage.removeItem("bliss_adminTab");}catch(e){}
    setCurrentUser(null); setCurrentBizId(null); setCurrentBiz(null);
    setData(null); setSuperData(null); setRole("staff");
    setUserBranches([]); setViewBranches([]); setPage("timeline");
    setActiveBiz(null);
    setPhase("login");
  };

  // ─── 복사/선택 방지 ───
  useEffect(() => {
    const prevent = e => { if (e.target.tagName !== "INPUT" && e.target.tagName !== "TEXTAREA") e.preventDefault(); };
    document.addEventListener("copy", prevent);
    document.addEventListener("cut", prevent);
    return () => { document.removeEventListener("copy", prevent); document.removeEventListener("cut", prevent); };
  }, []);

  // ─── 예약 실시간 동기화 ───
  useEffect(() => {
    if (phase !== "app" || !currentBizId) return;
    let channel = null;
    let pollIv = null;
    let rtConnected = false;
    const supaClient = _supaClient;

    const poll = async () => {
      try {
        const rows = await sb.getByBiz("reservations", currentBizId);
        const parsed = fromDb("reservations", rows);
        setData(prev => {
          if (!prev) return prev;
          const prevJson = JSON.stringify(prev.reservations.map(r => r.id + "|" + (r._ua||"")));
          const newJson = JSON.stringify(parsed.map(r => r.id + "|" + (r._ua||"")));
          return prevJson !== newJson ? {...prev, reservations: parsed} : prev;
        });
      } catch(e) { console.log("Poll error:", e); }
    };

    // 항상 폴링 시작 (30초)
    poll();
    pollIv = setInterval(poll, 30000);

    // Realtime 시도 (성공하면 폴링 간격 늘림)
    if (supaClient) {
      try {
        channel = supaClient.channel("rt_" + Date.now())
          .on("postgres_changes", { event: "*", schema: "public", table: "reservations", filter: "business_id=eq." + currentBizId }, (payload) => {
            const ev = payload.eventType;
            const row = payload.new || {};
            const oldRow = payload.old || {};
            setData(prev => {
              if (!prev) return prev;
              try {
                const parsed = row.id ? fromDb("reservations", [row])[0] : null;
                if (ev === "INSERT" && parsed) {
                  if (prev.reservations.some(r => r.id === parsed.id)) return prev;
                  return {...prev, reservations: [...prev.reservations, parsed]};
                }
                if (ev === "UPDATE" && parsed) {
                  return {...prev, reservations: prev.reservations.map(r => r.id === parsed.id ? {...r, ...parsed} : r)};
                }
                if (ev === "DELETE") {
                  const delId = oldRow.id;
                  return delId ? {...prev, reservations: prev.reservations.filter(r => r.id !== delId)} : prev;
                }
              } catch(e) {}
              return prev;
            });
          })
          .subscribe((status) => {
            console.log("RT:", status);
            if (status === "SUBSCRIBED") {
              rtConnected = true;
              clearInterval(pollIv);
              pollIv = setInterval(poll, 120000); // RT 성공 → 2분 백업 폴링
              console.log("✅ Realtime ON (백업 폴링 2분)");
            }
            if (status === "CLOSED" || status === "TIMED_OUT" || status === "CHANNEL_ERROR") {
              if (rtConnected) {
                rtConnected = false;
                clearInterval(pollIv);
                pollIv = setInterval(poll, 30000);
                console.log("⚠️ Realtime 끊김 → Polling 30초");
              }
            }
          });
      } catch(e) { console.log("RT setup error:", e); }
    }

    return () => {
      clearInterval(pollIv);
      if (channel && supaClient) { try { supaClient.removeChannel(channel); } catch(e){} }
    };
  }, [phase, currentBizId]);

  const handleBackToSuper = async () => {
    try{const s=JSON.parse(sessionStorage.getItem("bliss_session")||"{}");delete s.bizId;sessionStorage.setItem("bliss_session",JSON.stringify(s));}catch(e){}
    setLoadMsg("관리자 데이터 로딩 중...");
    setPhase("loading");
    const sd = await loadAllFromDb(null);
    setSuperData(sd);
    setRole("super");
    setCurrentBizId(null); setCurrentBiz(null); setData(null); setActiveBiz(null);
    setPhase("super");
  };

  if (phase === "loading") return <Loading msg={loadMsg} />;
  if (phase === "login") return <Login users={allUsers} onLogin={handleLogin} />;
  if (phase === "super") return <SuperDashboard superData={superData} setSuperData={setSuperData} currentUser={currentUser} onLogout={handleLogout} onEnterBiz={handleEnterBiz} />;

  // Phase: app (owner or staff)
  if (!data) return <Loading msg="데이터 로딩 중..." />;

  const isMaster = role === "owner" || role === "super";
  const isSuper = currentUser?.role === "super";
  const nav = [
    { id:"timeline", label:"타임라인", icon:<I name="calendar" size={16}/> },
    { id:"reservations", label:"예약목록", icon:<I name="clipboard" size={16}/> },
    { id:"sales", label:"매출관리", icon:<I name="wallet" size={16}/> },
    { id:"stats", label:"매출통계", icon:<I name="chart" size={16}/> },
    { id:"customers", label:"고객관리", icon:<I name="users" size={16}/> },
    ...(isMaster?[{ id:"users", label:"사용자관리", icon:<I name="user" size={16}/> }]:[]),
    { id:"admin", label:"관리설정", icon:<I name="settings" size={16}/> },
  ];

  const branchNames = userBranches.map(bid => (data.branches||[]).find(b=>b.id===bid)?.short||bid).filter(Boolean).join(", ");
  const bizName = currentBiz?.name || "";

  return (
    <div style={S.root}>
      <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet"/>
      <style>{CSS}</style>
      <aside className="sidebar-d" style={S.sidebar}>
        <Sidebar nav={nav} page={page} setPage={setPage} role={role} branchNames={branchNames} onLogout={handleLogout} bizName={bizName} isSuper={isSuper} onBackToSuper={handleBackToSuper} />
      </aside>
      {sideOpen && <div className="sidebar-m" style={{position:"fixed",inset:0,zIndex:300}}>
        <div style={{position:"absolute",inset:0,background:"rgba(0,0,0,.5)"}} onClick={()=>setSideOpen(false)}/>
        <div style={{position:"relative",width:260,height:"100%",background:"#fff",display:"flex",flexDirection:"column",animation:"slideIn .5s cubic-bezier(.22,1,.36,1)"}}>
          <Sidebar nav={nav} page={page} setPage={p=>{setPage(p);setSideOpen(false)}} role={role} branchNames={branchNames} onLogout={handleLogout} bizName={bizName} isSuper={isSuper} onBackToSuper={handleBackToSuper} />
        </div>
      </div>}
      <main className="main-c" style={S.main}>
        <div className="mob-hdr" style={S.mobHdr}>
          <button onClick={()=>setSideOpen(true)} style={S.menuBtn}><I name="menu" size={22}/></button>
          {bizName && <span style={{fontSize:18,fontWeight:800,color:"#7c7cc8"}}>{bizName}</span>}
        </div>
        <div className="page-pad" style={{flex:1,padding:page==="timeline"?"0":"16px 20px 16px",display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"}}>
          <div className={page==="timeline"?"":"fade-in"} key={page} style={page==="timeline"?{flex:1,display:"flex",flexDirection:"column",minHeight:0}:{overflow:"auto",flex:1,WebkitOverflowScrolling:"touch"}}>
            {page==="timeline" && <Timeline data={data} setData={setData} userBranches={userBranches} viewBranches={viewBranches} isMaster={isMaster} currentUser={currentUser} setPage={setPage} bizId={currentBizId}/>}
            {page==="reservations" && <ReservationList data={data} setData={setData} userBranches={userBranches} isMaster={isMaster}/>}
            {page==="sales" && <SalesPage data={data} setData={setData} userBranches={userBranches} isMaster={isMaster}/>}
            {page==="stats" && <StatsPage data={data} userBranches={userBranches} isMaster={isMaster} role={role}/>}
            {page==="customers" && <CustomersPage data={data} setData={setData} userBranches={userBranches} isMaster={isMaster}/>}
            {page==="users" && <UsersPage data={data} setData={setData} bizId={currentBizId}/>}
            {page==="admin" && <AdminPage data={data} setData={setData} bizId={currentBizId}/>}
          </div>
        </div>
      </main>
    </div>
  );
}

function Loading({msg}) { return <div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100vh",background:"#f8f8f8",color:"#888",fontFamily:"'Pretendard',sans-serif",gap:12}}><div style={{fontSize:24}}><I name="loader" size={24} color="#7c7cc8"/></div><div>{msg||"로딩 중..."}</div></div>; }

// ═══════════════════════════════════════════
// SUPER ADMIN DASHBOARD
// ═══════════════════════════════════════════
function SuperDashboard({ superData, setSuperData, currentUser, onLogout, onEnterBiz }) {
  const [tab, setTab] = useState("businesses");
  const { businesses=[], groups=[], groupMembers=[], users=[] } = superData || {};

  // ── Business CRUD ──
  const [bizForm, setBizForm] = useState(null);
  const saveBiz = async () => {
    if (!bizForm?.name || !bizForm?.code) return alert("업체명과 대표 아이디를 입력하세요");
    const isNew = !bizForm.id;
    const biz = isNew ? { ...bizForm, id: "biz_" + uid() } : bizForm;
    if (isNew) {
      await sb.insert("businesses", { id:biz.id, name:biz.name, code:biz.code, phone:biz.phone||"", memo:biz.memo||"" });
      const ownerId = "acc_" + uid();
      await sb.insert("app_users", { id:ownerId, business_id:biz.id, login_id:biz.code, password:"1234", name:biz.name+" 대표", role:"owner", branch_ids:"[]", view_branch_ids:"[]" });
      // Auto-assign group if selected
      if (bizForm.groupId) {
        const gm = { id:"gm_"+uid(), group_id:bizForm.groupId, business_id:biz.id };
        await sb.insert("business_group_members", gm);
        setSuperData(p => ({...p, businesses:[...p.businesses, biz], users:[...p.users, {id:ownerId, businessId:biz.id, loginId:biz.code, pw:"1234", name:biz.name+" 대표", role:"owner", branches:[], viewBranches:[]}], groupMembers:[...p.groupMembers, gm]}));
      } else {
        setSuperData(p => ({...p, businesses:[...p.businesses, biz], users:[...p.users, {id:ownerId, businessId:biz.id, loginId:biz.code, pw:"1234", name:biz.name+" 대표", role:"owner", branches:[], viewBranches:[]}]}));
      }
    } else {
      await sb.update("businesses", biz.id, { name:biz.name, code:biz.code, phone:biz.phone||"", memo:biz.memo||"" });
      // Update group membership
      const curMem = groupMembers.find(m=>m.business_id===biz.id);
      if (bizForm.groupId && (!curMem || curMem.group_id!==bizForm.groupId)) {
        if (curMem) await sb.del("business_group_members", curMem.id);
        const gm = { id:"gm_"+uid(), group_id:bizForm.groupId, business_id:biz.id };
        await sb.insert("business_group_members", gm);
        setSuperData(p => ({...p, businesses:p.businesses.map(b=>b.id===biz.id?biz:b), groupMembers:[...p.groupMembers.filter(m=>m.business_id!==biz.id), gm]}));
      } else if (!bizForm.groupId && curMem) {
        await sb.del("business_group_members", curMem.id);
        setSuperData(p => ({...p, businesses:p.businesses.map(b=>b.id===biz.id?biz:b), groupMembers:p.groupMembers.filter(m=>m.business_id!==biz.id)}));
      } else {
        setSuperData(p => ({...p, businesses:p.businesses.map(b=>b.id===biz.id?biz:b)}));
      }
    }
    setBizForm(null);
  };
  const deleteBiz = async (id) => {
    if (!confirm("이 사업자를 삭제하시겠습니까? 모든 데이터가 삭제됩니다.")) return;
    await sb.del("businesses", id);
    setSuperData(p => ({...p, businesses:p.businesses.filter(b=>b.id!==id)}));
  };
  const seedBizTemplates = async (bizId) => {
    const prefix = bizId.replace("biz_","");
    const br = { id:`br_${prefix}_1`, business_id:bizId, name:"본점", short:"본점", phone:"", address:"", color:"#FFFFFF", sort:0, use_yn:true };
    await sb.insert("branches", br);
    await sb.insert("rooms", { id:`rm_${prefix}_1`, business_id:bizId, branch_id:br.id, name:"담당자1", color:"", sort_order:0 });
    const cats = ["왁싱","페이셜","바디","기타"];
    for (let i=0;i<cats.length;i++) await sb.insert("service_categories", { id:`cat_${prefix}_${i}`, business_id:bizId, name:cats[i], sort:i });
    alert("기본 템플릿이 등록되었습니다.");
  };
  const startEditBiz = (b) => {
    const curMem = groupMembers.find(m=>m.business_id===b.id);
    setBizForm({...b, groupId: curMem?.group_id||""});
  };

  // ── Group quick-add (inline) ──
  const [newGrp, setNewGrp] = useState("");
  const addGroup = async () => {
    if (!newGrp.trim()) return;
    const grp = { id:"grp_"+uid(), name:newGrp.trim(), memo:"" };
    await sb.insert("business_groups", grp);
    setSuperData(p => ({...p, groups:[...p.groups, grp]}));
    setNewGrp("");
  };

  const [sideOpen, setSideOpen] = useState(false);
  const tabs = [{id:"businesses",label:<><I name="building" size={15}/> 업체 관리</>},{id:"users",label:<><I name="user" size={15}/> 사용자</>}];

  const SideContent = () => <>
    <div style={{padding:"20px 16px 16px",borderBottom:"1px solid #e0e0e0"}}>
      <div style={{fontSize:20,fontWeight:800,color:"#7c7cc8",letterSpacing:-1}}>Bliss</div>
      <div style={{fontSize:11,color:"#888",marginTop:4}}>슈퍼관리자 · {currentUser?.name}</div>
    </div>
    <div style={{flex:1,padding:"12px 0"}}>
      {tabs.map(t=>(
        <button key={t.id} onClick={()=>{setTab(t.id);setSideOpen(false)}} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 16px",border:"none",cursor:"pointer",fontSize:13,fontWeight:tab===t.id?700:400,
          background:tab===t.id?"#f0f0ff":"transparent",color:tab===t.id?"#5a5ac8":"#555",
          borderLeft:tab===t.id?"3px solid #7c7cc8":"3px solid transparent",
          fontFamily:"inherit",width:"100%",textAlign:"left"}}>{t.label}</button>
      ))}
    </div>
    <div style={{padding:12,borderTop:"1px solid #e0e0e0"}}>
      <button onClick={onLogout} style={{width:"100%",padding:"8px 14px",borderRadius:4,border:"1px solid #d0d0d0",background:"#fff",color:"#888",cursor:"pointer",fontSize:12,fontWeight:600,fontFamily:"inherit"}}>로그아웃</button>
    </div>
  </>;

  return (
    <div style={{display:"flex",height:"100dvh",fontFamily:"'Pretendard',sans-serif",background:"#f8f8f8",position:"fixed",top:0,left:0,right:0,bottom:0}}>
      <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet"/>
      <style>{CSS}</style>
      {/* Desktop sidebar */}
      <aside className="sidebar-d" style={{width:220,background:"#fff",borderRight:"1px solid #e0e0e0",display:"flex",flexDirection:"column"}}>
        <SideContent/>
      </aside>
      {/* Mobile sidebar overlay */}
      {sideOpen && <div className="sidebar-m" style={{position:"fixed",inset:0,zIndex:300}}>
        <div style={{position:"absolute",inset:0,background:"rgba(0,0,0,.5)"}} onClick={()=>setSideOpen(false)}/>
        <div style={{position:"relative",width:260,height:"100%",background:"#fff",display:"flex",flexDirection:"column",animation:"slideIn .5s cubic-bezier(.22,1,.36,1)"}}>
          <SideContent/>
        </div>
      </div>}
      <main className="main-c" style={{flex:1,display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"}}>
        {/* Mobile header */}
        <div className="mob-hdr" style={{padding:"10px 16px",background:"#fff",borderBottom:"1px solid #e0e0e0",display:"flex",alignItems:"center",gap:12}}>
          <button onClick={()=>setSideOpen(true)} style={{background:"none",border:"none",color:"#333",cursor:"pointer",fontSize:20,fontFamily:"inherit"}}><I name="menu" size={20}/></button>
          <span style={{fontSize:14,fontWeight:700,color:"#7c7cc8"}}>Bliss 슈퍼관리자</span>
        </div>
        <div className="page-pad" style={{flex:1,padding:24,overflow:"auto",WebkitOverflowScrolling:"touch"}}>
        {/* ── 업체 관리 ── */}
        {tab==="businesses" && <div>
          <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:16,flexWrap:"wrap"}}>
            <h2 style={{fontSize:18,fontWeight:800,color:"#333"}}><I name="building" size={18}/> 업체 관리</h2>
            <span style={{fontSize:12,color:"#888"}}>{businesses.length}개 업체</span>
            <button className="btn-p" style={{marginLeft:"auto"}} onClick={()=>setBizForm({name:"",code:"",phone:"",memo:"",groupId:""})}><I name="plus" size={12}/> 업체 추가</button>
          </div>
          {bizForm && <div className="card" style={{padding:16,marginBottom:16}}>
            <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"end"}}>
              <FLD label="업체명"><input className="inp" style={{width:"100%",maxWidth:160}} value={bizForm.name} onChange={e=>setBizForm({...bizForm,name:e.target.value})} placeholder="업체명 입력"/></FLD>
              <FLD label="대표 아이디"><input className="inp" style={{width:"100%",maxWidth:140}} value={bizForm.code} onChange={e=>setBizForm({...bizForm,code:e.target.value.toLowerCase().replace(/[^a-z0-9]/g,"")})} placeholder="영문소문자+숫자"/></FLD>
              <FLD label="전화"><input className="inp" style={{width:"100%",maxWidth:140}} value={bizForm.phone||""} onChange={e=>setBizForm({...bizForm,phone:e.target.value})} placeholder="02-0000-0000"/></FLD>
              <FLD label="그룹">
                <div style={{display:"flex",gap:4}}>
                  <select className="inp" style={{width:"100%",maxWidth:130}} value={bizForm.groupId||""} onChange={e=>setBizForm({...bizForm,groupId:e.target.value})}>
                    <option value="">없음</option>
                    {groups.map(g=><option key={g.id} value={g.id}>{g.name}</option>)}
                  </select>
                  <div style={{display:"flex",gap:2}}>
                    <input className="inp" style={{width:80,fontSize:10,padding:"4px 6px"}} value={newGrp} onChange={e=>setNewGrp(e.target.value)} placeholder="새 그룹" onKeyDown={e=>e.key==="Enter"&&addGroup()}/>
                    <button className="btn-s" style={{padding:"2px 6px",fontSize:10}} onClick={addGroup}>+</button>
                  </div>
                </div>
              </FLD>
              <FLD label="메모"><input className="inp" style={{width:"100%",maxWidth:160}} value={bizForm.memo||""} onChange={e=>setBizForm({...bizForm,memo:e.target.value})} placeholder="메모"/></FLD>
              <button className="btn-p" onClick={saveBiz}>{bizForm.id?"저장":"추가"}</button>
              <button className="btn-s" onClick={()=>setBizForm(null)}>취소</button>
            </div>
            {!bizForm.id && <div style={{marginTop:8,fontSize:11,color:"#999"}}>* 대표 아이디로 대표 계정이 자동 생성됩니다 (초기 비밀번호: 1234)</div>}
          </div>}
          <div className="card tw">
            <table><thead><tr>
              <th>업체명</th><th>대표 아이디</th><th>전화</th><th>그룹</th><th>계정수</th><th>메모</th><th>관리</th>
            </tr></thead><tbody>
              {businesses.map(b=>{
                const bizUsers = users.filter(u=>u.businessId===b.id);
                const grps = groupMembers.filter(m=>m.business_id===b.id).map(m=>groups.find(g=>g.id===m.group_id)?.name).filter(Boolean);
                return <tr key={b.id}>
                  <td style={{fontWeight:700}}>{b.name}</td>
                  <td style={{color:"#7c7cc8",fontFamily:"monospace",fontSize:12}}>{b.code}</td>
                  <td style={{fontSize:12,color:"#888"}}>{b.phone||"-"}</td>
                  <td>{grps.length>0 ? <span style={{fontSize:10,color:"#5cb5c5",background:"#5cb5c520",padding:"2px 8px",borderRadius:8}}>{grps.join(", ")}</span> : <span style={{color:"#ccc"}}>-</span>}</td>
                  <td style={{color:"#888"}}>{bizUsers.length}명</td>
                  <td style={{fontSize:12,color:"#888"}}>{b.memo||"-"}</td>
                  <td style={{display:"flex",gap:4}}>
                    <button className="btn-p" style={{padding:"4px 10px",fontSize:11}} onClick={()=>onEnterBiz(b.id)}>접속</button>
                    <button className="btn-s" style={{padding:"4px 10px",fontSize:11}} onClick={()=>startEditBiz(b)}>수정</button>
                    <button className="btn-s" style={{padding:"4px 10px",fontSize:11}} onClick={()=>seedBizTemplates(b.id)}>템플릿</button>
                    <button className="btn-d" style={{padding:"4px 10px",fontSize:11}} onClick={()=>deleteBiz(b.id)}>삭제</button>
                  </td>
                </tr>;
              })}
              {businesses.length===0 && <tr><td colSpan={7} style={{textAlign:"center",color:"#999",padding:40}}>등록된 업체가 없습니다</td></tr>}
            </tbody></table>
          </div>
        </div>}

        {/* ── 사용자 ── */}
        {tab==="users" && <SuperUsers users={users} businesses={businesses} superData={superData} setSuperData={setSuperData}/>}
        </div>
      </main>
    </div>
  );
}

// ─── Super: 전체 사용자 관리 ───
function SuperUsers({ users, businesses, superData, setSuperData }) {
  const [editId, setEditId] = useState(null);
  const [form, setForm] = useState(null);

  const startAdd = () => { setEditId("new"); setForm({name:"", loginId:"", pw:"1234", role:"owner", businessId:businesses[0]?.id||"", branches:[], viewBranches:[]}); };
  const startEdit = (u) => { setEditId(u.id); setForm({...u}); };
  const cancel = () => { setEditId(null); setForm(null); };

  const save = async () => {
    if(!form.name||!form.loginId||!form.pw) { alert("이름, 아이디, 비밀번호를 입력하세요."); return; }
    if(editId==="new") {
      const newU = {...form, id:"acc_"+uid()};
      await sb.insert("app_users", {id:newU.id, business_id:newU.businessId||null, login_id:newU.loginId, password:newU.pw, name:newU.name, role:newU.role, branch_ids:JSON.stringify(newU.branches||[]), view_branch_ids:JSON.stringify(newU.viewBranches||[])}).catch(console.error);
      setSuperData(p=>({...p, users:[...p.users, newU]}));
    } else {
      await sb.update("app_users", editId, {business_id:form.businessId||null, login_id:form.loginId, password:form.pw, name:form.name, role:form.role, branch_ids:JSON.stringify(form.branches||[]), view_branch_ids:JSON.stringify(form.viewBranches||[])}).catch(console.error);
      setSuperData(p=>({...p, users:p.users.map(u=>u.id===editId?{...form}:u)}));
    }
    cancel();
  };
  const remove = async (id) => {
    if(!window.confirm("이 사용자를 삭제하시겠습니까?")) return;
    await sb.del("app_users", id).catch(console.error);
    setSuperData(p=>({...p, users:p.users.filter(u=>u.id!==id)}));
  };

  const roleLabel = (r) => r==="super"?"슈퍼":r==="owner"?"대표":"직원";
  const roleBg = (r) => r==="super"?"#e5737315":r==="owner"?"#7c7cc815":"#f5f5f5";
  const roleClr = (r) => r==="super"?"#e57373":r==="owner"?"#7c7cc8":"#888";

  return <div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16,flexWrap:"wrap",gap:8}}>
      <h2 style={{fontSize:18,fontWeight:800,color:"#333"}}><I name="user" size={18}/> 전체 사용자 <span style={{fontSize:13,fontWeight:400,color:"#999"}}>{users.length}명</span></h2>
      <button className="btn-p" onClick={startAdd}><I name="plus" size={12}/> 사용자 추가</button>
    </div>

    {form && <div className="card" style={{padding:20,marginBottom:16}}>
      <h3 style={{fontSize:14,fontWeight:700,marginBottom:12}}>{editId==="new"?"사용자 추가":"사용자 수정"}</h3>
      <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"flex-end"}}>
        <FLD label="이름"><input className="inp" style={{width:"100%",maxWidth:120}} value={form.name} onChange={e=>setForm(p=>({...p,name:e.target.value}))}/></FLD>
        <FLD label="아이디"><input className="inp" style={{width:"100%",maxWidth:120}} value={form.loginId} onChange={e=>setForm(p=>({...p,loginId:e.target.value}))}/></FLD>
        <FLD label="비밀번호"><input className="inp" style={{width:"100%",maxWidth:100}} value={form.pw} onChange={e=>setForm(p=>({...p,pw:e.target.value}))}/></FLD>
        <FLD label="유형"><select className="inp" style={{width:"100%",maxWidth:90}} value={form.role} onChange={e=>setForm(p=>({...p,role:e.target.value}))}>
          <option value="super">슈퍼</option><option value="owner">대표</option><option value="staff">직원</option>
        </select></FLD>
        <FLD label="업체"><select className="inp" style={{width:"100%",maxWidth:150}} value={form.businessId||""} onChange={e=>setForm(p=>({...p,businessId:e.target.value}))}>
          <option value="">없음</option>{businesses.map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
        </select></FLD>
        <div style={{display:"flex",gap:6}}>
          <button className="btn-p" style={{padding:"7px 16px"}} onClick={save}>{editId==="new"?"추가":"저장"}</button>
          <button className="btn-s" style={{padding:"7px 16px"}} onClick={cancel}>취소</button>
        </div>
      </div>
    </div>}

    <div className="card tw">
      <table><thead><tr>
        <th>이름</th><th>아이디</th><th>유형</th><th>업체</th><th>비밀번호</th><th style={{width:120}}>관리</th>
      </tr></thead><tbody>
        {users.map(u=>{
          const biz = businesses.find(b=>b.id===u.businessId);
          return <tr key={u.id}>
            <td style={{fontWeight:600}}>{u.name}</td>
            <td style={{color:"#7c7cc8"}}>{u.loginId||u.login_id}</td>
            <td><span style={{fontSize:10,padding:"2px 8px",borderRadius:10,background:roleBg(u.role),color:roleClr(u.role),fontWeight:600}}>{roleLabel(u.role)}</span></td>
            <td style={{fontSize:12,color:"#555"}}>{biz?.name||"-"}</td>
            <td style={{color:"#aaa"}}>{"•".repeat((u.pw||u.password||"").length)}</td>
            <td style={{display:"flex",gap:4}}>
              <button className="btn-s" style={{padding:"4px 10px",fontSize:11}} onClick={()=>startEdit(u)}>수정</button>
              {u.role!=="super" && <button className="btn-d" style={{padding:"4px 10px",fontSize:11}} onClick={()=>remove(u.id)}>삭제</button>}
            </td>
          </tr>;
        })}
      </tbody></table>
    </div>
  </div>;
}

// ─── Login ───
function Login({ users, onLogin }) {
  const [loginId, setLoginId] = useState(() => {try{return localStorage.getItem("savedLoginId")||"";}catch(e){return "";}});
  const [pw, setPw] = useState("");
  const [saveId, setSaveId] = useState(() => {try{return localStorage.getItem("savedLoginId")!==null;}catch(e){return false;}});
  const [err, setErr] = useState("");
  const handleLogin = () => {
    const u = users.find(u => (u.loginId||u.login_id) === loginId && (u.pw||u.password) === pw);
    if (!u) { setErr("아이디 또는 비밀번호가 일치하지 않습니다."); return; }
    try{if(saveId)localStorage.setItem("savedLoginId",loginId);else localStorage.removeItem("savedLoginId");}catch(e){}
    onLogin(u);
  };
  return (
    <div style={{minHeight:"100vh",width:"100%",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg,#e8e8f0 0%,#d8d8e8 50%,#c8c8d8 100%)",fontFamily:"'Pretendard',sans-serif",padding:16}}>
      <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet"/>
      <style>{CSS}</style>
      <div style={{background:"#fff",borderRadius:12,border:"1px solid #e0e0e0",padding:"32px 28px",width:"92%",maxWidth:420,animation:"slideUp .6s cubic-bezier(.22,1,.36,1)",boxShadow:"0 12px 40px rgba(0,0,0,.15)"}}>
        <div style={{textAlign:"center",marginBottom:32}}>
          <div style={{fontSize:28,fontWeight:800,color:"#7c7cc8",letterSpacing:-1}}>Bliss</div>
          <div style={{fontSize:12,color:"#999",marginTop:8}}>통합 예약 & 매출 관리 시스템</div>
        </div>
        <div style={{display:"flex",flexDirection:"column",gap:14}}>
          <FLD label="아이디"><input className="inp" placeholder="아이디 입력" value={loginId} onChange={e=>{setLoginId(e.target.value);setErr("")}}/></FLD>
          <FLD label="비밀번호"><input className="inp" type="password" placeholder="비밀번호 입력" value={pw} onChange={e=>{setPw(e.target.value);setErr("")}} onKeyDown={e=>e.key==="Enter"&&handleLogin()}/></FLD>
          {err && <div style={{fontSize:12,color:"#e57373",textAlign:"center"}}>{err}</div>}
          <label style={{display:"flex",alignItems:"center",gap:6,fontSize:12,color:"#888",cursor:"pointer"}}>
            <input type="checkbox" checked={saveId} onChange={e=>setSaveId(e.target.checked)} style={{accentColor:"#7c7cc8",width:14,height:14}}/>
            아이디 저장
          </label>
          <button className="btn-p" style={{width:"100%",padding:13,marginTop:4,fontSize:15}} onClick={handleLogin}>로그인</button>
          <div style={{fontSize:10,color:"#bbb",textAlign:"center",marginTop:4}}>
            슈퍼관리자: admin / 1234 · 업체대표: master / 1234
          </div>
          <div style={{fontSize:9,color:"#d0d0d0",textAlign:"center",marginTop:8}}>v{BLISS_V}</div>
        </div>
      </div>
    </div>
  );
}

// ─── Sidebar ───

function Sidebar({ nav, page, setPage, role, branchNames, onLogout, bizName="", isSuper=false, onBackToSuper }) {
  const cats = [
    { label:"예약 관리", items: nav.filter(n=>["timeline","reservations"].includes(n.id)) },
    { label:"고객 관리", items: nav.filter(n=>["customers"].includes(n.id)) },
    { label:"매출 관리", items: nav.filter(n=>["sales","stats"].includes(n.id)) },
    ...(nav.find(n=>n.id==="admin") ? [{ label:"시스템", items: nav.filter(n=>["users","admin"].includes(n.id)) }] : []),
  ];
  return <>
    <div style={{padding:"16px 16px 12px",borderBottom:"1px solid #e0e0e0"}}>
      {bizName ? <div style={{fontSize:16,fontWeight:800,color:"#7c7cc8",letterSpacing:-.5}}>{bizName}</div>
        : <div style={{fontSize:16,fontWeight:800,color:"#7c7cc8"}}>Bliss</div>}
      <div style={{fontSize:11,color:"#888",marginTop:4}}>{role==="owner"?"대표 관리자":role==="super"?"슈퍼관리자":branchNames||"직원"}</div>
    </div>
    <div style={{flex:1,padding:"8px 0",overflowY:"auto"}}>
      {cats.map((cat,ci) => (
        <div key={ci}>
          <div style={{fontSize:10,fontWeight:700,color:"#999",padding:"12px 16px 4px",letterSpacing:.5}}>{cat.label}</div>
          {cat.items.map(n=>(
            <button key={n.id} onClick={()=>setPage(n.id)} style={{display:"flex",alignItems:"center",gap:10,padding:"9px 16px",border:"none",cursor:"pointer",fontSize:13,fontWeight:page===n.id?700:400,
              background:page===n.id?"#f0f0ff":"transparent",color:page===n.id?"#5a5ac8":"#555",
              borderLeft:page===n.id?"3px solid #7c7cc8":"3px solid transparent",
              fontFamily:"inherit",width:"100%",textAlign:"left",transition:"all .1s"}}>
              <span style={{width:20,display:"inline-flex",alignItems:"center",justifyContent:"center"}}>{n.icon}</span>{n.label}
            </button>
          ))}
        </div>
      ))}
    </div>
    <div style={{padding:12,borderTop:"1px solid #e0e0e0",display:"flex",flexDirection:"column",gap:6}}>
      {isSuper && <button onClick={onBackToSuper} style={{width:"100%",padding:"8px 14px",borderRadius:4,border:"1px solid #7c7cc8",background:"#7c7cc810",color:"#7c7cc8",cursor:"pointer",fontSize:12,fontWeight:600,fontFamily:"inherit",textAlign:"center"}}><I name="arrowL" size={14}/> 관리자 대시보드</button>}
      <button onClick={onLogout} style={{width:"100%",padding:"8px 14px",borderRadius:4,border:"1px solid #d0d0d0",background:"#fff",color:"#888",cursor:"pointer",fontSize:12,fontWeight:600,fontFamily:"inherit",textAlign:"center"}}>로그아웃</button>
      <div style={{fontSize:9,color:"#ccc",textAlign:"center",marginTop:2}}>v{BLISS_V}</div>
    </div>
  </>;
}

// ═══════════════════════════════════════════
// TIMELINE VIEW (myCream-style)
// ═══════════════════════════════════════════
function MiniCal({ selDate, onSelect, onClose }) {
  const [viewDate, setViewDate] = useState(() => {
    const d = new Date(selDate); return { y: d.getFullYear(), m: d.getMonth() };
  });
  const ref = useRef(null);
  useEffect(() => {
    const h = (e) => { if (ref.current && !ref.current.contains(e.target)) onClose(); };
    document.addEventListener("mousedown", h); document.addEventListener("touchstart", h);
    return () => { document.removeEventListener("mousedown", h); document.removeEventListener("touchstart", h); };
  }, [onClose]);
  const { y, m } = viewDate;
  const firstDay = new Date(y, m, 1).getDay();
  const daysInMonth = new Date(y, m + 1, 0).getDate();
  const today = todayStr();
  const weeks = [];
  let week = Array(firstDay).fill(null);
  for (let d = 1; d <= daysInMonth; d++) {
    week.push(d);
    if (week.length === 7) { weeks.push(week); week = []; }
  }
  if (week.length) { while (week.length < 7) week.push(null); weeks.push(week); }
  const prevM = () => setViewDate(v => v.m === 0 ? { y: v.y - 1, m: 11 } : { ...v, m: v.m - 1 });
  const nextM = () => setViewDate(v => v.m === 11 ? { y: v.y + 1, m: 0 } : { ...v, m: v.m + 1 });
  const dayNames = ["일","월","화","수","목","금","토"];
  useEffect(() => {
    if (ref.current) {
      const rect = ref.current.getBoundingClientRect();
      if (rect.right > window.innerWidth - 8) ref.current.style.left = "auto";
      if (rect.right > window.innerWidth - 8) ref.current.style.right = "0";
      if (rect.right > window.innerWidth - 8) ref.current.style.transform = "none";
      if (rect.left < 8) { ref.current.style.left = "0"; ref.current.style.transform = "none"; }
    }
  }, []);
  return <div ref={ref} style={{position:"absolute",top:"100%",left:"50%",transform:"translateX(-50%)",zIndex:100,background:"#fff",border:"1px solid #d0d0d0",borderRadius:8,boxShadow:"0 8px 24px rgba(0,0,0,.15)",padding:10,width:250,marginTop:4}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}>
      <button onClick={prevM} style={{background:"none",border:"none",cursor:"pointer",padding:4,color:"#666"}}><I name="chevL" size={14}/></button>
      <span style={{fontSize:13,fontWeight:700,color:"#333"}}>{y}년 {m+1}월</span>
      <button onClick={nextM} style={{background:"none",border:"none",cursor:"pointer",padding:4,color:"#666"}}><I name="chevR" size={14}/></button>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:1,textAlign:"center"}}>
      {dayNames.map((dn,i) => <div key={dn} style={{fontSize:10,fontWeight:600,color:i===0?"#e57373":i===6?"#5c7cc8":"#999",padding:"2px 0"}}>{dn}</div>)}
      {weeks.flat().map((d, i) => {
        if (!d) return <div key={"e"+i}/>;
        const ds = `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        const isSel = ds === selDate;
        const isToday = ds === today;
        const dow = new Date(y, m, d).getDay();
        return <button key={i} onClick={() => onSelect(ds)} style={{
          width:30,height:30,margin:"1px auto",borderRadius:"50%",border:isToday&&!isSel?"1.5px solid #7c7cc8":"none",
          background:isSel?"#7c7cc8":"transparent",color:isSel?"#fff":dow===0?"#e57373":dow===6?"#5c7cc8":"#333",
          fontSize:12,fontWeight:isSel||isToday?700:400,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:"inherit"
        }}>{d}</button>;
      })}
    </div>
  </div>;
}

function Timeline({ data, setData, userBranches, viewBranches=[], isMaster, currentUser, setPage, bizId }) {
  const SVC_LIST = (data?.services || []).slice().sort((a,b)=>(a.sort||0)-(b.sort||0));
  const PROD_LIST = (data?.products || []);
  const [selDate, setSelDate] = useState(todayStr());
  const [showModal, setShowModal] = useState(false);
  const [modalData, setModalData] = useState(null);
  const [showSettings, setShowSettings] = useState(false);
  const [showCal, setShowCal] = useState(false);
  const [showBranchPicker, setShowBranchPicker] = useState(false);
  const scrollRef = useRef(null);

  // Branch view: 편집가능(userBranches) + 열람가능(viewBranches)
  const allBranchList = (data.branchSettings || data.branches || []).filter(b => b.useYn !== false);
  const accessibleBids = [...new Set([...userBranches, ...(viewBranches||[])])];
  const [viewBids, setViewBids] = useState(isMaster ? allBranchList.map(b=>b.id) : accessibleBids);
  // Sync viewBids when branches change (e.g. added/removed in admin)
  useEffect(() => {
    const newIds = allBranchList.map(b=>b.id);
    setViewBids(prev => {
      const added = newIds.filter(id => !prev.includes(id) && (isMaster || accessibleBids.includes(id)));
      const filtered = prev.filter(id => newIds.includes(id));
      return added.length > 0 ? [...filtered, ...added] : filtered.length !== prev.length ? filtered : prev;
    });
  }, [allBranchList.length]);
  const toggleView = (bid) => setViewBids(prev => prev.includes(bid) ? prev.filter(x=>x!==bid) : [...prev, bid]);
  const canEdit = (bid) => isMaster || userBranches.includes(bid);

  const branchesToShow = allBranchList.filter(b => viewBids.includes(b.id) && (isMaster || accessibleBids.includes(b.id)));

  // ── Alarm system ──
  const ALARM_TAG_ID = (data?.serviceTags||[]).find(t=>t.name&&t.name.includes("알람"))?.id;
  const [alarmPopup, setAlarmPopup] = useState(null);
  const firedAlarmsRef = useRef(new Set());
  useEffect(() => {
    const check = () => {
      const now = new Date();
      const nowH = now.getHours();
      const nowM = now.getMinutes();
      const today = fmtLocal(now);
      const allRes = data.reservations || [];
      allRes.forEach(r => {
        if (!r.isSchedule || r.date !== today) return;
        if (!(r.selectedTags || []).includes(ALARM_TAG_ID)) return;
        if (firedAlarmsRef.current.has(r.id)) return;
        const [rh, rm] = (r.time || "10:00").split(":").map(Number);
        if (nowH === rh && nowM === rm) {
          firedAlarmsRef.current.add(r.id);
          const tags = (data?.serviceTags || []);
          const tagNames = (r.selectedTags || []).filter(tid => tid !== ALARM_TAG_ID).map(tid => tags.find(t => t.id === tid)?.name).filter(Boolean);
          setAlarmPopup({ time: r.time, memo: r.memo || "", tags: tagNames, room: r.roomId, id: r.id });
        }
      });
    };
    const timer = setInterval(check, 10000); // 10초마다 체크
    check();
    return () => clearInterval(timer);
  }, [data.reservations]);

  // ── Drag & Drop ──
  const [dragBlock, setDragBlock] = useState(null);
  const [dragPos, setDragPos] = useState(null);
  const [dragSnap, setDragSnap] = useState(null);
  const dragStartRef = useRef(null);
  const isDragging = useRef(false);
  const dragSnapRef = useRef(null);
  const longPressTimer = useRef(null);
  const longPressActive = useRef(false);
  const origBlockPos = useRef(null);

  // ── Resize ──
  const [resizeBlock, setResizeBlock] = useState(null);
  const [resizeDur, setResizeDur] = useState(0);
  const isResizing = useRef(false);
  const resizeDurRef = useRef(0);
  const [pendingChange, setPendingChange] = useState(null);
  const [hoverCell, setHoverCell] = useState(null); // {roomId, rowIdx}
  const cellLongPress = useRef(null);

  const allRooms = branchesToShow.flatMap(br => {
    const regularRooms = (data.rooms||[]).filter(r=>r.branch_id===br.id).map(r=>({...r, branchName:br.short||br.name||""}));
    const naverCount = br.naverEmail ? (br.naverColCount || 1) : 0;
    const naverRooms = Array.from({length: naverCount}, (_, i) => ({
      id: `nv_${br.id}_${i}`, name: naverCount > 1 ? `네이버${i+1}` : "네이버",
      branch_id: br.id, branchName: br.short||br.name||"", isNaver: true
    }));
    return [...naverRooms, ...regularRooms];
  });
  const isNaverRes = (r) => !!r.reservationId;
  
  const blocks = data.reservations.filter(r => r.date === selDate && branchesToShow.some(b=>b.id===r.bid));

  // Time config - per-browser via localStorage
  const getTlSettings = () => {
    try {
      const raw = localStorage.getItem("tl_settings");
      return raw ? JSON.parse(raw) : {};
    } catch(e) {}
    return {};
  };
  const dbTl = useRef(getTlSettings());
  const tlDef = (k, def) => dbTl.current[k] !== undefined ? Number(dbTl.current[k]) : def;
  const tlSaveLocal = useCallback((allSettings) => {
    try { localStorage.setItem("tl_settings", JSON.stringify(allSettings)); } catch(e) {}
  }, []);
  const [startHour, setStartHourRaw] = useState(() => tlDef("sh", 8));
  const [endHour, setEndHourRaw] = useState(() => tlDef("eh", 22));
  const [rowH, setRowHRaw] = useState(() => tlDef("rh", 14));
  const [colW, setColWRaw] = useState(() => tlDef("cw", 160));
  const [timeUnit, setTimeUnitRaw] = useState(() => tlDef("tu", 5));
  const [blockFs, setBlockFsRaw] = useState(() => tlDef("fs", 10));
  const [blockOp, setBlockOpRaw] = useState(() => tlDef("op", 100));
  const [statusClr, setStatusClrRaw] = useState(() => {
    const sc = dbTl.current.sc;
    return sc ? {...STATUS_CLR_DEFAULT,...sc} : {...STATUS_CLR_DEFAULT};
  });
  const makeTlSave = (k, rawSetter) => v => {
    rawSetter(prev => {
      const resolved = typeof v === "function" ? v(prev) : v;
      dbTl.current = {...dbTl.current, [k]: resolved};
      tlSaveLocal(dbTl.current);
      return resolved;
    });
  };
  const setStartHour = makeTlSave("sh", setStartHourRaw);
  const setEndHour = makeTlSave("eh", setEndHourRaw);
  const setRowH = makeTlSave("rh", setRowHRaw);
  const setColW = makeTlSave("cw", setColWRaw);
  const setTimeUnit = makeTlSave("tu", setTimeUnitRaw);
  const setBlockFs = makeTlSave("fs", setBlockFsRaw);
  const setBlockOp = makeTlSave("op", setBlockOpRaw);
  const setStatusClr = (k,v) => { setStatusClrRaw(p => { const n = {...p,[k]:v}; dbTl.current = {...dbTl.current, sc:n}; tlSaveLocal(dbTl.current); try{localStorage.setItem("tl_sc",JSON.stringify(n))}catch(e){} return n; }); };
  // Sync status colors to localStorage for other components using getStatusClr()
  useEffect(() => { try{localStorage.setItem("tl_sc",JSON.stringify(statusClr))}catch(e){} }, [statusClr]);
  const slotsPerHour = 60 / timeUnit;
  const totalRows = (endHour - startHour) * slotsPerHour;
  const headerH = 40;

  // CSS grid background
  const hourH = rowH * slotsPerHour;
  const halfH = rowH * (slotsPerHour / 2);
  const gridBg = useMemo(() => ({
    backgroundImage: [
      `repeating-linear-gradient(to bottom, #e8e8e8 0px, #e8e8e8 1px, transparent 1px, transparent ${hourH}px)`,
      ...(slotsPerHour >= 2 ? [`repeating-linear-gradient(to bottom, #f0f0f0 0px, #f0f0f0 1px, transparent 1px, transparent ${halfH}px)`] : []),
      ...(slotsPerHour > 2 ? [`repeating-linear-gradient(to bottom, #f5f5f5 0px, #f5f5f5 1px, transparent 1px, transparent ${rowH}px)`] : []),
    ].join(","),
    backgroundSize: "100% 100%",
  }), [rowH, hourH, halfH, slotsPerHour]);

  // Time label positions
  const timeLabels = useMemo(() => {
    const labels = [];
    for (let i = 0; i < totalRows; i++) {
      const totalMin = i * timeUnit;
      const h = startHour + Math.floor(totalMin / 60);
      const m = totalMin % 60;
      const isHour = m === 0;
      const ampm = h < 12 ? "오전" : "오후";
      const h12 = h <= 12 ? h : h - 12;
      const isMob = window.innerWidth <= 768;
      labels.push({ i, isHour, m, text: isHour ? (isMob ? `${h12}:00` : `${ampm} ${String(h12).padStart(2,"0")}:00`) : `${String(m).padStart(2,"0")}` });
    }
    return labels;
  }, [startHour, endHour, timeUnit, totalRows]);

  const timeToY = (timeStr) => {
    const [h, m] = timeStr.split(":").map(Number);
    return ((h - startHour) * 60 + m) / timeUnit * rowH;
  };

  const yToTime = (y) => {
    const totalMin = Math.floor(y / rowH) * timeUnit;
    const h = startHour + Math.floor(totalMin / 60);
    const m = totalMin % 60;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
  };

  const lastTouchCell = useRef(0);
  const handleCellClick = (room, y) => {
    if (isDragging.current || isResizing.current) return;
    if (!canEdit(room.branch_id)) return;
    if (room.isNaver) return;
    // 모바일: 터치 직후 click 무시 (롱프레스로만 등록)
    if (Date.now() - lastTouchCell.current < 500) return;
    const time = yToTime(y);
    setModalData({ roomId: room.id, bid: room.branch_id, time, date: selDate });
    setShowModal(true);
  };

  const handleBlockClick = (block, e) => {
    e.stopPropagation();
    if (isDragging.current || isResizing.current) return;
    const readOnly = !canEdit(block.bid);
    setModalData({ ...block, readOnly });
    setShowModal(true);
  };

  const handleSave = (item) => {
    // 신규고객이면 DB에 고객 등록
    if (item.isNewCust && item.custName && !item.custId) {
      const newCustId = "cust_" + uid();
      item.custId = newCustId;
      const newCust = {
        id: newCustId, bid: item.bid, name: item.custName, phone: item.custPhone || "",
        gender: item.custGender || "", visits: 0, lastVisit: null, memo: "",
        custNum: String(50000 + Math.floor(Math.random() * 10000))
      };
      setData(prev => ({ ...prev, customers: [...prev.customers, newCust] }));
      sb.insert("customers", toDb("customers", newCust)).catch(console.error);
    }
    const allItems = [];
    setData(prev => {
      const exists = prev.reservations.find(r => r.id === item.id);
      if (exists) {
        sb.update("reservations", item.id, toDb("reservations", item)).catch(console.error);
        return { ...prev, reservations: prev.reservations.map(r => r.id === item.id ? item : r) };
      }
      const items = [item];
      if (item.isSchedule && item.repeat && item.repeat !== "none" && item.repeatUntil) {
        const fmtD = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
        const start = new Date(item.date + "T12:00:00");
        const end = new Date(item.repeatUntil + "T12:00:00");
        const dayOfWeek = start.getDay();
        const dayOfMonth = start.getDate();
        let cur = new Date(start);
        cur.setDate(cur.getDate() + 1);
        while (cur <= end) {
          let match = false;
          if (item.repeat === "daily") match = true;
          else if (item.repeat === "weekly") match = cur.getDay() === dayOfWeek;
          else if (item.repeat === "monthly") match = cur.getDate() === dayOfMonth;
          if (match) {
            const ds = fmtD(cur);
            items.push({ ...item, id: uid(), date: ds, endDate: ds, repeat: item.repeat, repeatUntil: item.repeatUntil, repeatSourceId: item.id });
          }
          cur.setDate(cur.getDate() + 1);
        }
      }
      allItems.push(...items);
      return { ...prev, reservations: [...prev.reservations, ...items] };
    });
    // Async sync to Supabase
    setTimeout(()=>{ if(allItems.length) sb.upsert("reservations", allItems.map(i=>toDb("reservations",i))).catch(console.error); }, 0);
    setShowModal(false); setModalData(null);
  };

  // ── Delete with repeat options ──
  const [deletePopup, setDeletePopup] = useState(null);

  const handleDeleteRequest = (block) => {
    const sourceId = block.repeatSourceId || block.id;
    const hasRepeat = (data.reservations || []).some(r => r.repeatSourceId === sourceId || (r.id === sourceId && r.repeat && r.repeat !== "none"));
    if (hasRepeat) {
      setDeletePopup(block);
    } else {
      handleDelete(block.id);
    }
  };

  const handleDeleteConfirm = (mode) => {
    if (!deletePopup) return;
    const block = deletePopup;
    const sourceId = block.repeatSourceId || block.id;
    const toDelIds = [];
    setData(prev => {
      let res = prev.reservations;
      if (mode === "this") {
        toDelIds.push(block.id);
        res = res.filter(r => r.id !== block.id);
      } else if (mode === "future") {
        res = res.filter(r => {
          if (r.id === block.id) { toDelIds.push(r.id); return false; }
          const sameGroup = r.id === sourceId || r.repeatSourceId === sourceId;
          if (sameGroup && r.date >= block.date) { toDelIds.push(r.id); return false; }
          return true;
        });
      } else if (mode === "all") {
        res.forEach(r => { if(r.id===sourceId||r.repeatSourceId===sourceId) toDelIds.push(r.id); });
        res = res.filter(r => r.id !== sourceId && r.repeatSourceId !== sourceId);
      }
      return { ...prev, reservations: res };
    });
    setTimeout(()=>{ toDelIds.forEach(id=>sb.del("reservations",id).catch(console.error)); }, 0);
    setDeletePopup(null); setShowModal(false); setModalData(null);
  };

  const handleDelete = (id) => {
    setData(prev => ({ ...prev, reservations: prev.reservations.filter(r => r.id !== id) }));
    sb.del("reservations", id).catch(console.error);
    setShowModal(false); setModalData(null);
  };

  // ── Drag handlers ──
  const timeLabelsW = window.innerWidth <= 768 ? 52 : 88;
  const handleDragStart = (block, e) => {
    e.stopPropagation();
    const isTouch = e.type === "touchstart";
    if (!isTouch) e.preventDefault();
    const startPt = isTouch ? e.touches[0] : e;
    dragStartRef.current = { x: startPt.clientX, y: startPt.clientY };
    isDragging.current = false;
    longPressActive.current = false;

    origBlockPos.current = { time: block.time, roomId: block.roomId, bid: block.bid };

    const sr = scrollRef.current;
    const blockTopY = timeToY(block.time);
    let clickOffsetY = 0;
    if (sr) {
      const rect = sr.getBoundingClientRect();
      const cursorGridY = (startPt.clientY - rect.top + sr.scrollTop) - headerH;
      clickOffsetY = cursorGridY - blockTopY;
    }

    const getPoint = (ev) => isTouch ? ev.touches[0] : ev;

    const onDragMove = (ev) => {
      const pt = getPoint(ev);
      if (!pt) return;
      ev.preventDefault(); // 드래그 중에만 스크롤 차단
      if (!sr) return;
      const rect = sr.getBoundingClientRect();
      const x = pt.clientX - rect.left + sr.scrollLeft;
      const y = pt.clientY - rect.top + sr.scrollTop;
      setDragPos({ x: pt.clientX - rect.left, y: pt.clientY - rect.top });
      const colX = x - timeLabelsW;
      const roomIdx = Math.max(0, Math.min(allRooms.length - 1, Math.floor(colX / colW)));
      const targetRoom = allRooms[roomIdx];
      const gridY = y - headerH - clickOffsetY;
      const snappedTime = yToTime(Math.max(0, gridY));
      setDragSnap({ roomId: targetRoom?.id, bid: targetRoom?.branch_id, time: snappedTime });
      dragSnapRef.current = { roomId: targetRoom?.id, bid: targetRoom?.branch_id, time: snappedTime };
      const edgeZone = 40;
      if (pt.clientY - rect.top < edgeZone) sr.scrollTop -= 8;
      if (rect.bottom - pt.clientY < edgeZone) sr.scrollTop += 8;
    };

    const onDragUp = () => {
      document.removeEventListener(isTouch ? "touchmove" : "mousemove", onDragMove);
      document.removeEventListener(isTouch ? "touchend" : "mouseup", onDragUp);
      if (isDragging.current && dragSnapRef.current) {
        const snap = dragSnapRef.current;
        const orig = origBlockPos.current;
        if (snap.time !== orig.time || snap.roomId !== orig.roomId) {
          setData(prev => ({...prev, reservations: prev.reservations.map(r => {
            if (r.id !== block.id) return r;
            const [sh,sm] = snap.time.split(":").map(Number);
            const endMin = sh*60+sm+(r.dur||60);
            const endTime = `${String(Math.floor(endMin/60)).padStart(2,"0")}:${String(endMin%60).padStart(2,"0")}`;
            return {...r, time: snap.time, endTime, roomId: snap.roomId||r.roomId, bid: snap.bid||r.bid};
          })}));
          setPendingChange({ type: "move", block, data: snap, orig });
        }
      }
      setDragBlock(null); setDragPos(null); setDragSnap(null); dragSnapRef.current = null;
      setTimeout(() => { isDragging.current = false; longPressActive.current = false; }, 300);
    };

    if (isTouch) {
      // 터치: 롱프레스 성공 후에만 document 리스너 등록
      const cancelOnMove = (ev) => {
        const pt = ev.touches[0]; if (!pt) return;
        if (Math.abs(pt.clientX - startPt.clientX) + Math.abs(pt.clientY - startPt.clientY) > 8) {
          clearTimeout(longPressTimer.current);
          document.removeEventListener("touchmove", cancelOnMove);
          document.removeEventListener("touchend", cancelOnEnd);
        }
      };
      const cancelOnEnd = () => {
        clearTimeout(longPressTimer.current);
        document.removeEventListener("touchmove", cancelOnMove);
        document.removeEventListener("touchend", cancelOnEnd);
      };
      document.addEventListener("touchmove", cancelOnMove); // passive(기본) → 스크롤 안 막음
      document.addEventListener("touchend", cancelOnEnd);

      longPressTimer.current = setTimeout(() => {
        document.removeEventListener("touchmove", cancelOnMove);
        document.removeEventListener("touchend", cancelOnEnd);
        longPressActive.current = true;
        isDragging.current = true;
        setDragBlock(block);
        try { navigator.vibrate && navigator.vibrate(30); } catch(ex){}
        // 이제 드래그 리스너 등록 (passive:false → 스크롤 차단)
        document.addEventListener("touchmove", onDragMove, {passive:false});
        document.addEventListener("touchend", onDragUp);
      }, 500);
    } else {
      // 마우스: 기존 방식
      const onMouseMove = (ev) => {
        const dx = ev.clientX - dragStartRef.current.x;
        const dy = ev.clientY - dragStartRef.current.y;
        if (!isDragging.current && Math.abs(dx) + Math.abs(dy) < 6) return;
        if (!isDragging.current) { isDragging.current = true; setDragBlock(block); }
        onDragMove(ev);
      };
      const onMouseUp = () => {
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
        onDragUp();
      };
      document.addEventListener("mousemove", onMouseMove);
      document.addEventListener("mouseup", onMouseUp);
    }
  };

  // ── Resize handler ──
  const handleResizeStart = (block, e) => {
    e.stopPropagation();
    const isTouch = e.type === "touchstart";
    if (!isTouch) e.preventDefault();
    const startY = isTouch ? e.touches[0].clientY : e.clientY;
    const startDur = block.dur;
    const origDur = block.dur;

    const onResizeMove = (ev) => {
      const pt = isTouch ? ev.touches[0] : ev;
      if (!pt) return;
      if (isTouch) ev.preventDefault();
      const dy = pt.clientY - startY;
      const durDelta = Math.round(dy / rowH) * timeUnit;
      const newDur = Math.max(5, startDur + durDelta);
      setResizeDur(newDur);
      resizeDurRef.current = newDur;
    };

    const onResizeUp = () => {
      document.removeEventListener(isTouch ? "touchmove" : "mousemove", onResizeMove);
      document.removeEventListener(isTouch ? "touchend" : "mouseup", onResizeUp);
      const finalDur = resizeDurRef.current;
      if (isResizing.current && finalDur !== origDur) {
        setData(prev => ({...prev, reservations: prev.reservations.map(r => {
          if (r.id !== block.id) return r;
          const [sh,sm] = r.time.split(":").map(Number);
          const endMin = sh*60+sm+finalDur;
          const endTime = `${String(Math.floor(endMin/60)).padStart(2,"0")}:${String(endMin%60).padStart(2,"0")}`;
          return {...r, dur: finalDur, endTime};
        })}));
        setPendingChange({ type: "resize", block, data: { dur: finalDur }, orig: { dur: origDur } });
      }
      setResizeBlock(null); setResizeDur(0);
      setTimeout(() => { isResizing.current = false; longPressActive.current = false; }, 300);
    };

    const beginResize = () => {
      longPressActive.current = true;
      isResizing.current = true;
      setResizeBlock(block);
      setResizeDur(block.dur);
      resizeDurRef.current = block.dur;
      try { navigator.vibrate && navigator.vibrate(30); } catch(ex){}
      document.addEventListener(isTouch ? "touchmove" : "mousemove", onResizeMove, isTouch ? {passive:false} : undefined);
      document.addEventListener(isTouch ? "touchend" : "mouseup", onResizeUp);
    };

    if (isTouch) {
      const cancelOnMove = (ev) => {
        const pt = ev.touches[0]; if (!pt) return;
        if (Math.abs(pt.clientY - startY) > 8) {
          clearTimeout(longPressTimer.current);
          document.removeEventListener("touchmove", cancelOnMove);
          document.removeEventListener("touchend", cancelOnEnd);
        }
      };
      const cancelOnEnd = () => {
        clearTimeout(longPressTimer.current);
        document.removeEventListener("touchmove", cancelOnMove);
        document.removeEventListener("touchend", cancelOnEnd);
      };
      document.addEventListener("touchmove", cancelOnMove);
      document.addEventListener("touchend", cancelOnEnd);
      longPressTimer.current = setTimeout(() => {
        document.removeEventListener("touchmove", cancelOnMove);
        document.removeEventListener("touchend", cancelOnEnd);
        beginResize();
      }, 500);
    } else {
      beginResize();
    }
  };

  // ── 이동/리사이즈 확인/취소 ──
  const confirmChange = () => {
    if (!pendingChange) return;
    const { type, block, data: d } = pendingChange;
    // 이미 미리보기로 state에 반영됨 → DB만 저장
    if (type === "move") {
      const r = data.reservations.find(r => r.id === block.id);
      if (r) sb.update("reservations", block.id, toDb("reservations", r)).catch(console.error);
    }
    if (type === "resize") {
      const r = data.reservations.find(r => r.id === block.id);
      if (r) sb.update("reservations", block.id, toDb("reservations", r)).catch(console.error);
    }
    setPendingChange(null);
  };
  const cancelChange = () => {
    if (!pendingChange) return;
    const { type, block, orig } = pendingChange;
    // 원래 위치로 복원
    if (type === "move") {
      setData(prev => ({...prev, reservations: prev.reservations.map(r => {
        if (r.id !== block.id) return r;
        const [sh,sm] = orig.time.split(":").map(Number);
        const endMin = sh*60+sm+(r.dur||60);
        const endTime = `${String(Math.floor(endMin/60)).padStart(2,"0")}:${String(endMin%60).padStart(2,"0")}`;
        return {...r, time: orig.time, endTime, roomId: orig.roomId, bid: orig.bid};
      })}));
    }
    if (type === "resize") {
      setData(prev => ({...prev, reservations: prev.reservations.map(r => {
        if (r.id !== block.id) return r;
        const [sh,sm] = r.time.split(":").map(Number);
        const endMin = sh*60+sm+orig.dur;
        const endTime = `${String(Math.floor(endMin/60)).padStart(2,"0")}:${String(endMin%60).padStart(2,"0")}`;
        return {...r, dur: orig.dur, endTime};
      })}));
    }
    setPendingChange(null);
  };

  const changeDate = (off) => { const d = new Date(selDate); d.setDate(d.getDate()+off); setSelDate(fmtLocal(d)); };

  // Scroll to current time on mount
  useEffect(() => {
    if (scrollRef.current) {
      const now = new Date();
      const y = timeToY(`${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`);
      scrollRef.current.scrollTop = Math.max(0, y - 200);
    }
  }, [selDate]);

  // Current time line (updates every minute)
  const [nowTick, setNowTick] = useState(Date.now());
  useEffect(() => { const t = setInterval(() => setNowTick(Date.now()), 60000); return () => clearInterval(t); }, []);
  const now = new Date(nowTick);
  const nowY = (selDate === todayStr() && now.getHours() >= startHour && now.getHours() < endHour) ? timeToY(`${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`) : -1;

  // Date helpers
  const DAYS_KR = ["일","월","화","수","목","금","토"];
  const sd = new Date(selDate);
  const dateLabel = `${sd.getFullYear()}년 ${String(sd.getMonth()+1).padStart(2,"0")}월 ${String(sd.getDate()).padStart(2,"0")}일 (${DAYS_KR[sd.getDay()]})`;

  return (
    <div style={{display:"flex",flexDirection:"column",flex:1,minHeight:0}}>
      {/* Top Bar */}
      <div className="tl-topbar" style={{borderBottom:"1px solid #e0e0e0",background:"#fff",flexShrink:0,padding:"6px 12px",display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"}}>
        {/* Row 1: Date nav + settings + branch */}
        <div style={{display:"flex",alignItems:"center",gap:6,flexShrink:0}}>
          <button onClick={()=>changeDate(-1)} style={{background:"none",border:"none",cursor:"pointer",fontSize:12,color:"#666",padding:"2px 4px",flexShrink:0}}><I name="chevL" size={14}/></button>
          <span className="tl-date-label" style={{fontSize:13,fontWeight:700,color:"#333",flexShrink:0,whiteSpace:"nowrap"}}>{dateLabel}</span>
          <div style={{position:"relative",flexShrink:0}}>
            <button onClick={()=>setShowCal(!showCal)} style={{background:"none",border:"none",cursor:"pointer",padding:"2px 4px",color:"#333",display:"flex",alignItems:"center"}}><I name="calendar" size={14}/></button>
            {showCal && <MiniCal selDate={selDate} onSelect={d=>{setSelDate(d);setShowCal(false);}} onClose={()=>setShowCal(false)}/>}
          </div>
          <button onClick={()=>changeDate(1)} style={{background:"none",border:"none",cursor:"pointer",fontSize:12,color:"#666",padding:"2px 4px",flexShrink:0}}><I name="chevR" size={14}/></button>
          <button onClick={()=>setSelDate(todayStr())} style={{padding:"0 10px",height:32,fontSize:12,border:"1px solid #d0d0d0",borderRadius:6,background:"#fff",color:"#666",cursor:"pointer",fontFamily:"inherit",flexShrink:0,display:"flex",alignItems:"center"}}>오늘</button>
          <div style={{position:"relative",flexShrink:0}} ref={el => { if(el) el._settingsBtn = el; }}>
            <button onClick={(e)=>{setShowSettings(!showSettings);}} id="settings-btn"
              style={{width:32,height:32,border:"1px solid #d0d0d0",borderRadius:6,background:showSettings?"#f0f0ff":"#fff",
                cursor:"pointer",fontSize:12,display:"flex",alignItems:"center",justifyContent:"center",padding:0,color:"#888"}}><I name="settings" size={14}/></button>
          </div>
          {/* Branch multi-select */}
          {(() => {
            const branchList = isMaster ? allBranchList : allBranchList.filter(b=>accessibleBids.includes(b.id));
            const allSelected = branchList.every(b => viewBids.includes(b.id));
            const selectedCount = branchList.filter(b => viewBids.includes(b.id)).length;
            const label = allSelected ? "전체" : selectedCount === 1 ? (branchList.find(b=>viewBids.includes(b.id))?.short || branchList.find(b=>viewBids.includes(b.id))?.name || "지점") : `${selectedCount}개 지점`;
            return <div style={{position:"relative",flexShrink:0}}>
              <button onClick={()=>setShowBranchPicker(p=>!p)}
                style={{height:32,padding:"0 10px",fontSize:12,border:"1px solid #d0d0d0",borderRadius:6,
                  background:showBranchPicker?"#f0f0ff":"#fff",color:"#555",cursor:"pointer",fontFamily:"inherit",
                  fontWeight:600,display:"flex",alignItems:"center",gap:4,whiteSpace:"nowrap"}}>
                <I name="building" size={10}/> {label} <I name="chevD" size={10}/>
              </button>
              {showBranchPicker && <>
                <div style={{position:"fixed",inset:0,zIndex:98}} onClick={()=>setShowBranchPicker(false)}/>
                <div style={{position:"absolute",top:"100%",left:0,zIndex:99,marginTop:4,background:"#fff",
                  border:"1px solid #e0e0e0",borderRadius:8,boxShadow:"0 8px 24px rgba(0,0,0,.12)",
                  padding:6,minWidth:160,animation:"fadeIn .2s ease"}}>
                  {/* 전체 토글 */}
                  <div onClick={()=>{
                    if(allSelected) { const first = branchList[0]; if(first) setViewBids([first.id]); }
                    else setViewBids(branchList.map(b=>b.id));
                  }}
                    style={{padding:"6px 10px",borderRadius:6,cursor:"pointer",display:"flex",alignItems:"center",gap:6,
                      background:allSelected?"#7c7cc815":"transparent",marginBottom:2,borderBottom:"1px solid #f0f0f0"}}>
                    <span style={{width:16,height:16,borderRadius:4,border:allSelected?"none":"1.5px solid #ccc",
                      background:allSelected?"#7c7cc8":"transparent",display:"flex",alignItems:"center",justifyContent:"center",
                      fontSize:10,color:"#fff",flexShrink:0}}>{allSelected?"✓":""}</span>
                    <span style={{fontSize:11,fontWeight:600,color:"#333"}}>전체 선택</span>
                  </div>
                  {branchList.map(b => {
                    const sel = viewBids.includes(b.id);
                    const isReadOnly = !canEdit(b.id);
                    return <div key={b.id} onClick={()=>{
                      if(sel && viewBids.length <= 1) return; // 최소 1개
                      setViewBids(prev => sel ? prev.filter(id=>id!==b.id) : [...prev, b.id]);
                    }}
                      style={{padding:"6px 10px",borderRadius:6,cursor:"pointer",display:"flex",alignItems:"center",gap:6,
                        background:sel?"#7c7cc808":"transparent",transition:"background .1s"}}>
                      <span style={{width:16,height:16,borderRadius:4,border:sel?"none":"1.5px solid #ccc",
                        background:sel?(b.color||"#7c7cc8"):"transparent",display:"flex",alignItems:"center",justifyContent:"center",
                        fontSize:10,color:"#fff",flexShrink:0}}>{sel?"✓":""}</span>
                      <span style={{fontSize:11,fontWeight:sel?600:400,color:sel?"#333":"#888",flex:1}}>{b.short||b.name}</span>
                      {isReadOnly && <span style={{fontSize:8,color:"#bbb"}}>읽기</span>}
                    </div>;
                  })}
                </div>
              </>}
            </div>;
          })()}
        </div>
        {/* Row 2 (mobile) / inline (desktop): 7-day buttons */}
        <div className="tl-days" style={{display:"flex",gap:2,alignItems:"center"}}>
          {Array.from({length:7},(_,i)=>{
            const dt = new Date(); dt.setDate(dt.getDate()+i);
            const ds = fmtLocal(dt);
            const dow = dt.getDay();
            const isSel = ds === selDate;
            const dayColor = dow===0?"#e57373":dow===6?"#4a7cc8":"#555";
            return <button key={i} onClick={()=>setSelDate(ds)}
              style={{minWidth:42,height:32,borderRadius:8,border:isSel?"none":"1px solid #e8e8e8",
                background:isSel?"#7c7cc8":"#fff",color:isSel?"#fff":dayColor,
                fontSize:13,fontWeight:isSel?700:500,cursor:"pointer",fontFamily:"inherit",padding:"2px 4px",flexShrink:0,
                display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",lineHeight:1.1}}>
              <span style={{fontSize:12}}>{DAYS_KR[dow]}</span>
              <span>{dt.getDate()}</span>
            </button>;
          })}
        </div>
      </div>

      {/* Pending Reservations Alert */}
      {(() => {
        const pendingList = data.reservations.filter(r => r.status === "pending" && branchesToShow.some(b => b.id === r.bid));
        if (pendingList.length === 0) return null;
        return <div style={{background:"#FFF3E0",borderBottom:"1px solid #FFB74D",padding:"6px 12px",display:"flex",alignItems:"center",gap:8,flexShrink:0,cursor:"pointer",animation:"pendingBlink 2s infinite"}}
          onClick={()=>{
            const first = pendingList[0];
            setSelDate(first.date);
            setTimeout(()=>{
              if(!scrollRef.current) return;
              const [h,m] = (first.time||"10:00").split(":").map(Number);
              const y = ((h - startHour) * 60 + m) / timeUnit * rowH + headerH - 60;
              scrollRef.current.scrollTo({top: Math.max(0, y), behavior:"smooth"});
            }, 100);
          }}>
          <span style={{fontSize:18}}><I name="bell" size={18} color="#FF9800"/></span>
          <div style={{flex:1,minWidth:0}}>
            <span style={{fontSize:12,fontWeight:700,color:"#E65100"}}>확정대기 {pendingList.length}건</span>
            <span style={{fontSize:11,color:"#F57C00",marginLeft:8}}>
              {pendingList.slice(0,3).map(r => {
                const br = allBranchList.find(b=>b.id===r.bid);
                return `${br?.short||br?.name||""} ${r.custName||"네이버"} ${r.date.slice(5)}`;
              }).join(" · ")}
              {pendingList.length > 3 ? ` 외 ${pendingList.length-3}건` : ""}
            </span>
          </div>
          <span style={{fontSize:11,color:"#E65100",fontWeight:600,flexShrink:0}}>확인 <I name="chevR" size={11} color="#E65100"/></span>
          {(() => {
            const first = pendingList[0];
            const br = allBranchList.find(b=>b.id===first.bid);
            const bizId = br?.naverBizId;
            return bizId ? <a href={`https://partner.booking.naver.com/bizes/${bizId}/booking-list-view`} target="_blank" rel="noopener noreferrer"
              onClick={e=>e.stopPropagation()}
              style={{fontSize:11,color:"#fff",fontWeight:700,background:"#03C75A",padding:"4px 10px",borderRadius:6,textDecoration:"none",flexShrink:0,whiteSpace:"nowrap"}}>네이버 확정</a> : null;
          })()}
        </div>;
      })()}

      {/* Timeline Grid */}
      <div ref={scrollRef} className="timeline-scroll" onScroll={e=>{const hdr=document.querySelector(".mob-hdr");if(!hdr||window.innerWidth>768)return;const t=e.target.scrollTop;if(t>10){hdr.style.maxHeight="0";hdr.style.padding="0 16px";hdr.style.borderColor="transparent";}else{hdr.style.maxHeight="60px";hdr.style.padding="10px 16px";hdr.style.borderColor="#e0e0e0";}}} style={{flex:1,overflow:"scroll",position:"relative",minHeight:0}}>
        <div style={{display:"flex",minWidth:"fit-content"}}>
          {/* Time Labels */}
          <div className="tl-time-col" style={{width:timeLabelsW,flexShrink:0,position:"sticky",left:0,zIndex:20,background:"#fff",borderRight:"1px solid #eee"}}>
            <div className="tl-hdr-cell" style={{height:headerH,borderBottom:"1px solid #eee",position:"sticky",top:0,zIndex:25,background:"#fff"}}/>
            <div style={{position:"relative",height:totalRows*rowH,...gridBg}}>
              {hoverCell && hoverCell.rowIdx>=0 && <div style={{position:"absolute",top:hoverCell.rowIdx*rowH,left:0,right:0,height:rowH,background:"rgba(124,124,200,0.08)",zIndex:1,pointerEvents:"none"}}/>}
              {timeLabels.map(({i, isHour, m, text}) => {
                const isHighlighted = hoverCell && hoverCell.rowIdx === i;
                return <div key={i} className="tl-time-cell" style={{position:"absolute",top:i*rowH,left:0,right:0,height:rowH,display:"flex",alignItems:"center",justifyContent:"flex-end",paddingRight:window.innerWidth<=768?3:6}}>
                  <span style={{fontSize:isHour?(window.innerWidth<=768?10:11):(window.innerWidth<=768?8:9),fontWeight:isHighlighted?700:(isHour?600:400),color:isHighlighted?"#7c7cc8":(isHour?"#555":"#aaa"),whiteSpace:"nowrap",lineHeight:1,transition:"color 0.1s"}}>{text}</span>
                </div>;
              })}
              {nowY > 0 && <div style={{position:"absolute",top:nowY-9,left:0,right:0,display:"flex",alignItems:"center",justifyContent:"center",zIndex:6,pointerEvents:"none"}}>
                <span style={{fontSize:10,fontWeight:800,color:"#e57373",background:"#fff",padding:"1px 3px",borderRadius:3,lineHeight:1}}>
                  {(now.getHours()>12?now.getHours()-12:now.getHours()||12)}:{String(now.getMinutes()).padStart(2,"0")}
                </span>
              </div>}
            </div>
          </div>

          {/* Room Columns */}
          {allRooms.map((room, ci) => {
            const roomBlocks = blocks.filter(b => {
              if (room.isNaver) {
                if (!isNaverRes(b) || b.bid !== room.branch_id) return false;
                if (b.roomId === room.id) return true;
                if (!b.roomId?.startsWith("nv_")) {
                  const firstNv = allRooms.find(r => r.isNaver && r.branch_id === room.branch_id);
                  return firstNv?.id === room.id;
                }
                return false;
              }
              return !isNaverRes(b) && b.roomId === room.id;
            });
            const isNewBranch = ci === 0 || room.branch_id !== allRooms[ci-1]?.branch_id;
            const branchColor = (data.branchSettings || []).find(bs => bs.id === room.branch_id)?.color || "";
            return (
              <div key={room.id} className="tl-room-col" style={{width:colW,flexShrink:0,borderLeft:room.isNaver?"2px solid #A5D6A7":(isNewBranch&&ci>0?"none":"1px solid #f0f0f0"),background:room.isNaver?"#F1F8E9":(branchColor||"#fff"),marginLeft:isNewBranch&&ci>0?4:0,boxShadow:isNewBranch&&ci>0?"-4px 0 8px rgba(0,0,0,.06)":room.isNaver?"inset 2px 0 4px rgba(76,175,80,.08)":"none"}}>
                {/* Header */}
                <div className="tl-hdr-cell" style={{height:headerH,borderBottom:"1px solid #eee",position:"sticky",top:0,zIndex:10,background:room.isNaver?"#E8F5E9":(branchColor||"#fff"),display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",lineHeight:1.2}}>
                  <span className="tl-room-name" style={{fontSize:12,fontWeight:700,color:room.isNaver?"#2E7D32":"#333"}}>{room.branchName}</span>
                  <span className="tl-room-sub" style={{fontSize:9,color:room.isNaver?"#43A047":"#999"}}>{room.isNaver?<I name="naver" size={11}/> :"" }{room.name}</span>
                </div>
                {/* Grid Area */}
                <div style={{position:"relative",height:totalRows*rowH,cursor:room.isNaver?"default":(canEdit(room.branch_id)?"pointer":"default"),...gridBg}}
                  onClick={e=>{const rect=e.currentTarget.getBoundingClientRect();handleCellClick(room,e.clientY-rect.top)}}
                  onMouseMove={e=>{if(room.isNaver)return;const rect=e.currentTarget.getBoundingClientRect();const y=e.clientY-rect.top;const ri=Math.floor(y/rowH);setHoverCell({roomId:room.id,rowIdx:ri})}}
                  onMouseLeave={()=>setHoverCell(null)}
                  onTouchStart={e=>{
                    lastTouchCell.current=Date.now();
                    if(room.isNaver||!canEdit(room.branch_id))return;
                    const t=e.touches[0];const rect=e.currentTarget.getBoundingClientRect();
                    const y=t.clientY-rect.top;const ri=Math.floor(y/rowH);
                    setHoverCell({roomId:room.id,rowIdx:ri});
                    cellLongPress.current={moved:false};
                    cellLongPress.current.timer=setTimeout(()=>{
                      if(!cellLongPress.current?.moved){
                        try{navigator.vibrate&&navigator.vibrate(30)}catch(ex){}
                        const time=yToTime(y);
                        setModalData({roomId:room.id,bid:room.branch_id,time,date:selDate});
                        setShowModal(true);setHoverCell(null);
                      }
                    },500);
                  }}
                  onTouchMove={e=>{
                    if(cellLongPress.current)cellLongPress.current.moved=true;
                    clearTimeout(cellLongPress.current?.timer);
                    if(room.isNaver)return;
                    const t=e.touches[0];const rect=e.currentTarget.getBoundingClientRect();
                    const y=t.clientY-rect.top;const ri=Math.floor(y/rowH);
                    setHoverCell({roomId:room.id,rowIdx:ri});
                  }}
                  onTouchEnd={()=>{clearTimeout(cellLongPress.current?.timer);cellLongPress.current=null;setTimeout(()=>setHoverCell(null),300)}}
                >
                  {/* Hover/touch highlight */}
                  {hoverCell?.roomId===room.id && hoverCell.rowIdx>=0 && <div style={{position:"absolute",top:hoverCell.rowIdx*rowH,left:0,right:0,height:rowH,background:"rgba(124,124,200,0.12)",borderTop:"1px solid rgba(124,124,200,0.3)",borderBottom:"1px solid rgba(124,124,200,0.3)",zIndex:1,pointerEvents:"none",transition:"top 0.05s ease"}}/>}
                  {/* Row crosshair highlight (other columns) */}
                  {hoverCell && hoverCell.roomId!==room.id && hoverCell.rowIdx>=0 && <div style={{position:"absolute",top:hoverCell.rowIdx*rowH,left:0,right:0,height:rowH,background:"rgba(124,124,200,0.04)",zIndex:1,pointerEvents:"none"}}/>}
                  {/* Current time */}
                  {nowY > 0 && <div style={{position:"absolute",top:nowY,left:0,right:0,borderTop:"2px solid #e57373",zIndex:5}}>
                    <div style={{position:"absolute",top:-4,left:-1,width:8,height:8,borderRadius:4,background:"#e57373"}}/>
                  </div>}
                  {/* Blocks */}
                  {roomBlocks.map(block => {
                    const y = timeToY(block.time);
                    const isBeingResized = resizeBlock?.id === block.id;
                    const blockDur = isBeingResized ? resizeDur : block.dur;
                    const h = (blockDur / timeUnit) * rowH;
                    // 서비스태그 색상 우선 적용
                    const tags = data?.serviceTags || [];
                    const tagColor = block.type==="reservation" && block.selectedTags?.length
                      ? (block.selectedTags.map(tid=>tags.find(t=>t.id===tid)).find(t=>t?.color)?.color || "")
                      : "";
                    // 네이버 취소/대기 상태 처리
                    const isNaverCancelled = block.status === "naver_cancelled";
                    const isNaverPending = block.status === "pending";
                    const stClr = block.type==="reservation" && !block.isSchedule && statusClr[block.status];
                    const color = isNaverCancelled ? "#E6A700" : (stClr || tagColor || BLOCK_COLORS[block.type] || "#7c7cc8");
                    const staff = (data.staff||[]).find(s=>s.id===block.staffId);
                    const isDrag = dragBlock?.id === block.id;
                    const isSch = block.isSchedule;
                    const isEditable = canEdit(block.bid);
                    const opHex = (pct) => Math.round(pct * 2.55).toString(16).padStart(2,"0");
                    const bgAlpha = isSch ? opHex(Math.min(blockOp, 80)) : opHex(blockOp);
                    return (
                      <div key={block.id}
                        onClick={e=>handleBlockClick(block,e)}
                        onMouseDown={e=>{if(isEditable && !isResizing.current)handleDragStart(block,e)}}
                        onTouchStart={e=>{if(isEditable && !isResizing.current)handleDragStart(block,e)}}
                        style={{position:"absolute",top:y,left:3,right:3,height:Math.max(h,rowH*2),
                          background:isNaverCancelled?"#FFF8E1":isNaverPending?`${color}15`:`${color}${bgAlpha}`,
                          border:isNaverCancelled?"1.5px dashed #E6A700":isNaverPending?`1.5px dashed ${color}`:"none",
                          borderLeft:`3.5px solid ${isNaverCancelled?"#E6A700":color}`,
                          borderRadius:8,padding:"4px 6px",overflow:"hidden",fontSize:blockFs,lineHeight:1.2,
                          boxShadow:isDrag?"none":"0 1px 4px rgba(0,0,0,.1)",
                          cursor:isEditable?"grab":"pointer",zIndex:isDrag?0:3,transition:(isDrag||isBeingResized)?"none":"all .15s, box-shadow .2s",
                          opacity:isDrag?0.15:1,userSelect:"none",WebkitUserSelect:"none",WebkitTouchCallout:"none"}}
                        className="tl-block">
                        {block.type==="reservation" && !block.isSchedule && <>
                          <div style={{display:"flex",alignItems:"center",gap:3,overflow:"hidden",whiteSpace:"nowrap"}}>
                            {isNaverCancelled && <span style={{fontSize:Math.max(6,blockFs-2),padding:"1px 3px",borderRadius:2,background:"#E6A700",color:"#fff",fontWeight:700,lineHeight:1,flexShrink:0}}>네이버취소</span>}
                            {isNaverPending && <span style={{fontSize:Math.max(6,blockFs-2),padding:"1px 3px",borderRadius:2,background:"#FF9800",color:"#fff",fontWeight:700,lineHeight:1,flexShrink:0,animation:"pendingBlink 1.5s infinite"}}>확정대기</span>}
                            {block.isNewCust && <span style={{fontSize:Math.max(6,blockFs-2),padding:"1px 3px",borderRadius:2,background:"#e57373",color:"#fff",fontWeight:700,lineHeight:1,flexShrink:0}}>신규</span>}
                            <span style={{fontWeight:600,color:isNaverCancelled?"#999":"#333",overflow:"hidden",textOverflow:"ellipsis",textDecoration:isNaverCancelled?"line-through":"none"}}>{block.custGender && <span style={{color:block.custGender==="M"?"#4a7cc8":"#e57373"}}>{block.custGender==="M"?"남":"여"}</span>} {block.custName}</span>
                          </div>
                          {block.selectedTags?.length>0 && <div style={{display:"flex",flexWrap:"wrap",gap:2,marginTop:1}}>
                            {block.selectedTags.slice(0,3).map(tid=>{const tg=tags.find(t=>t.id===tid);return tg?<span key={tid} style={{fontSize:Math.max(6,blockFs-2),padding:"0 3px",borderRadius:2,border:"1px solid "+(tg.color||"#7c7cc8"),background:tg.color?tg.color+"25":"#7c7cc815",color:"#333",fontWeight:600}}>{tg.name}</span>:null})}
                            {block.selectedTags.length>3 && <span style={{fontSize:Math.max(6,blockFs-2),color:"#999"}}>+{block.selectedTags.length-3}</span>}
                          </div>}
                          {block.selectedServices?.length>0 && <div style={{fontSize:Math.max(6,blockFs-2),color:"#333",fontWeight:600,marginTop:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>
                            {block.selectedServices.map(sid=>SVC_LIST.find(s=>s.id===sid)?.name).filter(Boolean).slice(0,2).join(", ")}
                            {block.selectedServices.length>2 && ` +${block.selectedServices.length-2}`}
                          </div>}
                        </>}
                        {block.type==="reservation" && block.isSchedule && <div style={{fontWeight:700,color:"#333",fontSize:blockFs+1}}>
                          {block.selectedTags?.map(tid=>{const tg=tags.find(t=>t.id===tid);return tg?.name}).filter(Boolean).join(", ")||"내부일정"}
                        </div>}
                        {block.type==="memo" && <div style={{color:"#ef5350",fontWeight:600}}><I name="fileText" size={10} color="#ef5350"/> 메모</div>}
                        {block.type==="clockin" && <div style={{color:"#666",fontWeight:600}}><I name="clock" size={10} color="#666"/> {staff?.dn||"출근"}</div>}
                        {block.type==="cleaning" && <div style={{color:"#5cb5c5",fontWeight:600}}><I name="sparkles" size={10} color="#5cb5c5"/> 청소</div>}
                        {block.memo && (() => { const clean = block.memo.split("\n").filter(l => !/^\[등록:|^\[수정:/.test(l.trim())).join("\n").trim(); return clean ? <div style={{color:"#555",marginTop:1,whiteSpace:"pre-line",wordBreak:"break-word"}}><I name="msgSq" size={10} color="#888"/> {clean}</div> : null; })()}
                        {/* Resize handle */}
                        {isEditable && <div className="resize-handle" onMouseDown={e=>handleResizeStart(block,e)} onTouchStart={e=>handleResizeStart(block,e)}
                          style={{position:"absolute",bottom:-8,left:0,right:0,height:24,cursor:"ns-resize",
                            display:"flex",alignItems:"flex-start",justifyContent:"center",opacity:0,transition:"opacity .15s",zIndex:3}}>
                          <div style={{width:24,height:4,borderRadius:2,background:color,marginTop:4}}/>
                        </div>}
                        {isBeingResized && <div style={{position:"absolute",bottom:2,right:4,fontSize:Math.max(6,blockFs-2),fontWeight:700,color,background:"#fff",padding:"0 3px",borderRadius:2}}>
                          {blockDur}분
                        </div>}
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })}
        </div>

        {/* Snap indicator inside scroll area */}
        {dragBlock && dragSnap && (() => {
          const snapY = timeToY(dragSnap.time);
          const snapH = Math.max((dragBlock.dur / timeUnit) * rowH, rowH * 2);
          const roomIdx = allRooms.findIndex(r => r.id === dragSnap.roomId);
          if (roomIdx < 0) return null;
          const snapLeft = timeLabelsW + roomIdx * colW + 2;
          return <div style={{position:"absolute",top:headerH+snapY,left:snapLeft,width:colW-4,height:snapH,
            background:"#7c7cc815",border:"1.5px solid #7c7cc860",borderRadius:8,pointerEvents:"none",zIndex:50,boxShadow:"0 2px 8px rgba(124,124,200,.2)"}}/>
        })()}
      </div>

      {/* Drag ghost - follows cursor */}
      {dragBlock && dragPos && <div style={{position:"fixed",
        left:scrollRef.current?.getBoundingClientRect().left+dragPos.x-50,
        top:scrollRef.current?.getBoundingClientRect().top+dragPos.y-15,
        width:colW-10,padding:"5px 8px",
        background:"#fff",color:"#333",borderRadius:8,fontSize:10,fontWeight:600,
        borderLeft:`3px solid ${BLOCK_COLORS[dragBlock.type]||"#7c7cc8"}`,
        boxShadow:"0 8px 24px rgba(0,0,0,.2)",pointerEvents:"none",zIndex:100,opacity:.95}}>
        <div style={{fontSize:9,color:"#7c7cc8",fontWeight:700}}>{dragBlock.time} → {dragSnap?.time||"?"}</div>
        <div>{dragBlock.custGender && <span style={{color:dragBlock.custGender==="M"?"#4a7cc8":"#e57373"}}>{dragBlock.custGender==="M"?"남":"여"}</span>} {dragBlock.custName}</div>
        <div style={{fontSize:8,color:"#999"}}>{allRooms.find(r=>r.id===dragSnap?.roomId)?.name||""}</div>
      </div>}

      {/* 이동/리사이즈 확인 팝업 */}
      {pendingChange && (() => {
        const { type, block, data: d, orig } = pendingChange;
        const name = block.custName || "일정";
        const desc = type === "move"
          ? `${name}: ${orig.time} → ${d.time}`
          : `${name}: ${orig.dur}분 → ${d.dur}분`;
        return <div className="ov" style={{zIndex:9998}} onClick={()=>_mc(cancelChange)}>
          <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:14,boxShadow:"0 12px 40px rgba(0,0,0,0.2)",padding:"20px 24px",
            fontFamily:"inherit",minWidth:260,maxWidth:340,textAlign:"center",animation:"slideUp .6s cubic-bezier(.22,1,.36,1)"}}>
            <div style={{fontSize:14,fontWeight:700,marginBottom:6}}>{type==="move"?"예약 이동":"시간 변경"}</div>
            <div style={{fontSize:13,color:"#555",marginBottom:16}}>{desc}</div>
            <div style={{display:"flex",gap:10,justifyContent:"center"}}>
              <button onClick={()=>_mc(cancelChange)} style={{flex:1,padding:"10px 0",fontSize:13,fontWeight:600,borderRadius:8,border:"1px solid #ddd",background:"#f5f5f5",color:"#666",cursor:"pointer",fontFamily:"inherit"}}>취소</button>
              <button onClick={confirmChange} style={{flex:1,padding:"10px 0",fontSize:13,fontWeight:700,borderRadius:8,border:"none",background:"#7c7cc8",color:"#fff",cursor:"pointer",fontFamily:"inherit"}}>완료</button>
            </div>
          </div>
        </div>;
      })()}

      {showModal && <TimelineModal item={modalData} onSave={handleSave} onDelete={handleDelete} onDeleteRequest={handleDeleteRequest} onClose={()=>_mc(()=>{setShowModal(false);setModalData(null)})} selBranch={userBranches[0]} userBranches={userBranches} data={data} setData={setData} setPage={setPage}/>}

      {/* Settings dropdown (fixed, outside overflow) */}
      {showSettings && <>{(() => {
        const handleTouchStart = e => {
          const el = e.currentTarget;
          el.dataset.sy = e.touches[0].clientY;
          el.dataset.dragging = "1";
          el.style.transition = "none";
        };
        const handleTouchMove = e => {
          const el = e.currentTarget;
          if (el.dataset.dragging !== "1") return;
          const dy = Math.max(0, e.touches[0].clientY - Number(el.dataset.sy||0));
          el.style.transform = `translateY(${dy}px)`;
          // fade overlay
          const ov = el.previousElementSibling;
          if (ov) ov.style.opacity = Math.max(0, 1 - dy / 300);
        };
        const handleTouchEnd = e => {
          const el = e.currentTarget;
          el.dataset.dragging = "0";
          const dy = e.changedTouches[0].clientY - Number(el.dataset.sy||0);
          if (dy > 80) {
            el.style.transition = "transform .3s cubic-bezier(.4,0,1,1)";
            el.style.transform = `translateY(${el.offsetHeight}px)`;
            const ov = el.previousElementSibling;
            if (ov) { ov.style.transition = "opacity .3s"; ov.style.opacity = "0"; }
            setTimeout(() => setShowSettings(false), 300);
          } else {
            el.style.transition = "transform .25s cubic-bezier(.22,1,.36,1)";
            el.style.transform = "translateY(0)";
            const ov = el.previousElementSibling;
            if (ov) { ov.style.transition = "opacity .25s"; ov.style.opacity = "1"; }
          }
        };
        return <>
        <div style={{position:"fixed",inset:0,zIndex:99,background:"rgba(0,0,0,.3)",animation:"ovFadeIn .25s"}} onClick={()=>{
          const p=document.querySelector('[data-settings-panel]');
          const o=document.querySelector('[data-settings-ov]');
          if(p){p.style.transition='transform .3s ease-out';p.style.transform='translateY(100%)';}
          if(o){o.style.transition='opacity .3s';o.style.opacity='0';}
          setTimeout(()=>setShowSettings(false),300);
        }} data-settings-ov/>
        <div
          data-settings-panel
          onTouchStart={handleTouchStart}
          onTouchMove={handleTouchMove}
          onTouchEnd={handleTouchEnd}
          style={{position:"fixed",bottom:0,left:0,right:0,
          background:"#fff",borderRadius:"16px 16px 0 0",padding:"20px 20px 32px",boxShadow:"0 -8px 32px rgba(0,0,0,.15)",zIndex:100,
          maxHeight:"80vh",overflowY:"auto",animation:"bottomSheet .4s cubic-bezier(.22,1,.36,1)",willChange:"transform"}}>
          <div style={{width:36,height:4,borderRadius:2,background:"#ddd",margin:"0 auto 16px",cursor:"grab"}}/>
          <div style={{fontSize:14,fontWeight:700,color:"#333",marginBottom:12}}><I name="settings" size={14}/> 타임라인 설정</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          {[
            {label:"줄간격",val:rowH,dec:()=>setRowH(h=>Math.max(6,h-2)),inc:()=>setRowH(h=>Math.min(30,h+2))},
            {label:"열너비",val:colW,dec:()=>setColW(w=>Math.max(80,w-20)),inc:()=>setColW(w=>Math.min(300,w+20))},
            {label:"글자크기",val:blockFs,dec:()=>setBlockFs(f=>Math.max(6,f-1)),inc:()=>setBlockFs(f=>Math.min(16,f+1))},
            {label:"불투명도",val:blockOp,suffix:"%",dec:()=>setBlockOp(o=>Math.max(10,o-10)),inc:()=>setBlockOp(o=>Math.min(100,o+10))},
            {label:"시작시간",val:startHour,suffix:"시",dec:()=>setStartHour(h=>Math.max(0,h-1)),inc:()=>setStartHour(h=>Math.min(endHour-1,h+1))},
            {label:"종료시간",val:endHour,suffix:"시",dec:()=>setEndHour(h=>Math.max(startHour+1,h-1)),inc:()=>setEndHour(h=>Math.min(24,h+1))},
          ].map(r=><div key={r.label} style={{background:"#f8f8fc",borderRadius:10,padding:"10px 12px",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
            <span style={{fontSize:12,color:"#555",fontWeight:600}}>{r.label}</span>
            <div style={{display:"flex",alignItems:"center",gap:6}}>
              <button onClick={r.dec} style={{width:32,height:32,border:"1px solid #ddd",borderRadius:8,background:"#fff",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",padding:0}}><I name="minus" size={16} color="#555"/></button>
              <span style={{fontSize:13,color:"#7c7cc8",fontWeight:700,width:36,textAlign:"center"}}>{r.val}{r.suffix||""}</span>
              <button onClick={r.inc} style={{width:32,height:32,border:"1px solid #ddd",borderRadius:8,background:"#fff",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",padding:0}}><I name="plus" size={16} color="#555"/></button>
            </div>
          </div>)}
          </div>
          <div style={{background:"#f8f8fc",borderRadius:10,padding:"10px 12px",marginTop:8,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
            <span style={{fontSize:12,color:"#555",fontWeight:600}}>시간단위</span>
            <div style={{display:"flex",gap:4}}>
              {[5,10,15,30,60].map(u=><button key={u} onClick={()=>setTimeUnit(u)}
                style={{padding:"6px 12px",fontSize:12,border:"1px solid #ddd",borderRadius:8,background:timeUnit===u?"#7c7cc8":"#fff",
                  color:timeUnit===u?"#fff":"#888",fontWeight:timeUnit===u?700:400,cursor:"pointer"}}>{u}분</button>)}
            </div>
          </div>
          <div style={{marginTop:8}}>
            <span style={{fontSize:12,color:"#555",fontWeight:600,display:"block",marginBottom:6}}>예약상태 색상</span>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}}>
              {STATUS_KEYS.map(k=><div key={k} style={{background:"#f8f8fc",borderRadius:10,padding:"8px 12px",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                <span style={{fontSize:12,fontWeight:600,color:statusClr[k]}}>{STATUS_LABEL[k]}</span>
                <div style={{display:"flex",alignItems:"center",gap:4}}>
                  <input type="color" value={statusClr[k]||STATUS_CLR_DEFAULT[k]} onChange={e=>setStatusClr(k,e.target.value)}
                    style={{width:32,height:28,border:"1px solid #ddd",borderRadius:6,cursor:"pointer",padding:1}}/>
                  <EyeDrop onPick={c=>setStatusClr(k,c)} size={28}/>
                </div>
              </div>)}
            </div>
          </div>
        </div>
      </>;})()}</>}

      {/* 알람 팝업 */}
      {alarmPopup && <div className="ov" onClick={()=>_mc(()=>setAlarmPopup(null))} style={{zIndex:9999}}>
        <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:12,padding:0,width:"90%",maxWidth:400,
          boxShadow:"0 16px 48px rgba(0,0,0,.25)",animation:"slideUp .6s cubic-bezier(.22,1,.36,1)",overflow:"hidden"}}>
          <div style={{background:"linear-gradient(135deg,#FF6B00,#FF9800)",padding:"20px 24px",color:"#fff",textAlign:"center"}}>
            <div style={{fontSize:40,marginBottom:8}}><I name="bell" size={16} color="#FF9800"/></div>
            <div style={{fontSize:18,fontWeight:800}}>알람</div>
            <div style={{fontSize:14,marginTop:4,opacity:.9}}>{alarmPopup.time}</div>
          </div>
          <div style={{padding:"20px 24px"}}>
            {alarmPopup.tags.length > 0 && <div style={{display:"flex",flexWrap:"wrap",gap:4,marginBottom:12}}>
              {alarmPopup.tags.map((t,i)=><span key={i} style={{fontSize:11,padding:"3px 10px",borderRadius:12,background:"#FF6B0015",color:"#FF6B00",fontWeight:600}}>{t}</span>)}
            </div>}
            {alarmPopup.memo ? <div style={{fontSize:14,color:"#333",lineHeight:1.8,whiteSpace:"pre-wrap",
              background:"#FFF8F0",border:"1px solid #FFE0B2",borderRadius:8,padding:16}}>{alarmPopup.memo}</div>
              : <div style={{fontSize:13,color:"#999",textAlign:"center",padding:12}}>메모 내용 없음</div>}
          </div>
          <div style={{padding:"0 24px 20px",textAlign:"center"}}>
            <button className="btn-p" onClick={()=>_mc(()=>setAlarmPopup(null))}
              style={{width:"100%",padding:12,fontSize:14,background:"#FF6B00",borderRadius:8}}>확인</button>
          </div>
        </div>
      </div>}

      {/* 반복일정 삭제 옵션 팝업 */}
      {deletePopup && <div className="ov" onClick={()=>_mc(()=>setDeletePopup(null))} style={{zIndex:9998}}>
        <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:12,width:"90%",maxWidth:340,
          boxShadow:"0 16px 48px rgba(0,0,0,.25)",animation:"slideUp .6s cubic-bezier(.22,1,.36,1)",overflow:"hidden"}}>
          <div style={{padding:"20px 24px 12px",borderBottom:"1px solid #eee"}}>
            <div style={{fontSize:14,fontWeight:700,color:"#333"}}>반복 일정 삭제</div>
            <div style={{fontSize:12,color:"#888",marginTop:4}}>이 일정은 반복 등록된 일정입니다.</div>
          </div>
          <div style={{padding:"8px 0"}}>
            {[
              {mode:"this", label:"이 일정만 삭제", desc:"선택한 날짜의 일정만 삭제합니다"},
              {mode:"future", label:"이후 모든 일정을 삭제", desc:`${deletePopup.date} 이후 반복 일정을 삭제합니다`},
              {mode:"all", label:"모든 일정을 삭제", desc:"이 반복 일정을 모두 삭제합니다"},
            ].map(opt => (
              <button key={opt.mode} onClick={()=>handleDeleteConfirm(opt.mode)}
                style={{width:"100%",padding:"12px 24px",border:"none",background:"transparent",cursor:"pointer",
                  textAlign:"left",fontFamily:"inherit",transition:"background .1s",display:"block"}}
                onMouseOver={e=>e.currentTarget.style.background="#f5f5f5"}
                onMouseOut={e=>e.currentTarget.style.background="transparent"}>
                <div style={{fontSize:13,fontWeight:600,color:opt.mode==="all"?"#e57373":"#333"}}>{opt.label}</div>
                <div style={{fontSize:10,color:"#999",marginTop:2}}>{opt.desc}</div>
              </button>
            ))}
          </div>
          <div style={{padding:"8px 24px 16px"}}>
            <button onClick={()=>_mc(()=>setDeletePopup(null))}
              style={{width:"100%",padding:"10px",fontSize:12,border:"1px solid #ddd",borderRadius:6,background:"#fff",
                color:"#888",cursor:"pointer",fontFamily:"inherit"}}>취소</button>
          </div>
        </div>
      </div>}
    </div>
  );
}

function TimelineModal({ item, onSave, onDelete, onDeleteRequest, onClose, selBranch, userBranches, data, setData, setPage }) {
  const SVC_LIST = (data?.services || []).slice().sort((a,b)=>(a.sort||0)-(b.sort||0));
  const PROD_LIST = (data?.products || []);
  const CATS = (data?.categories || []).slice().sort((a,b)=>(a.sort||0)-(b.sort||0));
  const isNew = !item?.id || item?.roomId;
  const isReadOnly = item?.readOnly || false;
  const branchId = item?.bid || selBranch;
  const branchRooms = (data.rooms||[]).filter(r=>r.branch_id===branchId);
  const branchStaff = (data.staff||[]).filter(s=>s.bid===branchId);
  const [showSaleForm, setShowSaleForm] = useState(false);
  const [isSchedule, setIsSchedule] = useState(item?.isSchedule || false);
  const modalRef = useRef(null);
  const tags = (data?.serviceTags || []).slice().sort((a,b)=>a.sort-b.sort);
  const visibleTags = tags.filter(tag => tag.useYn !== false && (isSchedule ? tag.scheduleYn === "Y" : tag.scheduleYn !== "Y"));

  const BASE_DUR = 5; // 기본 예약시간 5분
  const isNaverItem = !!(item?.reservationId);
  const itemDur = item?.dur || (isNaverItem ? 60 : BASE_DUR);
  const defaultEnd = () => { const t = item?.time||"10:00"; const [h,m] = t.split(":").map(Number); const em = m + itemDur; return `${String(h+Math.floor(em/60)).padStart(2,"0")}:${String(em%60).padStart(2,"0")}`; };
  const addMin = (t, mins) => { const [h,m] = t.split(":").map(Number); const em = m + mins; return `${String(h+Math.floor(em/60)).padStart(2,"0")}:${String(em%60).padStart(2,"0")}`; };
  const [f, setF] = useState(isNew && !item?.id ? {
    id: uid(), bid: branchId, roomId: item?.roomId||branchRooms[0]?.id, custId:null, custName:"", custPhone:"", custGender:"",
    staffId: branchStaff[0]?.id, serviceId: (data.services||[])[0]?.id, date: item?.date||todayStr(), time: item?.time||"10:00",
    endDate: item?.date||todayStr(), endTime: defaultEnd(),
    dur: itemDur, status:"confirmed", memo:"", type:"reservation",
    selectedTags: [], isNewCust: true, tsLog: [],
    selectedServices: [], repeat: "none", repeatUntil: ""
  } : (() => {
    const existingTs = item?.tsLog || [];
    const memoLines = (item?.memo || "").split("\n");
    const extractedTs = memoLines.filter(l => /^\[등록:|^\[수정:/.test(l.trim()));
    const cleanMemo = memoLines.filter(l => !/^\[등록:|^\[수정:/.test(l.trim())).join("\n").trim();
    const mergedTs = existingTs.length > 0 ? existingTs : extractedTs;
    return {...item, memo: cleanMemo, custGender: item?.custGender || "", endDate: item?.date||todayStr(), endTime: defaultEnd(),
      selectedTags: item?.selectedTags || [], isNewCust: false, tsLog: mergedTs,
      selectedServices: item?.selectedServices || [],
      repeat: item?.repeat || "none", repeatUntil: item?.repeatUntil || ""};
  })());
  const set = (k,v) => setF(p=>({...p,[k]:v}));

  // 고객 검색
  const [custSearch, setCustSearch] = useState("");
  const [showCustDropdown, setShowCustDropdown] = useState(false);
  const [custResults, setCustResults] = useState([]);
  // 디바운스 검색 (300ms, 2글자 이상)
  useEffect(() => {
    if (custSearch.length < 2) { setCustResults([]); return; }
    const timer = setTimeout(() => {
      const q = custSearch.toLowerCase();
      const results = (data?.customers||[]).filter(c =>
        c.name.toLowerCase().includes(q) || c.phone.includes(q)
      ).slice(0,50);
      setCustResults(results);
    }, 300);
    return () => clearTimeout(timer);
  }, [custSearch]);
  const selectCust = (c) => { setF(p=>({...p, custId:c.id, custName:c.name, custPhone:c.phone, custGender:c.gender, isNewCust:false})); setCustSearch(""); setShowCustDropdown(false); };

  // 태그 선택 → 기본 5분 + 태그 소요시간 합산 → 종료시간 자동 계산
  const toggleTag = (tagId) => {
    setF(p => {
      const newTags = p.selectedTags.includes(tagId) ? p.selectedTags.filter(t=>t!==tagId) : [...p.selectedTags, tagId];
      const tagSum = newTags.reduce((sum, tid) => {
        const tag = tags.find(t => t.id === tid);
        return sum + (tag?.dur || 0);
      }, 0);
      const svcSum = (p.selectedServices||[]).reduce((sum, sid) => sum + (SVC_LIST.find(s=>s.id===sid)?.dur||0), 0);
      const dur = (tagSum + svcSum) || itemDur;
      const [sh, sm] = p.time.split(":").map(Number);
      const endMin = sh * 60 + sm + dur;
      const endTime = `${String(Math.min(22, Math.floor(endMin/60))).padStart(2,"0")}:${String(endMin%60).padStart(2,"0")}`;
      return { ...p, selectedTags: newTags, dur, endTime };
    });
  };

  // 선택된 태그 소요시간 합계
  const tagDurTotal = (f.selectedTags||[]).reduce((sum, tid) => {
    const tag = tags.find(t => t.id === tid);
    return sum + (tag?.dur || 0);
  }, 0);

  // 선택된 시술 소요시간 합계
  const svcDurTotal = (f.selectedServices||[]).reduce((sum, sid) => {
    const svc = SVC_LIST.find(s => s.id === sid);
    return sum + (svc?.dur || 0);
  }, 0);

  // 시술 선택 토글
  const toggleService = (svcId) => {
    setF(p => {
      const newSvcs = p.selectedServices?.includes(svcId) ? p.selectedServices.filter(s=>s!==svcId) : [...(p.selectedServices||[]), svcId];
      const svcSum = newSvcs.reduce((sum, sid) => sum + (SVC_LIST.find(s=>s.id===sid)?.dur||0), 0);
      const tagSum = (p.selectedTags||[]).reduce((sum, tid) => sum + (tags.find(t=>t.id===tid)?.dur||0), 0);
      const dur = (svcSum + tagSum) || itemDur;
      const [sh, sm] = p.time.split(":").map(Number);
      const endMin = sh * 60 + sm + dur;
      const endTime = `${String(Math.min(22, Math.floor(endMin/60))).padStart(2,"0")}:${String(endMin%60).padStart(2,"0")}`;
      return { ...p, selectedServices: newSvcs, dur, endTime };
    });
  };

  // 시술 선택 패널 열기
  const [showSvcPicker, setShowSvcPicker] = useState(false);

  // 시간으로 dur 자동 계산
  const calcDur = (startT, endT) => {
    const [sh,sm] = startT.split(":").map(Number);
    const [eh,em] = endT.split(":").map(Number);
    return (eh*60+em) - (sh*60+sm);
  };

  const handleSaleSubmit = (saleData) => {
    const existingSale = (data.sales||[]).find(s => s.reservationId === f.id);
    if (existingSale) {
      // 기존 매출 수정
      const updated = {...saleData, id:existingSale.id, reservationId:f.id};
      setData(prev => ({ ...prev, sales: prev.sales.map(s=>s.id===existingSale.id ? updated : s) }));
      sb.update("sales", existingSale.id, toDb("sales", updated)).catch(console.error);
    } else {
      // 신규 매출 등록
      const newSale = {...saleData, reservationId: f.id};
      if (setData) setData(prev => ({ ...prev, sales: [...prev.sales, newSale] }));
      sb.insert("sales", toDb("sales", newSale)).catch(console.error);
    }
    // 매출 등록 시 예약 상태를 "완료"로 변경
    if (f.id) {
      setData(prev => ({ ...prev, reservations: prev.reservations.map(r => r.id === f.id ? {...r, status:"completed"} : r) }));
      sb.update("reservations", f.id, {status:"completed"}).catch(console.error);
    }
    setShowSaleForm(false);
    if (setPage) { onClose(); setPage("sales"); }
  };

  // 기존 매출 확인
  const existingSale = (data.sales||[]).find(s => s.reservationId === f.id);

  if (showSaleForm) {
    const saleReservation = existingSale
      ? {...f, saleMemo:existingSale.memo||"", _existingSale:existingSale}
      : f;
    return <DetailedSaleForm reservation={saleReservation} branchId={branchId} onSubmit={handleSaleSubmit} onClose={() => setShowSaleForm(false)} data={data} setData={setData} />;
  }

  return (
    <div className="ov" onClick={onClose} style={{alignItems:"flex-start",padding:"20px 16px",overflow:"auto",WebkitOverflowScrolling:"touch"}}>
      <div ref={modalRef} className="modal-res" onClick={e=>e.stopPropagation()} style={{background:"#fff",
        borderRadius:12,border:"1px solid #e0e0e0",
        width:"92%",maxWidth:500,margin:"0 auto",
        animation:"slideUp .4s cubic-bezier(.22,1,.36,1)",
        boxShadow:"0 8px 40px rgba(0,0,0,.18)"}}>
        {/* ═══ Chrome-style Tabs ═══ */}
        <div style={{display:"flex",alignItems:"flex-end",gap:0,padding:"0",background:"#f5f5f5",borderRadius:"12px 12px 0 0",borderBottom:"1px solid #e0e0e0",overflow:"hidden"}}>
          {/* 예약 탭 */}
          <button onClick={()=>{setIsSchedule(false);setF(p=>({...p,isSchedule:false,selectedTags:[],type:"reservation"}));if(modalRef.current)modalRef.current.scrollTop=0}}
            style={{flex:1,padding:"12px 16px",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:"inherit",
              border:"none",borderBottom:isSchedule?"none":"2px solid #7c7cc8",
              background:isSchedule?"transparent":"#fff",color:isSchedule?"#999":"#7c7cc8",
              transition:"all .15s"}}>
            <I name="calendar" size={12}/> 예약
          </button>
          {/* 내부일정 탭 */}
          <button onClick={()=>{setIsSchedule(true);setF(p=>({...p,isSchedule:true,selectedTags:[],type:"reservation"}));if(modalRef.current)modalRef.current.scrollTop=0}}
            style={{flex:1,padding:"12px 16px",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:"inherit",
              border:"none",borderBottom:isSchedule?"2px solid #e17055":"none",
              background:isSchedule?"#fff":"transparent",color:isSchedule?"#e17055":"#999",
              transition:"all .15s"}}>
            <I name="clipboard" size={12}/> 내부일정
          </button>
          {/* 닫기 */}
          <button onClick={onClose} style={{padding:"8px 14px",background:"transparent",border:"none",color:"#999",cursor:"pointer",
            fontSize:16,fontFamily:"inherit",borderRadius:4}}
            onMouseOver={e=>e.currentTarget.style.color="#e57373"} onMouseOut={e=>e.currentTarget.style.color="#999"}><I name="x" size={16}/></button>
        </div>

        <div style={{padding:"16px 20px"}} className="form-col">

          {/* ═══ 네이버 예약 상태 배너 ═══ */}
          {f.status === "naver_cancelled" && <div style={{background:"#FFF8E1",border:"1.5px solid #E6A700",borderRadius:6,padding:"8px 12px",marginBottom:12,display:"flex",alignItems:"center",gap:8}}>
            <span style={{fontSize:16}}><I name="alert" size={16} color="#E65100"/></span>
            <span style={{fontSize:13,fontWeight:700,color:"#E6A700"}}>네이버 취소 예약</span>
            {f.reservationId && <span style={{fontSize:11,color:"#999",marginLeft:"auto"}}>#{f.reservationId}</span>}
          </div>}
          {f.status === "pending" && <div style={{background:"#FFF3E0",border:"1.5px solid #FF9800",borderRadius:6,padding:"8px 12px",marginBottom:12,display:"flex",alignItems:"center",gap:8,flexWrap:"wrap",animation:"naverBlink 1.5s infinite"}}>
            <span style={{fontSize:16}}><I name="bell" size={16} color="#E65100"/></span>
            <span style={{fontSize:13,fontWeight:700,color:"#E65100"}}>네이버 확정대기</span>
            <div style={{marginLeft:"auto",display:"flex",gap:6}}>
              <button onClick={()=>{if(!window.confirm("이 예약을 취소 처리하시겠습니까?")) return; const updated={...f,status:"naver_cancelled"}; onSave(updated); onClose();}}
                style={{fontSize:11,color:"#fff",fontWeight:700,background:"#E65100",padding:"5px 12px",borderRadius:6,border:"none",cursor:"pointer",fontFamily:"inherit"}}>취소처리</button>
              {(() => {
              const br = (data.branchSettings||data.branches||[]).find(b=>b.id===branchId);
              const bizId = br?.naverBizId;
              return bizId ? <a href={`https://partner.booking.naver.com/bizes/${bizId}/booking-list-view`} target="_blank" rel="noopener noreferrer"
                onClick={e=>e.stopPropagation()}
                style={{fontSize:11,color:"#fff",fontWeight:700,background:"#03C75A",padding:"5px 12px",borderRadius:6,textDecoration:"none",display:"inline-flex",alignItems:"center",gap:3}}>네이버 확정 <I name="chevR" size={11} color="#fff"/></a> : null;
              })()}
            </div>
          </div>}

          {/* ═══ 내부일정 모드 ═══ */}
          {isSchedule && <>
            <div>
              <div className="res-time-row" style={{display:"flex",gap:3,alignItems:"center",flexWrap:"nowrap",overflowX:"auto"}}>
                <DatePick value={f.date} onChange={v=>set("date",v)} style={{flex:"1 1 0",minWidth:0}}/>
                <select className="inp" style={{flex:"0 0 78px",fontSize:12,padding:"5px 8px"}} value={f.time} onChange={e=>{const nt=e.target.value;set("time",nt);set("endTime",addMin(nt,f.dur))}}>
                  {TIMES.filter(t=>{const h=parseInt(t);return h>=8&&h<=21}).map(t=><option key={t} value={t}>{t}</option>)}
                </select>
                <span style={{color:"#999",fontSize:10,flexShrink:0}}>~</span>
                <select className="inp" style={{flex:"0 0 78px",fontSize:12,padding:"5px 8px"}} value={f.endTime} onChange={e=>{set("endTime",e.target.value);set("dur",calcDur(f.time,e.target.value))}}>
                  {TIMES.filter(t=>{const h=parseInt(t);return h>=8&&h<=22}).map(t=><option key={t} value={t}>{t}</option>)}
                </select>
                <span className="res-room-sep" style={{width:1,height:18,background:"#e0e0e0",flexShrink:0}}/>
                <select className="inp res-room-sel" style={{flex:"1 1 0",minWidth:0,fontSize:12,padding:"5px 8px"}} value={`${f.roomId}|${f.staffId}`} onChange={e=>{const [r,s]=e.target.value.split("|");set("roomId",r);set("staffId",s)}}>
                  {branchRooms.map(rm => branchStaff.map(st =>
                    <option key={rm.id+st.id} value={`${rm.id}|${st.id}`}>[{(data.branches||[]).find(b=>b.id===branchId)?.short}] {rm.name}-{st.dn}</option>
                  ))}
                </select>
              </div>
            </div>
            {/* 반복 설정 */}
            <div style={{marginTop:8}}>
              <label style={{fontSize:11,fontWeight:600,color:"#888",marginBottom:5,display:"block"}}>반복 설정</label>
              <div style={{display:"flex",gap:6,alignItems:"center",flexWrap:"wrap"}}>
                {[{v:"none",l:"반복 안함"},{v:"daily",l:"매일 같은시간"},{v:"weekly",l:"매주 같은요일·시간"},{v:"monthly",l:"매월 같은일·시간"}].map(o => (
                  <button key={o.v} onClick={()=>set("repeat",o.v)}
                    style={{padding:"5px 12px",fontSize:11,fontWeight:f.repeat===o.v?700:400,borderRadius:6,cursor:"pointer",fontFamily:"inherit",
                      border:`1px solid ${f.repeat===o.v?"#e17055":"#d0d0d0"}`,
                      background:f.repeat===o.v?"#e1705520":"transparent",
                      color:f.repeat===o.v?"#e17055":"#999",transition:"all .15s"}}>{o.l}</button>
                ))}
              </div>
              {f.repeat !== "none" && <div style={{display:"flex",gap:6,alignItems:"center",marginTop:6}}>
                <span style={{fontSize:11,color:"#888"}}>반복 종료일:</span>
                <DatePick value={f.repeatUntil} onChange={v=>set("repeatUntil",v)} min={f.date} style={{flex:"1 1 100px",minWidth:90}}/>
                {f.repeat === "daily" && <span style={{fontSize:10,color:"#e17055"}}>매일 {f.time}에 반복</span>}
                {f.repeat === "weekly" && <span style={{fontSize:10,color:"#e17055"}}>매주 {["일","월","화","수","목","금","토"][new Date(f.date+"T00:00").getDay()]}요일 {f.time}에 반복</span>}
                {f.repeat === "monthly" && <span style={{fontSize:10,color:"#e17055"}}>매월 {new Date(f.date+"T00:00").getDate()}일 {f.time}에 반복</span>}
              </div>}
            </div>
            <FLD label={`내부일정 항목${tagDurTotal > 0 ? ` — 소요시간: ${tagDurTotal}분` : ""}`}>
              <div style={{display:"flex",flexWrap:"wrap",gap:4,padding:8,background:"#fff8f6",borderRadius:8,border:"1px dashed #e17055"}}>
                {visibleTags.length > 0 ? visibleTags.map(tag => {
                  const sel = f.selectedTags?.includes(tag.id);
                  const hasColor = tag.color && tag.color !== "";
                  const bgClr = hasColor ? tag.color : "#e17055";
                  return <button key={tag.id} onClick={()=>toggleTag(tag.id)}
                    style={{padding:"3px 8px",fontSize:11,fontWeight:600,borderRadius:3,cursor:"pointer",fontFamily:"inherit",transition:"all .1s",
                      border:sel?"1px solid "+bgClr:"1px solid #d0d0d0",
                      background:sel?bgClr+"70":"#e8e8e8",
                      color:sel?"#333":"#aaa",display:"inline-flex",alignItems:"center",gap:3,lineHeight:1.3}}>
                    {hasColor && <span style={{width:6,height:6,borderRadius:1,background:bgClr,flexShrink:0,opacity:sel?1:0.4}}/>}
                    {tag.name}
                    {tag.dur > 0 && <span style={{fontSize:9,opacity:0.6}}>({tag.dur}분)</span>}
                  </button>;
                }) : <span style={{fontSize:11,color:"#999",padding:8}}>서비스태그관리에서 내부일정(Y) 항목을 등록하세요</span>}
              </div>
              {(f.selectedTags||[]).length > 0 && tagDurTotal>0 && <div style={{marginTop:4,fontSize:10,color:"#e17055",fontWeight:700,textAlign:"right"}}>합산 {tagDurTotal}분</div>}
            </FLD>
          </>}

          {/* ═══ 예약 모드 ═══ */}
          {!isSchedule && <>
            {/* 고객 검색 */}
            <div>
              <div style={{position:"relative"}}>
                <div style={{display:"flex",gap:6}}>
                  <input className="inp" style={{flex:1}} value={custSearch} onChange={e=>{setCustSearch(e.target.value);setShowCustDropdown(true)}}
                    placeholder="고객명, 전화번호, 차량번호 (2글자 이상)" onFocus={()=>setShowCustDropdown(true)}/>
                  <button className="btn-s btn-sm" onClick={()=>setShowCustDropdown(!showCustDropdown)}><I name="search" size={14}/></button>
                </div>
                {showCustDropdown && custSearch.length >= 2 && <div style={{position:"absolute",top:"100%",left:0,right:0,background:"#fff",border:"1px solid #d0d0d0",borderRadius:8,maxHeight:220,overflow:"auto",zIndex:10,marginTop:4,boxShadow:"0 8px 24px rgba(0,0,0,.12)"}}>
                  {custResults.map(c=><div key={c.id} onClick={()=>{selectCust(c);setF(p=>({...p,isNewCust:false}))}}
                    style={{padding:"8px 12px",cursor:"pointer",borderBottom:"1px solid #e0e0e030",display:"flex",gap:8,alignItems:"center",fontSize:12}}
                    onMouseOver={e=>e.currentTarget.style.background="#f0f0f0"} onMouseOut={e=>e.currentTarget.style.background="transparent"}>
                    <span className="badge" style={{background:c.gender==="M"?"#e0edf5":c.gender==="F"?"#fce8e8":"#f0f0f0",color:c.gender==="M"?"#7c7cc8":c.gender==="F"?"#e57373":"#999",fontSize:9}}>{c.gender==="M"?"남":c.gender==="F"?"여":"-"}</span>
                    <span style={{fontWeight:600}}>{c.name}</span>
                    <span style={{color:"#888"}}>{c.phone}</span>
                  </div>)}
                  {custResults.length===0 && <div style={{padding:"10px 12px",fontSize:11,color:"#999",textAlign:"center"}}>검색결과 없음</div>}
                  <div onClick={()=>{setF(p=>({...p,isNewCust:true,custId:null,custName:custSearch.replace(/[0-9\-]/g,"").trim(),custPhone:custSearch.replace(/[^0-9]/g,"")}));setCustSearch("");setShowCustDropdown(false)}}
                    style={{padding:"10px 12px",cursor:"pointer",display:"flex",gap:8,alignItems:"center",fontSize:12,
                      background:"#d0d0d020",borderTop:"1px solid #e0e0e0",color:"#e57373",fontWeight:700}}
                    onMouseOver={e=>e.currentTarget.style.background="#d0d0d040"} onMouseOut={e=>e.currentTarget.style.background="#d0d0d020"}>
                    <I name="plus" size={14}/> 신규고객으로 등록 {custSearch && <span style={{fontWeight:400,color:"#888"}}>"{custSearch}"</span>}
                  </div>
                </div>}
              </div>
            </div>

            {/* 고객 정보 */}
            <div className="cust-row" style={{display:"grid",gridTemplateColumns:"1fr 1fr 60px",gap:8}}>
              <div><input className="inp" value={f.custName} onChange={e=>set("custName",e.target.value)} placeholder="고객명"
                style={f.isNewCust?{borderColor:"#e57373",background:"#d0d0d008"}:{}}/></div>
              <div><input className="inp" value={f.custPhone} onChange={e=>set("custPhone",e.target.value)} placeholder="010"
                style={f.isNewCust?{borderColor:"#e57373",background:"#d0d0d008"}:{}}/></div>
              <div>
                <div style={{display:"flex",gap:1,height:34}}>
                  <button onClick={()=>set("custGender",f.custGender==="F"?"":"F")} style={{flex:1,fontSize:11,fontWeight:700,border:"1px solid #e57373",borderRadius:"4px 0 0 4px",cursor:"pointer",fontFamily:"inherit",padding:0,
                    background:f.custGender==="F"?"#e57373":"transparent",color:f.custGender==="F"?"#fff":"#e57373"}}>여</button>
                  <button onClick={()=>set("custGender",f.custGender==="M"?"":"M")} style={{flex:1,fontSize:11,fontWeight:700,border:"1px solid #7c7cc8",borderRadius:"0 4px 4px 0",cursor:"pointer",fontFamily:"inherit",padding:0,
                    background:f.custGender==="M"?"#7c7cc8":"transparent",color:f.custGender==="M"?"#fff":"#7c7cc8"}}>남</button>
                </div>
              </div>
            </div>

            {/* 예약기간 + 장소/담당자 */}
            <div>
              <div className="res-time-row" style={{display:"flex",gap:3,alignItems:"center",flexWrap:"nowrap",overflowX:"auto"}}>
                <DatePick value={f.date} onChange={v=>set("date",v)} style={{flex:"1 1 0",minWidth:0}}/>
                <select className="inp" style={{flex:"0 0 78px",fontSize:12,padding:"5px 8px"}} value={f.time} onChange={e=>{const nt=e.target.value;set("time",nt);set("endTime",addMin(nt,f.dur))}}>
                  {TIMES.filter(t=>{const h=parseInt(t);return h>=8&&h<=21}).map(t=><option key={t} value={t}>{t}</option>)}
                </select>
                <span style={{color:"#999",fontSize:10,flexShrink:0}}>~</span>
                <select className="inp" style={{flex:"0 0 78px",fontSize:12,padding:"5px 8px"}} value={f.endTime} onChange={e=>{set("endTime",e.target.value);set("dur",calcDur(f.time,e.target.value))}}>
                  {TIMES.filter(t=>{const h=parseInt(t);return h>=8&&h<=22}).map(t=><option key={t} value={t}>{t}</option>)}
                </select>
                <span className="res-room-sep" style={{width:1,height:18,background:"#e0e0e0",flexShrink:0}}/>
                <select className="inp res-room-sel" style={{flex:"1 1 0",minWidth:0,fontSize:12,padding:"5px 8px"}} value={`${f.roomId}|${f.staffId}`} onChange={e=>{const [r,s]=e.target.value.split("|");set("roomId",r);set("staffId",s)}}>
                  {branchRooms.map(rm => branchStaff.map(st =>
                    <option key={rm.id+st.id} value={`${rm.id}|${st.id}`}>[{(data.branches||[]).find(b=>b.id===branchId)?.short}] {rm.name}-{st.dn}</option>
                  ))}
                </select>
              </div>
            </div>

            {/* 시술 상품 선택 */}
            {(() => {
              const svcPriceTotal = (f.selectedServices||[]).reduce((sum, sid) => {
                const svc = SVC_LIST.find(s=>s.id===sid);
                return sum + (svc ? (f.custGender==="M"?svc.priceM:svc.priceF) : 0);
              }, 0);
              return <div>
              <button onClick={()=>setShowSvcPicker(!showSvcPicker)}
                style={{width:"100%",padding:"8px 12px",fontSize:11,fontWeight:600,borderRadius:6,cursor:"pointer",fontFamily:"inherit",
                  border:"1px dashed #7c7cc8",background:showSvcPicker?"#7c7cc810":"#fafafa",color:"#7c7cc8",
                  display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                <span>{(f.selectedServices||[]).length > 0 ?
                  `${(f.selectedServices||[]).map(sid=>SVC_LIST.find(s=>s.id===sid)?.name).filter(Boolean).join(", ")} (${(f.selectedServices||[]).length}건, ${svcDurTotal}분, ${fmt(svcPriceTotal)}원)`
                  : "시술 상품을 선택하세요"}</span>
                <span style={{fontSize:13}}>{showSvcPicker?<I name="chevU" size={12}/>:<I name="chevD" size={12}/>}</span>
              </button>
              {showSvcPicker && <div style={{marginTop:6,border:"1px solid #e0e0e0",borderRadius:8,background:"#fff",maxHeight:280,overflow:"auto"}}>
                {SVC_LIST.length===0 && <div style={{padding:12,fontSize:11,color:"#999",textAlign:"center"}}>시술 상품이 없습니다 (관리설정 → 시술상품관리에서 등록)</div>}
                {SVC_LIST.length>0 && SVC_LIST.map(svc=>{
                      const sel = (f.selectedServices||[]).includes(svc.id);
                      const price = f.custGender==="M"?svc.priceM:svc.priceF;
                      const disabled = price===0;
                      const catName = CATS.find(c=>c.id===svc.cat)?.name||"";
                      return <div key={svc.id} onClick={()=>!disabled&&toggleService(svc.id)}
                        style={{padding:"6px 10px",cursor:disabled?"default":"pointer",display:"flex",alignItems:"center",gap:6,
                          borderBottom:"1px solid #f0f0f0",opacity:disabled?0.3:1,background:sel?"#7c7cc810":"transparent",borderRadius:4,transition:"background .15s"}}>
                        {sel && <span style={{color:"#7c7cc8",fontWeight:700,fontSize:12,flexShrink:0}}>✓</span>}
                        {catName && <span style={{fontSize:8,color:"#7c7cc8",background:"#f0f0ff",borderRadius:3,padding:"1px 4px",flexShrink:0}}>{catName}</span>}
                        <span style={{flex:1,fontSize:11,fontWeight:sel?600:400,color:sel?"#333":"#666"}}>{svc.name}</span>
                        <span style={{fontSize:9,color:"#999"}}>{svc.dur}분</span>
                        <span style={{fontSize:10,color:"#ef5350",fontWeight:600,width:55,textAlign:"right"}}>{price>0?fmt(price):"-"}</span>
                      </div>;
                    })}
              </div>}
            </div>;
            })()}

            {/* 예약태그 */}
            <FLD label={`예약태그${(tagDurTotal+svcDurTotal) > 0 ? ` — 소요시간: ${tagDurTotal+svcDurTotal}분` : ""}`}>
              <div style={{display:"flex",flexWrap:"wrap",gap:4,padding:8,background:"#f8f8f8",borderRadius:8,border:"1px solid #e0e0e0"}}>
                {visibleTags.map(tag => {
                  const sel = f.selectedTags?.includes(tag.id);
                  const hasColor = tag.color && tag.color !== "";
                  const bgClr = hasColor ? tag.color : "#7c7cc8";
                  return <button key={tag.id} onClick={()=>toggleTag(tag.id)}
                    style={{padding:"3px 8px",fontSize:11,fontWeight:600,borderRadius:3,cursor:"pointer",fontFamily:"inherit",transition:"all .1s",
                      border:sel?"1px solid "+bgClr:"1px solid #d0d0d0",
                      background:sel?bgClr+"70":"#e8e8e8",
                      color:sel?"#333":"#aaa",display:"inline-flex",alignItems:"center",gap:3,lineHeight:1.3}}>
                    {hasColor && <span style={{width:6,height:6,borderRadius:1,background:bgClr,flexShrink:0,opacity:sel?1:0.4}}/>}
                    {tag.name}
                    {tag.dur > 0 && <span style={{fontSize:9,opacity:0.6}}>({tag.dur}분)</span>}
                  </button>;
                })}
              </div>
              {(f.selectedTags||[]).length > 0 && tagDurTotal>0 && <div style={{marginTop:4,fontSize:10,color:"#ef5350",fontWeight:700,textAlign:"right"}}>합산 {tagDurTotal}분</div>}
            </FLD>


          </>}

          {/* 예약메모 */}
          <div>
            <textarea className="inp" rows={8} value={f.memo} onChange={e=>set("memo",e.target.value)} style={{resize:"vertical"}} placeholder="예약 관련 메모를 입력하세요"/>
            {(() => {
              const isNaverRes = !!(f.reservationId || (f.memo && /네이버/.test(f.memo)));
              if (!isNaverRes) return null;
              const br = (data.branchSettings||data.branches||[]).find(b=>b.id===branchId);
              const bizId = br?.naverBizId;
              if (!bizId) return null;
              return <a href={`https://partner.booking.naver.com/bizes/${bizId}/booking-list-view?bookingBusinessId=${bizId}`} target="_blank" rel="noopener noreferrer"
                style={{display:"inline-flex",alignItems:"center",gap:4,marginTop:4,fontSize:11,color:"#03C75A",fontWeight:600,textDecoration:"none",padding:"4px 8px",background:"#03C75A10",borderRadius:4,border:"1px solid #03C75A30"}}>
                <I name="naver" size={13}/> 네이버 예약 관리 바로가기 <I name="chevR" size={12} color="#03C75A"/>
              </a>;
            })()}
            {(f.tsLog?.length > 0) && <div style={{marginTop:4,fontSize:10,color:"#999",lineHeight:1.6}}>
              {f.tsLog.map((ts,i)=><div key={i}>{ts}</div>)}
            </div>}
          </div>

          {/* Action Buttons - 한 줄 (pinned bottom) */}
        </div>
        <div style={{padding:"12px 16px",borderTop:"1px solid #e0e0e0",background:"#fafafa",borderRadius:"0 0 12px 12px"}}>
            {/* 예약상태 버튼 */}
            {item?.id && !isSchedule && <div style={{display:"flex",gap:4,marginBottom:8}}>
              {STATUS_KEYS.map(k=>{const sc=getStatusClr();const sel=f.status===k;return <button key={k} onClick={()=>set("status",k)}
                style={{flex:1,padding:"7px 0",borderRadius:6,border:sel?`2px solid ${sc[k]}`:"1px solid #e0e0e0",
                  background:sel?sc[k]:"#fff",color:sel?"#fff":sc[k],fontSize:12,fontWeight:700,cursor:"pointer",fontFamily:"inherit",transition:"all .15s"}}>
                {STATUS_LABEL[k]}</button>})}
            </div>}
            <div style={{display:"flex",gap:6,flexWrap:"wrap",alignItems:"center"}}>
            <button className="btn-s" style={{padding:"10px 16px"}} onClick={onClose}>닫기</button>
            {!isReadOnly && <><button className="btn-p" style={{flex:1,justifyContent:"center",padding:10,
              background:isSchedule?"#e17055":"#7c7cc8"}} onClick={()=>{
                if(!isSchedule && !f.custGender) { alert("고객 성별을 선택해주세요."); return; }
                const now = new Date();
                const ts = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")} ${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
                const prevLog = f.tsLog || [];
                const newLog = !item?.id && !isSchedule
                  ? [...prevLog, `[등록: ${ts}]`]
                  : item?.id
                    ? [...prevLog, `[수정: ${ts}]`]
                    : prevLog;
                onSave({...f, tsLog: newLog});
              }}>{item?.id?"수정 완료":"등록"}</button>
            {item?.id && <button className="btn-d" style={{padding:"10px 16px"}} onClick={()=>onDeleteRequest?.(item)}>삭제</button>}
            {!isSchedule && f.type === "reservation" && (
              <button onClick={()=>setShowSaleForm(true)}
                style={{padding:"10px 18px",borderRadius:8,border:"none",background:existingSale?"linear-gradient(135deg,#5cb5c5,#6bab9e)":"linear-gradient(135deg,#7c7cc8,#5cb5c5)",color:"#fff",fontWeight:800,fontSize:12,cursor:"pointer",fontFamily:"inherit",whiteSpace:"nowrap"}}>
                {existingSale ? <><I name="wallet" size={12}/> 매출확인</> : <><I name="wallet" size={12}/> 매출등록</>}
              </button>
            )}</>}
            {isReadOnly && <span style={{fontSize:12,color:"#999",display:"flex",alignItems:"center",gap:4}}><I name="eye" size={12}/> 열람 전용 (타 지점)</span>}
          </div>
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════
// Bliss v2.5 - realtime extra/discount totals
const SaleSvcRow = React.memo(function SaleSvcRow({ id, name, dur, checked, amount, defPrice, toggle, setAmt }) {
  const disabled = defPrice === 0;
  const [localAmt, setLocalAmt] = useState(amount || "");
  useEffect(() => { setLocalAmt(amount || ""); }, [checked]);
  return (
    <div onClick={() => !disabled && !checked && toggle(id, defPrice)}
      style={{ display: "flex", alignItems: "center", gap: 6, padding: "6px 8px", borderRadius: 6, marginBottom: 2,
        background: checked ? "#7c7cc810" : "transparent", cursor: disabled ? "not-allowed" : "pointer",
        opacity: disabled ? 0.3 : 1, transition: "background .15s" }}>
      <span onClick={e => { e.stopPropagation(); if(!disabled) toggle(id, defPrice); }}
        style={{ flex: 1, fontSize: 11, color: checked ? "#333" : "#999", fontWeight: checked ? 600 : 400 }}>
        {checked && <span style={{color:"#7c7cc8",marginRight:4}}>✓</span>}{name}
      </span>
      <span style={{ fontSize: 9, color: "#bbb", flexShrink: 0, width: 32, textAlign: "center" }}>{dur}분</span>
      <input className="inp" type="number" value={checked ? localAmt : ""} placeholder={disabled ? "—" : (defPrice||0).toLocaleString()}
        onClick={e => e.stopPropagation()}
        onChange={e => setLocalAmt(e.target.value)} onBlur={e => setAmt(id, e.target.value)} disabled={!checked}
        style={{ width: 72, padding: "4px 6px", fontSize: 11, textAlign: "right", borderRadius: 6,
          background: checked ? "#fff" : "transparent", border: `1px solid ${checked ? "#d0d0d0" : "#eee"}`,
          color: checked ? "#ef5350" : "#d0d0d0", fontWeight: checked ? 700 : 400 }} />
    </div>
  );
});

const SaleProdRow = React.memo(function SaleProdRow({ id, name, price, checked, amount, toggle, setAmt }) {
  const [localAmt, setLocalAmt] = useState(amount || "");
  useEffect(() => { setLocalAmt(amount || ""); }, [checked]);
  return (
    <div onClick={() => !checked && toggle(id, price)}
      style={{ display: "flex", alignItems: "center", gap: 6, padding: "6px 8px", borderRadius: 6, marginBottom: 2,
        background: checked ? "#6bab9e10" : "transparent", cursor: "pointer", transition: "background .15s" }}>
      <span onClick={e => { e.stopPropagation(); toggle(id, price); }}
        style={{ flex: 1, fontSize: 11, color: checked ? "#333" : "#999", fontWeight: checked ? 600 : 400 }}>
        {checked && <span style={{color:"#6bab9e",marginRight:4}}>✓</span>}{name}
      </span>
      <input className="inp" type="number" value={checked ? localAmt : ""} placeholder="0"
        onClick={e => e.stopPropagation()}
        onChange={e => setLocalAmt(e.target.value)} onBlur={e => setAmt(id, e.target.value)} disabled={!checked}
        style={{ width: 72, padding: "4px 6px", fontSize: 11, textAlign: "right", borderRadius: 6,
          background: checked ? "#fff" : "transparent", border: `1px solid ${checked ? "#d0d0d0" : "#eee"}`,
          color: checked ? "#ef5350" : "#d0d0d0", fontWeight: checked ? 700 : 400 }} />
    </div>
  );
});

const SaleExtraRow = React.memo(function SaleExtraRow({ id, color, placeholder, checked, amount, label, toggle, setAmt, setLabel }) {
  const [localLabel, setLocalLabel] = useState(label || "");
  const [localAmt, setLocalAmt] = useState(amount || "");
  useEffect(() => { setLocalAmt(amount || ""); }, [checked]);
  return (
    <div style={{ display: "flex", alignItems: "center", gap: 5, padding: "6px 8px", borderTop: "1px solid #e0e0e0", marginTop: 4 }}>
      <span onClick={() => toggle(id, 0)}
        style={{ fontSize: 10, color: checked ? "#ef5350" : "#999", fontWeight: 700, flexShrink: 0, cursor: "pointer" }}>
        {checked ? "✓ 추가" : "+ 추가"}
      </span>
      <input className="inp" value={localLabel} onChange={e => setLocalLabel(e.target.value)}
        onBlur={e => setLabel(id, e.target.value)}
        placeholder={placeholder} style={{ flex: 1, padding: "4px 6px", fontSize: 11, background: "transparent", border: "1px solid #e0e0e0", borderRadius: 6 }} />
      <input className="inp" type="number" value={localAmt} placeholder="0"
        onChange={e => { setLocalAmt(e.target.value); setAmt(id, e.target.value); if(!checked && Number(e.target.value)>0) toggle(id, 0); }}
        style={{ width: 72, padding: "4px 6px", fontSize: 11, textAlign: "right", borderRadius: 6,
          border: `1px solid ${checked ? "#d0d0d0" : "#eee"}`,
          color: checked ? "#ef5350" : "#999", fontWeight: checked ? 700 : 400 }} />
    </div>
  );
});

const SaleDiscountRow = React.memo(function SaleDiscountRow({ id, checked, amount, toggle, setAmt }) {
  const [localAmt, setLocalAmt] = useState(amount || "");
  useEffect(() => { setLocalAmt(amount || ""); }, [checked]);
  return <div onClick={() => !checked && toggle(id, 0)}
    style={{ display: "flex", alignItems: "center", gap: 6, padding: "6px 8px", cursor: "pointer", borderRadius: 6,
      background: checked ? "#e8a0a010" : "transparent", transition: "background .15s" }}>
    <span onClick={e => { e.stopPropagation(); toggle(id, 0); }}
      style={{ flex: 1, fontSize: 11, color: checked ? "#e8a0a0" : "#888", fontWeight: 600, cursor: "pointer" }}>
      {checked ? <span style={{color:"#e8a0a0"}}>✓ </span> : ""}할인
    </span>
    <input className="inp" type="number" value={checked ? localAmt : ""} placeholder="0"
      onClick={e => e.stopPropagation()}
      onChange={e => { setLocalAmt(e.target.value); setAmt(id, e.target.value); }} disabled={!checked}
      style={{ width: 72, padding: "4px 6px", fontSize: 11, textAlign: "right", borderRadius: 6,
        background: checked ? "#fff" : "transparent", border: `1px solid ${checked ? "#d0d0d0" : "#eee"}`,
        color: checked ? "#ef5350" : "#d0d0d0", fontWeight: checked ? 700 : 400 }} />
  </div>;
});

// DETAILED SALE FORM (매출 입력 - 시술상품/제품 연동)
// ═══════════════════════════════════════════
function DetailedSaleForm({ reservation, branchId, onSubmit, onClose, data, setData }) {
  const SVC_LIST = (data?.services || []).slice().sort((a,b)=>(a.sort||0)-(b.sort||0));
  const PROD_LIST = (data?.products || []);
  const CATS = (data?.categories || []).slice().sort((a,b)=>(a.sort||0)-(b.sort||0));
  const branchStaff = (data.staff||[]).filter(s => s.bid === branchId);
  const [manager, setManager] = useState(reservation?.staffId || branchStaff[0]?.id || "");
  const [selBranch, setSelBranch] = useState(branchId);
  const [gender, setGender] = useState(reservation?.custGender || "");
  const [saleMemo, setSaleMemo] = useState(reservation?.saleMemo || "");

  // 결제수단 분배
  const [payMethod, setPayMethod] = useState({ svcCash:0, svcCard:0, svcTransfer:0, svcPoint:0, prodCash:0, prodCard:0, prodTransfer:0, prodPoint:0 });
  const [openPay, setOpenPay] = useState({ svcCard:false, svcCash:false, svcTransfer:false, prodCard:false, prodCash:false, prodTransfer:false });
  const [primaryPay, setPrimaryPay] = useState({ svc:null, prod:null });
  const togglePayField = (k, total, prefix) => {
    const fields = prefix === "svc" ? ["svcCard","svcCash","svcTransfer"] : ["prodCard","prodCash","prodTransfer"];
    setOpenPay(prev => {
      const next = {...prev, [k]: !prev[k]};
      if (!prev[k]) {
        // Opening: set as primary if first, or fill remainder
        const openOthers = fields.filter(f => f !== k && next[f]);
        if (openOthers.length === 0) {
          setPrimaryPay(p => ({...p, [prefix]: k}));
          setPayMethod(pm => ({...pm, [k]: total}));
        } else {
          const used = openOthers.reduce((s, f) => s + (payMethod[f]||0), 0);
          setPayMethod(pm => ({...pm, [k]: Math.max(0, total - used)}));
        }
      } else {
        // Closing: zero out and redistribute to primary
        const pri = primaryPay[prefix];
        setPayMethod(pm => {
          const n = {...pm, [k]: 0};
          if (pri && pri !== k && next[pri]) {
            const others = fields.filter(f => f !== pri && next[f]).reduce((s, f) => s + (n[f]||0), 0);
            n[pri] = Math.max(0, total - others);
          }
          return n;
        });
        if (primaryPay[prefix] === k) {
          const remaining = fields.find(f => f !== k && next[f]);
          setPrimaryPay(p => ({...p, [prefix]: remaining || null}));
        }
      }
      return next;
    });
  };
  const editPay = (k, v, total, prefix) => {
    const val = Number(v) || 0;
    const fields = prefix === "svc" ? ["svcCard","svcCash","svcTransfer"] : ["prodCard","prodCash","prodTransfer"];
    const pri = primaryPay[prefix];
    setPayMethod(prev => {
      const next = {...prev, [k]: val};
      if (pri && pri !== k && openPay[pri]) {
        const others = fields.filter(f => f !== pri).reduce((s, f) => s + (f === k ? val : (prev[f]||0)), 0);
        next[pri] = Math.max(0, total - others);
      }
      return next;
    });
  };

  // 네이버 예약 감지 (태그, 예약번호, 메모 중 하나라도 해당)
  const isNaver = !!(
    (reservation?.selectedTags||[]).some(tid => {
      const tag = (data?.serviceTags||[]).find(t=>t.id===tid);
      return tag && tag.name.includes("네이버");
    }) ||
    reservation?.reservationId ||
    (reservation?.memo && /네이버/.test(reservation.memo))
  );
  const [naverPrepaid, setNaverPrepaid] = useState(() => {
    if (!reservation?.memo) return 0;
    // 패턴: "예약금 33,000원", "예약금33000", "예약금 33000원"
    const m = reservation.memo.match(/예약금\s*:?\s*([0-9,]+)\s*원?/);
    return m ? Number(m[1].replace(/,/g, "")) || 0 : 0;
  });

  // 고객 상태 (예약에서 넘어오면 자동 기입, 매출관리에서 열면 검색)
  const [cust, setCust] = useState({
    id: reservation?.custId || null,
    name: reservation?.custName || "",
    phone: reservation?.custPhone || "",
    gender: reservation?.custGender || ""
  });
  const hasReservationCust = !!(reservation?.custName);

  // 고객 검색 (디바운스)
  const [custSearch, setCustSearch] = useState("");
  const [showCustDrop, setShowCustDrop] = useState(false);
  const [custResults, setCustResults] = useState([]);
  useEffect(() => {
    if (custSearch.length < 2) { setCustResults([]); return; }
    const timer = setTimeout(() => {
      const q = custSearch.toLowerCase();
      const results = (data?.customers||[]).filter(c =>
        c.name.toLowerCase().includes(q) || c.phone.includes(q)
      ).slice(0, 30);
      setCustResults(results);
    }, 300);
    return () => clearTimeout(timer);
  }, [custSearch]);
  const selectCust = (c) => {
    setCust({ id: c.id, name: c.name, phone: c.phone, gender: c.gender || "" });
    setGender(c.gender || "");
    setCustSearch(""); setShowCustDrop(false);
  };

  // State: { [id]: { checked, amount } }
  const [items, setItems] = useState(() => {
    const init = {};
    const selSvcs = reservation?.selectedServices || [];
    SVC_LIST.forEach(svc => {
      const preSelected = selSvcs.includes(svc.id);
      const defPrice = (reservation?.custGender||"F")==="M" ? svc.priceM : svc.priceF;
      init[svc.id] = { checked: preSelected, amount: preSelected ? defPrice : 0 };
    });
    PROD_LIST.forEach(p => { init[p.id] = { checked: false, amount: 0 }; });
    init["discount"] = { checked: false, amount: 0 };
    init["extra_svc"] = { checked: false, amount: 0, label: "" };
    init["extra_prod"] = { checked: false, amount: 0, label: "" };
    return init;
  });

  const toggle = useCallback((id, defPrice) => {
    setItems(prev => {
      const cur = prev[id] || { checked: false, amount: 0 };
      const newChecked = !cur.checked;
      return { ...prev, [id]: { ...cur, checked: newChecked, amount: newChecked ? (cur.amount || defPrice || 0) : 0 } };
    });
  }, []);
  const setAmt = useCallback((id, v) => setItems(prev => ({ ...prev, [id]: { ...prev[id], amount: Number(v) || 0 } })), []);
  const setLabel = useCallback((id, v) => setItems(prev => ({ ...prev, [id]: { ...prev[id], label: v } })), []);

  // 신규고객 등록 모드
  const [newCustMode, setNewCustMode] = useState(false);
  const [newCustName, setNewCustName] = useState("");
  const [newCustPhone, setNewCustPhone] = useState("");
  const [newCustGender, setNewCustGender] = useState("");
  const registerNewCust = () => {
    if (!newCustName.trim()) return;
    setCust({ id: "new_" + uid(), name: newCustName.trim(), phone: newCustPhone.trim(), gender: newCustGender });
    setGender(newCustGender);
    setNewCustMode(false); setCustSearch(""); setShowCustDrop(false);
  };

  // Totals
  const svcTotal = SVC_LIST.reduce((sum, svc) => sum + (items[svc.id]?.checked ? items[svc.id].amount : 0), 0)
    + (items.extra_svc?.checked ? items.extra_svc.amount : 0);
  const prodTotal = PROD_LIST.reduce((sum, p) => sum + (items[p.id]?.checked ? items[p.id].amount : 0), 0)
    + (items.extra_prod?.checked ? items.extra_prod.amount : 0);
  const discount = items.discount?.checked ? items.discount.amount : 0;
  const naverDeduct = isNaver ? naverPrepaid : 0;
  const grandTotal = svcTotal + prodTotal - discount - naverDeduct;
  // 실제 결제할 금액 (예약금·할인 차감)
  const svcPayTotal = Math.max(0, svcTotal - discount - naverDeduct);
  const prodPayTotal = prodTotal;

  // Count checked
  const checkedSvc = SVC_LIST.filter(s => items[s.id]?.checked).length + (items.extra_svc?.checked ? 1 : 0);
  const checkedProd = PROD_LIST.filter(p => items[p.id]?.checked).length + (items.extra_prod?.checked ? 1 : 0);

  // Auto-calc remaining for default payment
  const svcRemain = Math.max(0, svcTotal - payMethod.svcCard - payMethod.svcTransfer - payMethod.svcCash - payMethod.svcPoint);
  const prodRemain = Math.max(0, prodTotal - payMethod.prodCard - payMethod.prodTransfer - payMethod.prodCash - payMethod.prodPoint);
  // Reset payment when total changes
  const prevSvcPay = useRef(0);
  const prevProdPay = useRef(0);
  useEffect(() => {
    if (svcPayTotal !== prevSvcPay.current) {
      prevSvcPay.current = svcPayTotal;
      const pri = primaryPay.svc;
      if (pri && openPay[pri]) {
        const fields = ["svcCard","svcCash","svcTransfer"];
        setPayMethod(p => { const n={...p}; const others=fields.filter(f=>f!==pri&&openPay[f]).reduce((s,f)=>s+(n[f]||0),0); n[pri]=Math.max(0,svcPayTotal-others); return n; });
      }
    }
  }, [svcPayTotal]);
  useEffect(() => {
    if (prodPayTotal !== prevProdPay.current) {
      prevProdPay.current = prodPayTotal;
      const pri = primaryPay.prod;
      if (pri && openPay[pri]) {
        const fields = ["prodCard","prodCash","prodTransfer"];
        setPayMethod(p => { const n={...p}; const others=fields.filter(f=>f!==pri&&openPay[f]).reduce((s,f)=>s+(n[f]||0),0); n[pri]=Math.max(0,prodPayTotal-others); return n; });
      }
    }
  }, [prodPayTotal]);

  const handleSubmit = () => {
    if (grandTotal <= 0) {
      alert("매출 금액이 0원입니다. 시술 또는 제품을 선택해주세요.");
      return;
    }
    // 고객 이름/연락처 필수 + 마스킹 체크
    const custName = (cust.name||"").trim();
    const custPhone = (cust.phone||"").trim();
    if (!custName || !custPhone) {
      alert("고객 이름과 연락처를 모두 입력해주세요.");
      return;
    }
    if (!gender) {
      alert("고객 성별을 선택해주세요.");
      return;
    }
    if (/\*/.test(custName) || /\*/.test(custPhone)) {
      alert("고객 이름이나 연락처에 '*'가 포함되어 있습니다.\n네이버 마스킹 데이터가 아닌 실제 정보를 입력해주세요.");
      return;
    }
    if (!gender) {
      alert("고객 성별을 선택해주세요.");
      return;
    }
    const staff = (data.staff||[]).find(s => s.id === manager);
    // 고객 정보 저장 (신규 등록 또는 기존 업데이트)
    const isNewCust = cust.id?.startsWith("new_") || (!cust.id && custName);
    if (setData) {
      if (isNewCust) {
        const custId = cust.id || ("cust_" + uid());
        const newCustObj = {
          id: custId, bid: selBranch, name: custName, phone: custPhone,
          gender: gender, visits: 1, lastVisit: todayStr(), memo: "",
          custNum: String(50000 + Math.floor(Math.random() * 10000))
        };
        const alreadyExists = (data?.customers||[]).some(c => c.id === custId);
        if (!alreadyExists) {
          setData(prev => ({ ...prev, customers: [...prev.customers, newCustObj] }));
          sb.insert("customers", toDb("customers", newCustObj)).catch(console.error);
        }
        cust.id = custId;
      } else if (cust.id) {
        // 기존 고객 정보 업데이트 (이름, 연락처, 성별, 최근방문)
        const updates = { name: custName, phone: custPhone, gender: gender, lastVisit: todayStr() };
        setData(prev => ({ ...prev, customers: prev.customers.map(c => c.id === cust.id ? {...c, ...updates, visits: (c.visits||0)+1} : c) }));
        sb.update("customers", cust.id, toDb("customers", updates)).catch(console.error);
      }
    }
    const sale = {
      id: uid(), bid: selBranch,
      custId: cust.id || null, custName: custName,
      custPhone: custPhone, custGender: gender,
      custNum: String(50000 + Math.floor(Math.random() * 10000)),
      staffId: manager, staffName: staff?.dn || "",
      date: reservation?.date || todayStr(),
      serviceId: reservation?.serviceId || null, serviceName: SVC_LIST.find(s => s.id === reservation?.serviceId)?.name || "",
      productId: null, productName: null,
      svcCash: payMethod.svcCash, svcTransfer: payMethod.svcTransfer, svcCard: payMethod.svcCard, svcPoint: payMethod.svcPoint,
      prodCash: payMethod.prodCash, prodTransfer: payMethod.prodTransfer, prodCard: payMethod.prodCard, prodPoint: payMethod.prodPoint,
      gift: 0, orderNum: String(252000 + Math.floor(Math.random() * 200)),
      memo: (isNaver && naverPrepaid > 0 ? `[네이버예약금 ${naverPrepaid.toLocaleString()}원] ` : "") + (saleMemo || ""),
      createdAt: new Date().toISOString(),
    };
    onSubmit(sale);
  };

  // Split services into 2 columns by flat sort order
  const halfSvc = Math.ceil(SVC_LIST.length / 2);
  const leftSvcs = SVC_LIST.slice(0, halfSvc);
  const rightSvcs = SVC_LIST.slice(halfSvc);
  const halfProd = Math.ceil(PROD_LIST.length / 2);

  return (
    <div className="ov" onClick={onClose} style={{alignItems:"flex-start",padding:"20px 16px",overflow:"auto",WebkitOverflowScrolling:"touch"}}>
      <div onClick={e => e.stopPropagation()} style={{
        background: "#fff", borderRadius: 12, border: "1px solid #e0e0e0", padding: 0,
        width: "92%", maxWidth: 1200, margin: "0 auto",
        animation: "slideUp .6s cubic-bezier(.22,1,.36,1)", boxShadow: "0 12px 40px rgba(0,0,0,.18)"
      }}>
        {/* Header */}
        <div style={{ padding: "10px 20px", borderBottom: "1px solid #e0e0e0", display: "flex", alignItems: "center", justifyContent: "space-between", background: "#f8f8f8", gap: 10, borderRadius: "12px 12px 0 0" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 14, flexWrap: "wrap", flex: 1 }}>
            <h3 style={{ fontSize: 16, fontWeight: 800, color: "#ef5350", flexShrink: 0 }}><I name="diamond" size={14}/> 매출 입력</h3>
            {cust.name ? (
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <span className="badge" style={{ background: cust.gender === "M" ? "#e0edf5" : cust.gender === "F" ? "#fce8e8" : "#f0f0f0", color: cust.gender === "M" ? "#7c7cc8" : cust.gender === "F" ? "#e57373" : "#999", fontSize: 10 }}>{cust.gender === "M" ? "남" : cust.gender === "F" ? "여" : "-"}</span>
                <strong style={{ color: "#444", fontSize: 13 }}>{cust.name}</strong>
                <span style={{ fontSize: 11, color: "#888" }}>{cust.phone}</span>
                {cust.id?.startsWith("new_") && <span style={{ fontSize: 8, padding: "1px 4px", borderRadius: 3, background: "#e57373", color: "#fff", fontWeight: 700 }}>신규</span>}
                {!hasReservationCust && <button onClick={() => { setCust({ id: null, name: "", phone: "", gender: "" }); setGender(""); setCustSearch(""); setNewCustMode(false); }}
                  style={{ fontSize: 10, color: "#e57373", background: "none", border: "none", cursor: "pointer", fontFamily: "inherit", textDecoration: "underline" }}>변경</button>}
              </div>
            ) : newCustMode ? (
              <div style={{ display: "flex", gap: 6, alignItems: "center", flex: 1 }}>
                <div style={{ display: "flex", gap: 2 }}>
                  {["F","M"].map(g => <button key={g} onClick={() => setNewCustGender(prev => prev===g ? "" : g)}
                    style={{ padding: "3px 8px", fontSize: 10, fontWeight: 700, borderRadius: 4, cursor: "pointer", fontFamily: "inherit", border: "1px solid " + (newCustGender === g ? (g === "F" ? "#e57373" : "#7c7cc8") : "#d0d0d0"),
                      background: newCustGender === g ? (g === "F" ? "#e5737320" : "#7c7cc820") : "transparent",
                      color: newCustGender === g ? (g === "F" ? "#e57373" : "#7c7cc8") : "#999"
                    }}>{g === "F" ? "여" : "남"}</button>)}
                </div>
                <input className="inp" style={{ width: 90, fontSize: 11, padding: "4px 8px" }} value={newCustName} onChange={e => setNewCustName(e.target.value)} placeholder="고객명" autoFocus />
                <input className="inp" style={{ width: 110, fontSize: 11, padding: "4px 8px" }} value={newCustPhone} onChange={e => setNewCustPhone(e.target.value)} placeholder="전화번호" />
                <button onClick={registerNewCust} style={{ padding: "4px 12px", fontSize: 10, fontWeight: 700, borderRadius: 5, border: "none", background: "#7c7cc8", color: "#fff", cursor: "pointer", fontFamily: "inherit", whiteSpace: "nowrap" }}>확인</button>
                <button onClick={() => setNewCustMode(false)} style={{ padding: "4px 8px", fontSize: 10, border: "none", background: "transparent", color: "#999", cursor: "pointer", fontFamily: "inherit" }}>취소</button>
              </div>
            ) : (
              <div style={{ position: "relative", flex: 1, maxWidth: 280 }}>
                <input className="inp" style={{ fontSize: 11, width: "100%" }} value={custSearch}
                  onChange={e => { setCustSearch(e.target.value); setShowCustDrop(true); }}
                  onFocus={() => setShowCustDrop(true)}
                  placeholder="고객 검색 (2글자 이상)" />
                {showCustDrop && custSearch.length >= 2 && (
                  <div style={{ position: "absolute", top: "100%", left: 0, right: 0, background: "#fff", border: "1px solid #d0d0d0", borderRadius: 8,
                    maxHeight: 200, overflow: "auto", zIndex: 20, marginTop: 2, boxShadow: "0 8px 20px rgba(0,0,0,.12)" }}>
                    {custResults.map(c => (
                      <div key={c.id} onClick={() => selectCust(c)}
                        style={{ padding: "7px 10px", cursor: "pointer", borderBottom: "1px solid #e0e0e020", display: "flex", gap: 6, alignItems: "center", fontSize: 11 }}
                        onMouseOver={e => e.currentTarget.style.background = "#f0f0f0"} onMouseOut={e => e.currentTarget.style.background = "transparent"}>
                        <span className="badge" style={{ background: c.gender === "M" ? "#e0edf5" : "#fce8e8", color: c.gender === "M" ? "#7c7cc8" : "#e57373", fontSize: 9 }}>{c.gender === "M" ? "남" : "여"}</span>
                        <span style={{ fontWeight: 600 }}>{c.name}</span>
                        <span style={{ color: "#888" }}>{c.phone}</span>
                      </div>
                    ))}
                    {custResults.length === 0 && <div style={{ padding: "10px", fontSize: 11, color: "#999", textAlign: "center" }}>검색결과 없음</div>}
                    <div onClick={() => { setNewCustMode(true); setShowCustDrop(false); setNewCustName(custSearch.replace(/[0-9\-]/g,"").trim()); setNewCustPhone(custSearch.replace(/[^0-9]/g,"")); }}
                      style={{ padding: "8px 10px", cursor: "pointer", borderTop: "1px solid #e0e0e0", display: "flex", alignItems: "center", gap: 6, fontSize: 11, fontWeight: 700, color: "#7c7cc8" }}
                      onMouseOver={e => e.currentTarget.style.background = "#e0edf520"} onMouseOut={e => e.currentTarget.style.background = "transparent"}>
                      <I name="plus" size={14}/> 신규고객으로 등록 {custSearch && <span style={{ fontWeight: 400, color: "#888" }}>"{custSearch}"</span>}
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
          <button onClick={onClose} className="close-btn" style={{ fontSize: 18 }}><I name="x" size={16}/></button>
        </div>

        {/* Controls: Manager, Branch, Gender, Live Totals */}
        <div style={{ padding: "8px 16px", borderBottom: "1px solid #e0e0e0", display: "flex", gap: 12, alignItems: "center", flexWrap: "wrap", background: "#f8f0f0" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 5, fontSize: 12 }}>
            <span style={{ color: "#888" }}>Manager</span>
            <select className="inp" style={{ width: 90, padding: "3px 6px", fontSize: 11 }} value={manager} onChange={e => setManager(e.target.value)}>
              {branchStaff.map(s => <option key={s.id} value={s.id}>{s.dn}</option>)}
            </select>
          </div>
          <div style={{ display: "flex", alignItems: "center", gap: 5, fontSize: 12 }}>
            <span style={{ color: "#888" }}>지점</span>
            <select className="inp" style={{ width: 90, padding: "3px 6px", fontSize: 11 }} value={selBranch} onChange={e => setSelBranch(e.target.value)}>
              {(data.branches||[]).map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
            </select>
          </div>
          {/* Gender - changeable buttons */}
          <div style={{ display: "flex", alignItems: "center", gap: 2 }}>
            {["F","M"].map(g => <button key={g} onClick={() => { setGender(g); setCust(p=>({...p,gender:g})); }}
              style={{ padding: "4px 10px", fontSize: 11, fontWeight: 700, borderRadius: g==="F"?"6px 0 0 6px":"0 6px 6px 0", cursor: "pointer", fontFamily: "inherit", border: "none",
                background: gender === g ? (g==="F" ? "#e5737340" : "#7c7cc840") : "#f0f0f0",
                color: gender === g ? (g==="F" ? "#e57373" : "#5cb5c5") : "#ccc" }}>{g === "F" ? "여" : "남"}</button>)}
            <span style={{ fontSize: 9, color: "#d0d0d0", marginLeft: 2 }}>{gender ? (gender==="F"?"여성":"남성")+" 가격" : "성별 미선택"}</span>
          </div>
          {/* Totals */}
          <div style={{ marginLeft: "auto", display: "flex", alignItems: "center", gap: 10 }}>
            <span style={{ fontSize: 11, color: "#888" }}>시술 <strong style={{ color: "#7c7cc8" }}>{fmt(svcTotal)}</strong> ({checkedSvc})</span>
            <span style={{ fontSize: 11, color: "#888" }}>제품 <strong style={{ color: "#6bab9e" }}>{fmt(prodTotal)}</strong> ({checkedProd})</span>
            {discount > 0 && <span style={{ fontSize: 11, color: "#888" }}>할인 <strong style={{ color: "#e8a0a0" }}>-{fmt(discount)}</strong></span>}
            {isNaver && naverPrepaid > 0 && <span style={{ fontSize: 11, color: "#888" }}>예약금 <strong style={{ color: "#e65100" }}>-{fmt(naverPrepaid)}</strong></span>}
            <span style={{ fontSize: 17, fontWeight: 900, color: "#ef5350" }}>{fmt(grandTotal)}원</span>
          </div>
        </div>

        {/* Main Body - 4 columns: svc left, svc right, prod left, prod right */}
        <div className="sale-grid" style={{ flex: 1, overflow: "auto", padding: "10px 14px", display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 14, alignContent: "start" }}>

          {/* Col 1: Services (left half) */}
          <div>
            <div style={{ fontSize: 10, fontWeight: 700, color: "#7c7cc8", padding: "4px 0 3px", borderBottom: "2px solid #7c7cc830", marginBottom: 1 }}>시술 ({SVC_LIST.length})</div>
            {leftSvcs.map(svc => { const it=items[svc.id]||{}; const dp=(gender||"F")==="M"?svc.priceM:svc.priceF; return <SaleSvcRow key={svc.id} id={svc.id} name={svc.name} dur={svc.dur} checked={!!it.checked} amount={it.amount||0} defPrice={dp} toggle={toggle} setAmt={setAmt} />; })}
            <SaleExtraRow id="extra_svc" color="#7c7cc8" placeholder="추가 시술명 입력" checked={!!(items.extra_svc||{}).checked} amount={(items.extra_svc||{}).amount||0} label={(items.extra_svc||{}).label||""} toggle={toggle} setAmt={setAmt} setLabel={setLabel} />
          </div>

          {/* Col 2: Services (right half) */}
          <div>
            {rightSvcs.map(svc => { const it=items[svc.id]||{}; const dp=(gender||"F")==="M"?svc.priceM:svc.priceF; return <SaleSvcRow key={svc.id} id={svc.id} name={svc.name} dur={svc.dur} checked={!!it.checked} amount={it.amount||0} defPrice={dp} toggle={toggle} setAmt={setAmt} />; })}
            {/* Discount */}
            <div style={{ marginTop: 6, padding: "4px 0", borderTop: "1px solid #d0d0d0" }}>
              <SaleDiscountRow id="discount" checked={items.discount?.checked} amount={items.discount?.amount||0} toggle={toggle} setAmt={setAmt} />
            </div>
          </div>

          {/* Col 3: Products (first half) */}
          <div>
            <div style={{ fontSize: 10, fontWeight: 700, color: "#6bab9e", padding: "4px 0 3px", borderBottom: "2px solid #6bab9e30", marginBottom: 1 }}>제품 ({PROD_LIST.length})</div>
            {PROD_LIST.slice(0, halfProd).map(p => { const it=items[p.id]||{}; return <SaleProdRow key={p.id} id={p.id} name={p.name} price={p.price||0} checked={!!it.checked} amount={it.amount||0} toggle={toggle} setAmt={setAmt} />; })}
          </div>

          {/* Col 4: Products (second half) + extra */}
          <div>
            <div style={{ fontSize: 10, fontWeight: 700, color: "#6bab9e", padding: "4px 0 3px", borderBottom: "2px solid #6bab9e30", marginBottom: 1 }}>&nbsp;</div>
            {PROD_LIST.slice(halfProd).map(p => { const it=items[p.id]||{}; return <SaleProdRow key={p.id} id={p.id} name={p.name} price={p.price||0} checked={!!it.checked} amount={it.amount||0} toggle={toggle} setAmt={setAmt} />; })}
            <SaleExtraRow id="extra_prod" color="#6bab9e" placeholder="추가 제품명 입력" checked={!!(items.extra_prod||{}).checked} amount={(items.extra_prod||{}).amount||0} label={(items.extra_prod||{}).label||""} toggle={toggle} setAmt={setAmt} setLabel={setLabel} />
          </div>
        </div>

        {/* 결제 정리 */}
        <div style={{padding:"14px 16px",borderTop:"2px solid #e0e0e0",background:"#fafafa"}}>
          {/* 금액 브레이크다운 */}
          <div style={{marginBottom:12,padding:"10px 14px",background:"#fff",borderRadius:8,border:"1px solid #e8e8e8"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 0"}}>
              <span style={{fontSize:12,color:"#555"}}><I name="scissors" size={12}/> 시술 합계</span>
              <span style={{fontSize:13,fontWeight:700,color:"#7c7cc8"}}>{fmt(svcTotal)}원</span>
            </div>
            {prodTotal > 0 && <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 0"}}>
              <span style={{fontSize:12,color:"#555"}}><I name="pkg" size={12}/> 제품 합계</span>
              <span style={{fontSize:13,fontWeight:700,color:"#6bab9e"}}>{fmt(prodTotal)}원</span>
            </div>}
            {discount > 0 && <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 0"}}>
              <span style={{fontSize:12,color:"#e8a0a0"}}><I name="tag" size={11}/> 할인</span>
              <span style={{fontSize:13,fontWeight:700,color:"#e8a0a0"}}>-{fmt(discount)}원</span>
            </div>}
            {isNaver && <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"6px 0",marginTop:2}}>
              <span style={{fontSize:12,color:"#e65100"}}><I name="naver" size={11}/> 네이버 예약금</span>
              <div style={{display:"flex",alignItems:"center",gap:4}}>
                <span style={{fontSize:13,fontWeight:700,color:"#e65100"}}>-</span>
                <input className="inp" type="number" value={naverPrepaid||""} placeholder="0"
                  onChange={e=>setNaverPrepaid(Number(e.target.value)||0)}
                  style={{width:85,padding:"4px 8px",fontSize:13,textAlign:"right",fontWeight:700,color:"#e65100",
                    border:"2px solid #ff9800",borderRadius:6,background:"#fff8e1"}} />
                <span style={{fontSize:12,color:"#e65100",fontWeight:600}}>원</span>
              </div>
            </div>}
            <div style={{borderTop:"2px solid #333",marginTop:6,paddingTop:8,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <span style={{fontSize:13,fontWeight:800,color:"#333"}}>{isNaver ? "현장 결제금액" : "총 결제금액"}</span>
              <span style={{fontSize:18,fontWeight:900,color:"#ef5350"}}>{fmt(grandTotal)}원</span>
            </div>
          </div>

          {/* 결제수단 분배 */}
          {grandTotal > 0 && <div className="sale-pay-row" style={{display:"flex",gap:16,flexWrap:"wrap"}}>
            {svcPayTotal > 0 && <div style={{flex:1,minWidth:0,padding:"8px 12px",background:"#fff",borderRadius:8,border:"1px solid #e0e0e0"}}>
              <div style={{fontSize:10,fontWeight:700,color:"#7c7cc8",marginBottom:6}}><I name="scissors" size={12}/> 시술 결제 <span style={{color:"#ef5350",fontWeight:800}}>{fmt(svcPayTotal)}원</span></div>
              <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                {[
                  {k:"svcCard",label:"카드",clr:"#1565c0",bg:"#e3f2fd"},
                  {k:"svcCash",label:"현금",clr:"#e65100",bg:"#fff3e0"},
                  {k:"svcTransfer",label:"입금",clr:"#2e7d32",bg:"#e8f5e9"},
                ].map(({k,label,clr,bg})=><div key={k} style={{display:"flex",alignItems:"center",gap:3}}>
                  <button onClick={()=>togglePayField(k,svcPayTotal,"svc")}
                    style={{padding:"5px 10px",fontSize:11,fontWeight:700,borderRadius:6,cursor:"pointer",fontFamily:"inherit",transition:"all .15s",
                      border:openPay[k]?`2px solid ${clr}`:"1px solid #d0d0d0",
                      background:openPay[k]?bg:"#f8f8f8",color:openPay[k]?clr:"#999"}}>{label}</button>
                  {openPay[k] && <input className="inp" type="number" value={payMethod[k]||""} placeholder="0"
                    onChange={e=>editPay(k,e.target.value,svcPayTotal,"svc")}
                    readOnly={primaryPay.svc===k}
                    style={{width:75,padding:"4px 6px",fontSize:12,textAlign:"right",border:`1.5px solid ${clr}`,color:clr,fontWeight:700,borderRadius:6,
                      background:primaryPay.svc===k?"#f5f5f5":"#fff"}}/>}
                </div>)}
              </div>
            </div>}
            {prodPayTotal > 0 && <div style={{flex:1,minWidth:0,padding:"8px 12px",background:"#fff",borderRadius:8,border:"1px solid #e0e0e0"}}>
              <div style={{fontSize:10,fontWeight:700,color:"#6bab9e",marginBottom:6}}><I name="pkg" size={12}/> 제품 결제 <span style={{color:"#ef5350",fontWeight:800}}>{fmt(prodPayTotal)}원</span></div>
              <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                {[
                  {k:"prodCard",label:"카드",clr:"#1565c0",bg:"#e3f2fd"},
                  {k:"prodCash",label:"현금",clr:"#e65100",bg:"#fff3e0"},
                  {k:"prodTransfer",label:"입금",clr:"#2e7d32",bg:"#e8f5e9"},
                ].map(({k,label,clr,bg})=><div key={k} style={{display:"flex",alignItems:"center",gap:3}}>
                  <button onClick={()=>togglePayField(k,prodPayTotal,"prod")}
                    style={{padding:"5px 10px",fontSize:11,fontWeight:700,borderRadius:6,cursor:"pointer",fontFamily:"inherit",transition:"all .15s",
                      border:openPay[k]?`2px solid ${clr}`:"1px solid #d0d0d0",
                      background:openPay[k]?bg:"#f8f8f8",color:openPay[k]?clr:"#999"}}>{label}</button>
                  {openPay[k] && <input className="inp" type="number" value={payMethod[k]||""} placeholder="0"
                    onChange={e=>editPay(k,e.target.value,prodPayTotal,"prod")}
                    readOnly={primaryPay.prod===k}
                    style={{width:75,padding:"4px 6px",fontSize:12,textAlign:"right",border:`1.5px solid ${clr}`,color:clr,fontWeight:700,borderRadius:6,
                      background:primaryPay.prod===k?"#f5f5f5":"#fff"}}/>}
                </div>)}
              </div>
            </div>}
          </div>}
          {grandTotal > 0 && <div style={{fontSize:9,color:"#bbb",marginTop:6}}>결제수단 버튼 클릭 → 전액 입력 / 추가 수단 클릭 → 금액 입력 시 첫 수단에서 차감</div>}
        </div>

        {/* 매출 메모 */}
        <div style={{padding:"8px 16px",borderTop:"1px solid #eee"}}>
          <textarea className="inp" rows={2} value={saleMemo} onChange={e=>setSaleMemo(e.target.value)}
            placeholder="매출 관련 메모를 입력하세요" style={{resize:"vertical",width:"100%",fontSize:11}}/>
        </div>

        {/* Footer */}
        <div style={{ padding: "10px 16px", borderTop: "1px solid #e0e0e0", display: "flex", gap: 8, alignItems: "center", justifyContent: "space-between", background: "#f8f8f8", flexWrap: "wrap", borderRadius: "0 0 12px 12px" }}>
          <div style={{ fontSize: 10, color: "#d0d0d0", flex: "1 1 200px" }}>
            {gender ? (gender === "F" ? "여성" : "남성") + " 가격 적용" : "성별 미선택"} · 체크한 항목만 매출 반영
          </div>
          <div style={{ display: "flex", gap: 8, flexShrink: 0 }}>
            <button className="btn-s" onClick={onClose}>취소</button>
            <button className="btn-p" style={{ padding: "10px 20px", fontSize: 13, fontWeight: 800 }} onClick={handleSubmit}>
              <I name="wallet" size={12}/> 매출 등록 ({fmt(grandTotal)}원)
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════
// RESERVATION LIST
// ═══════════════════════════════════════════
function ReservationList({ data, setData, userBranches, isMaster }) {
  const [selDate, setSelDate] = useState(todayStr());
  const [vb, setVb] = useState("all");
  const res = data.reservations.filter(r => r.date===selDate && r.type==="reservation" && ((vb==="all"?userBranches.includes(r.bid):r.bid===vb))).sort((a,b)=>a.time.localeCompare(b.time));
  const changeDate = (off) => { const d = new Date(selDate); d.setDate(d.getDate()+off); setSelDate(fmtLocal(d)); };
  const updateStatus = (id, status) => { setData(prev=>({...prev,reservations:prev.reservations.map(r=>r.id===id?{...r,status}:r)})); sb.update("reservations",id,{status}).catch(console.error); };
  const deleteRes = (id) => setData(prev=>({...prev,reservations:prev.reservations.filter(r=>r.id!==id)}));

  return <div>
    <h2 className="page-title">예약 목록</h2>
    <div style={{display:"flex",gap:10,marginBottom:16,flexWrap:"wrap",alignItems:"center"}}>
      <div style={{display:"flex",alignItems:"center",gap:4}}>
        <button className="btn-s btn-sm" onClick={()=>changeDate(-1)}><I name="chevL" size={14}/></button>
        <input type="date" className="inp" style={{maxWidth:150,width:"auto"}} value={selDate} onChange={e=>setSelDate(e.target.value)}/>
        <button className="btn-s btn-sm" onClick={()=>changeDate(1)}><I name="chevR" size={14}/></button>
      </div>
      <button className="btn-s btn-sm" onClick={()=>setSelDate(todayStr())}>오늘</button>
      {<select className="inp" style={{maxWidth:140,width:"auto"}} value={vb} onChange={e=>setVb(e.target.value)}>
        <option value="all">전체 매장</option>
        {(data.branches||[]).map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
      </select>}
      <span style={{fontSize:13,color:"#888"}}>총 {res.length}건</span>
    </div>
    <div className="card tw">
      <table><thead><tr>
        <th>시간</th><th>매장</th><th>룸</th><th>고객</th><th>성별</th><th>연락처</th><th>시술</th><th>시술자</th><th>상태</th><th>액션</th>
      </tr></thead><tbody>
        {res.length===0?<tr><td colSpan={10} style={{textAlign:"center",color:"#999",padding:40}}>예약이 없습니다</td></tr>:
          res.map(r=>{
            const svc = (data.services||[]).find(s=>s.id===r.serviceId);
            const staff = (data.staff||[]).find(s=>s.id===r.staffId);
            const br = (data.branches||[]).find(b=>b.id===r.bid);
            const room = (data.rooms||[]).find(rm=>rm.id===r.roomId);
            const g = r.custGender || "";
            return <tr key={r.id}>
              <td style={{fontWeight:700,color:"#7c7cc8"}}>{r.time}</td>
              <td>{br?.short}</td>
              <td>{room?.name||"-"}</td>
              <td style={{fontWeight:600}}>{r.custName||"-"}</td>
              <td>{g ? <span className="badge" style={{background:g==="M"?"#e0edf5":"#fce8e8",color:g==="M"?"#7c7cc8":"#e57373",fontSize:10}}>{g==="M"?"남":"여"}</span> : <span style={{color:"#ccc",fontSize:10}}>-</span>}</td>
              <td style={{color:"#7c7cc8"}}>{r.custPhone||"-"}</td>
              <td>{svc?.name||"-"}</td>
              <td>{staff?.dn||"-"}</td>
              <td>{(() => { const sc = getStatusClr(); const c = sc[r.status]||"#999"; return <span style={{fontSize:11,fontWeight:700,color:c}}>{STATUS_LABEL[r.status]||r.status}</span>; })()}</td>
              <td><div style={{display:"flex",gap:3}}>
                {r.status==="confirmed"&&<button className="btn-sm" style={{background:"#e8f5f0",color:"#6bab9e",border:"none",borderRadius:6,padding:"4px 8px",cursor:"pointer",fontSize:11}} onClick={()=>updateStatus(r.id,"completed")}><I name="check" size={11}/> 완료</button>}
                <button className="btn-sm btn-s" onClick={()=>deleteRes(r.id)} style={{padding:"4px 8px"}}><I name="trash" size={13}/></button>
              </div></td>
            </tr>
          })}
      </tbody></table>
    </div>
  </div>;
}

// ═══════════════════════════════════════════
// SALES PAGE (시술/제품 분리, 결제수단 세분화)
// ═══════════════════════════════════════════
function SalesPage({ data, setData, userBranches, isMaster }) {
  const [selDate, setSelDate] = useState(todayStr());
  const [vb, setVb] = useState("all");
  const [tab, setTab] = useState("daily");
  const [showModal, setShowModal] = useState(false);
  const [editSale, setEditSale] = useState(null); // sale being edited
  
  const sales = data.sales.filter(s => {
    const brMatch = (vb==="all"?userBranches.includes(s.bid):s.bid===vb);
    if (tab==="daily") return s.date===selDate && brMatch;
    if (tab==="prev") { const d=new Date(selDate);d.setDate(d.getDate()-1); return s.date===fmtLocal(d) && brMatch; }
    return brMatch;
  });

  const totals = sales.reduce((a,s)=>({
    svcCash:a.svcCash+s.svcCash, svcTransfer:a.svcTransfer+s.svcTransfer, svcCard:a.svcCard+s.svcCard, svcPoint:a.svcPoint+s.svcPoint,
    prodCash:a.prodCash+s.prodCash, prodTransfer:a.prodTransfer+s.prodTransfer, prodCard:a.prodCard+s.prodCard, prodPoint:a.prodPoint+s.prodPoint,
    gift:a.gift+s.gift, svcTotal:a.svcTotal+(s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint), prodTotal:a.prodTotal+(s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint),
    total:a.total+(s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint+s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint+s.gift)
  }),{svcCash:0,svcTransfer:0,svcCard:0,svcPoint:0,prodCash:0,prodTransfer:0,prodCard:0,prodPoint:0,gift:0,svcTotal:0,prodTotal:0,total:0});

  const changeDate = (off) => { const d = new Date(selDate); d.setDate(d.getDate()+off); setSelDate(fmtLocal(d)); };
  const handleDelete = (id) => { setData(prev=>({...prev,sales:prev.sales.filter(s=>s.id!==id)})); sb.del("sales",id).catch(console.error); };
  const handleSave = (item) => { setData(prev=>({...prev,sales:[...prev.sales,item]})); sb.insert("sales",toDb("sales",item)).catch(console.error); setShowModal(false); };
  const handleEditSave = (item) => {
    const finalItem = {...item, id:editSale.id};
    setData(prev=>({...prev, sales: prev.sales.map(s=>s.id===editSale.id ? finalItem : s)}));
    sb.update("sales",editSale.id,toDb("sales",finalItem)).catch(console.error);
    setEditSale(null);
  };

  return <div>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16,flexWrap:"wrap",gap:10}}>
      <h2 className="page-title" style={{marginBottom:0}}>매출 관리</h2>
      <button className="btn-p" onClick={()=>setShowModal(true)}><I name="plus" size={12}/> 매출등록</button>
    </div>
    {/* Tabs */}
    <div style={{display:"flex",gap:2,marginBottom:16,background:"#e0e0e0",borderRadius:8,padding:3,width:"fit-content"}}>
      {[["daily","일매출"],["prev","전일매출"],["all","전체매출"]].map(([k,v])=>(
        <button key={k} className={tab===k?"btn-p btn-sm":"btn-s btn-sm"} onClick={()=>setTab(k)}>{v}</button>
      ))}
    </div>
    {/* Filters */}
    <div style={{display:"flex",gap:10,marginBottom:16,flexWrap:"wrap",alignItems:"center"}}>
      {tab!=="all"&&<div style={{display:"flex",alignItems:"center",gap:4}}>
        <button className="btn-s btn-sm" onClick={()=>changeDate(-1)}><I name="chevL" size={14}/></button>
        <input type="date" className="inp" style={{maxWidth:150,width:"auto"}} value={selDate} onChange={e=>setSelDate(e.target.value)}/>
        <button className="btn-s btn-sm" onClick={()=>changeDate(1)}><I name="chevR" size={14}/></button>
        <button className="btn-s btn-sm" onClick={()=>setSelDate(todayStr())}>오늘</button>
      </div>}
      {<select className="inp" style={{maxWidth:140,width:"auto"}} value={vb} onChange={e=>setVb(e.target.value)}>
        <option value="all">전체 매장</option>
        {(data.branches||[]).map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
      </select>}
    </div>
    {/* Sales Table - like existing admin */}
    <div className="card tw">
      <table><thead><tr>
        <th>번호</th><th>지점</th><th>고객번호</th><th>이름</th><th>핸드폰</th><th>매니저</th>
        <th style={{background:"#e0edf5"}}>매출합계</th>
        <th style={{background:"#e0edf5"}}>시술합계</th><th style={{background:"#e0edf5"}}>시술현금</th><th style={{background:"#e0edf5"}}>시술입금</th><th style={{background:"#e0edf5"}}>시술카드</th><th style={{background:"#e0edf5"}}>시술포인트</th>
        <th style={{background:"#e8f5f0"}}>제품합계</th><th style={{background:"#e8f5f0"}}>제품현금</th><th style={{background:"#e8f5f0"}}>제품입금</th><th style={{background:"#e8f5f0"}}>제품카드</th><th style={{background:"#e8f5f0"}}>제품포인트</th>
        <th style={{background:"#e57373"}}>상품권</th>
        <th>메모</th>
        <th>등록시간</th>
        <th style={{width:60}}>관리</th>
      </tr></thead><tbody>
        {sales.length===0?<tr><td colSpan={21} style={{textAlign:"center",color:"#999",padding:40}}>매출 기록 없음</td></tr>:
          sales.map((s,i)=>{
            const br=(data.branches||[]).find(b=>b.id===s.bid);
            const st=s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint;
            const pt=s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint;
            return <tr key={s.id}>
              <td>{i+1}</td><td>{br?.short}</td>
              <td>{s.custNum}</td>
              <td style={{fontWeight:600}}>{s.custGender && <span style={{color:s.custGender==="M"?"#4a7cc8":"#e57373",marginRight:3}}>{s.custGender==="M"?"남":"여"}</span>}{s.custName||"-"}</td>
              <td style={{color:"#7c7cc8",fontSize:11}}>{s.custPhone}</td>
              <td>{s.staffName}</td>
              <td style={{fontWeight:700,color:"#5cb5c5"}}>{fmt(st+pt+(s.gift||0))}</td>
              <td style={{fontWeight:600,color:"#7c7cc8"}}>{fmt(st)}</td>
              <td>{s.svcCash>0?fmt(s.svcCash):<Z/>}</td><td>{s.svcTransfer>0?fmt(s.svcTransfer):<Z/>}</td>
              <td>{s.svcCard>0?fmt(s.svcCard):<Z/>}</td><td>{s.svcPoint>0?fmt(s.svcPoint):<Z/>}</td>
              <td style={{fontWeight:600,color:"#6bab9e"}}>{fmt(pt)}</td>
              <td>{s.prodCash>0?fmt(s.prodCash):<Z/>}</td><td>{s.prodTransfer>0?fmt(s.prodTransfer):<Z/>}</td>
              <td>{s.prodCard>0?fmt(s.prodCard):<Z/>}</td><td>{s.prodPoint>0?fmt(s.prodPoint):<Z/>}</td>
              <td style={{fontWeight:600,color:"#ef5350"}}>{s.gift>0?fmt(s.gift):<Z/>}</td>
              <td style={{fontSize:10,color:"#888",maxWidth:80,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.memo||""}</td>
              <td style={{fontSize:9,color:"#aaa",whiteSpace:"nowrap"}}>{s.createdAt ? new Date(s.createdAt).toLocaleString("ko-KR",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}) : "-"}</td>
              <td style={{whiteSpace:"nowrap"}}>
                <button className="btn-sm btn-s" style={{padding:"3px 5px",fontSize:10,marginRight:2}} onClick={()=>setEditSale(s)}><I name="edit" size={13}/></button>
                <button className="btn-sm btn-s" style={{padding:"3px 5px",fontSize:10}} onClick={()=>handleDelete(s.id)}><I name="trash" size={13}/></button>
              </td>
            </tr>
          })}
        {/* Totals */}
        {sales.length>0 && <tr style={{background:"#f0f0f0",fontWeight:700}}>
          <td colSpan={6} style={{textAlign:"right",color:"#7c7cc8"}}>합계</td>
          <td style={{color:"#5cb5c5"}}>{fmt(totals.total)}</td>
          <td style={{color:"#7c7cc8"}}>{fmt(totals.svcTotal)}</td>
          <td>{fmt(totals.svcCash)}</td><td>{fmt(totals.svcTransfer)}</td><td>{fmt(totals.svcCard)}</td><td>{fmt(totals.svcPoint)}</td>
          <td style={{color:"#6bab9e"}}>{fmt(totals.prodTotal)}</td>
          <td>{fmt(totals.prodCash)}</td><td>{fmt(totals.prodTransfer)}</td><td>{fmt(totals.prodCard)}</td><td>{fmt(totals.prodPoint)}</td>
          <td style={{color:"#ef5350"}}>{fmt(totals.gift)}</td>
          <td colSpan={3}/>
        </tr>}
      </tbody></table>
    </div>
    {showModal && <DetailedSaleForm
      reservation={{id:uid(),bid:userBranches[0],custId:null,custName:"",custPhone:"",custGender:"",
        staffId:(data.staff||[]).find(s=>s.bid===(userBranches[0]))?.id||"",serviceId:null,date:selDate}}
      branchId={userBranches[0]}
      onSubmit={(sale)=>{handleSave(sale);}}
      onClose={()=>_mc(()=>setShowModal(false))} data={data} setData={setData} />}
    {editSale && <DetailedSaleForm
      reservation={{...editSale, saleMemo:editSale.memo||""}}
      branchId={editSale.bid}
      onSubmit={handleEditSave}
      onClose={()=>_mc(()=>setEditSale(null))} data={data} setData={setData} />}
  </div>;
}

function Z() { return <span style={{color:"#bbb"}}>0</span>; }

// ═══════════════════════════════════════════
// STATISTICS
// ═══════════════════════════════════════════
function StatsPage({ data, userBranches, isMaster, role }) {
  const [period, setPeriod] = useState("7");
  const [vb, setVb] = useState("all");
  const end = new Date(), start = new Date();
  start.setDate(start.getDate() - parseInt(period));
  
  const filtered = data.sales.filter(s => {
    const d = new Date(s.date);
    return d >= start && d <= end && ((vb==="all"?userBranches.includes(s.bid):s.bid===vb));
  });

  const t = filtered.reduce((a,s)=>({
    svcTotal:a.svcTotal+(s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint),
    prodTotal:a.prodTotal+(s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint),
    gift:a.gift+s.gift,
    total:a.total+(s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint+s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint+s.gift),
    count:a.count+1,
    svcCash:a.svcCash+s.svcCash,svcTransfer:a.svcTransfer+s.svcTransfer,svcCard:a.svcCard+s.svcCard,svcPoint:a.svcPoint+s.svcPoint,
    prodCash:a.prodCash+s.prodCash,prodTransfer:a.prodTransfer+s.prodTransfer,prodCard:a.prodCard+s.prodCard,prodPoint:a.prodPoint+s.prodPoint,
  }),{svcTotal:0,prodTotal:0,gift:0,total:0,count:0,svcCash:0,svcTransfer:0,svcCard:0,svcPoint:0,prodCash:0,prodTransfer:0,prodCard:0,prodPoint:0});

  const days = parseInt(period);

  // By staff
  const byStaff = {};
  filtered.forEach(s => {
    if(!byStaff[s.staffName]) byStaff[s.staffName]={count:0,total:0};
    byStaff[s.staffName].count++;
    byStaff[s.staffName].total+=(s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint+s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint+s.gift);
  });
  const staffRank = Object.entries(byStaff).sort((a,b)=>b[1].total-a[1].total);

  // By branch
  const byBranch = {};
  if (isMaster) {
    filtered.forEach(s => {
      const bn = (data.branches||[]).find(b=>b.id===s.bid)?.short||"";
      if(!byBranch[bn]) byBranch[bn]={count:0,total:0};
      byBranch[bn].count++;
      byBranch[bn].total+=(s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint+s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint+s.gift);
    });
  }
  const branchRank = Object.entries(byBranch).sort((a,b)=>b[1].total-a[1].total);

  // Chart data (7 days)
  const chartDays = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    const ds = fmtLocal(d);
    const dayData = data.sales.filter(s=>s.date===ds && ((vb==="all"?userBranches.includes(s.bid):s.bid===vb)));
    const svc = dayData.reduce((a,s)=>a+s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint,0);
    const prod = dayData.reduce((a,s)=>a+s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint,0);
    chartDays.push({label:`${d.getMonth()+1}/${d.getDate()}`,svc,prod,total:svc+prod});
  }
  const maxChart = Math.max(...chartDays.map(d=>d.total),1);

  return <div>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16,flexWrap:"wrap",gap:10}}>
      <h2 className="page-title" style={{marginBottom:0}}>매출 통계</h2>
      <div style={{display:"flex",gap:8}}>
        {<select className="inp" style={{maxWidth:130,width:"auto"}} value={vb} onChange={e=>setVb(e.target.value)}>
          <option value="all">전체 매장</option>
          {(data.branches||[]).map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
        </select>}
        <select className="inp" style={{maxWidth:110,width:"auto"}} value={period} onChange={e=>setPeriod(e.target.value)}>
          <option value="7">7일</option><option value="14">14일</option><option value="30">30일</option>
        </select>
      </div>
    </div>
    {/* Summary Cards */}
    <div className="stat-cards" style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(160px,1fr))",gap:12,marginBottom:20}}>
      <SC label="총 매출" val={`${fmt(t.total)}원`} sub={`${t.count}건`} clr="#5cb5c5"/>
      <SC label="시술 매출" val={`${fmt(t.svcTotal)}원`} sub="시술 합계" clr="#7c7cc8"/>
      <SC label="제품 매출" val={`${fmt(t.prodTotal)}원`} sub="제품 합계" clr="#6bab9e"/>
      <SC label="상품권" val={`${fmt(t.gift)}원`} sub="상품권 합계" clr="#ef5350"/>
      <SC label="일 평균" val={`${fmt(Math.round(t.total/days))}원`} sub={`${days}일 평균`} clr="#5cb5c5"/>
      <SC label="객단가" val={`${fmt(t.count>0?Math.round(t.total/t.count):0)}원`} sub="건당 평균" clr="#d0d0d0"/>
    </div>
    {/* Chart */}
    <div className="card" style={{padding:20,marginBottom:16}}>
      <div style={{fontSize:13,fontWeight:700,color:"#888",marginBottom:16}}>최근 7일 매출 (시술 + 제품)</div>
      <div style={{display:"flex",alignItems:"flex-end",gap:6,height:130}}>
        {chartDays.map((d,i)=>(
          <div key={i} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:4}}>
            <span style={{fontSize:9,color:"#888"}}>{d.total>0?`${fmt(Math.round(d.total/10000))}만`:""}</span>
            <div style={{width:"100%",display:"flex",flexDirection:"column",gap:1}}>
              <div style={{width:"100%",height:`${Math.max((d.prod/maxChart)*80,0)}px`,background:"#6bab9e",borderRadius:"4px 4px 0 0",transition:"height .3s"}}/>
              <div style={{width:"100%",height:`${Math.max((d.svc/maxChart)*80,2)}px`,background:"#7c7cc8",borderRadius:"0 0 4px 4px",transition:"height .3s"}}/>
            </div>
            <span style={{fontSize:10,color:"#999"}}>{d.label}</span>
          </div>
        ))}
      </div>
      <div style={{display:"flex",gap:12,justifyContent:"center",marginTop:10}}>
        <span style={{fontSize:10,display:"flex",alignItems:"center",gap:4}}><span style={{width:8,height:8,borderRadius:2,background:"#7c7cc8"}}/>시술</span>
        <span style={{fontSize:10,display:"flex",alignItems:"center",gap:4}}><span style={{width:8,height:8,borderRadius:2,background:"#6bab9e"}}/>제품</span>
      </div>
    </div>
    <div className="stat-charts" style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(300px,1fr))",gap:16}}>
      {/* Payment Breakdown */}
      <div className="card" style={{padding:20}}>
        <div style={{fontSize:13,fontWeight:700,color:"#888",marginBottom:14}}>결제수단별 시술 매출</div>
        {[["현금",t.svcCash,"#6bab9e"],["입금",t.svcTransfer,"#ef5350"],["카드",t.svcCard,"#7c7cc8"],["포인트",t.svcPoint,"#d0d0d0"]].map(([l,v,c])=>(
          <div key={l} style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,fontSize:13}}>
            <span style={{width:45,color:c,fontWeight:600}}>{l}</span>
            <div style={{flex:1,height:6,background:"#e0e0e0",borderRadius:3,overflow:"hidden"}}>
              <div style={{height:"100%",width:`${t.svcTotal>0?(v/t.svcTotal)*100:0}%`,background:c,borderRadius:3}}/>
            </div>
            <span style={{width:80,textAlign:"right",fontWeight:600}}>{fmt(v)}원</span>
          </div>
        ))}
      </div>
      {/* Staff Rank */}
      <div className="card" style={{padding:20}}>
        <div style={{fontSize:13,fontWeight:700,color:"#888",marginBottom:14}}>매니저별 매출</div>
        {staffRank.slice(0,8).map(([n,v],i)=>(
          <div key={i} style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,fontSize:13}}>
            <span style={{width:18,color:i<3?"#5cb5c5":"#d0d0d0",fontWeight:700}}>{i+1}</span>
            <span style={{flex:1,fontWeight:500}}>{n}</span>
            <span style={{color:"#888",fontSize:11}}>{v.count}건</span>
            <span style={{fontWeight:700,color:"#5cb5c5",width:80,textAlign:"right"}}>{fmt(v.total)}원</span>
          </div>
        ))}
      </div>
      {/* Branch Rank (master) */}
      {isMaster && <div className="card" style={{padding:20}}>
        <div style={{fontSize:13,fontWeight:700,color:"#888",marginBottom:14}}>매장별 매출</div>
        {branchRank.map(([n,v],i)=>(
          <div key={i} style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,fontSize:13}}>
            <span style={{width:18,color:i<3?"#7c7cc8":"#d0d0d0",fontWeight:700}}>{i+1}</span>
            <span style={{width:55,fontWeight:600}}>{n}</span>
            <div style={{flex:1,height:6,background:"#e0e0e0",borderRadius:3,overflow:"hidden"}}>
              <div style={{height:"100%",width:`${branchRank[0][1].total>0?(v.total/branchRank[0][1].total)*100:0}%`,background:"linear-gradient(90deg,#5cb5c5,#7c7cc8)",borderRadius:3}}/>
            </div>
            <span style={{fontWeight:700,width:85,textAlign:"right"}}>{fmt(v.total)}원</span>
          </div>
        ))}
      </div>}
    </div>
  </div>;
}

function SC({label,val,sub,clr}) {
  return <div style={{padding:16,borderRadius:10,background:"linear-gradient(135deg,#fff,#f0f0f0)",border:"1px solid #e0e0e0"}}>
    <div style={{fontSize:11,color:"#999",fontWeight:600}}>{label}</div>
    <div style={{fontSize:20,fontWeight:800,color:clr,letterSpacing:-.5,marginTop:4}}>{val}</div>
    <div style={{fontSize:10,color:"#bbb",marginTop:2}}>{sub}</div>
  </div>;
}

// ═══════════════════════════════════════════
// CUSTOMERS
// ═══════════════════════════════════════════
function CustomersPage({ data, setData, userBranches, isMaster }) {
  const [q, setQ] = useState("");
  const [vb, setVb] = useState("all");
  const [showModal, setShowModal] = useState(false);
  const [editItem, setEditItem] = useState(null);
  const [detailCust, setDetailCust] = useState(null);

  const custs = data.customers.filter(c => {
    const bm = (vb==="all"?userBranches.includes(c.bid):c.bid===vb);
    const sm = !q||c.name.includes(q)||c.phone.includes(q);
    return bm&&sm;
  }).sort((a,b)=>b.visits-a.visits);

  const handleSave = (item) => {
    setData(prev=>{
      const ex=prev.customers.find(c=>c.id===item.id);
      if(ex) { sb.update("customers",item.id,toDb("customers",item)).catch(console.error); return {...prev,customers:prev.customers.map(c=>c.id===item.id?item:c)}; }
      sb.insert("customers",toDb("customers",item)).catch(console.error);
      return {...prev,customers:[...prev.customers,item]};
    }); setShowModal(false); setEditItem(null);
  };

  // 선택된 고객의 매출 내역
  const custSales = detailCust ? (data.sales||[]).filter(s=>s.custId===detailCust.id).sort((a,b)=>b.date.localeCompare(a.date)) : [];

  return <div>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16,flexWrap:"wrap",gap:10}}>
      <h2 className="page-title" style={{marginBottom:0}}>고객 관리</h2>
      <button className="btn-p" onClick={()=>{setEditItem(null);setShowModal(true)}}><I name="plus" size={12}/> 고객 등록</button>
    </div>
    <div style={{display:"flex",gap:10,marginBottom:16,flexWrap:"wrap",alignItems:"center"}}>
      <div style={{position:"relative",flex:1,minWidth:180}}>
        <span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",color:"#999",fontSize:14}}><I name="search" size={14} color="#999"/></span>
        <input className="inp" style={{paddingLeft:32}} placeholder="이름 또는 전화번호 검색..." value={q} onChange={e=>setQ(e.target.value)}/>
      </div>
      {<select className="inp" style={{maxWidth:140,width:"auto"}} value={vb} onChange={e=>setVb(e.target.value)}>
        <option value="all">전체 매장</option>{(data.branches||[]).filter(b=>userBranches.includes(b.id)).map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
      </select>}
      <span style={{fontSize:12,color:"#888"}}>{custs.length}명</span>
    </div>
    <div className="card tw">
      <table><thead><tr>
        <th>매장</th><th>고객번호</th><th>이름</th><th>연락처</th><th>성별</th><th>방문수</th><th>최초등록일</th><th>최근방문</th><th>메모</th><th>관리</th>
      </tr></thead><tbody>
        {custs.length===0?<tr><td colSpan={10} style={{textAlign:"center",color:"#999",padding:40}}>고객 없음</td></tr>:
          custs.map(c=>{
            const br=(data.branches||[]).find(b=>b.id===c.bid);
            const isDetail = detailCust?.id===c.id;
            return <React.Fragment key={c.id}>
              <tr style={{cursor:"pointer",background:isDetail?"#f0f0ff":"transparent"}} onClick={()=>setDetailCust(isDetail?null:c)}>
                <td>{br?.short}</td>
                <td style={{color:"#888"}}>{c.custNum}</td>
                <td style={{fontWeight:600}}>{c.name}</td>
                <td style={{color:"#7c7cc8",fontSize:12}}>{c.phone}</td>
                <td><span style={{color:c.gender==="M"?"#4a7cc8":"#e57373"}}>{c.gender==="F"?"여":"남"}</span></td>
                <td><span style={{fontWeight:700,color:c.visits>=5?"#5cb5c5":"#999"}}>{c.visits}회</span></td>
                <td style={{color:"#888",fontSize:11}}>{c.createdAt ? new Date(c.createdAt).toLocaleDateString("ko-KR") : "-"}</td>
                <td style={{color:"#888",fontSize:11}}>{c.lastVisit||"-"}</td>
                <td style={{color:"#888",fontSize:12,whiteSpace:"pre-wrap",wordBreak:"break-word",maxWidth:200}}>{c.memo||"-"}</td>
                <td onClick={e=>e.stopPropagation()}>
                  <button className="btn-sm btn-s" onClick={()=>{setEditItem(c);setShowModal(true)}}><I name="edit" size={13}/></button>
                </td>
              </tr>
              {isDetail && <tr><td colSpan={10} style={{padding:0,background:"#f8f8ff"}}>
                <div style={{padding:"12px 16px"}}>
                  <div style={{fontSize:12,fontWeight:700,color:"#7c7cc8",marginBottom:8}}><I name="clipboard" size={12}/> 매출 내역 ({custSales.length}건)</div>
                  {custSales.length===0 ? <div style={{fontSize:11,color:"#999",padding:8}}>매출 기록 없음</div> :
                    <table style={{width:"100%",fontSize:11}}><thead><tr style={{background:"#e8e8f8"}}>
                      <th>날짜</th><th>매장</th><th>담당자</th><th>시술합계</th><th>제품합계</th><th>총합계</th><th>메모</th>
                    </tr></thead><tbody>
                      {custSales.map(s=>{
                        const st=s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint;
                        const pt=s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint;
                        return <tr key={s.id}>
                          <td>{s.date}</td>
                          <td>{(data.branches||[]).find(b=>b.id===s.bid)?.short}</td>
                          <td>{s.staffName}</td>
                          <td style={{color:"#7c7cc8",fontWeight:600}}>{fmt(st)}</td>
                          <td style={{color:"#6bab9e",fontWeight:600}}>{fmt(pt)}</td>
                          <td style={{color:"#5cb5c5",fontWeight:700}}>{fmt(st+pt+(s.gift||0))}</td>
                          <td style={{color:"#888",maxWidth:120,overflow:"hidden",textOverflow:"ellipsis"}}>{s.memo||"-"}</td>
                        </tr>;
                      })}
                    </tbody></table>}
                </div>
              </td></tr>}
            </React.Fragment>;
          })}
      </tbody></table>
    </div>
    {showModal && <CustModal item={editItem} onSave={handleSave} onClose={()=>_mc(()=>{setShowModal(false);setEditItem(null)})} defBranch={userBranches[0]} userBranches={userBranches} branches={data.branches||[]}/>}
  </div>;
}

function CustModal({ item, onSave, onClose, defBranch, userBranches, branches }) {
  const [f, setF] = useState(item || { id:uid(), bid:defBranch, name:"", phone:"", gender:"", visits:0, lastVisit:null, memo:"", custNum:String(50000+Math.floor(Math.random()*10000)) });
  const set = (k,v) => setF(p=>({...p,[k]:v}));
  return <div className="ov" onClick={onClose}>
    <div className="modal" onClick={e=>e.stopPropagation()}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
        <h3 style={{fontSize:16,fontWeight:700}}>{item?"고객 수정":"새 고객"}</h3>
        <button onClick={onClose} className="close-btn"><I name="x" size={16}/></button>
      </div>
      <div className="form-col">
        <FLD label="매장"><select className="inp" value={f.bid} onChange={e=>set("bid",e.target.value)}>{(branches||[]).filter(b=>userBranches.includes(b.id)).map(b=><option key={b.id} value={b.id}>{b.name}</option>)}</select></FLD>
        <div className="grid2">
          <FLD label="이름"><input className="inp" value={f.name} onChange={e=>set("name",e.target.value)}/></FLD>
          <FLD label="연락처"><input className="inp" value={f.phone} onChange={e=>set("phone",e.target.value)} placeholder="010-0000-0000"/></FLD>
        </div>
        <FLD label="성별"><select className="inp" value={f.gender} onChange={e=>set("gender",e.target.value)}><option value="">선택</option><option value="F">여성</option><option value="M">남성</option></select></FLD>
        <FLD label="메모"><textarea className="inp" rows={2} value={f.memo} onChange={e=>set("memo",e.target.value)}/></FLD>
        <button className="btn-p" style={{width:"100%",justifyContent:"center",padding:12}} onClick={()=>{if(!f.gender){alert("고객 성별을 선택해주세요.");return;}onSave(f)}}>{item?"수정":"등록"}</button>
      </div>
    </div>
  </div>;
}

// ═══════════════════════════════════════════
// USERS MANAGEMENT (마스터 전용)
// ═══════════════════════════════════════════
function UsersPage({ data, setData, bizId }) {
  const [editId, setEditId] = useState(null);
  const [form, setForm] = useState(null);
  const users = data.users || [];
  const regBranches = (data.branchSettings || data.branches || []).filter(b => b.useYn !== false);

  const startAdd = () => { setEditId("new"); setForm({ name:"", loginId:"", pw:"", role:"staff", branches:[], viewBranches:[] }); };
  const startEdit = (u) => { setEditId(u.id); setForm({ ...u, viewBranches: u.viewBranches||[] }); };
  const save = (finalForm) => {
    const f = finalForm || form;
    if (!f.name || !f.loginId || !f.pw) { alert("이름, 아이디, 비밀번호를 모두 입력하세요."); return; }
    if (f.role === "staff" && (!f.branches || f.branches.length === 0)) { alert("직원은 담당 지점을 1개 이상 선택하세요."); return; }
    const userData = { ...f, viewBranches: f.viewBranches||[], businessId: bizId };
    setData(prev => {
      const us = [...(prev.users || [])];
      if (editId === "new") {
        const newUser = { ...userData, id: "acc_" + uid() };
        us.push(newUser);
        sb.insert("app_users", toDb("app_users", newUser)).catch(console.error);
      } else {
        const idx = us.findIndex(u => u.id === editId);
        if (idx >= 0) { us[idx] = { ...userData }; sb.update("app_users", editId, toDb("app_users", userData)).catch(console.error); }
      }
      return { ...prev, users: us };
    });
    setEditId(null); setForm(null);
  };
  const remove = (id) => {
    setData(prev => ({ ...prev, users: (prev.users || []).filter(u => u.id !== id) }));
    sb.del("app_users", id).catch(console.error);
  };

  return <div>
    <h2 className="page-title">사용자 관리</h2>
    <div style={{display:"flex",gap:8,marginBottom:12}}>
      <button className="btn-p" onClick={startAdd}><I name="plus" size={12}/> 사용자 추가</button>
      <span style={{fontSize:12,color:"#888",display:"flex",alignItems:"center"}}>{users.length}개 계정</span>
    </div>
    <div className="card tw">
      <table><thead><tr>
        <th>이름</th><th>아이디</th><th>비밀번호</th><th>유형</th><th>담당 지점</th><th>열람 지점</th><th>관리</th>
      </tr></thead><tbody>
        {users.map(u => {
          if (editId === u.id && form) return <UserEditRow key={u.id} init={form} regBranches={regBranches} allBranches={data.branches||[]} onSave={save} onCancel={()=>{setEditId(null);setForm(null)}} isNew={false}/>;
          const roleLabel = u.role==="owner" ? "대표" : "직원";
          const roleBg = u.role==="owner" ? "#7c7cc815" : "#f5f5f5";
          const roleClr = u.role==="owner" ? "#7c7cc8" : "#888";
          return <tr key={u.id}>
            <td style={{fontWeight:600}}>{u.name}</td>
            <td style={{color:"#7c7cc8"}}>{u.loginId||u.login_id}</td>
            <td style={{color:"#aaa"}}>{"•".repeat((u.pw||u.password||"").length)}</td>
            <td><span style={{fontSize:10,padding:"2px 8px",borderRadius:10,background:roleBg,color:roleClr,fontWeight:600}}>{roleLabel}</span></td>
            <td style={{fontSize:11,color:"#555"}}>{u.role==="owner"?"전체 지점":(u.branches||[]).map(bid=>(data.branches||[]).find(b=>b.id===bid)?.short).filter(Boolean).join(", ")}</td>
            <td style={{fontSize:11,color:"#5cb5c5"}}>{u.role==="owner"?"-":(u.viewBranches||[]).map(bid=>(data.branches||[]).find(b=>b.id===bid)?.short).filter(Boolean).join(", ")||"-"}</td>
            <td style={{display:"flex",gap:4}}>
              <button className="btn-s" style={{padding:"4px 10px",fontSize:11}} onClick={()=>startEdit(u)}>수정</button>
              <button className="btn-d" style={{padding:"4px 10px",fontSize:11}} onClick={()=>remove(u.id)}>삭제</button>
            </td>
          </tr>;
        })}
        {editId === "new" && form && <UserEditRow key="new" init={form} regBranches={regBranches} allBranches={data.branches||[]} onSave={save} onCancel={()=>{setEditId(null);setForm(null)}} isNew={true}/>}
      </tbody></table>
    </div>
    <div style={{marginTop:16,padding:12,background:"#f9f9f9",borderRadius:6,fontSize:11,color:"#888",lineHeight:1.8}}>
      <b>권한 안내</b><br/>
      · 대표: 전 지점 예약/매출 조회·편집, 사용자·관리설정 접근<br/>
      · 직원: 담당 지점 예약/매출 조회·편집, 열람 지점 타임라인 읽기 전용
    </div>
  </div>;
}

// Separate top-level component — won't re-create on parent re-render
function UserEditRow({ init, regBranches, allBranches, onSave, onCancel, isNew }) {
  const [f, setF] = useState({...init});
  const set = (k, v) => setF(p => ({...p, [k]: v}));

  const MultiSelect = ({selected, onChange, color="#7c7cc8"}) => {
    const [open, setOpen] = useState(false);
    const toggle = (bid) => { onChange(selected.includes(bid) ? selected.filter(x=>x!==bid) : [...selected, bid]); };
    const label = selected.length === 0 ? "선택" : regBranches.filter(b=>selected.includes(b.id)).map(b=>b.short||b.name).join(", ");
    return <div style={{position:"relative"}}>
      <div onClick={()=>setOpen(!open)} className="inp" style={{width:140,cursor:"pointer",fontSize:11,display:"flex",justifyContent:"space-between",alignItems:"center",minHeight:30}}>
        <span style={{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:selected.length?"#333":"#aaa"}}>{label}</span>
        <span style={{fontSize:8,color:"#999"}}>{open?<I name="chevU" size={12}/>:<I name="chevD" size={12}/>}</span>
      </div>
      {open && <div style={{position:"absolute",top:"100%",left:0,right:0,background:"#fff",border:"1px solid #d0d0d0",borderRadius:4,zIndex:50,maxHeight:160,overflowY:"auto",boxShadow:"0 4px 12px rgba(0,0,0,.1)"}}>
        {regBranches.map(b => {
          const on = selected.includes(b.id);
          return <div key={b.id} onClick={()=>toggle(b.id)} style={{padding:"6px 10px",fontSize:11,cursor:"pointer",display:"flex",alignItems:"center",gap:6,background:on?color+"10":"transparent"}}>
            <div style={{width:14,height:14,borderRadius:3,border:`1.5px solid ${on?color:"#ccc"}`,background:on?color:"transparent",display:"flex",alignItems:"center",justifyContent:"center"}}>
              {on && <span style={{color:"#fff",fontSize:9,fontWeight:700}}><I name="check" size={10}/></span>}
            </div>
            <span style={{color:on?color:"#555"}}>{b.short||b.name}</span>
          </div>;
        })}
      </div>}
    </div>;
  };

  return <tr style={{background:"#f5f5ff"}}>
    <td><input className="inp" style={{width:80}} placeholder={isNew?"이름":""} value={f.name} onChange={e=>set("name",e.target.value)}/></td>
    <td><input className="inp" style={{width:80}} placeholder={isNew?"아이디":""} value={f.loginId} onChange={e=>set("loginId",e.target.value)}/></td>
    <td><input className="inp" style={{width:80}} placeholder={isNew?"비밀번호":""} value={f.pw} onChange={e=>set("pw",e.target.value)}/></td>
    <td><select className="inp" style={{width:80}} value={f.role} onChange={e=>set("role",e.target.value)}>
      <option value="owner">대표</option><option value="staff">직원</option>
    </select></td>
    <td>{f.role==="owner" ? <span style={{fontSize:11,color:"#7c7cc8"}}>전체 지점</span> :
      <MultiSelect selected={f.branches||[]} onChange={v=>set("branches",v)} color="#7c7cc8"/>}</td>
    <td>{f.role==="owner" ? <span style={{fontSize:11,color:"#999"}}>-</span> :
      <MultiSelect selected={f.viewBranches||[]} onChange={v=>set("viewBranches",v)} color="#5cb5c5"/>}</td>
    <td style={{display:"flex",gap:4}}>
      <button className="btn-p" style={{padding:"4px 10px",fontSize:11}} onClick={()=>onSave(f.role==="owner"?{...f,branches:allBranches.map(b=>b.id)}:f)}>{isNew?"추가":"저장"}</button>
      <button className="btn-s" style={{padding:"4px 10px",fontSize:11}} onClick={onCancel}>취소</button>
    </td>
  </tr>;
}

// ═══════════════════════════════════════════
// ADMIN
// ═══════════════════════════════════════════
function AdminPage({ data, setData, bizId }) {
  const [tab, setTabRaw] = useState(() => {
    try { const t = sessionStorage.getItem("bliss_adminTab"); console.log("[SESSION] adminTab restore:", t); return t || "places"; } catch(e){ return "places"; }
  });
  const setTab = useCallback((t) => {
    console.log("[SESSION] adminTab save:", t);
    setTabRaw(t);
    try { sessionStorage.setItem("bliss_adminTab", t); } catch(e){}
  }, []);
  return <div>
    <h2 className="page-title">관리 설정</h2>
    <div style={{display:"flex",gap:2,marginBottom:16,background:"#e0e0e0",borderRadius:8,padding:3,width:"fit-content",flexWrap:"wrap"}}>
      {[["places","예약장소관리"],["workers","담당자관리"],["saleitems","시술상품관리"],["prodmgmt","제품관리"],["svctags","서비스태그관리"]].map(([k,v])=>(
        <button key={k} className={tab===k?"btn-p btn-sm":"btn-s btn-sm"} onClick={()=>setTab(k)}>{v}</button>
      ))}
    </div>
    {tab==="places" && <AdminPlaces data={data} setData={setData} bizId={bizId}/>}
    {tab==="workers" && <AdminWorkers data={data} setData={setData}/>}
    {tab==="saleitems" && <AdminSaleItems data={data} setData={setData}/>}
    {tab==="prodmgmt" && <AdminProductItems data={data} setData={setData}/>}
    {tab==="svctags" && <AdminServiceTags data={data} setData={setData}/>}
  </div>;
}

// ─── 예약장소관리 (myCream style) ───
function AdminPlaces({ data, setData, bizId }) {
  const branches = data.branchSettings || (data.branches||[]).map(b => ({...b, color: "#FFFFFF", useYn: true}));
  const [edited, setEdited] = useState({});
  const [deleteId, setDeleteId] = useState(null);
  const [expandedCard, setExpandedCard] = useState(null);
  const cardRects = useRef({});
  const [dragIdx, setDragIdx] = useState(null);
  const [dragOverIdx, setDragOverIdx] = useState(null);
  const [selected, setSelected] = useState(new Set());
  const fileRef = useRef(null);

  const allChecked = branches.length > 0 && branches.every(b => selected.has(b.id));
  const toggleAll = () => { if (allChecked) setSelected(new Set()); else setSelected(new Set(branches.map(b => b.id))); };
  const toggleOne = (id) => setSelected(prev => { const s = new Set(prev); s.has(id)?s.delete(id):s.add(id); return s; });
  const bulkDelete = () => {
    if (selected.size === 0) return;
    if (!window.confirm(selected.size + "개 지점을 삭제하시겠습니까?")) return;
    selected.forEach(id => sb.del("branches", id).catch(console.error));
    setData(prev => ({...prev, branchSettings:(prev.branchSettings||[]).filter(x=>!selected.has(x.id)), branches:(prev.branches||[]).filter(x=>!selected.has(x.id))}));
    setSelected(new Set());
  };

  const updateField = (id, field, value) => {
    setData(prev => {
      const updated = (prev.branchSettings || (data.branches||[]).map(b=>({...b,color:"#FFFFFF",useYn:true}))).map(b => b.id===id ? {...b, [field]:value} : b);
      return {...prev, branchSettings: updated, branches: updated};
    });
    setEdited(prev => ({...prev, [id]: true}));
  };
  const applyRow = (id) => {
    const b = branches.find(x=>x.id===id);
    if(b) sb.update("branches", id, {name:b.name, short:b.short||b.name, phone:b.phone||"", address:b.address||"", color:b.color||"#FFFFFF", use_yn:b.useYn!==false, naver_email:b.naverEmail||"", naver_biz_id:b.naverBizId||"", naver_col_count:b.naverColCount||0}).catch(console.error);
    setEdited(prev => { const n={...prev}; delete n[id]; return n; });
  };
  const addBranch = () => {
    const bName = prompt("지점명을 입력하세요", "");
    if(!bName || !bName.trim()) return;
    const newId = "br_" + uid();
    const newBranch = {id:newId, name:bName.trim(), short:bName.trim(), phone:"", address:"", color:"#FFFFFF", useYn:true, business_id:bizId};
    setData(prev => ({...prev, branchSettings:[...(prev.branchSettings||[]), newBranch], branches:[...(prev.branches||[]), newBranch]}));
    sb.insert("branches", {id:newId, business_id:bizId||_activeBizId, name:bName.trim(), short:bName.trim(), phone:"", address:"", color:"#FFFFFF", sort:branches.length, use_yn:true}).catch(console.error);
    setEdited(prev => ({...prev, [newId]: true}));
  };
  const deleteBranch = (id) => {
    setData(prev => ({...prev, branchSettings:(prev.branchSettings||[]).filter(x=>x.id!==id), branches:(prev.branches||[]).filter(x=>x.id!==id)}));
    sb.del("branches", id).catch(console.error);
    setDeleteId(null);
  };

  // Excel download
  const downloadExcel = () => {
    const rows = branches.map((b,i) => ({지점명:b.name, 약칭:b.short||"", 전화:b.phone||"", 주소:b.address||"", 색상:b.color||"", 사용:b.useYn!==false?"Y":"N"}));
    XL.download(rows, "지점목록.xlsx", "지점", ["지점명","약칭","전화","주소","색상","사용"]);
  };
  // Excel upload
  const uploadExcel = (e) => {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const wb = XLSX.read(ev.target.result, {type:"array"});
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      const newBranches = rows.map((r,i) => ({
        id:"br_"+uid(), name:r["지점명"]||r["name"]||"", short:r["약칭"]||r["short"]||"", phone:r["전화"]||r["phone"]||"",
        address:r["주소"]||r["address"]||"", color:r["색상"]||r["color"]||"#FFFFFF", useYn:(r["사용"]||"Y")!=="N", business_id:bizId
      }));
      if(newBranches.length && confirm(`${newBranches.length}개 지점을 추가하시겠습니까?`)) {
        newBranches.forEach(b => sb.insert("branches", {id:b.id, business_id:bizId||_activeBizId, name:b.name, short:b.short, phone:b.phone, address:b.address, color:b.color, sort:0, use_yn:b.useYn}).catch(console.error));
        setData(prev => ({...prev, branchSettings:[...(prev.branchSettings||[]),...newBranches], branches:[...(prev.branches||[]),...newBranches]}));
      }
    };
    reader.readAsArrayBuffer(file); e.target.value="";
  };

  // Drag reorder
  const handleDragEnd = () => {
    if (dragIdx !== null && dragOverIdx !== null && dragIdx !== dragOverIdx) {
      const reordered = [...branches];
      const [moved] = reordered.splice(dragIdx, 1);
      reordered.splice(dragOverIdx, 0, moved);
      setData(prev => ({...prev, branchSettings: reordered}));
    }
    setDragIdx(null); setDragOverIdx(null);
  };

  // Touch drag
  const touchStartRef = useRef(null);
  const touchRowRef = useRef(null);
  const handleTouchStart = (i, e) => { const tag=e.target.tagName;if(tag==="INPUT"||tag==="SELECT"||tag==="BUTTON"||tag==="TEXTAREA")return; touchStartRef.current = e.touches[0].clientY; touchRowRef.current = i; setDragIdx(i); };
  const handleTouchMove = (e) => {
    if (touchStartRef.current === null) return;
    const dy = e.touches[0].clientY - touchStartRef.current;
    const newIdx = Math.max(0, Math.min(branches.length - 1, touchRowRef.current + Math.round(dy / 52)));
    setDragOverIdx(newIdx);
  };
  const handleTouchEnd = () => { handleDragEnd(); touchStartRef.current = null; touchRowRef.current = null; };

  const isMobileView = window.innerWidth <= 768;

  return <div>
    <div className={isMobileView?undefined:"card"} style={{padding:isMobileView?0:20}}>
      <AdminHeader title="예약장소 관리" count={branches.length} onAdd={addBranch} addLabel={<><I name="plus" size={12}/> 지점 추가</>} onDownload={downloadExcel} onUpload={uploadExcel}/>
      {selected.size > 0 && <div style={{marginBottom:8}}><button className="btn-d btn-sm" onClick={bulkDelete} style={{fontSize:10,padding:"4px 12px"}}><I name="trash" size={12}/> 선택 삭제 ({selected.size})</button></div>}

      {/* ═══ Desktop: Table ═══ */}
      {!isMobileView && <div className="tw">
        <table><thead><tr>
          <th style={{width:30}}><input type="checkbox" checked={allChecked} onChange={toggleAll}/></th>
          <th style={{width:30}}></th>
          <th style={{width:40}}>번호</th>
          <th style={{width:100}}>지점명</th>
          <th>주소</th>
          <th style={{width:140}}>전화번호</th>
          <th style={{width:180}}>네이버연동 Gmail</th>
          <th style={{width:100}}>네이버 Biz ID</th>
          <th style={{width:60}}>네이버칼럼</th>
          <th style={{width:80}}>사용구분</th>
          <th style={{width:140}}>표시색상</th>
          <th style={{width:55}}>적용</th>
          <th style={{width:50}}>삭제</th>
        </tr></thead>
        <tbody onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
          {branches.map((b,i) => (
            <tr key={b.id}
              draggable onDragStart={()=>setDragIdx(i)} onDragOver={e=>{e.preventDefault();setDragOverIdx(i)}} onDragEnd={handleDragEnd}
              onTouchStart={e=>handleTouchStart(i,e)}
              style={{
                background: dragOverIdx===i ? "#7c7cc815" : edited[b.id] ? "rgba(167,139,250,.05)" : "transparent",
                opacity: dragIdx===i ? 0.4 : 1, cursor:"grab", touchAction:"none"
              }}>
              <td><input type="checkbox" checked={selected.has(b.id)} onChange={()=>toggleOne(b.id)}/></td>
              <td style={{textAlign:"center"}}><I name="grip" size={14} color="#999"/></td>
              <td style={{color:"#888",textAlign:"center"}}>{i+1}</td>
              <td><input className="inp" value={b.name} onChange={e=>updateField(b.id,"name",e.target.value)} style={{background:"transparent",border:"1px solid #d0d0d0",fontWeight:600}}/></td>
              <td><input className="inp" value={b.address||""} onChange={e=>updateField(b.id,"address",e.target.value)} style={{background:"transparent",border:"1px solid #d0d0d0",width:"100%"}} placeholder="고객 안내용 주소"/></td>
              <td><input className="inp" value={b.phone||""} onChange={e=>updateField(b.id,"phone",e.target.value)} style={{background:"transparent",border:"1px solid #d0d0d0",fontSize:11}}/></td>
              <td><input className="inp" value={b.naverEmail||""} onChange={e=>updateField(b.id,"naverEmail",e.target.value)} style={{background:"transparent",border:"1px solid #d0d0d0",fontSize:11}} placeholder="example@gmail.com"/></td>
              <td><input className="inp" value={b.naverBizId||""} onChange={e=>updateField(b.id,"naverBizId",e.target.value)} style={{background:"transparent",border:"1px solid #d0d0d0",fontSize:11}} placeholder="449920"/></td>
              <td>{b.naverEmail ? <input type="number" className="inp" value={b.naverColCount||1} min={1} max={5} onChange={e=>updateField(b.id,"naverColCount",Math.max(1,Math.min(5,parseInt(e.target.value)||1)))} style={{background:"transparent",border:"1px solid #d0d0d0",fontSize:11,width:40,textAlign:"center"}}/> : <span style={{color:"#ccc",fontSize:10}}>\u2014</span>}</td>
              <td><select className="inp" value={b.useYn!==false?"사용":"미사용"} onChange={e=>updateField(b.id,"useYn",e.target.value==="사용")} style={{background:"transparent",border:"1px solid #d0d0d0",fontSize:11}}><option>사용</option><option>미사용</option></select></td>
              <td><div style={{display:"flex",alignItems:"center",gap:4}}>
                <input type="color" value={b.color||"#FFFFFF"} onChange={e=>updateField(b.id,"color",e.target.value)} style={{width:24,height:24,border:"none",background:"none",cursor:"pointer",padding:0}}/>
                <EyeDrop onPick={c=>updateField(b.id,"color",c)} size={24}/>
                <input className="inp" value={b.color||""} onChange={e=>updateField(b.id,"color",e.target.value)} style={{width:72,background:b.color||"transparent",border:"1px solid #d0d0d0",fontSize:10,fontFamily:"monospace",color:"#333"}}/>
              </div></td>
              <td><button className={edited[b.id]?"btn-p btn-sm":"btn-s btn-sm"} onClick={()=>applyRow(b.id)} style={{padding:"4px 10px"}}>적용</button></td>
              <td>{deleteId===b.id ? <div style={{display:"flex",gap:3}}>
                <button onClick={()=>deleteBranch(b.id)} style={{padding:"2px 8px",fontSize:10,fontWeight:700,borderRadius:4,border:"none",background:"#e57373",color:"#fff",cursor:"pointer",fontFamily:"inherit"}}>확인</button>
                <button onClick={()=>setDeleteId(null)} style={{padding:"2px 6px",fontSize:10,borderRadius:4,border:"1px solid #d0d0d0",background:"#fff",color:"#888",cursor:"pointer",fontFamily:"inherit"}}>취소</button>
              </div> : <button onClick={()=>setDeleteId(b.id)} style={{background:"none",border:"none",cursor:"pointer",color:"#e57373"}}><I name="trash" size={13}/></button>}</td>
            </tr>
          ))}
        </tbody></table>
      </div>}

      {/* ═══ Mobile: iPhone folder-style cards ═══ */}
      {isMobileView && <>
      {/* Expanded card overlay */}
      {expandedCard && <>{(() => {
        const b = branches.find(x=>x.id===expandedCard);
        if(!b) return null;
        const INP = {fontSize:16,border:"none",background:"transparent",padding:"12px 0",borderRadius:0,outline:"none",fontFamily:"inherit",color:"#333",WebkitTapHighlightColor:"transparent",width:"100%"};
        const closeCard = () => {
          const modal = document.getElementById("place-modal");
          const overlay = document.getElementById("place-overlay");
          const rect = cardRects.current[b.id];
          if(modal && rect) {
            const vw = window.innerWidth, vh = window.innerHeight;
            const modalRect = modal.getBoundingClientRect();
            const sx = rect.width / modalRect.width, sy = rect.height / modalRect.height;
            const tx = rect.left + rect.width/2 - (modalRect.left + modalRect.width/2);
            const ty = rect.top + rect.height/2 - (modalRect.top + modalRect.height/2);
            modal.style.transition = "transform .3s cubic-bezier(.4,0,.6,1), opacity .25s";
            modal.style.transform = `translate(${tx}px,${ty}px) scale(${sx},${sy})`;
            modal.style.opacity = "0";
            if(overlay) { overlay.style.transition = "opacity .3s"; overlay.style.opacity = "0"; }
            setTimeout(()=>setExpandedCard(null), 300);
          } else { setExpandedCard(null); }
        };
        const rect = cardRects.current[b.id];
        const originStyle = rect ? (() => {
          const vw = window.innerWidth;
          const modalW = vw - 48, modalH = 420;
          const modalL = 24, modalT = window.innerHeight * 0.15;
          const sx = rect.width / modalW, sy = rect.height / modalH;
          const tx = rect.left + rect.width/2 - (modalL + modalW/2);
          const ty = rect.top + rect.height/2 - (modalT + modalH/2);
          return `translate(${tx}px,${ty}px) scale(${sx},${sy})`;
        })() : "scale(.7)";
        return <>
          <div id="place-overlay" style={{position:"fixed",inset:0,zIndex:999,background:"rgba(0,0,0,.35)",backdropFilter:"blur(6px)",WebkitBackdropFilter:"blur(6px)",
            animation:"ovFadeIn .3s"}} onClick={closeCard}/>
          <div id="place-modal" onClick={e=>e.stopPropagation()}
            ref={el=>{if(el && !el.dataset.init){
              el.dataset.init="1";
              el.style.transform=originStyle; el.style.opacity="0";
              requestAnimationFrame(()=>{
                el.style.transition="transform .35s cubic-bezier(.2,.9,.3,1), opacity .3s";
                el.style.transform="translate(0,0) scale(1)"; el.style.opacity="1";
              });
            }}}
            style={{position:"fixed",left:24,right:24,top:"15vh",zIndex:1000,
            background:"#fff",borderRadius:16,overflow:"hidden",
            boxShadow:"0 20px 60px rgba(0,0,0,.2)"}}>
            {/* Header */}
            <div style={{padding:"14px 16px",background:`linear-gradient(135deg, ${b.color||"#f0f0f0"}18, ${b.color||"#f0f0f0"}08)`,
              borderBottom:"1px solid #f0f0f0",display:"flex",alignItems:"center",gap:8}}>
              <div style={{width:10,height:10,borderRadius:"50%",background:b.color||"#7c7cc8"}}/>
              <span style={{fontSize:16,fontWeight:800,color:"#222"}}>{b.name||"새 지점"}</span>
            </div>
            {/* Form */}
            <div style={{maxHeight:"55vh",overflowY:"auto"}}>
              {[
                {label:"지점명",field:"name",val:b.name,ph:"지점명을 입력하세요"},
                {label:"주소",field:"address",val:b.address||"",ph:"고객 안내용 주소를 입력하세요"},
                {label:"전화번호",field:"phone",val:b.phone||"",ph:"02-0000-0000"},
              ].map(row=>(
                <div key={row.field} style={{display:"flex",alignItems:"center",padding:"0 16px",borderBottom:"1px solid #f2f2f7",minHeight:44}}>
                  <span style={{width:56,fontSize:12,color:"#888",flexShrink:0,fontWeight:500}}>{row.label}</span>
                  <input value={row.val} onChange={e=>updateField(b.id,row.field,e.target.value)}
                    placeholder={row.ph} style={INP}/>
                </div>
              ))}
              {/* 메일주소 */}
              <div style={{borderBottom:"1px solid #f2f2f7"}}>
                <div style={{display:"flex",alignItems:"center",padding:"0 16px",minHeight:44}}>
                  <span style={{width:56,fontSize:12,color:"#888",flexShrink:0,fontWeight:500}}>메일주소</span>
                  <input value={b.naverEmail||""} onChange={e=>updateField(b.id,"naverEmail",e.target.value)}
                    placeholder="example@gmail.com" style={INP}/>
                </div>
                <div style={{padding:"0 16px 6px 72px",fontSize:10,color:"#bbb",lineHeight:1.3}}>
                  네이버 예약 알림을 수신할 Gmail 주소를 입력하세요.
                </div>
              </div>
              {/* 비즈 ID */}
              <div style={{display:"flex",alignItems:"center",padding:"0 16px",borderBottom:"1px solid #f2f2f7",minHeight:44}}>
                <span style={{width:56,fontSize:12,color:"#888",flexShrink:0,fontWeight:500}}>비즈 ID</span>
                <input value={b.naverBizId||""} onChange={e=>updateField(b.id,"naverBizId",e.target.value)}
                  placeholder="네이버 예약 비즈니스 ID (숫자)" style={INP}/>
              </div>
              {/* 네이버예약 칼럼수 */}
              <div style={{display:"flex",alignItems:"center",padding:"0 16px",minHeight:44}}>
                <span style={{width:80,fontSize:12,color:"#888",flexShrink:0,fontWeight:500,lineHeight:1.2}}>네이버예약<br/>칼럼수</span>
                <div style={{flex:1,display:"flex",alignItems:"center",gap:6,padding:"8px 0"}}>
                  {[1,2,3,4,5].map(n=>(
                    <button key={n} onClick={()=>updateField(b.id,"naverColCount",n)}
                      style={{width:34,height:34,borderRadius:8,border:"none",fontSize:14,fontWeight:700,cursor:"pointer",fontFamily:"inherit",
                        background:(b.naverColCount||1)===n?"#7c7cc8":"#f2f2f7",
                        color:(b.naverColCount||1)===n?"#fff":"#888"}}>{n}</button>
                  ))}
                </div>
              </div>
            </div>
            {/* Footer */}
            <div style={{display:"flex",gap:8,padding:"10px 16px",background:"#fafafa",borderTop:"1px solid #f0f0f0"}}>
              {deleteId===b.id ? <>
                <button onClick={()=>{deleteBranch(b.id);setExpandedCard(null);}} style={{flex:1,padding:"10px",fontSize:13,fontWeight:700,borderRadius:8,border:"none",background:"#ff3b30",color:"#fff",cursor:"pointer",fontFamily:"inherit"}}>삭제 확인</button>
                <button onClick={()=>setDeleteId(null)} style={{flex:1,padding:"10px",fontSize:13,borderRadius:8,border:"1px solid #d0d0d0",background:"#fff",color:"#888",cursor:"pointer",fontFamily:"inherit"}}>취소</button>
              </> : <>
                <button onClick={()=>setDeleteId(b.id)} style={{padding:"10px 14px",fontSize:12,borderRadius:8,border:"none",background:"#ff3b3010",color:"#ff3b30",cursor:"pointer",fontFamily:"inherit",fontWeight:600}}>
                  <I name="trash" size={11}/> 삭제
                </button>
                <div style={{flex:1}}/>
                {edited[b.id] && <button onClick={()=>applyRow(b.id)}
                  style={{padding:"10px 24px",fontSize:13,fontWeight:700,borderRadius:8,border:"none",background:"#7c7cc8",color:"#fff",cursor:"pointer",fontFamily:"inherit"}}>저장</button>}
              </>}
            </div>
          </div>
        </>;
      })()}</>}

      {/* Collapsed cards grid */}
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
        {branches.map((b,i) => (
          <div key={b.id} ref={el=>{if(el) cardRects.current[b.id] = el.getBoundingClientRect();}}
            onClick={()=>{cardRects.current[b.id]=document.querySelector(`[data-bid="${b.id}"]`)?.getBoundingClientRect(); setExpandedCard(b.id);}}
            data-bid={b.id}
            style={{
              borderRadius:14,padding:"14px",background:"#fff",cursor:"pointer",
              boxShadow:"0 1px 3px rgba(0,0,0,.06), 0 2px 8px rgba(0,0,0,.04)",
              borderLeft:`4px solid ${b.color||"#ddd"}`,
              WebkitTapHighlightColor:"transparent"
            }}>
            <div style={{fontSize:14,fontWeight:700,color:"#222",marginBottom:4,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{b.name||"새 지점"}</div>
            <div style={{fontSize:11,color:"#999",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{b.phone||"전화번호 미등록"}</div>
            <div style={{fontSize:10,color:"#bbb",marginTop:2,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{b.address||"주소 미등록"}</div>
            {b.naverEmail && <div style={{marginTop:6,fontSize:9,color:"#03c75a",fontWeight:600,display:"flex",alignItems:"center",gap:3}}>
              <span style={{width:5,height:5,borderRadius:"50%",background:"#03c75a",display:"inline-block"}}/>네이버 연동
            </div>}
          </div>
        ))}
      </div>
      </>}
    </div>
  </div>;
}


// ─── Unified Admin Header ───
function AdminHeader({title, count, color="#7c7cc8", desc="", onAdd, addLabel, onDownload, onUpload}) {
  const fileRef = useRef(null);
  const defaultLabel = <><I name="plus" size={12}/> 추가</>;
  return <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14,flexWrap:"wrap",gap:8}}>
    <div>
      <h3 style={{fontSize:14,fontWeight:700,color}}>{title}</h3>
      <p style={{fontSize:11,color:"#999",marginTop:2}}>{desc || `총 ${count}개`}</p>
    </div>
    <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
      {onDownload && <button className="btn-s btn-sm" onClick={onDownload}><I name="download" size={12}/> 내려받기</button>}
      {onUpload && <>
        <button className="btn-s btn-sm" onClick={()=>fileRef.current?.click()}><I name="upload" size={12}/> 올리기</button>
        <input ref={fileRef} type="file" accept=".xlsx,.xls,.csv" onChange={e=>{onUpload(e);e.target.value=""}} style={{display:"none"}}/>
      </>}
      {onAdd && <button className="btn-p btn-sm" onClick={onAdd}>{addLabel||defaultLabel}</button>}
    </div>
  </div>;
}

// ─── 담당자관리 (rooms from DB) ───
function AdminWorkers({ data, setData }) {
  const rooms = data.rooms || [];
  const regBranches = (data.branchSettings || data.branches || []).filter(b => b.useYn !== false);
  const [showAdd, setShowAdd] = useState(false);
  const [newW, setNewW] = useState({name:"", branchId:""});
  const [editId, setEditId] = useState(null);
  const [editData, setEditData] = useState({});
  const [delId, setDelId] = useState(null);
  const [selected, setSelected] = useState(new Set());

  const allChecked = rooms.length > 0 && rooms.every(r => selected.has(r.id));
  const toggleAll = () => { if (allChecked) setSelected(new Set()); else setSelected(new Set(rooms.map(r => r.id))); };
  const toggleOne = (id) => setSelected(prev => { const s = new Set(prev); s.has(id)?s.delete(id):s.add(id); return s; });
  const bulkDelete = () => {
    if (selected.size === 0) return;
    if (!window.confirm(selected.size + "명 담당자를 삭제하시겠습니까?")) return;
    selected.forEach(id => sb.del("rooms", id).catch(console.error));
    setData(p => ({...p, rooms: p.rooms.filter(r => !selected.has(r.id))}));
    setSelected(new Set());
  };

  const addRoom = () => {
    if(!newW.name.trim()||!newW.branchId) return;
    const nr = {id:"rm_"+uid(), branch_id:newW.branchId, name:newW.name, color:"", sort_order:rooms.length};
    setData(p=>({...p, rooms:[...p.rooms, nr]}));
    sb.insert("rooms", {id:nr.id, business_id:_activeBizId, branch_id:nr.branch_id, name:nr.name, color:"", sort_order:nr.sort_order}).catch(console.error);
    setNewW({name:"",branchId:""}); setShowAdd(false);
  };
  const startEdit = (r) => { setEditId(r.id); setEditData({...r}); };
  const saveEdit = () => {
    setData(p=>({...p, rooms:p.rooms.map(r=>r.id===editId?{...r,...editData}:r)}));
    sb.update("rooms", editId, {name:editData.name, branch_id:editData.branch_id, color:editData.color||""}).catch(console.error);
    setEditId(null);
  };
  const deleteRoom = (id) => {
    setData(p=>({...p, rooms:p.rooms.filter(r=>r.id!==id)}));
    sb.del("rooms", id).catch(console.error); setDelId(null);
  };

  const branchName = (bid) => regBranches.find(b=>b.id===bid)?.name || "-";
  const downloadXl = () => XL.download(rooms.map((r,i)=>({담당자명:r.name, 지점:branchName(r.branch_id), 색상:r.color||""})), "담당자목록.xlsx", "담당자", ["담당자명","지점","색상"]);
  const uploadXl = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    const rows = await XL.readFile(file);
    const newRooms = rows.map(r => {
      const br = regBranches.find(b=>b.name===(r["지점"]||r["branch"]));
      return {id:"rm_"+uid(), branch_id:br?.id||regBranches[0]?.id||"", name:r["담당자명"]||r["name"]||"", color:r["색상"]||"", sort_order:rooms.length};
    }).filter(r=>r.name);
    if(newRooms.length && window.confirm(newRooms.length+"명 추가하시겠습니까?")) {
      newRooms.forEach(r=>sb.insert("rooms",{id:r.id,business_id:_activeBizId,branch_id:r.branch_id,name:r.name,color:r.color,sort_order:r.sort_order}).catch(console.error));
      setData(p=>({...p,rooms:[...p.rooms,...newRooms]}));
    }
  };

  return <div>
    <AdminHeader title="담당자 관리" count={rooms.length} onAdd={()=>setShowAdd(!showAdd)} addLabel={showAdd?"취소":<><I name="plus" size={12}/> 담당자 추가</>} onDownload={downloadXl} onUpload={uploadXl}/>
    {showAdd && <div className="card" style={{padding:14,marginBottom:14}}>
      <div style={{display:"flex",gap:8,alignItems:"flex-end",flexWrap:"wrap"}}>
        <FLD label="담당자명"><input className="inp" style={{width:140}} value={newW.name} onChange={e=>setNewW(p=>({...p,name:e.target.value}))} placeholder="담당자명"/></FLD>
        <FLD label="지점"><select className="inp" style={{width:140}} value={newW.branchId} onChange={e=>setNewW(p=>({...p,branchId:e.target.value}))}>
          <option value="">선택</option>{regBranches.map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
        </select></FLD>
        <button className="btn-p btn-sm" onClick={addRoom}>등록</button>
      </div>
    </div>}
    {selected.size > 0 && <div style={{marginBottom:8}}><button className="btn-d btn-sm" onClick={bulkDelete} style={{fontSize:10,padding:"4px 12px"}}><I name="trash" size={12}/> 선택 삭제 ({selected.size})</button></div>}
    <div className="card tw admin-tw" style={{maxHeight:"calc(100vh - 300px)",overflow:"auto"}}>
      <table><thead><tr>
        <th style={{width:30}}><input type="checkbox" checked={allChecked} onChange={toggleAll}/></th>
        <th style={{width:35}}>No</th><th>담당자명</th><th>지점</th><th style={{width:80}}>색상</th><th style={{width:100}}>관리</th>
      </tr></thead><tbody>
        {rooms.map((r,i) => {
          if(editId===r.id) return <tr key={r.id} style={{background:"#f5f5ff"}}>
            <td><input type="checkbox" checked={selected.has(r.id)} onChange={()=>toggleOne(r.id)}/></td>
            <td style={{color:"#999"}}>{i+1}</td>
            <td><input className="inp" value={editData.name} onChange={e=>setEditData(p=>({...p,name:e.target.value}))} style={{width:"100%"}}/></td>
            <td><select className="inp" value={editData.branch_id} onChange={e=>setEditData(p=>({...p,branch_id:e.target.value}))}>
              {regBranches.map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
            </select></td>
            <td><div style={{display:"flex",alignItems:"center",gap:3}}><input type="color" value={editData.color||"#FFFFFF"} onChange={e=>setEditData(p=>({...p,color:e.target.value}))} style={{width:28,height:24,border:"none",cursor:"pointer"}}/><EyeDrop onPick={c=>setEditData(p=>({...p,color:c}))} size={24}/></div></td>
            <td><div style={{display:"flex",gap:3}}><button className="btn-p btn-sm" onClick={saveEdit}>저장</button><button className="btn-s btn-sm" onClick={()=>setEditId(null)}>취소</button></div></td>
          </tr>;
          return <tr key={r.id}>
            <td><input type="checkbox" checked={selected.has(r.id)} onChange={()=>toggleOne(r.id)}/></td>
            <td style={{color:"#999"}}>{i+1}</td>
            <td style={{fontWeight:600}}>{r.name}</td>
            <td>{branchName(r.branch_id)}</td>
            <td>{r.color ? <div style={{width:24,height:16,borderRadius:3,background:r.color,border:"1px solid #d0d0d080"}}/> : <span style={{color:"#ccc"}}>-</span>}</td>
            <td><div style={{display:"flex",gap:4}}>
              <button onClick={()=>startEdit(r)} style={{background:"none",border:"none",cursor:"pointer",color:"#7c7cc8",fontSize:13}}><I name="edit" size={13}/></button>
              {delId===r.id
                ? <><button className="btn-d btn-sm" onClick={()=>deleteRoom(r.id)} style={{padding:"1px 6px",fontSize:9}}>확인</button><button className="btn-s btn-sm" onClick={()=>setDelId(null)} style={{padding:"1px 5px",fontSize:9}}>취소</button></>
                : <button onClick={()=>setDelId(r.id)} style={{background:"none",border:"none",cursor:"pointer",color:"#e57373",fontSize:13}}><I name="trash" size={13}/></button>}
            </div></td>
          </tr>;
        })}
      </tbody></table>
    </div>
  </div>;
}

// ─── Drag Sort Helper ───
function useDragSort(items, setItems, sortKey="sort", onComplete) {
  const dragItem = useRef(null);
  const dragOver = useRef(null);
  const onDragStart = (idx) => { dragItem.current = idx; };
  const onDragEnter = (idx) => { dragOver.current = idx; };
  const onDragEnd = () => {
    if (dragItem.current === null || dragOver.current === null) return;
    const copy = [...items];
    const dragged = copy.splice(dragItem.current, 1)[0];
    copy.splice(dragOver.current, 0, dragged);
    const reordered = copy.map((it, i) => ({ ...it, [sortKey]: i }));
    setItems(reordered);
    if (onComplete) onComplete(reordered);
    dragItem.current = null;
    dragOver.current = null;
  };
  return { onDragStart, onDragEnter, onDragEnd };
}

const DragHandle = () => <span style={{cursor:"grab",flexShrink:0,userSelect:"none"}}><I name="grip" size={14} color="#999"/></span>;

// ─── 시술상품관리 ───
function AdminSaleItems({ data, setData }) {
  const [services, setServices] = useState([...(data?.services||[])].sort((a,b)=>a.sort-b.sort));
  useEffect(() => { setData(p => ({...p, services})); }, [services]);
  const cats = (data?.categories || []);
  const [editId, setEditId] = useState(null);
  const [editData, setEditData] = useState({});
  const [showAdd, setShowAdd] = useState(false);
  const [newSvc, setNewSvc] = useState({ cat:cats[0]?.id||"sc1", name:"", dur:20, priceF:0, priceM:0, note:"" });
  const [filterCat, setFilterCat] = useState("all");
  const [delConfirm, setDelConfirm] = useState(null);
  const [selected, setSelected] = useState(new Set());
  const drag = useDragSort(services, setServices, "sort", (reordered) => {
    reordered.forEach(s => sb.update("services", s.id, {sort: s.sort}).catch(console.error));
  });

  const filtered = filterCat === "all" ? services : services.filter(s => s.cat === filterCat);
  const allChecked = filtered.length > 0 && filtered.every(s => selected.has(s.id));
  const toggleAll = () => {
    if (allChecked) setSelected(new Set());
    else setSelected(new Set(filtered.map(s => s.id)));
  };
  const toggleOne = (id) => setSelected(prev => { const s = new Set(prev); s.has(id)?s.delete(id):s.add(id); return s; });
  const bulkDelete = () => {
    if (selected.size === 0) return;
    if (!window.confirm(selected.size + "개 시술을 삭제하시겠습니까?")) return;
    selected.forEach(id => sb.del("services", id).catch(console.error));
    setServices(p => p.filter(s => !selected.has(s.id)).map((s,i) => ({...s, sort:i})));
    setSelected(new Set());
  };

  const startEdit = (svc) => { setEditId(svc.id); setEditData({...svc}); };
  const saveEdit = () => { 
    setServices(p=>p.map(s=>s.id===editId?{...editData}:s)); 
    sb.update("services", editId, {cat:editData.cat, name:editData.name, dur:editData.dur, price_f:editData.priceF, price_m:editData.priceM, note:editData.note||"", sort:editData.sort||0}).catch(console.error);
    setEditId(null); 
  };
  const deleteSvc = (id) => { 
    setServices(p=>p.filter(s=>s.id!==id).map((s,i)=>({...s,sort:i}))); 
    sb.del("services", id).catch(console.error);
    setDelConfirm(null); 
  };
  const addSvc = () => {
    if(!newSvc.name.trim()) return;
    const svc = {...newSvc, id:uid(), priceF:Number(newSvc.priceF)||0, priceM:Number(newSvc.priceM)||0, dur:Number(newSvc.dur)||20, sort:services.length};
    setServices(p=>[...p, svc]);
    sb.insert("services", {id:svc.id, business_id:_activeBizId, cat:svc.cat, name:svc.name, dur:svc.dur, price_f:svc.priceF, price_m:svc.priceM, note:svc.note||"", sort:svc.sort}).catch(console.error);
    setNewSvc({ cat:cats[0]?.id||"sc1", name:"", dur:20, priceF:0, priceM:0, note:"" }); setShowAdd(false);
  };
  const inp = (val, onChange, w, type) => <input className="inp" type={type||"text"} value={val}
    onChange={e => onChange(type==="number" ? Number(e.target.value)||0 : e.target.value)}
    style={{width:w||"100%",padding:"4px 6px",fontSize:11,background:"#f8f0f0",border:"1px solid #d0d0d0",textAlign:type==="number"?"right":"left"}} />;

  const downloadXl = () => XL.download(services.map(s=>({카테고리:cats.find(c=>c.id===s.cat)?.name||"",시술명:s.name,여성가:s.priceF,남성가:s.priceM,소요분:s.dur,비고:s.note||""})),"시술목록.xlsx","시술",["카테고리","시술명","여성가","남성가","소요분","비고"]);
  const uploadXl = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    const rows = await XL.readFile(file);
    // Auto-create missing categories from Excel
    const catNames = [...new Set(rows.map(r=>String(r["카테고리"]||r["category"]||"").trim()).filter(Boolean))];
    let localCats = [...cats];
    const newCats = [];
    for (const cn of catNames) {
      if (!localCats.find(c=>c.name.trim()===cn)) {
        const nc = {id:uid(), name:cn, sort:localCats.length+newCats.length};
        newCats.push(nc);
        localCats.push(nc);
      }
    }
    if (newCats.length > 0) {
      for (const nc of newCats) {
        await sb.insert("service_categories", {id:nc.id, business_id:_activeBizId, name:nc.name, sort:nc.sort}).catch(console.error);
      }
      if (setData) setData(prev => ({...prev, categories: localCats}));
    }
    const newSvcs = rows.map((r,i)=>{
      const catName = String(r["카테고리"]||r["category"]||"").trim();
      const cat = localCats.find(c=>c.name.trim()===catName);
      return {id:uid(), cat:cat?.id||localCats[0]?.id||"sc1", name:String(r["시술명"]||r["name"]||"").trim(), priceF:Number(r["여성가"]||r["priceF"])||0, priceM:Number(r["남성가"]||r["priceM"])||0, dur:Number(r["소요분"]||r["dur"])||20, note:String(r["비고"]||"").trim(), sort:i};
    }).filter(r=>r.name);
    // Re-assign sort after filter
    newSvcs.forEach((s,i) => s.sort = i);
    if(newSvcs.length) {
      const mode = window.confirm(newSvcs.length+"개 시술 업로드\n\n[확인] 기존 전체 삭제 후 교체\n[취소] 기존에 추가");
      if (mode) {
        // Replace all: delete existing services first
        for (const s of services) { await sb.del("services", s.id).catch(console.error); }
        setServices(newSvcs);
        for (const s of newSvcs) { await sb.insert("services",{id:s.id, business_id:_activeBizId, cat:s.cat, name:s.name, dur:s.dur, price_f:s.priceF, price_m:s.priceM, note:s.note||"", sort:s.sort}).catch(console.error); }
      } else {
        const maxSort = services.reduce((m,s)=>Math.max(m,s.sort||0),0);
        newSvcs.forEach((s,i) => s.sort = maxSort + 1 + i);
        setServices(p=>[...p,...newSvcs]);
        newSvcs.forEach(s=>sb.insert("services",{id:s.id, business_id:_activeBizId, cat:s.cat, name:s.name, dur:s.dur, price_f:s.priceF, price_m:s.priceM, note:s.note||"", sort:s.sort}).catch(console.error));
      }
      if (setData) setData(prev => ({...prev, services: mode ? newSvcs : [...prev.services, ...newSvcs]}));
    }
    e.target.value="";
  };

  const resetSort = () => {
    if(!window.confirm("현재 화면 순서대로 sort 값을 0부터 재설정합니다.")) return;
    const reordered = services.map((s,i) => ({...s, sort:i}));
    setServices(reordered);
    reordered.forEach(s => sb.update("services", s.id, {sort:s.sort}).catch(console.error));
  };

  return <div>
    <AdminHeader title="시술 상품 관리" count={services.length} onAdd={()=>setShowAdd(!showAdd)} addLabel={showAdd?"취소":<><I name="plus" size={12}/> 시술 추가</>} onDownload={downloadXl} onUpload={uploadXl}/>
    {showAdd && <div className="card" style={{padding:14,marginBottom:14}}>
      <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"flex-end"}}>
        <FLD label="카테고리"><select className="inp" style={{width:120,padding:"4px 6px",fontSize:11}} value={newSvc.cat} onChange={e=>setNewSvc(p=>({...p,cat:e.target.value}))}>{cats.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></FLD>
        <FLD label="시술명">{inp(newSvc.name, v=>setNewSvc(p=>({...p,name:v})), 150)}</FLD>
        <FLD label="여성가">{inp(newSvc.priceF, v=>setNewSvc(p=>({...p,priceF:v})), 90, "number")}</FLD>
        <FLD label="남성가">{inp(newSvc.priceM, v=>setNewSvc(p=>({...p,priceM:v})), 90, "number")}</FLD>
        <FLD label="소요(분)">{inp(newSvc.dur, v=>setNewSvc(p=>({...p,dur:v})), 60, "number")}</FLD>
        <FLD label="비고">{inp(newSvc.note||"", v=>setNewSvc(p=>({...p,note:v})), 130)}</FLD>
        <button className="btn-p btn-sm" onClick={addSvc} style={{padding:"6px 16px"}}>등록</button>
      </div>
    </div>}
    <div style={{display:"flex",gap:3,marginBottom:10,flexWrap:"wrap",alignItems:"center"}}>
      <button className={filterCat==="all"?"btn-p btn-sm":"btn-s btn-sm"} onClick={()=>setFilterCat("all")} style={{fontSize:10}}>전체 ({services.length})</button>
      {cats.map(c=><button key={c.id} className={filterCat===c.id?"btn-p btn-sm":"btn-s btn-sm"} onClick={()=>setFilterCat(c.id)} style={{fontSize:10}}>{c.name} ({services.filter(s=>s.cat===c.id).length})</button>)}
      {selected.size > 0 && <button className="btn-d btn-sm" onClick={bulkDelete} style={{fontSize:10,marginLeft:"auto",padding:"4px 12px"}}><I name="trash" size={12}/> 선택 삭제 ({selected.size})</button>}
      <button onClick={resetSort} style={{fontSize:9,marginLeft:selected.size>0?"4px":"auto",padding:"3px 8px",border:"1px solid #ccc",borderRadius:4,background:"#f8f8f8",color:"#888",cursor:"pointer"}}>순서 리셋</button>
    </div>
    <div className="tw admin-tw" style={{maxHeight:"calc(100vh - 340px)",overflow:"auto"}}>
      <table><thead><tr>
        <th style={{width:30}}><input type="checkbox" checked={allChecked} onChange={toggleAll}/></th><th style={{width:25}}></th><th style={{width:30}}>No</th><th style={{width:85}}>카테고리</th><th>시술명</th>
        <th style={{width:85,textAlign:"right"}}>여성가</th><th style={{width:85,textAlign:"right"}}>남성가</th>
        <th style={{width:50,textAlign:"center"}}>소요</th><th style={{width:120}}>비고</th><th style={{width:75,textAlign:"center"}}>관리</th>
      </tr></thead><tbody>
        {filtered.map((svc,i)=>{
          const isEdit = editId === svc.id;
          if (isEdit) return <tr key={svc.id} style={{background:"#f5f5ff"}}>
            <td><input type="checkbox" checked={selected.has(svc.id)} onChange={()=>toggleOne(svc.id)}/></td>
            <td><DragHandle/></td><td style={{color:"#999"}}>{i+1}</td>
            <td><select className="inp" value={editData.cat} onChange={e=>setEditData(p=>({...p,cat:e.target.value}))} style={{width:"100%",padding:"4px 6px",fontSize:11}}>{cats.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></td>
            <td>{inp(editData.name, v=>setEditData(p=>({...p,name:v})))}</td>
            <td>{inp(editData.priceF, v=>setEditData(p=>({...p,priceF:v})), "100%", "number")}</td>
            <td>{inp(editData.priceM, v=>setEditData(p=>({...p,priceM:v})), "100%", "number")}</td>
            <td>{inp(editData.dur, v=>setEditData(p=>({...p,dur:v})), "100%", "number")}</td>
            <td>{inp(editData.note||"", v=>setEditData(p=>({...p,note:v})))}</td>
            <td style={{textAlign:"center"}}><div style={{display:"flex",gap:3,justifyContent:"center"}}>
              <button className="btn-p btn-sm" onClick={saveEdit} style={{padding:"2px 8px",fontSize:10}}>저장</button>
              <button className="btn-s btn-sm" onClick={()=>setEditId(null)} style={{padding:"2px 6px",fontSize:10}}>취소</button>
            </div></td>
          </tr>;
          return <tr key={svc.id} draggable onDragStart={()=>drag.onDragStart(i)} onDragEnter={()=>drag.onDragEnter(i)} onDragEnd={drag.onDragEnd} onDragOver={e=>e.preventDefault()}>
            <td><input type="checkbox" checked={selected.has(svc.id)} onChange={()=>toggleOne(svc.id)}/></td>
            <td><DragHandle/></td>
            <td style={{color:"#999"}}>{i+1}</td>
            <td><span className="badge" style={{background:"#f0f0ff",color:"#7c7cc8"}}>{cats.find(c=>c.id===svc.cat)?.name||"-"}</span></td>
            <td style={{fontWeight:500,fontSize:12}}>{svc.name}</td>
            <td style={{textAlign:"right",color:"#7c7cc8",fontWeight:600,fontSize:12}}>{svc.priceF>0?fmt(svc.priceF)+"원":"-"}</td>
            <td style={{textAlign:"right",color:"#4a7cc8",fontWeight:600,fontSize:12}}>{svc.priceM>0?fmt(svc.priceM)+"원":"-"}</td>
            <td style={{textAlign:"center",color:"#888",fontSize:11}}>{svc.dur}분</td>
            <td style={{fontSize:11,color:"#888"}}>{svc.note||""}</td>
            <td style={{textAlign:"center"}}><div style={{display:"flex",gap:4,justifyContent:"center"}}>
              <button onClick={()=>startEdit(svc)} style={{background:"none",border:"none",cursor:"pointer",color:"#7c7cc8",fontSize:13}}><I name="edit" size={13}/></button>
              {delConfirm===svc.id
                ? <><button className="btn-d btn-sm" onClick={()=>deleteSvc(svc.id)} style={{padding:"1px 6px",fontSize:9}}>확인</button><button className="btn-s btn-sm" onClick={()=>setDelConfirm(null)} style={{padding:"1px 5px",fontSize:9}}>취소</button></>
                : <button onClick={()=>setDelConfirm(svc.id)} style={{background:"none",border:"none",cursor:"pointer",color:"#e57373",fontSize:13}}><I name="trash" size={13}/></button>}
            </div></td>
          </tr>;
        })}
      </tbody></table>
    </div>
  </div>;
}

// ─── 제품관리 ───
function AdminProductItems({ data, setData }) {
  const [items, setItems] = useState(()=>[...(data?.products||[])].map((p,i)=>({...p,sort:p.sort??i})).sort((a,b)=>a.sort-b.sort));
  useEffect(() => { setData(p => ({...p, products: items})); }, [items]);
  const [editId, setEditId] = useState(null);
  const [editData, setEditData] = useState({});
  const [showAdd, setShowAdd] = useState(false);
  const [newItem, setNewItem] = useState({ name:"", price:0 });
  const [delConfirm, setDelConfirm] = useState(null);
  const [selected, setSelected] = useState(new Set());
  const drag = useDragSort(items, setItems, "sort", (reordered) => {
    reordered.forEach(s => sb.update("products", s.id, {sort: s.sort}).catch(console.error));
  });

  const allChecked = items.length > 0 && items.every(it => selected.has(it.id));
  const toggleAll = () => { if (allChecked) setSelected(new Set()); else setSelected(new Set(items.map(it => it.id))); };
  const toggleOne = (id) => setSelected(prev => { const s = new Set(prev); s.has(id)?s.delete(id):s.add(id); return s; });
  const bulkDelete = () => {
    if (selected.size === 0) return;
    if (!window.confirm(selected.size + "개 제품을 삭제하시겠습니까?")) return;
    selected.forEach(id => sb.del("products", id).catch(console.error));
    setItems(p => p.filter(it => !selected.has(it.id)).map((it,i) => ({...it, sort:i})));
    setSelected(new Set());
  };

  const startEdit = (it) => { setEditId(it.id); setEditData({...it}); };
  const saveEdit = () => { 
    setItems(p=>p.map(x=>x.id===editId?{...editData}:x)); 
    sb.update("products", editId, {name:editData.name, price:editData.price||0}).catch(console.error);
    setEditId(null); 
  };
  const deleteItem = (id) => { 
    setItems(p=>p.filter(x=>x.id!==id).map((x,i)=>({...x,sort:i}))); 
    sb.del("products", id).catch(console.error);
    setDelConfirm(null); 
  };
  const addItem = () => {
    if(!newItem.name.trim()) return;
    const it = {id:uid(), name:newItem.name, price:Number(newItem.price)||0, cat:"product", sort:items.length};
    setItems(p=>[...p, it]);
    sb.insert("products", {id:it.id, business_id:_activeBizId, name:it.name, price:it.price, cat:"product", sort:it.sort}).catch(console.error);
    setNewItem({name:"",price:0}); setShowAdd(false);
  };

  const downloadXl = () => XL.download(items.map((p,i)=>({제품명:p.name, 가격:p.price||0})), "제품목록.xlsx", "제품", ["제품명","가격"]);
  const uploadXl = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    const rows = await XL.readFile(file);
    const newItems = rows.map((r,i)=>({id:uid(), name:String(r["제품명"]||r["name"]||"").trim(), price:Number(r["가격"]||r["price"])||0, cat:"product", sort:items.length+i})).filter(r=>r.name);
    if(newItems.length && window.confirm(newItems.length+"개 제품을 추가하시겠습니까?")) {
      setItems(p=>[...p,...newItems]);
      newItems.forEach(it=>sb.insert("products",{id:it.id, business_id:_activeBizId, name:it.name, price:it.price, cat:"product", sort:it.sort}).catch(console.error));
    }
    e.target.value="";
  };

  return <div>
    <AdminHeader title="제품 관리" count={items.length} onAdd={()=>setShowAdd(!showAdd)} addLabel={showAdd?"취소":<><I name="plus" size={12}/> 제품 추가</>} onDownload={downloadXl} onUpload={uploadXl}/>
    {showAdd && <div className="card" style={{padding:14,marginBottom:14}}>
      <div style={{display:"flex",gap:8,alignItems:"flex-end"}}>
        <FLD label="제품명"><input className="inp" style={{width:180}} value={newItem.name} onChange={e=>setNewItem(p=>({...p,name:e.target.value}))} placeholder="제품명"/></FLD>
        <FLD label="가격"><input className="inp" type="number" style={{width:100}} value={newItem.price} onChange={e=>setNewItem(p=>({...p,price:e.target.value}))} placeholder="0"/></FLD>
        <button className="btn-p btn-sm" onClick={addItem} style={{padding:"6px 16px"}}>등록</button>
      </div>
    </div>}
    {selected.size > 0 && <div style={{marginBottom:8}}><button className="btn-d btn-sm" onClick={bulkDelete} style={{fontSize:10,padding:"4px 12px"}}><I name="trash" size={12}/> 선택 삭제 ({selected.size})</button></div>}
    <div className="tw admin-tw" style={{maxHeight:"calc(100vh - 300px)",overflow:"auto"}}>
      <table><thead><tr>
        <th style={{width:30}}><input type="checkbox" checked={allChecked} onChange={toggleAll}/></th><th style={{width:25}}></th><th style={{width:35}}>No</th><th>제품명</th><th style={{width:100,textAlign:"right"}}>가격</th><th style={{width:80,textAlign:"center"}}>관리</th>
      </tr></thead>
        <tbody>{items.map((it,i)=>{
          if (editId===it.id) return <tr key={it.id} style={{background:"#f5f5ff"}}>
            <td><input type="checkbox" checked={selected.has(it.id)} onChange={()=>toggleOne(it.id)}/></td>
            <td><DragHandle/></td><td style={{color:"#999"}}>{i+1}</td>
            <td><input className="inp" value={editData.name} onChange={e=>setEditData(p=>({...p,name:e.target.value}))} style={{width:"100%"}}/></td>
            <td><input className="inp" type="number" value={editData.price} onChange={e=>setEditData(p=>({...p,price:Number(e.target.value)||0}))} style={{width:"100%",textAlign:"right"}}/></td>
            <td style={{textAlign:"center"}}><div style={{display:"flex",gap:3,justifyContent:"center"}}>
              <button className="btn-p btn-sm" onClick={saveEdit} style={{padding:"2px 8px",fontSize:10}}>저장</button>
              <button className="btn-s btn-sm" onClick={()=>setEditId(null)} style={{padding:"2px 6px",fontSize:10}}>취소</button>
            </div></td>
          </tr>;
          return <tr key={it.id} draggable onDragStart={()=>drag.onDragStart(i)} onDragEnter={()=>drag.onDragEnter(i)} onDragEnd={drag.onDragEnd} onDragOver={e=>e.preventDefault()}>
            <td><input type="checkbox" checked={selected.has(it.id)} onChange={()=>toggleOne(it.id)}/></td>
            <td><DragHandle/></td><td style={{color:"#999"}}>{i+1}</td>
            <td style={{fontWeight:500,fontSize:12}}>{it.name}</td>
            <td style={{textAlign:"right",color:"#6bab9e",fontWeight:600,fontSize:12}}>{it.price>0?fmt(it.price)+"원":"-"}</td>
            <td style={{textAlign:"center"}}><div style={{display:"flex",gap:4,justifyContent:"center"}}>
              <button onClick={()=>startEdit(it)} style={{background:"none",border:"none",cursor:"pointer",color:"#7c7cc8",fontSize:13}}><I name="edit" size={13}/></button>
              {delConfirm===it.id
                ? <><button className="btn-d btn-sm" onClick={()=>deleteItem(it.id)} style={{padding:"1px 6px",fontSize:9}}>확인</button><button className="btn-s btn-sm" onClick={()=>setDelConfirm(null)} style={{padding:"1px 5px",fontSize:9}}>취소</button></>
                : <button onClick={()=>setDelConfirm(it.id)} style={{background:"none",border:"none",cursor:"pointer",color:"#e57373",fontSize:13}}><I name="trash" size={13}/></button>}
            </div></td>
          </tr>;
        })}</tbody>
      </table>
    </div>
  </div>;
}

// ─── 서비스태그관리 ───
function AdminServiceTags({ data, setData }) {
  const [tags, setTags] = useState(()=>[...(data?.serviceTags || [])].sort((a,b)=>a.sort-b.sort));
  useEffect(() => { setData(p => ({...p, serviceTags: tags})); }, [tags]);
  const [showAdd, setShowAdd] = useState(false);
  const [newTag, setNewTag] = useState({ name:"", dur:0, scheduleYn:"N", color:"" });
  const [editId, setEditId] = useState(null);
  const [editData, setEditData] = useState({});
  const [delConfirm, setDelConfirm] = useState(null);
  const [selected, setSelected] = useState(new Set());
  const syncTags = (updated) => { setTags(updated); if(setData) setData(prev=>({...prev,serviceTags:updated})); };
  const drag = useDragSort(tags, syncTags, "sort", (reordered) => {
    reordered.forEach(s => sb.update("service_tags", s.id, {sort: s.sort}).catch(console.error));
  });

  const allChecked = tags.length > 0 && tags.every(t => selected.has(t.id));
  const toggleAll = () => { if (allChecked) setSelected(new Set()); else setSelected(new Set(tags.map(t => t.id))); };
  const toggleOne = (id) => setSelected(prev => { const s = new Set(prev); s.has(id)?s.delete(id):s.add(id); return s; });
  const bulkDelete = () => {
    if (selected.size === 0) return;
    if (!window.confirm(selected.size + "개 태그를 삭제하시겠습니까?")) return;
    selected.forEach(id => sb.del("service_tags", id).catch(console.error));
    syncTags(tags.filter(t => !selected.has(t.id)).map((t,i) => ({...t, sort:i})));
    setSelected(new Set());
  };

  const tagToDb = (t) => ({id:t.id, business_id:_activeBizId, name:t.name, dur:t.dur||0, schedule_yn:t.scheduleYn==="Y"||t.scheduleYn===true, color:t.color||"", use_yn:t.useYn!==false, sort:t.sort||0});

  const addTag = () => {
    if(!newTag.name.trim()) return;
    const t = {id:uid(), name:newTag.name.trim(), dur:Number(newTag.dur)||0, scheduleYn:newTag.scheduleYn, color:newTag.color, useYn:true, sort:tags.length};
    syncTags([...tags, t]);
    sb.insert("service_tags", tagToDb(t)).catch(console.error);
    setNewTag({name:"",dur:0,scheduleYn:"N",color:""}); setShowAdd(false);
  };
  const deleteTag = (id) => { 
    syncTags(tags.filter(t=>t.id!==id).map((t,i)=>({...t,sort:i}))); 
    sb.del("service_tags", id).catch(console.error);
    setDelConfirm(null); 
  };
  const startEdit = (tag) => { setEditId(tag.id); setEditData({...tag}); };
  const saveEdit = () => { 
    syncTags(tags.map(t=>t.id===editId?{...editData}:t)); 
    sb.update("service_tags", editId, {name:editData.name, dur:editData.dur||0, schedule_yn:editData.scheduleYn==="Y"||editData.scheduleYn===true, color:editData.color||"", use_yn:editData.useYn!==false, sort:editData.sort||0}).catch(console.error);
    setEditId(null); 
  };
  const toggleUse = (id) => { 
    const tag = tags.find(t=>t.id===id);
    const newUse = tag?.useYn===false;
    syncTags(tags.map(t=>t.id===id?{...t,useYn:!t.useYn}:t)); 
    sb.update("service_tags", id, {use_yn:newUse}).catch(console.error);
  };

  const inpS = {padding:"4px 6px",fontSize:11,background:"#f8f0f0",border:"1px solid #d0d0d0"};

  const downloadXl = () => XL.download(tags.map((t,i)=>({태그명:t.name, 소요분:t.dur, 내부일정:t.scheduleYn, 색상:t.color||"", 사용:t.useYn!==false?"Y":"N"})), "서비스태그.xlsx", "태그", ["태그명","소요분","내부일정","색상","사용"]);
  const uploadXl = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    const rows = await XL.readFile(file);
    const newTags = rows.map(r=>({id:uid(), name:r["태그명"]||r["name"]||"", dur:Number(r["소요분"]||r["dur"])||0, scheduleYn:r["내부일정"]||"N", color:r["색상"]||"", useYn:(r["사용"]||"Y")!=="N", sort:tags.length})).filter(r=>r.name);
    if(newTags.length && window.confirm(newTags.length+"개 태그를 추가하시겠습니까?")) {
      syncTags([...tags,...newTags]);
      newTags.forEach(t=>sb.insert("service_tags", tagToDb(t)).catch(console.error));
    }
  };

  return <div>
    <AdminHeader title="서비스 태그 관리" count={tags.length} onAdd={()=>setShowAdd(!showAdd)} addLabel={showAdd?"취소":<><I name="plus" size={12}/> 태그 추가</>} onDownload={downloadXl} onUpload={uploadXl}/>

    {showAdd && <div className="card" style={{padding:14,marginBottom:14}}>
      <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"flex-end"}}>
        <FLD label="태그명"><input className="inp" style={{width:160,...inpS}} value={newTag.name} onChange={e=>setNewTag(p=>({...p,name:e.target.value}))} placeholder="태그명" onKeyDown={e=>e.key==="Enter"&&addTag()}/></FLD>
        <FLD label="소요(분)"><input className="inp" type="number" style={{width:80,...inpS}} value={newTag.dur} onChange={e=>setNewTag(p=>({...p,dur:e.target.value}))}/></FLD>
        <FLD label="내부일정"><select className="inp" style={{width:55,...inpS}} value={newTag.scheduleYn} onChange={e=>setNewTag(p=>({...p,scheduleYn:e.target.value}))}><option value="N">N</option><option value="Y">Y</option></select></FLD>
        <FLD label="색상"><div style={{display:"flex",alignItems:"center",gap:3}}>
          <input type="color" value={newTag.color||"#e0e0e0"} onChange={e=>setNewTag(p=>({...p,color:e.target.value}))} style={{width:22,height:22,border:"none",cursor:"pointer"}}/>
          <EyeDrop onPick={c=>setNewTag(p=>({...p,color:c}))} size={22}/>
          <input className="inp" style={{width:75,...inpS,fontFamily:"monospace",fontSize:9}} value={newTag.color} onChange={e=>setNewTag(p=>({...p,color:e.target.value}))} placeholder="#000000"/>
        </div></FLD>
        <button className="btn-p btn-sm" onClick={addTag} style={{padding:"6px 18px"}}>추가</button>
      </div>
    </div>}

    <div className="card" style={{padding:12,marginBottom:14}}>
      <div style={{fontSize:10,color:"#888",marginBottom:6}}>미리보기</div>
      <div style={{display:"flex",flexWrap:"wrap",gap:4,padding:8,background:"#f8f8f8",borderRadius:8,border:"1px solid #e0e0e0"}}>
        {tags.filter(t=>t.useYn!==false).map(t=>{
          const hasClr = t.color && t.color!=="";
          return <span key={t.id} style={{padding:"4px 8px",fontSize:10,fontWeight:500,borderRadius:4,display:"flex",alignItems:"center",gap:3,
            border:"1px solid "+(hasClr?t.color+"80":"#d0d0d0"),color:hasClr?t.color:"#7c7cc8",background:hasClr?t.color+"15":"transparent"}}>
            {t.name}{t.dur>0&&<span style={{fontSize:8,opacity:.6}}>({t.dur}분)</span>}
          </span>;
        })}
      </div>
    </div>

    {selected.size > 0 && <div style={{marginBottom:8}}><button className="btn-d btn-sm" onClick={bulkDelete} style={{fontSize:10,padding:"4px 12px"}}><I name="trash" size={12}/> 선택 삭제 ({selected.size})</button></div>}

    <div className="tw admin-tw" style={{maxHeight:"calc(100vh - 400px)",overflow:"auto"}}>
      <table><thead><tr>
        <th style={{width:30}}><input type="checkbox" checked={allChecked} onChange={toggleAll}/></th>
        <th style={{width:22}}></th><th style={{width:25}}>No</th><th>태그명</th>
        <th style={{width:55,textAlign:"center"}}>소요</th><th style={{width:45,textAlign:"center"}}>기타</th>
        <th style={{width:80,textAlign:"center"}}>색상</th><th style={{width:55,textAlign:"center"}}>사용</th>
        <th style={{width:35,textAlign:"center"}}>순서</th><th style={{width:65,textAlign:"center"}}>관리</th>
      </tr></thead><tbody>
      {tags.map((tag,i) => {
        const isEdit = editId===tag.id;
        if (isEdit) return <tr key={tag.id} style={{background:"#f5f5ff"}}>
          <td><input type="checkbox" checked={selected.has(tag.id)} onChange={()=>toggleOne(tag.id)}/></td>
          <td><DragHandle/></td><td style={{color:"#999"}}>{i+1}</td>
          <td><input className="inp" value={editData.name} onChange={e=>setEditData(p=>({...p,name:e.target.value}))} style={{width:"100%",...inpS}}/></td>
          <td><input className="inp" type="number" value={editData.dur} onChange={e=>setEditData(p=>({...p,dur:Number(e.target.value)||0}))} style={{width:50,...inpS,textAlign:"center"}}/></td>
          <td><select className="inp" value={editData.scheduleYn} onChange={e=>setEditData(p=>({...p,scheduleYn:e.target.value}))} style={{width:45,...inpS}}><option value="N">N</option><option value="Y">Y</option></select></td>
          <td><div style={{display:"flex",alignItems:"center",gap:2}}>
            <input type="color" value={editData.color||"#e0e0e0"} onChange={e=>setEditData(p=>({...p,color:e.target.value}))} style={{width:20,height:18,border:"none",cursor:"pointer"}}/>
            <EyeDrop onPick={c=>setEditData(p=>({...p,color:c}))} size={20}/>
            <input className="inp" value={editData.color||""} onChange={e=>setEditData(p=>({...p,color:e.target.value}))} style={{width:55,...inpS,fontFamily:"monospace",fontSize:8}}/>
          </div></td>
          <td></td><td></td>
          <td style={{textAlign:"center"}}><div style={{display:"flex",gap:3,justifyContent:"center"}}>
            <button className="btn-p btn-sm" onClick={saveEdit} style={{padding:"1px 6px",fontSize:9}}>저장</button>
            <button className="btn-s btn-sm" onClick={()=>setEditId(null)} style={{padding:"1px 5px",fontSize:9}}>취소</button>
          </div></td>
        </tr>;
        return <tr key={tag.id} draggable onDragStart={()=>drag.onDragStart(i)} onDragEnter={()=>drag.onDragEnter(i)} onDragEnd={drag.onDragEnd} onDragOver={e=>e.preventDefault()}
          style={{opacity:tag.useYn===false?0.45:1}}>
          <td><input type="checkbox" checked={selected.has(tag.id)} onChange={()=>toggleOne(tag.id)}/></td>
          <td><DragHandle/></td>
          <td style={{color:"#999"}}>{i+1}</td>
          <td style={{fontWeight:600,fontSize:12}}>
            <span style={{padding:"2px 6px",borderRadius:4,border:"1px solid "+(tag.color||"#d0d0d0")+"50",background:tag.color?tag.color+"12":"transparent",color:tag.color||"#333"}}>{tag.name}</span>
          </td>
          <td style={{textAlign:"center",fontSize:11,color:tag.dur>0?"#ef5350":"#d0d0d0",fontWeight:tag.dur>0?600:400}}>{tag.dur>0?tag.dur+"분":"-"}</td>
          <td style={{textAlign:"center",fontSize:10,color:tag.scheduleYn==="Y"?"#ef5350":"#d0d0d0"}}>{tag.scheduleYn}</td>
          <td style={{textAlign:"center"}}>{tag.color?<div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:4}}>
            <div style={{width:24,height:16,borderRadius:3,background:tag.color,border:"1px solid #d0d0d080"}}/>
            <span style={{fontSize:8,color:"#888",fontFamily:"monospace"}}>{tag.color}</span>
          </div>:<span style={{color:"#bbb",fontSize:10}}>—</span>}</td>
          <td style={{textAlign:"center"}}><button onClick={()=>toggleUse(tag.id)}
            style={{fontSize:10,padding:"2px 6px",borderRadius:4,border:"1px solid "+(tag.useYn===false?"#e57373":"#d0d0d0"),cursor:"pointer",fontFamily:"inherit",
              background:tag.useYn===false?"#e5737320":"transparent",color:tag.useYn===false?"#e8a0a0":"#888"}}>{tag.useYn===false?"미사용":"사용"}</button></td>
          <td style={{textAlign:"center",color:"#bbb",fontSize:10}}>{i+1}</td>
          <td style={{textAlign:"center"}}><div style={{display:"flex",gap:3,justifyContent:"center"}}>
            <button onClick={()=>startEdit(tag)} style={{background:"none",border:"none",cursor:"pointer",color:"#7c7cc8",fontSize:12}}><I name="edit" size={13}/></button>
            {delConfirm===tag.id
              ? <><button className="btn-d btn-sm" onClick={()=>deleteTag(tag.id)} style={{padding:"1px 5px",fontSize:9}}>확인</button><button className="btn-s btn-sm" onClick={()=>setDelConfirm(null)} style={{padding:"1px 4px",fontSize:9}}>취소</button></>
              : <button onClick={()=>setDelConfirm(tag.id)} style={{background:"none",border:"none",cursor:"pointer",color:"#e57373",fontSize:12}}><I name="trash" size={13}/></button>}
          </div></td>
        </tr>;
      })}</tbody></table>
    </div>
  </div>;
}

// ─── Shared ───
function EyeDrop({ onPick, size=20 }) {
  const supported = typeof window !== "undefined" && "EyeDropper" in window;
  if (!supported) return null;
  const pick = async () => {
    try {
      const ed = new EyeDropper();
      const r = await ed.open();
      if (r?.sRGBHex) onPick(r.sRGBHex);
    } catch(e) {}
  };
  return <button onClick={pick} title="화면에서 색상 추출" style={{width:size,height:size,border:"1px solid #d0d0d0",borderRadius:4,background:"#fff",cursor:"pointer",display:"inline-flex",alignItems:"center",justifyContent:"center",padding:0,flexShrink:0}}>
    <svg width={size-6} height={size-6} viewBox="0 0 16 16" fill="none" stroke="#666" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M13.5 2.5l-1-1-2 2-1-1-6 6-.5 3.5 3.5-.5 6-6-1-1 2-2z"/><path d="M3.5 9.5l3 3"/></svg>
  </button>;
}

function DatePick({ value, onChange, style, min }) {
  const DAYS = ["일","월","화","수","목","금","토"];
  const fmt = (v) => {
    if (!v) return "--";
    const p = v.split("-");
    const d = new Date(Number(p[0]), Number(p[1])-1, Number(p[2]));
    const dow = d.getDay();
    const clr = dow===0?"#e55":dow===6?"#47f":"#888";
    return <>{p[1]}.{p[2]}<span style={{color:clr,fontWeight:700,marginLeft:2}}>({DAYS[dow]})</span></>;
  };
  return <div style={{position:"relative",display:"inline-flex",...style}}>
    <div className="inp" style={{width:"100%",fontSize:12,padding:"5px 8px",textAlign:"center",whiteSpace:"nowrap",pointerEvents:"none",display:"flex",alignItems:"center",justifyContent:"center",gap:4}}>
      <I name="calPick" size={13} color="#aaa"/>{fmt(value)}</div>
    <input type="date" value={value} onChange={e=>onChange(e.target.value)} min={min}
      style={{position:"absolute",inset:0,opacity:0,width:"100%",height:"100%",cursor:"pointer",fontSize:16}}/>
  </div>;
}
function FLD({ label, children }) {
  return <div><label style={{fontSize:11,fontWeight:600,color:"#888",marginBottom:5,display:"block"}}>{label}</label>{children}</div>;
}

// ─── Styles ───
// Palette: #5cb5c5(teal) #7c7cc8(slate) #d0d0d0(pink) #f0f0f0(blush)
const S = {
  root: { display:"flex", height:"100dvh", fontFamily:"'Pretendard',-apple-system,BlinkMacSystemFont,'Noto Sans KR',sans-serif", background:"#f8f8f8", color:"#333", overflow:"hidden", position:"fixed", top:0, left:0, right:0, bottom:0 },
  sidebar: { width:200, background:"#fff", borderRight:"1px solid #e0e0e0", display:"flex", flexDirection:"column", position:"fixed", top:0, left:0, bottom:0, zIndex:50 },
  main: { flex:1, marginLeft:200, display:"flex", flexDirection:"column", height:"100%", minHeight:0, overflow:"hidden" },
  mobHdr: { padding:"10px 16px", background:"#fff", borderBottom:"1px solid #e0e0e0", display:"flex", alignItems:"center", gap:12, overflow:"hidden", transition:"max-height .3s ease, padding .3s ease, border-color .3s ease", maxHeight:60 },
  menuBtn: { background:"none", border:"none", color:"#333", cursor:"pointer", fontSize:20, fontFamily:"inherit" },
};

const CSS = `
  html,body,#root{height:100%;margin:0;padding:0;overflow:hidden}
  @supports(height:100dvh){html,body,#root{height:100dvh}}
  *{box-sizing:border-box;margin:0;padding:0}
  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}
  ::-webkit-scrollbar{width:10px;height:10px}
  ::-webkit-scrollbar-track{background:#eee}
  ::-webkit-scrollbar-thumb{background:#aaa;border-radius:5px;border:2px solid #eee}
  ::-webkit-scrollbar-thumb:hover{background:#888}
  .ov>div::-webkit-scrollbar{display:none}
  .timeline-scroll{scrollbar-width:auto;scrollbar-color:#999 #e0e0e0;overflow:scroll !important;scrollbar-gutter:stable}
  .timeline-scroll::-webkit-scrollbar{width:14px !important;height:14px !important;display:block !important}
  .timeline-scroll::-webkit-scrollbar-track{background:#e0e0e0 !important}
  .timeline-scroll::-webkit-scrollbar-thumb{background:#999 !important;border-radius:7px !important;border:3px solid #e0e0e0 !important}
  .timeline-scroll::-webkit-scrollbar-thumb:hover{background:#666 !important}
  .timeline-scroll::-webkit-scrollbar-corner{background:#d0d0d0 !important}
  div:hover>.resize-handle{opacity:1 !important}
  @media(pointer:coarse){.resize-handle{opacity:0.6 !important}}
  .tl-block{transition:box-shadow .2s ease,transform .15s ease !important}
  .tl-time-col{position:-webkit-sticky;position:sticky}
  .tl-hdr-cell{position:-webkit-sticky;position:sticky}
  .tl-block:hover{box-shadow:0 2px 8px rgba(0,0,0,.12) !important}
  @media(pointer:coarse){.tl-block:active{box-shadow:0 2px 8px rgba(0,0,0,.12) !important}}
  .tl-block:hover{box-shadow:0 4px 14px rgba(0,0,0,.18) !important;transform:translateY(-1px)}
  .tl-block:active{box-shadow:0 2px 6px rgba(0,0,0,.12) !important;transform:translateY(0)}
  input,select,textarea{font-family:inherit}
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideUp{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
  @keyframes bottomSheet{from{transform:translateY(100%)}to{transform:translateY(0)}}
  @keyframes ovFadeIn{from{opacity:0}to{opacity:1}}
  @keyframes slideIn{from{transform:translateX(-100%)}to{transform:translateX(0)}}
  @keyframes naverBlink{0%,100%{background:#fff3e0}50%{background:#ffe0b2}}
  @keyframes pendingBlink{0%,100%{opacity:1}50%{opacity:.5}}
  .fade-in{animation:fadeIn .6s ease}
  .card{background:#fff;border-radius:4px;border:1px solid #e0e0e0;box-shadow:none}
  .tw{overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th{text-align:left;padding:8px 10px;color:#555;font-weight:600;font-size:11px;letter-spacing:.3px;border-bottom:2px solid #e0e0e0;white-space:nowrap;position:sticky;top:0;background:#fff;z-index:1}
  td{padding:7px 10px;border-bottom:1px solid #eee;white-space:nowrap;color:#333}
  tr:hover td{background:#f5f5ff}
  .inp{background:#fff;border:1px solid #d0d0d0;color:#333;padding:7px 10px;border-radius:4px;font-size:13px;width:100%;font-family:inherit;outline:none;transition:border-color .15s}
  .inp:focus{border-color:#7c7cc8;box-shadow:0 0 0 2px rgba(124,124,200,.15)}

  select.inp{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:26px}
  .badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:99px;font-size:10px;font-weight:600}
  .btn-p{background:#7c7cc8;color:#fff;padding:7px 14px;border-radius:4px;border:none;cursor:pointer;font-size:12px;font-weight:700;font-family:inherit;display:inline-flex;align-items:center;gap:5px;transition:all .15s}
  .btn-p:hover{background:#6a6ab8}
  .btn-p:active{transform:scale(.97)}
  .btn-s{background:#f5f5f5;color:#555;padding:7px 14px;border-radius:4px;border:1px solid #d0d0d0;cursor:pointer;font-size:12px;font-weight:600;font-family:inherit;display:inline-flex;align-items:center;gap:5px;transition:all .15s}
  .btn-s:hover{background:#ebebeb}
  .btn-d{background:#e57373;color:#fff;padding:7px 14px;border-radius:4px;border:none;cursor:pointer;font-size:12px;font-weight:600;font-family:inherit;transition:all .15s}
  .btn-d:hover{background:#d32f2f}
  .btn-sm{padding:5px 10px;font-size:11px}
  .ov{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);z-index:200;display:flex;align-items:center;justify-content:center;padding:16px;animation:ovFadeIn .25s}
  .modal{background:#fff;border-radius:12px;border:1px solid #e0e0e0;padding:22px;width:92%;max-width:500px;max-height:85vh;overflow-y:auto;animation:slideUp .6s cubic-bezier(.22,1,.36,1);box-shadow:0 12px 40px rgba(0,0,0,.18)}
  .close-btn{background:none;border:none;color:#999;cursor:pointer;font-size:16px;font-family:inherit}
  .form-col{display:flex;flex-direction:column;gap:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .page-title{font-size:18px;font-weight:800;color:#333;margin-bottom:16px}
  @media(max-width:768px){
    .sidebar-d{display:none!important}
    .main-c{margin-left:0!important}
    .page-title{font-size:15px;margin-bottom:10px}
    .page-pad{padding:8px 6px 8px!important}
    .grid2{grid-template-columns:1fr!important}
    .form-col{gap:8px}
    .sale-grid{grid-template-columns:1fr 1fr!important;gap:8px!important}
    .sale-pay-row{flex-direction:column!important;gap:8px!important}
    .res-time-row{flex-wrap:wrap!important;overflow-x:auto!important}
    .res-time-row .inp{font-size:13px!important;padding:5px 8px!important}
    .res-room-sep{display:none!important}
    .res-room-sel{flex:1 1 100%!important;margin-top:4px!important}
    .cust-row{grid-template-columns:5.5em 1fr 44px!important;gap:6px!important}
    .cust-row .inp{height:38px!important;box-sizing:border-box!important}
    .cust-row button{height:38px!important;box-sizing:border-box!important}
    .form-col .inp,.form-col select.inp{height:38px!important;box-sizing:border-box!important;padding:5px 8px!important}
    .form-col textarea.inp{height:auto!important}
    .modal-res{width:92%!important;max-width:500px!important;border-radius:12px!important}
    .modal-res .form-col{overflow:visible!important}
    .ov{padding:8px!important;-webkit-overflow-scrolling:touch!important}
    .tl-topbar{flex-direction:column!important;gap:4px!important;padding:8px 10px!important}
    .mob-hdr{padding:10px 16px!important}
    .tl-date-label{font-size:15px!important}
    .tl-room-name{font-size:14px!important}
    .tl-room-sub{font-size:11px!important}
    .tl-time-col{position:-webkit-sticky!important;position:sticky!important}
    .tl-hdr-cell{position:-webkit-sticky!important;position:sticky!important}
    .tl-topbar{padding:8px 10px!important}

    .tl-days{width:100%;justify-content:space-between}
    .page-filter{flex-wrap:wrap!important;gap:4px!important}
    .page-filter .inp{max-width:130px!important}
    table{font-size:11px}
    th,td{padding:5px 6px}
    .btn-p,.btn-s,.btn-d{padding:6px 10px;font-size:11px}
    .btn-sm{padding:4px 8px!important;font-size:10px!important}
    .stat-cards{grid-template-columns:repeat(auto-fit,minmax(100px,1fr))!important;gap:8px!important}
    .stat-charts{grid-template-columns:1fr!important}
    .admin-tw{max-height:calc(100vh - 260px)!important}
    .ov{padding:8px!important}
    .modal-res span:not(.badge),.modal-res label,.modal-res p{font-size:13px!important}
    .modal-res h3{font-size:15px!important}
    .modal-res button{font-size:13px!important}
    .modal-res .inp,.modal-res select.inp,.modal-res textarea.inp{font-size:16px!important}
    .ov>div:not(.modal-res) span:not(.badge),.ov>div:not(.modal-res) label{font-size:13px!important}
    .ov>div:not(.modal-res) h3{font-size:15px!important}
    .ov>div:not(.modal-res) button{font-size:13px!important}
    .ov>div:not(.modal-res) .inp,.ov>div:not(.modal-res) select.inp{font-size:16px!important}
    .inp,.inp:focus{font-size:16px!important}
    select.inp{font-size:14px!important}
    .modal{padding:16px!important;max-height:90vh!important;width:92%!important;border-radius:12px!important}
  }
  @media(max-width:480px){
    .sale-grid{grid-template-columns:1fr!important}
    .page-filter .inp{max-width:110px!important;font-size:14px!important}
    .stat-cards{grid-template-columns:1fr 1fr!important}
  }
  @media(min-width:769px){
    .mob-hdr{display:none!important}
    .sidebar-m{display:none!important}
  }
`;

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));



ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
</script></body></html>
