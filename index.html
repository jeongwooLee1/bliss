<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Bliss ê´€ë¦¬ì‹œìŠ¤í…œ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>*{margin:0;padding:0;box-sizing:border-box}</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;
// React hooks provided by HTML wrapper

// â”€â”€â”€ Supabase Config â”€â”€â”€
const SB_URL = "https://dpftlrsuqxqqeouwbfjd.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwZnRscnN1cXhxcWVvdXdiZmpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MDU4MjQsImV4cCI6MjA4NzQ4MTgyNH0.iydEkjtPjZ0jXpUUPJben4IWWneDqLomv-HDlcFayE4";
const sbHeaders = {"apikey":SB_KEY,"Authorization":`Bearer ${SB_KEY}`,"Content-Type":"application/json","Prefer":"return=representation"};
const sb = {
  async get(table, filter="") { 
    const hasCreatedAt = !["rooms","services","products","service_categories","service_tags"].includes(table);
    const order = hasCreatedAt ? "order=created_at.asc.nullsfirst" : "order=id.asc";
    const r=await fetch(`${SB_URL}/rest/v1/${table}?select=*&${order}${filter}`,{headers:sbHeaders}); return r.ok?r.json():[]; 
  },
  async getByBiz(table, bizId) { return this.get(table, `&business_id=eq.${bizId}`); },
  async upsert(table,rows) { if(!rows?.length)return; await fetch(`${SB_URL}/rest/v1/${table}`,{method:"POST",headers:{...sbHeaders,"Prefer":"resolution=merge-duplicates,return=representation"},body:JSON.stringify(rows)}); },
  async insert(table,row) { const r=await fetch(`${SB_URL}/rest/v1/${table}`,{method:"POST",headers:sbHeaders,body:JSON.stringify(row)}); return r.ok?r.json():null; },
  async update(table,id,row) { await fetch(`${SB_URL}/rest/v1/${table}?id=eq.${id}`,{method:"PATCH",headers:sbHeaders,body:JSON.stringify(row)}); },
  async del(table,id) { await fetch(`${SB_URL}/rest/v1/${table}?id=eq.${id}`,{method:"DELETE",headers:sbHeaders}); },
  async delWhere(table,col,val) { await fetch(`${SB_URL}/rest/v1/${table}?${col}=eq.${val}`,{method:"DELETE",headers:sbHeaders}); },
};
// snake_case <-> camelCase column mapping per table
const DBMAP = {
  reservations:{business_id:"businessId",branch_id:"bid",room_id:"roomId",cust_id:"custId",cust_name:"custName",cust_phone:"custPhone",cust_gender:"custGender",staff_id:"staffId",end_time:"endTime",is_schedule:"isSchedule",is_new_cust:"isNewCust",selected_tags:"selectedTags",selected_services:"selectedServices",ts_log:"tsLog",repeat_source_id:"repeatSourceId",repeat_until:"repeatUntil",updated_at:"_ua"},
  sales:{business_id:"businessId",branch_id:"bid",cust_id:"custId",cust_name:"custName",cust_phone:"custPhone",cust_gender:"custGender",cust_num:"custNum",staff_id:"staffId",staff_name:"staffName",svc_cash:"svcCash",svc_transfer:"svcTransfer",svc_card:"svcCard",svc_point:"svcPoint",prod_cash:"prodCash",prod_transfer:"prodTransfer",prod_card:"prodCard",prod_point:"prodPoint",order_num:"orderNum",reservation_id:"reservationId"},
  customers:{business_id:"businessId",branch_id:"bid",last_visit:"lastVisit",cust_num:"custNum"},
  service_tags:{business_id:"businessId",schedule_yn:"scheduleYn",use_yn:"useYn"},
  services:{business_id:"businessId",price_f:"priceF",price_m:"priceM"},
  app_users:{business_id:"businessId",login_id:"loginId",branch_ids:"branches",password:"pw",view_branch_ids:"viewBranches"},
};
function fromDb(table,rows){const m=DBMAP[table];if(!m)return rows;return rows.map(row=>{const r={};for(const[k,v]of Object.entries(row)){if(k==="created_at"){r.createdAt=v;continue;}const mk=m[k]||k;r[mk]=v;} 
  // Parse JSON string arrays for app_users
  if(table==="app_users"){try{if(typeof r.branches==="string")r.branches=JSON.parse(r.branches);}catch{r.branches=[];}try{if(typeof r.viewBranches==="string")r.viewBranches=JSON.parse(r.viewBranches);}catch{r.viewBranches=[];}if(!Array.isArray(r.branches))r.branches=[];if(!Array.isArray(r.viewBranches))r.viewBranches=[];}
  // Convert booleans to Y/N for service_tags
  if(table==="service_tags"){r.scheduleYn=(r.scheduleYn===true||r.scheduleYn==="Y")?"Y":"N";r.useYn=r.useYn!==false;}
  return r;});}
// Valid DB columns per table (to filter out extra JS fields)
const DB_COLS={
  reservations:["id","business_id","branch_id","room_id","cust_id","cust_name","cust_phone","cust_gender","staff_id","date","time","end_time","dur","status","memo","type","is_schedule","is_new_cust","selected_tags","selected_services","ts_log","repeat_source_id","repeat","repeat_until","updated_at"],
  sales:["id","business_id","branch_id","cust_id","cust_name","cust_phone","cust_gender","cust_num","staff_id","staff_name","date","svc_cash","svc_transfer","svc_card","svc_point","prod_cash","prod_transfer","prod_card","prod_point","gift","memo","order_num","reservation_id"],
  customers:["id","business_id","branch_id","name","phone","gender","visits","last_visit","memo","cust_num"],
  service_tags:["id","business_id","name","dur","schedule_yn","color","use_yn","sort"],
  services:["id","business_id","cat","name","dur","price_f","price_m","note","sort"],
  app_users:["id","business_id","login_id","password","name","role","branch_ids","view_branch_ids"],
};
// Global active business context - auto-injected into DB writes
let _activeBizId = null;
const setActiveBiz = (bizId) => { _activeBizId = bizId; };

// Excel utility (uses SheetJS/XLSX global)
const XL = {
  download(rows, filename, sheetName="Sheet1") {
    if(typeof XLSX==="undefined"){alert("SheetJS ë¡œë“œ ì¤‘...");return;}
    const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,sheetName); XLSX.writeFile(wb,filename);
  },
  readFile(file) {
    return new Promise((resolve) => {
      const reader=new FileReader();
      reader.onload=ev=>{const wb=XLSX.read(ev.target.result,{type:"array"});resolve(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));};
      reader.readAsArrayBuffer(file);
    });
  }
};

function toDb(table,obj){const m=DBMAP[table];if(!m){const r={...obj};delete r.created_at;return r;}const rev={};for(const[k,v]of Object.entries(m))rev[v]=k;const r={};for(const[k,v]of Object.entries(obj)){if(k==="created_at"||k==="_ua")continue;r[rev[k]||k]=v;}
  // Stringify arrays for app_users
  if(table==="app_users"){if(Array.isArray(r.branch_ids))r.branch_ids=JSON.stringify(r.branch_ids);if(Array.isArray(r.view_branch_ids))r.view_branch_ids=JSON.stringify(r.view_branch_ids);}
  const cols=DB_COLS[table];if(cols){const f={};for(const c of cols)if(r[c]!==undefined)f[c]=r[c];
  // Auto-inject business_id if active and column exists
  if(_activeBizId && cols.includes("business_id") && !f.business_id) f.business_id=_activeBizId;
  return f;}return r;}

// Supabase seed: push initial data if table is empty
async function seedIfEmpty(table, appRows, mapTable) {
  const existing = await sb.get(table);
  if (existing.length > 0) return fromDb(mapTable||table, existing);
  const dbRows = appRows.map(r => toDb(mapTable||table, r));
  await sb.upsert(table, dbRows);
  return appRows;
}

// Load all data from Supabase (filtered by business_id)
async function loadAllFromDb(bizId) {
  if (!bizId) {
    // Super admin: load meta tables only
    const [businesses, groups, groupMembers, users] = await Promise.all([
      sb.get("businesses"), sb.get("business_groups"),
      sb.get("business_group_members"), sb.get("app_users"),
    ]);
    return { businesses, groups, groupMembers, users:fromDb("app_users",users) };
  }
  const [branches,rooms,users,customers,reservations,sales,serviceTags,services,products,cats] = await Promise.all([
    sb.getByBiz("branches",bizId), sb.getByBiz("rooms",bizId),
    sb.get("app_users",`&business_id=eq.${bizId}`), sb.getByBiz("customers",bizId),
    sb.getByBiz("reservations",bizId), sb.getByBiz("sales",bizId), sb.getByBiz("service_tags",bizId),
    sb.getByBiz("services",bizId), sb.getByBiz("products",bizId), sb.getByBiz("service_categories",bizId),
  ]);
  return { branches, rooms, users:fromDb("app_users",users), customers:fromDb("customers",customers),
    reservations:fromDb("reservations",reservations), sales:fromDb("sales",sales),
    serviceTags:fromDb("service_tags",serviceTags), services:fromDb("services",services),
    products, cats };
}

// â”€â”€â”€ Constants â”€â”€â”€
const BRANCHES = [
  { id: "b1", name: "ê°•ë‚¨ì ", short: "ê°•ë‚¨", phone: "0507-1316-5141", address: "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í•™ë™ë¡œ30ê¸¸ 16 ë‚¨ê°•ë¹Œë”© 5ì¸µ" },
  { id: "b2", name: "í™ëŒ€ì ", short: "í™ëŒ€", phone: "0507-1476-8005", address: "ì„œìš¸ì‹œ ë§ˆí¬êµ¬ ì–‘í™”ë¡œ 178 ëª©í™”ë¹Œë”© 5ì¸µ" },
  { id: "b3", name: "ì™•ì‹­ë¦¬ì ", short: "ì™•ì‹­ë¦¬", phone: "0507-1316-5141", address: "ì„œìš¸ì‹œ ì„±ë™êµ¬ ì™•ì‹­ë¦¬ë¡œ 311-1 3ì¸µ" },
  { id: "b4", name: "ì ì‹¤ì ", short: "ì ì‹¤", phone: "0507-1384-2553", address: "ì„œìš¸ì‹œ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 116 ë©”ë””ì‹œí‹° 5ì¸µ" },
  { id: "b5", name: "ì²œí˜¸ì ", short: "ì²œí˜¸", phone: "0507-1305-4735", address: "ì„œìš¸ì‹œ ê°•ë™êµ¬ ì˜¬ë¦¼í”½ë¡œ 664 ëŒ€ìš°í•œê°•ë² ë„¤ì‹œí‹° 203,204í˜¸" },
  { id: "b6", name: "ë§ˆê³¡ì ", short: "ë§ˆê³¡", phone: "0507-1413-6123", address: "ì„œìš¸ì‹œ ê°•ì„œêµ¬ ë§ˆê³¡ì¤‘ì•™ë¡œ 59-17 3ì¸µ 310í˜¸" },
  { id: "b7", name: "ìš©ì‚°ì ", short: "ìš©ì‚°", phone: "010-2330-8088", address: "ì„œìš¸ì‹œ ìš©ì‚°êµ¬ í•œê°•ëŒ€ë¡œ 69 ìš©ì‚°í‘¸ë¥´ì§€ì˜¤ì¨ë°‹ ìƒê°€ë™ B1ì¸µ 114-2í˜¸" },
  { id: "b8", name: "ìœ„ë¡€ì ", short: "ìœ„ë¡€", phone: "0507-1424-8078", address: "ê²½ê¸°ë„ ì„±ë‚¨ì‹œ ìˆ˜ì •êµ¬ ìœ„ë¡€ê´‘ì¥ë¡œ 300 ì¤‘ì•™íƒ€ì›Œ 4ì¸µ 403í˜¸" },
];

const ROOMS = (() => {
  const rooms = [];
  const configs = {
    b1: [
      {n:"ë§ˆ1",color:"#E8F0FE"},{n:"ë§ˆ2",color:"#E8F0FE"},{n:"ë§ˆ3",color:"#E8F0FE"},
      {n:"ë§ˆ4",color:"#FFF3E0"},{n:"ë§ˆ5",color:"#FFF3E0"},{n:"ë§ˆ6",color:"#FFF3E0"},
      {n:"ì‹œë‹ˆì–´1",color:"#F3E5F5"},{n:"ì‹œë‹ˆì–´2",color:"#F3E5F5"},{n:"ì‹œë‹ˆì–´3",color:"#F3E5F5"}
    ],
    b2: [{n:"í™1",color:"#E8F0FE"},{n:"í™2",color:"#FFF3E0"}],
    b3: [{n:"ì™•ë§ˆ1",color:"#E8F0FE"},{n:"1 ì™•ì§€ì›ë§ˆ",color:"#FFF3E0"},{n:"ì™•ì‹œë‹ˆì–´1",color:"#F3E5F5"},{n:"ì™•ì‹œë‹ˆì–´2",color:"#F3E5F5"}],
    b4: [{n:"ì 1",color:"#E8F0FE"},{n:"ì 2",color:"#FFF3E0"},{n:"ì ì‹œë‹ˆì–´1",color:"#F3E5F5"}],
    b5: [{n:"ì²œ1",color:"#E8F0FE"},{n:"ì²œ2",color:"#FFF3E0"},{n:"ì²œì‹œë‹ˆì–´1",color:"#F3E5F5"}],
    b6: [{n:"ë§ˆê³¡1",color:"#E8F0FE"},{n:"ë§ˆê³¡2",color:"#FFF3E0"}],
    b7: [{n:"ìš©1",color:"#E8F0FE"},{n:"ìš©2",color:"#FFF3E0"},{n:"ìš©ì‹œë‹ˆì–´1",color:"#F3E5F5"}],
    b8: [{n:"ìœ„1",color:"#E8F0FE"},{n:"ìœ„2",color:"#FFF3E0"},{n:"ìœ„ì‹œë‹ˆì–´1",color:"#F3E5F5"}],
  };
  Object.entries(configs).forEach(([bid, arr]) => {
    arr.forEach((r, i) => rooms.push({ id: `${bid}_r${i}`, branch_id: bid, name: r.n, color: r.color || "", sort_order: i }));
  });
  return rooms;
})();

const SERVICE_CATS = [
  { id: "sc1", name: "ì—ë„ˆì§€í…Œë¼í”¼" }, { id: "sc2", name: "ë¸Œë¼ì§ˆë¦¬ì–¸" },
  { id: "sc3", name: "ë°”ë””" }, { id: "sc4", name: "íŒ”/ë‹¤ë¦¬/ì†/ë°œ" },
  { id: "sc5", name: "ë“±/ë°°/ê°€ìŠ´" }, { id: "sc6", name: "í˜ì´ì…œ" },
  { id: "sc7", name: "ëª©" },
];

// ì „ ì§€ì  ë™ì¼ê°€ - priceF:ì—¬ì„±, priceM:ë‚¨ì„± (0ì´ë©´ í•´ë‹¹ ì„±ë³„ ë¶ˆê°€)
const INIT_SERVICES = [
  // ì—ë„ˆì§€í…Œë¼í”¼
  { id:"s1", cat:"sc1", name:"ì—ë„ˆì§€í…Œë¼í”¼ 60ë¶„", dur:60, priceF:198000, priceM:198000, note:"ê³µë™ê°€", sort:0 },
  { id:"s2", cat:"sc1", name:"ì—ë„ˆì§€í…Œë¼í”¼ 20ë¶„", dur:20, priceF:66000, priceM:66000, note:"ê³µë™ê°€", sort:1 },
  // ë¸Œë¼ì§ˆë¦¬ì–¸
  { id:"s3", cat:"sc2", name:"ë¸Œë¼ì§ˆë¦¬ì–¸", dur:35, priceF:154000, priceM:176000, note:"ì¿ í° ì ìš© ì‹œ í• ì¸", sort:2 },
  { id:"s4", cat:"sc2", name:"ë¸Œë¼ì§ˆë¦¬ì–¸ + ì¼€ì–´", dur:50, priceF:187000, priceM:209000, note:"ì¿ í° ì ìš© ì‹œ í• ì¸", sort:3 },
  { id:"s5", cat:"sc2", name:"ë¸Œë¼ì§ˆë¦¬ì–¸ + ê¶í…Œë¼í”¼", dur:65, priceF:220000, priceM:0, note:"ì—¬ì„± ì „ìš©", sort:4 },
  { id:"s6", cat:"sc2", name:"ë¸Œë¼ì§ˆë¦¬ì–¸ + ë¨¸ìŠ¬ëœë”", dur:65, priceF:0, priceM:242000, note:"ë‚¨ì„± ì „ìš©", sort:5 },
  { id:"s7", cat:"sc2", name:"ë¹„í‚¤ë‹ˆ", dur:25, priceF:55000, priceM:88000, sort:6 },
  { id:"s8", cat:"sc2", name:"í•­ë¬¸ ì™ì‹±", dur:25, priceF:55000, priceM:55000, sort:7 },
  // ë°”ë””
  { id:"s9", cat:"sc3", name:"ê²¨ë“œë‘ì´", dur:20, priceF:20000, priceM:30000, sort:8 },
  { id:"s10", cat:"sc3", name:"ì—‰ë©ì´", dur:13, priceF:10000, priceM:10000, note:"ì—¬10000~30000/ë‚¨10000~50000", sort:9 },
  { id:"s11", cat:"sc3", name:"ìœ ë¥œ", dur:10, priceF:10000, priceM:10000, sort:10 },
  // íŒ”/ë‹¤ë¦¬/ì†/ë°œ
  { id:"s12", cat:"sc4", name:"íŒ” ì „ì²´", dur:30, priceF:70000, priceM:90000, sort:11 },
  { id:"s13", cat:"sc4", name:"íŒ” ì ˆë°˜", dur:25, priceF:40000, priceM:60000, sort:12 },
  { id:"s14", cat:"sc4", name:"ë‹¤ë¦¬ ì „ì²´", dur:40, priceF:90000, priceM:110000, sort:13 },
  { id:"s15", cat:"sc4", name:"ë‹¤ë¦¬ ì ˆë°˜", dur:25, priceF:50000, priceM:70000, note:"ë¬´ë¦ ê¸°ì¤€", sort:14 },
  { id:"s16", cat:"sc4", name:"ì† ì „ì²´", dur:10, priceF:20000, priceM:20000, sort:15 },
  { id:"s17", cat:"sc4", name:"ì† ì ˆë°˜", dur:10, priceF:10000, priceM:10000, sort:16 },
  { id:"s18", cat:"sc4", name:"ë°œê°€ë½", dur:10, priceF:10000, priceM:10000, sort:17 },
  // ë“±/ë°°/ê°€ìŠ´
  { id:"s19", cat:"sc5", name:"ë“± ì „ì²´", dur:25, priceF:50000, priceM:70000, sort:18 },
  { id:"s20", cat:"sc5", name:"ë“± ì ˆë°˜", dur:20, priceF:30000, priceM:40000, sort:19 },
  { id:"s21", cat:"sc5", name:"ë°°", dur:18, priceF:10000, priceM:10000, note:"ì—¬10000~30000/ë‚¨10000~40000", sort:20 },
  { id:"s22", cat:"sc5", name:"ê°€ìŠ´", dur:18, priceF:10000, priceM:10000, note:"ì—¬10000~30000/ë‚¨10000~40000", sort:21 },
  // í˜ì´ì…œ
  { id:"s23", cat:"sc6", name:"ëˆˆì¹", dur:30, priceF:45000, priceM:45000, note:"ë””ìì¸ í¬í•¨", sort:22 },
  { id:"s24", cat:"sc6", name:"ì¸ì¤‘", dur:10, priceF:15000, priceM:25000, sort:23 },
  { id:"s25", cat:"sc6", name:"ë³¼", dur:20, priceF:20000, priceM:30000, note:"ì—¬20000~50000/ë‚¨30000~70000", sort:24 },
  { id:"s26", cat:"sc6", name:"ì´ë§ˆ", dur:15, priceF:30000, priceM:40000, sort:25 },
  { id:"s27", cat:"sc6", name:"í—¤ì–´ë¼ì¸", dur:15, priceF:30000, priceM:30000, sort:26 },
  { id:"s28", cat:"sc6", name:"êµ¬ë ›ë‚˜ë£¨", dur:18, priceF:20000, priceM:20000, sort:27 },
  { id:"s29", cat:"sc6", name:"í„±", dur:25, priceF:10000, priceM:30000, note:"ì—¬10000~30000/ë‚¨30000~50000", sort:28 },
  // ëª©
  { id:"s30", cat:"sc7", name:"ì•ëª©", dur:10, priceF:10000, priceM:10000, note:"ì—¬10000~30000/ë‚¨10000~30000", sort:29 },
  { id:"s31", cat:"sc7", name:"ë’·ëª©", dur:20, priceF:30000, priceM:30000, sort:30 },
];
const SERVICES = INIT_SERVICES; // alias for existing code

const PRODUCTS = [
  { id: "p1", name: "GLì•„ë¥´ê°„ì˜¤ì¼", price: 0, cat: "product" },
  { id: "p2", name: "ë” ëª¨ ìŠ¤í¬ëŸ½", price: 0, cat: "product" },
  { id: "p3", name: "ì½”ì½”ë„› ìŠ¤í¬ëŸ½", price: 0, cat: "product" },
  { id: "p4", name: "ëª¨ìŠ¬ë¡œ", price: 0, cat: "product" },
  { id: "p5", name: "ì¸-ìŠ¤í”„ë ˆì´", price: 0, cat: "product" },
  { id: "p6", name: "ë¯¸ë°±í¬ë¦¼", price: 0, cat: "product" },
  { id: "p7", name: "ê°€ìš´(ì—¬)", price: 0, cat: "product" },
  { id: "p8", name: "ê°€ìš´(ë‚¨)", price: 0, cat: "product" },
  { id: "p9", name: "ì „í›„ ì²˜ë¦¬ì œ å¤§", price: 0, cat: "product" },
  { id: "p10", name: "ì „í›„ ì²˜ë¦¬ì œ å°", price: 0, cat: "product" },
  { id: "p11", name: "ì¸íŠ¸í¬ë¦¼", price: 0, cat: "product" },
  { id: "p12", name: "ì—ë„ˆì§€ í™€ì´íˆ¬", price: 0, cat: "product" },
  { id: "p13", name: "ì—ë„ˆì§€ ì£¼ì—´ê¸°", price: 0, cat: "product" },
  { id: "p14", name: "ì„±ê²°ì²´", price: 0, cat: "product" },
  { id: "p15", name: "ì•„ë¡¬í… ì¹´íŠ¸ë¦¬ì§€", price: 0, cat: "product" },
  { id: "p16", name: "ì¹´íŠ¸ë¦¬ì§€ SET", price: 0, cat: "product" },
  { id: "p17", name: "ìŠ¤íŠ¸ë¦½ 100ì¥", price: 0, cat: "product" },
  { id: "p18", name: "ìŠ¤íŒŒíŠ¤ë¼ 1box", price: 0, cat: "product" },
  { id: "p19", name: "ì½œê³¡ì™ìŠ¤", price: 0, cat: "product" },
  { id: "p20", name: "ì™ìŠ¤", price: 0, cat: "product" },
  { id: "p21", name: "íŠœë¸Œ(ì‚´êµ¬)ìŠ¤í¬ë¦¼", price: 0, cat: "product" },
];

// ìƒí’ˆì¢…ë¥˜ (myCream ìƒí’ˆì¢…ë¥˜ê´€ë¦¬ ì „ì²´ ë°ì´í„°) - dur:ì†Œìš”ì‹œê°„(ë¶„), scheduleYn:ê¸°íƒ€ì¼ì •, color:ìƒ‰ìƒ, useYn:ì‚¬ìš©ì—¬ë¶€
const INIT_SERVICE_TAGS = [
  // â”€â”€ ìœ ì…ì±„ë„ (ì†Œìš”ì‹œê°„ 0) â”€â”€
  { id:"t1", name:"ì „í™”", dur:0, scheduleYn:"N", color:"", useYn:true, sort:0 },
  { id:"t2", name:"ë„¤ì´ë²„", dur:0, scheduleYn:"N", color:"", useYn:true, sort:1 },
  { id:"t3", name:"ì¹´ì¹´ì˜¤", dur:0, scheduleYn:"N", color:"", useYn:true, sort:2 },
  { id:"t4", name:"ì„ ì˜ˆì•½", dur:0, scheduleYn:"N", color:"", useYn:true, sort:3 },
  { id:"t5", name:"ì¸ìŠ¤íƒ€", dur:0, scheduleYn:"N", color:"", useYn:true, sort:4 },
  { id:"t6", name:"êµ¬ê¸€", dur:0, scheduleYn:"N", color:"", useYn:true, sort:5 },
  { id:"t7", name:"ì™“ì¸ ì•±", dur:0, scheduleYn:"N", color:"", useYn:true, sort:6 },
  // â”€â”€ ê³ ê°êµ¬ë¶„ â”€â”€
  { id:"t8", name:"ê¸°)ì¢…ë£Œâ˜…", dur:0, scheduleYn:"N", color:"", useYn:true, sort:7 },
  { id:"t9", name:"ë°”í”„â˜…ë‹¤ë‹´", dur:0, scheduleYn:"N", color:"", useYn:true, sort:8 },
  { id:"t10", name:"ì‹ ê·œâ™¥í˜ë°”", dur:0, scheduleYn:"N", color:"", useYn:true, sort:9 },
  { id:"t11", name:"ê¸°ì¡´", dur:0, scheduleYn:"N", color:"", useYn:true, sort:10 },
  { id:"t12", name:"ì‹ ê·œâ™¥ìŒëª¨", dur:0, scheduleYn:"N", color:"", useYn:true, sort:11 },
  { id:"t13", name:"ê¸°ì¡´â™¥ìƒë‹´", dur:0, scheduleYn:"N", color:"", useYn:true, sort:12 },
  { id:"t14", name:"ì§€ì •ê´€ë¦¬", dur:0, scheduleYn:"N", color:"", useYn:true, sort:13 },
  { id:"t15", name:"ì„ ì˜ˆì•½2", dur:0, scheduleYn:"N", color:"", useYn:true, sort:14 },
  { id:"t16", name:"ì²´í—˜/ì¸í”Œ", dur:0, scheduleYn:"N", color:"", useYn:true, sort:15 },
  { id:"t17", name:"ìŒëª¨", dur:0, scheduleYn:"N", color:"", useYn:true, sort:16 },
  { id:"t18", name:"ì˜ˆì•½ê¸ˆì™„ë£Œ", dur:0, scheduleYn:"N", color:"", useYn:true, sort:17 },
  { id:"t19", name:"â˜…â˜…ì´ˆë³´âœ•", dur:0, scheduleYn:"N", color:"", useYn:true, sort:18 },
  // â”€â”€ íŒ¨í‚¤ì§€ íƒœê·¸ â”€â”€
  { id:"t20", name:"ì™ì‹¬PKG", dur:0, scheduleYn:"N", color:"", useYn:true, sort:19 },
  { id:"t21", name:"í† íƒˆPKG", dur:0, scheduleYn:"N", color:"", useYn:true, sort:20 },
  { id:"t22", name:"ì‹ )ííŒ¨", dur:0, scheduleYn:"N", color:"", useYn:true, sort:21 },
  { id:"t23", name:"ì¬ìƒPKG", dur:0, scheduleYn:"N", color:"", useYn:true, sort:22 },
  { id:"t24", name:"êµ¬)ííŒ¨", dur:0, scheduleYn:"N", color:"", useYn:true, sort:23 },
  { id:"t25", name:"ë‹¤ë‹´ê¶Œë³´ìœ ", dur:0, scheduleYn:"N", color:"", useYn:true, sort:24 },
  // â”€â”€ ì‹œìˆ  íƒœê·¸ (ì†Œìš”ì‹œê°„ ìˆìŒ) â”€â”€
  { id:"t26", name:"ë‚˜ë…¸ì™ì‹±", dur:10, scheduleYn:"N", color:"", useYn:true, sort:25 },
  { id:"t27", name:"ë°”ë””", dur:10, scheduleYn:"N", color:"", useYn:true, sort:26 },
  { id:"t28", name:"í’€ë°”ë””", dur:40, scheduleYn:"N", color:"", useYn:true, sort:27 },
  { id:"t29", name:"ëˆˆì¹", dur:30, scheduleYn:"N", color:"", useYn:true, sort:28 },
  { id:"t30", name:"í˜ì´ìŠ¤", dur:25, scheduleYn:"N", color:"", useYn:true, sort:29 },
  { id:"t31", name:"ì—ë„ˆì§€", dur:60, scheduleYn:"N", color:"", useYn:true, sort:30 },
  { id:"t32", name:"ì†ëˆˆì¹íŒ", dur:60, scheduleYn:"N", color:"", useYn:true, sort:31 },
  // â”€â”€ ê¸°íƒ€ íƒœê·¸ â”€â”€
  { id:"t33", name:"#ì£¼ì°¨", dur:0, scheduleYn:"N", color:"", useYn:true, sort:32 },
  { id:"t34", name:"ì‚°ëª¨ë‹˜", dur:0, scheduleYn:"N", color:"", useYn:true, sort:33 },
  { id:"t35", name:"ì»¤í”Œë£¸", dur:0, scheduleYn:"N", color:"", useYn:true, sort:34 },
  { id:"t36", name:"ì–‘ë„ì‚¬ìš©", dur:0, scheduleYn:"N", color:"", useYn:true, sort:35 },
  { id:"t37", name:"ì¼€ì–´íŒ¨í‚¤ì§€", dur:0, scheduleYn:"N", color:"", useYn:true, sort:36 },
  { id:"t38", name:"ë‚¨ìì„ ìƒë‹˜", dur:0, scheduleYn:"N", color:"", useYn:true, sort:37 },
  { id:"t39", name:"ì§ê±°ë˜êµìœ¡", dur:0, scheduleYn:"N", color:"", useYn:true, sort:38 },
  // â”€â”€ ê¸°íƒ€ì¼ì • íƒœê·¸ (scheduleYn:Y) â”€â”€
  { id:"t40", name:"ì¶œê·¼", dur:20, scheduleYn:"Y", color:"#F96DA7", useYn:true, sort:39 },
  { id:"t41", name:"ì¶œê·¼ë‚¨", dur:20, scheduleYn:"Y", color:"#3CB889", useYn:true, sort:40 },
  { id:"t42", name:"ì´ë™", dur:60, scheduleYn:"Y", color:"#EFDFEB", useYn:true, sort:41 },
  { id:"t43", name:"ì˜¤í”ˆA", dur:15, scheduleYn:"Y", color:"#A2B240", useYn:true, sort:42 },
  { id:"t44", name:"ì˜¤í”ˆB30ë¶„ì†Œìš”", dur:30, scheduleYn:"Y", color:"#A2B240", useYn:true, sort:43 },
  { id:"t45", name:"ì˜¤í”ˆC", dur:30, scheduleYn:"Y", color:"#A2B240", useYn:true, sort:44 },
  { id:"t46", name:"60ì¶”ê²Œ", dur:60, scheduleYn:"Y", color:"#EFDFEB", useYn:true, sort:45 },
  { id:"t47", name:"45ì¶”ê²Œ", dur:45, scheduleYn:"Y", color:"#EFDFEB", useYn:true, sort:46 },
  { id:"t48", name:"30ì¶”ê²Œ", dur:30, scheduleYn:"Y", color:"#EFDFEB", useYn:true, sort:47 },
  { id:"t49", name:"15ì¶”ê²Œ", dur:15, scheduleYn:"Y", color:"#EFDFEB", useYn:true, sort:48 },
  { id:"t50", name:"ë°”ë””ë„ì›€", dur:20, scheduleYn:"Y", color:"#96ABE5", useYn:true, sort:49 },
  { id:"t51", name:"í˜ì´ìŠ¤ë„ì›€", dur:20, scheduleYn:"Y", color:"#96ABE5", useYn:true, sort:50 },
  { id:"t52", name:"í¬ë¡œìŠ¤ë„ì›€", dur:10, scheduleYn:"Y", color:"#96ABE5", useYn:true, sort:51 },
  { id:"t53", name:"ì¼€ì–´ë„ì›€", dur:15, scheduleYn:"Y", color:"#96ABE5", useYn:true, sort:52 },
  { id:"t54", name:"ì—ë„ˆì§€ë„ì›€", dur:40, scheduleYn:"Y", color:"#96ABE5", useYn:true, sort:53 },
  { id:"t55", name:"ì†ëˆˆì¹ë„ì›€", dur:60, scheduleYn:"Y", color:"", useYn:true, sort:54 },
  { id:"t56", name:"ì²­ì†Œ", dur:30, scheduleYn:"Y", color:"#A2B240", useYn:true, sort:55 },
  { id:"t57", name:"ì²­ì†Œ(ë°”ë‹¥)", dur:10, scheduleYn:"Y", color:"#A2B240", useYn:true, sort:56 },
  { id:"t58", name:"ì•„ì¹¨(ë¹¨ê°„)", dur:30, scheduleYn:"Y", color:"#A2B240", useYn:true, sort:57 },
  { id:"t59", name:"ì „ì¼", dur:30, scheduleYn:"Y", color:"#C1AEFF", useYn:true, sort:58 },
  { id:"t60", name:"ì „ì¼í¬ë¡œìŠ¤", dur:15, scheduleYn:"Y", color:"#C1AEFF", useYn:true, sort:59 },
  { id:"t61", name:"ì¬ê³ ", dur:20, scheduleYn:"Y", color:"#C1AEFF", useYn:true, sort:60 },
  { id:"t62", name:"ì—ë„ˆì§€ì „ì‹ 60", dur:60, scheduleYn:"Y", color:"#96ABE5", useYn:true, sort:61 },
  { id:"t63", name:"ë¯¸ìˆ ", dur:50, scheduleYn:"Y", color:"#96ABE5", useYn:true, sort:62 },
  { id:"t64", name:"ì˜¤ëŠ˜ì˜ê³µë¶€", dur:60, scheduleYn:"Y", color:"#BFBF01", useYn:true, sort:63 },
  { id:"t65", name:"ë©”ëª¨", dur:30, scheduleYn:"Y", color:"#BF7DDF", useYn:true, sort:64 },
  { id:"t66", name:"ì§ê±°ë˜êµìœ¡", dur:20, scheduleYn:"Y", color:"#BFBF01", useYn:false, sort:65 },
  { id:"t67", name:"íšŒê·¼Â·ì—°ì¥/ì¼í‡´ì—¬ê¸°ì‘ì„±", dur:60, scheduleYn:"Y", color:"#EFDFEB", useYn:true, sort:66 },
  { id:"t68", name:"â˜…í•„ìˆ˜â˜…5ì‹œ", dur:15, scheduleYn:"Y", color:"#EF2B15", useYn:true, sort:67 },
  { id:"t69", name:"â˜…í•„ìˆ˜â˜…7ì‹œ", dur:30, scheduleYn:"Y", color:"#EF2B15", useYn:true, sort:68 },
  { id:"t70", name:"â˜…í•„ìˆ˜â˜…9ì‹œ", dur:40, scheduleYn:"Y", color:"#EF2B15", useYn:true, sort:69 },
  { id:"t71", name:"â˜…ë¹„ì•½í™•ì¸í¬ë¡œìŠ¤â˜…", dur:15, scheduleYn:"Y", color:"#EF2B15", useYn:true, sort:70 },
  { id:"t72", name:"ğŸ”” ì•ŒëŒ", dur:5, scheduleYn:"Y", color:"#FF6B00", useYn:true, sort:71 },
];

const STAFF = [
  { id: "u1", bid: "b1", name: "ê¹€ì§€ì€", dn: "ì§€ì€ìŒ¤", role: "admin" },
  { id: "u2", bid: "b1", name: "ì´ìˆ˜ì§„", dn: "ìˆ˜ì§„ìŒ¤", role: "staff" },
  { id: "u3", bid: "b1", name: "ë°•ë¯¼ì •", dn: "ë¯¼ì •ìŒ¤", role: "staff" },
  { id: "u4", bid: "b1", name: "ìµœì†Œì—°", dn: "ì†Œì—°ìŒ¤", role: "staff" },
  { id: "u5", bid: "b1", name: "ì •ê²½ì•„", dn: "ê²½ì•„ìŒ¤", role: "staff" },
  { id: "u6", bid: "b1", name: "í•œìˆ˜ì—°", dn: "ìˆ˜ì—°ìŒ¤", role: "staff" },
  { id: "u7", bid: "b2", name: "ì˜¤í˜„ì•„", dn: "í˜„ì•„ìŒ¤", role: "admin" },
  { id: "u8", bid: "b3", name: "ìœ¤ìˆ˜ë¯¼", dn: "ìˆ˜ë¯¼ìŒ¤", role: "admin" },
  { id: "u9", bid: "b4", name: "ì„ìˆ˜ì—°", dn: "ìˆ˜ì—°ìŒ¤", role: "admin" },
  { id: "u10", bid: "b5", name: "ê°•ì„¸ë¼", dn: "ì„¸ë¼ìŒ¤", role: "admin" },
  { id: "u11", bid: "b6", name: "ì¡°ë‹¤ì€", dn: "ë‹¤ì€ìŒ¤", role: "admin" },
  { id: "u12", bid: "b7", name: "ì‹ ë³´ë¼", dn: "ë³´ë¼ìŒ¤", role: "admin" },
  { id: "u13", bid: "b8", name: "ë¥˜í•˜ë¦°", dn: "í•˜ë¦°ìŒ¤", role: "admin" },
];

// â”€â”€â”€ Users (accounts) â”€â”€â”€
const INIT_USERS = [
  { id:"acc_super", name:"Bliss ê´€ë¦¬ì", loginId:"admin", pw:"1234", role:"super", branches: [], viewBranches:[] },
  { id:"acc_hw_owner", name:"í•˜ìš°ìŠ¤ì™ì‹± ëŒ€í‘œ", loginId:"master", pw:"1234", role:"owner", branches:BRANCHES.map(b=>b.id), viewBranches:[], businessId:"biz_hw" },
];

const uid = () => Math.random().toString(36).substr(2, 9);
const fmt = n => (n || 0).toLocaleString("ko-KR");
const todayStr = () => new Date().toISOString().split("T")[0];
const TIMES = [];
for (let h = 8; h <= 22; h++) for (let m = 0; m < 60; m += 5)
  TIMES.push(`${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`);
const HOUR_TIMES = [];
for (let h = 10; h <= 21; h++) { HOUR_TIMES.push(`${String(h).padStart(2,"0")}:00`); HOUR_TIMES.push(`${String(h).padStart(2,"0")}:30`); }

const PAY_KEYS = ["cash","transfer","card","point"];
const PAY_LABEL = { cash:"í˜„ê¸ˆ", transfer:"ì…ê¸ˆ", card:"ì¹´ë“œ", point:"í¬ì¸íŠ¸", gift:"ìƒí’ˆê¶Œ" };
const PAY_CLR = { cash:"#6bab9e", transfer:"#ef5350", card:"#7c7cc8", point:"#d0d0d0", gift:"#ef5350" };
const STATUS_LABEL = { confirmed:"ì˜ˆì•½í™•ì •", completed:"ì™„ë£Œ", cancelled:"ì·¨ì†Œ", no_show:"ë…¸ì‡¼" };
const STATUS_CLR = { confirmed:"#7c7cc8", completed:"#6bab9e", cancelled:"#e57373", no_show:"#ef5350" };
const BLOCK_COLORS = { reservation:"#7c7cc8", memo:"#ef5350", clockin:"#d0d0d0", cleaning:"#5cb5c5", break:"#9e9ec8" };
const BLOCK_LABELS = { reservation:"ì˜ˆì•½", memo:"ë©”ëª¨", clockin:"ì¶œê·¼", cleaning:"ì²­ì†Œ", break:"íœ´ì‹" };

function generateData() {
  const customers = [], reservations = [], sales = [];
  const names = ["ê¹€ë¯¼ì§€","ì´ì„œìœ¤","ë°•ì§€ìœ ","ìµœìˆ˜ì•„","ì •ì˜ˆë¦°","í•œì†Œìœ¨","ì˜¤í•˜ì€","ìœ¤ì±„ì›","ì„ë‹¤ì¸","ê°•ì„œí˜„","ì¡°ìœ ë‚˜","ì†¡ì§€ì•„","ì‹ í•˜ë¦°","ë¥˜ì€ì„œ","ë°±ì•„ë¦°","ë‚¨ì§€ì›","ì „ë¯¼ì„œ","ê³ ì˜ˆì€","ë¬¸ì„œì§„","í™ë‹¤í˜„","ì–‘ì†Œë¯¸","ê¶Œë‚˜ì—°","ì¥ì„œì˜","ì‹¬ì˜ˆì§€","ë°°í•˜ìœ¨"];
  const SERVICES = INIT_SERVICES;
  const maleNames = ["ê¹€ë¯¼ì¤€","ì´ì„œì¤€","ë°•ë„ìœ¤","ìµœì‹œìš°","ì •ì˜ˆì¤€","í•œì§€í˜¸","ì˜¤ì£¼ì›","ìœ¤í•˜ì¤€","ì„ê±´ìš°","ê°•í˜„ìš°"];
  
  BRANCHES.forEach(br => {
    for (let i = 0; i < 10; i++) {
      const isMale = Math.random() > 0.7;
      const nm = isMale ? maleNames[Math.floor(Math.random()*maleNames.length)] : names[Math.floor(Math.random()*names.length)];
      customers.push({ id: uid(), bid: br.id, name: nm, phone: `010-${String(1000+Math.floor(Math.random()*9000))}-${String(1000+Math.floor(Math.random()*9000))}`, gender: isMale?"M":"F", visits: Math.floor(Math.random()*15)+1, lastVisit: todayStr(), memo:"", custNum: String(50000+Math.floor(Math.random()*10000)) });
    }
  });

  const d = new Date();
  for (let off = 0; off < 14; off++) {
    const dd = new Date(d); dd.setDate(dd.getDate() - off);
    const ds = dd.toISOString().split("T")[0];
    BRANCHES.forEach(br => {
      const bCust = customers.filter(c => c.bid === br.id);
      const bStaff = STAFF.filter(s => s.bid === br.id);
      const bRooms = ROOMS.filter(r => r.branch_id === br.id);
      const n = Math.floor(Math.random()*6)+4;
      for (let k = 0; k < n; k++) {
        const svc = SERVICES[Math.floor(Math.random()*SERVICES.length)];
        const cust = bCust[Math.floor(Math.random()*bCust.length)];
        const staff = bStaff.length > 0 ? bStaff[Math.floor(Math.random()*bStaff.length)] : STAFF[0];
        const room = bRooms.length > 0 ? bRooms[Math.floor(Math.random()*bRooms.length)] : null;
        const h = 10 + Math.floor(Math.random()*9);
        const m = [0,10,20,30,40,50][Math.floor(Math.random()*6)];
        const time = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
        const status = off === 0 ? (Math.random()>0.4?"confirmed":"completed") : "completed";
        
        reservations.push({
          id: uid(), bid: br.id, roomId: room?.id||null, custId: cust.id, custName: cust.name, custPhone: cust.phone, custGender: cust.gender,
          staffId: staff.id, serviceId: svc.id, date: ds, time, dur: svc.dur, status, memo:"", type:"reservation"
        });

        if (status === "completed" || off > 0) {
          const payMethod = ["cash","card","transfer","point"][Math.floor(Math.random()*4)];
          const hasProduct = Math.random() > 0.7;
          const prod = hasProduct ? PRODUCTS[Math.floor(Math.random()*PRODUCTS.length)] : null;
          const svcPay = { cash:0, transfer:0, card:0, point:0 };
          svcPay[payMethod] = cust.gender==="M" ? (svc.priceM||svc.priceF) : (svc.priceF||svc.priceM);
          const prodPay = { cash:0, transfer:0, card:0, point:0 };
          if (prod) prodPay[payMethod] = prod.price;
          const gift = Math.random() > 0.9 ? 10000 : 0;

          sales.push({
            id: uid(), bid: br.id, custId: cust.id, custName: cust.name, custPhone: cust.phone, custNum: cust.custNum,
            staffId: staff.id, staffName: staff.dn, date: ds,
            serviceId: svc.id, serviceName: svc.name,
            productId: prod?.id||null, productName: prod?.name||null,
            svcCash: svcPay.cash, svcTransfer: svcPay.transfer, svcCard: svcPay.card, svcPoint: svcPay.point,
            prodCash: prodPay.cash, prodTransfer: prodPay.transfer, prodCard: prodPay.card, prodPoint: prodPay.point,
            gift, orderNum: String(251900+Math.floor(Math.random()*200)),
            get svcTotal() { return this.svcCash+this.svcTransfer+this.svcCard+this.svcPoint; },
            get prodTotal() { return this.prodCash+this.prodTransfer+this.prodCard+this.prodPoint; },
            get total() { return this.svcTotal+this.prodTotal+this.gift; },
          });
        }
      }
      // Add some memo/cleaning blocks
      if (bRooms.length > 0) {
        for (let i = 0; i < 2; i++) {
          const room = bRooms[Math.floor(Math.random()*bRooms.length)];
          reservations.push({
            id: uid(), bid: br.id, roomId: room.id, custId:null, custName:"", custPhone:"",
            staffId: bStaff[0]?.id, serviceId:null, date: ds,
            time: `${String(11+i*2).padStart(2,"0")}:30`, dur: 15, status:"completed",
            memo: i===0?"ì²­ì†Œ":"", type: i===0?"cleaning":"memo"
          });
        }
      }
    });
  }
  return { customers, reservations, sales };
}

// â”€â”€â”€ App â”€â”€â”€
function App() {
  const [phase, setPhase] = useState("loading"); // loading, login, super, app
  const [allUsers, setAllUsers] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [currentBizId, setCurrentBizId] = useState(null);
  const [currentBiz, setCurrentBiz] = useState(null);
  const [data, setData] = useState(null);
  const [superData, setSuperData] = useState(null);
  const [role, setRole] = useState("staff");
  const [userBranches, setUserBranches] = useState([]);
  const [viewBranches, setViewBranches] = useState([]);
  const [page, setPage] = useState("timeline");
  const [sideOpen, setSideOpen] = useState(false);
  const [loadMsg, setLoadMsg] = useState("ì—°ê²° ì¤‘...");

  // Phase 1: Load all users on mount
  useEffect(() => {
    (async () => {
      try {
        const users = fromDb("app_users", await sb.get("app_users"));
        if (users.length === 0) {
          // First time: no users at all, create super admin via SQL schema
          setAllUsers([{id:"acc_super", loginId:"admin", pw:"1234", name:"Bliss ê´€ë¦¬ì", role:"super", branches:[], viewBranches:[]}]);
        } else {
          setAllUsers(users);
        }
        setPhase("login");
      } catch(e) {
        console.error("DB ì—°ê²° ì‹¤íŒ¨:", e);
        setAllUsers([{id:"acc_super", loginId:"admin", pw:"1234", name:"Bliss ê´€ë¦¬ì", role:"super", branches:[], viewBranches:[]}]);
        setPhase("login");
      }
    })();
  }, []);

  // Handle login â†’ route to super dashboard or business app
  const handleLogin = async (user) => {
    setCurrentUser(user);
    setRole(user.role);
    if (user.role === "super") {
      setLoadMsg("ê´€ë¦¬ì ë°ì´í„° ë¡œë”© ì¤‘...");
      setPhase("loading");
      try {
        const sd = await loadAllFromDb(null);
        setSuperData(sd);
        setPhase("super");
      } catch(e) {
        console.error(e);
        setSuperData({ businesses:[], groups:[], groupMembers:[], users:[] });
        setPhase("super");
      }
    } else {
      const bizId = user.businessId;
      if (!bizId) { alert("ì‚¬ì—…ì ì—°ê²° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."); setPhase("login"); return; }
      setCurrentBizId(bizId);
      setActiveBiz(bizId);
      setLoadMsg("ë§¤ì¥ ë°ì´í„° ë¡œë”© ì¤‘...");
      setPhase("loading");
      try {
        // Load business info
        const bizList = await sb.get("businesses", `&id=eq.${bizId}`);
        setCurrentBiz(bizList[0] || { name: "ë§¤ì¥" });
        // Load business data
        const db = await loadAllFromDb(bizId);
        const staff = db.rooms.map(r => ({ id: r.id, dn: r.name, bid: r.branch_id }));
        setData({
          branches: db.branches, rooms: db.rooms, services: db.services, products: db.products,
          categories: db.cats, serviceTags: db.serviceTags,
          branchSettings: db.branches.map(b => ({...b, useYn: b.use_yn !== false})),
          users: db.users, customers: db.customers, reservations: db.reservations, sales: db.sales,
          staff,
        });
        setUserBranches(user.role === "owner" ? db.branches.map(b=>b.id) : (user.branches || []));
        setViewBranches(user.viewBranches || []);
        setPhase("app");
      } catch(e) {
        console.error("Data load error:", e);
        setLoadMsg("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨");
      }
    }
  };

  // Super admin: enter a specific business
  const handleEnterBiz = async (bizId) => {
    setLoadMsg("ë§¤ì¥ ë°ì´í„° ë¡œë”© ì¤‘...");
    setPhase("loading");
    try {
      const bizList = await sb.get("businesses", `&id=eq.${bizId}`);
      setCurrentBiz(bizList[0] || { name: "ë§¤ì¥" });
      setCurrentBizId(bizId);
      setActiveBiz(bizId);
      const db = await loadAllFromDb(bizId);
      const staff = db.rooms.map(r => ({ id: r.id, dn: r.name, bid: r.branch_id }));
      setData({
        branches: db.branches, rooms: db.rooms, services: db.services, products: db.products,
        categories: db.cats, serviceTags: db.serviceTags,
        branchSettings: db.branches.map(b => ({...b, useYn: b.use_yn !== false})),
        users: db.users, customers: db.customers, reservations: db.reservations, sales: db.sales,
        staff,
      });
      setRole("owner"); // super acts as owner inside a business
      setUserBranches(db.branches.map(b => b.id));
      setViewBranches([]);
      setPhase("app");
    } catch(e) { console.error(e); setPhase("super"); }
  };

  const handleLogout = () => {
    setCurrentUser(null); setCurrentBizId(null); setCurrentBiz(null);
    setData(null); setSuperData(null); setRole("staff");
    setUserBranches([]); setViewBranches([]); setPage("timeline");
    setActiveBiz(null);
    setPhase("login");
  };

  const handleBackToSuper = async () => {
    setLoadMsg("ê´€ë¦¬ì ë°ì´í„° ë¡œë”© ì¤‘...");
    setPhase("loading");
    const sd = await loadAllFromDb(null);
    setSuperData(sd);
    setRole("super");
    setCurrentBizId(null); setCurrentBiz(null); setData(null); setActiveBiz(null);
    setPhase("super");
  };

  if (phase === "loading") return <Loading msg={loadMsg} />;
  if (phase === "login") return <Login users={allUsers} onLogin={handleLogin} />;
  if (phase === "super") return <SuperDashboard superData={superData} setSuperData={setSuperData} currentUser={currentUser} onLogout={handleLogout} onEnterBiz={handleEnterBiz} />;

  // Phase: app (owner or staff)
  if (!data) return <Loading msg="ë°ì´í„° ë¡œë”© ì¤‘..." />;

  const isMaster = role === "owner" || role === "super";
  const isSuper = currentUser?.role === "super";
  const nav = [
    { id:"timeline", label:"íƒ€ì„ë¼ì¸", icon:"ğŸ“…" },
    { id:"reservations", label:"ì˜ˆì•½ëª©ë¡", icon:"ğŸ“‹" },
    { id:"sales", label:"ë§¤ì¶œê´€ë¦¬", icon:"ğŸ’°" },
    { id:"stats", label:"ë§¤ì¶œí†µê³„", icon:"ğŸ“Š" },
    { id:"customers", label:"ê³ ê°ê´€ë¦¬", icon:"ğŸ‘¥" },
    ...(isMaster?[{ id:"users", label:"ì‚¬ìš©ìê´€ë¦¬", icon:"ğŸ‘¤" }]:[]),
    { id:"admin", label:"ê´€ë¦¬ì„¤ì •", icon:"âš™ï¸" },
  ];

  const branchNames = userBranches.map(bid => (data.branches||[]).find(b=>b.id===bid)?.short||bid).filter(Boolean).join(", ");
  const bizName = currentBiz?.name || "";

  return (
    <div style={S.root}>
      <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet"/>
      <style>{CSS}</style>
      <aside className="sidebar-d" style={S.sidebar}>
        <Sidebar nav={nav} page={page} setPage={setPage} role={role} branchNames={branchNames} onLogout={handleLogout} bizName={bizName} isSuper={isSuper} onBackToSuper={handleBackToSuper} />
      </aside>
      {sideOpen && <div className="sidebar-m" style={{position:"fixed",inset:0,zIndex:300}}>
        <div style={{position:"absolute",inset:0,background:"rgba(0,0,0,.5)"}} onClick={()=>setSideOpen(false)}/>
        <div style={{position:"relative",width:260,height:"100%",background:"#fff",display:"flex",flexDirection:"column",animation:"slideIn .2s ease"}}>
          <Sidebar nav={nav} page={page} setPage={p=>{setPage(p);setSideOpen(false)}} role={role} branchNames={branchNames} onLogout={handleLogout} bizName={bizName} isSuper={isSuper} onBackToSuper={handleBackToSuper} />
        </div>
      </div>}
      <main className="main-c" style={S.main}>
        <div className="mob-hdr" style={S.mobHdr}>
          <button onClick={()=>setSideOpen(true)} style={S.menuBtn}>â˜°</button>
          {bizName && <span style={{fontSize:14,fontWeight:700,color:"#7c7cc8"}}>{bizName}</span>}
        </div>
        <div style={{flex:1,padding:page==="timeline"?"0":"20px 24px 24px",display:"flex",flexDirection:"column",minHeight:0,...(page!=="timeline"?{overflow:"hidden"}:{})}}>
          <div className={page==="timeline"?"":"fade-in"} key={page} style={page==="timeline"?{flex:1,display:"flex",flexDirection:"column",minHeight:0}:{overflow:"auto",flex:1}}>
            {page==="timeline" && <Timeline data={data} setData={setData} userBranches={userBranches} viewBranches={viewBranches} isMaster={isMaster} currentUser={currentUser} setPage={setPage} bizId={currentBizId}/>}
            {page==="reservations" && <ReservationList data={data} setData={setData} userBranches={userBranches} isMaster={isMaster}/>}
            {page==="sales" && <SalesPage data={data} setData={setData} userBranches={userBranches} isMaster={isMaster}/>}
            {page==="stats" && <StatsPage data={data} userBranches={userBranches} isMaster={isMaster} role={role}/>}
            {page==="customers" && <CustomersPage data={data} setData={setData} userBranches={userBranches} isMaster={isMaster}/>}
            {page==="users" && <UsersPage data={data} setData={setData} bizId={currentBizId}/>}
            {page==="admin" && <AdminPage data={data} setData={setData} bizId={currentBizId}/>}
          </div>
        </div>
      </main>
    </div>
  );
}

function Loading({msg}) { return <div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100vh",background:"#f8f8f8",color:"#888",fontFamily:"'Pretendard',sans-serif",gap:12}}><div style={{fontSize:24}}>â³</div><div>{msg||"ë¡œë”© ì¤‘..."}</div></div>; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPER ADMIN DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function SuperDashboard({ superData, setSuperData, currentUser, onLogout, onEnterBiz }) {
  const [tab, setTab] = useState("businesses");
  const { businesses=[], groups=[], groupMembers=[], users=[] } = superData || {};

  // â”€â”€ Business CRUD â”€â”€
  const [bizForm, setBizForm] = useState(null);
  const saveBiz = async () => {
    if (!bizForm?.name || !bizForm?.code) return alert("ì—…ì²´ëª…ê³¼ ëŒ€í‘œ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    const isNew = !bizForm.id;
    const biz = isNew ? { ...bizForm, id: "biz_" + uid() } : bizForm;
    if (isNew) {
      await sb.insert("businesses", { id:biz.id, name:biz.name, code:biz.code, phone:biz.phone||"", memo:biz.memo||"" });
      const ownerId = "acc_" + uid();
      await sb.insert("app_users", { id:ownerId, business_id:biz.id, login_id:biz.code, password:"1234", name:biz.name+" ëŒ€í‘œ", role:"owner", branch_ids:"[]", view_branch_ids:"[]" });
      // Auto-assign group if selected
      if (bizForm.groupId) {
        const gm = { id:"gm_"+uid(), group_id:bizForm.groupId, business_id:biz.id };
        await sb.insert("business_group_members", gm);
        setSuperData(p => ({...p, businesses:[...p.businesses, biz], users:[...p.users, {id:ownerId, businessId:biz.id, loginId:biz.code, pw:"1234", name:biz.name+" ëŒ€í‘œ", role:"owner", branches:[], viewBranches:[]}], groupMembers:[...p.groupMembers, gm]}));
      } else {
        setSuperData(p => ({...p, businesses:[...p.businesses, biz], users:[...p.users, {id:ownerId, businessId:biz.id, loginId:biz.code, pw:"1234", name:biz.name+" ëŒ€í‘œ", role:"owner", branches:[], viewBranches:[]}]}));
      }
    } else {
      await sb.update("businesses", biz.id, { name:biz.name, code:biz.code, phone:biz.phone||"", memo:biz.memo||"" });
      // Update group membership
      const curMem = groupMembers.find(m=>m.business_id===biz.id);
      if (bizForm.groupId && (!curMem || curMem.group_id!==bizForm.groupId)) {
        if (curMem) await sb.del("business_group_members", curMem.id);
        const gm = { id:"gm_"+uid(), group_id:bizForm.groupId, business_id:biz.id };
        await sb.insert("business_group_members", gm);
        setSuperData(p => ({...p, businesses:p.businesses.map(b=>b.id===biz.id?biz:b), groupMembers:[...p.groupMembers.filter(m=>m.business_id!==biz.id), gm]}));
      } else if (!bizForm.groupId && curMem) {
        await sb.del("business_group_members", curMem.id);
        setSuperData(p => ({...p, businesses:p.businesses.map(b=>b.id===biz.id?biz:b), groupMembers:p.groupMembers.filter(m=>m.business_id!==biz.id)}));
      } else {
        setSuperData(p => ({...p, businesses:p.businesses.map(b=>b.id===biz.id?biz:b)}));
      }
    }
    setBizForm(null);
  };
  const deleteBiz = async (id) => {
    if (!confirm("ì´ ì‚¬ì—…ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.")) return;
    await sb.del("businesses", id);
    setSuperData(p => ({...p, businesses:p.businesses.filter(b=>b.id!==id)}));
  };
  const seedBizTemplates = async (bizId) => {
    const prefix = bizId.replace("biz_","");
    const br = { id:`br_${prefix}_1`, business_id:bizId, name:"ë³¸ì ", short:"ë³¸ì ", phone:"", address:"", color:"#FFFFFF", sort:0, use_yn:true };
    await sb.insert("branches", br);
    await sb.insert("rooms", { id:`rm_${prefix}_1`, business_id:bizId, branch_id:br.id, name:"ë‹´ë‹¹ì1", color:"", sort_order:0 });
    const cats = ["ì™ì‹±","í˜ì´ì…œ","ë°”ë””","ê¸°íƒ€"];
    for (let i=0;i<cats.length;i++) await sb.insert("service_categories", { id:`cat_${prefix}_${i}`, business_id:bizId, name:cats[i], sort:i });
    alert("ê¸°ë³¸ í…œí”Œë¦¿ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
  };
  const startEditBiz = (b) => {
    const curMem = groupMembers.find(m=>m.business_id===b.id);
    setBizForm({...b, groupId: curMem?.group_id||""});
  };

  // â”€â”€ Group quick-add (inline) â”€â”€
  const [newGrp, setNewGrp] = useState("");
  const addGroup = async () => {
    if (!newGrp.trim()) return;
    const grp = { id:"grp_"+uid(), name:newGrp.trim(), memo:"" };
    await sb.insert("business_groups", grp);
    setSuperData(p => ({...p, groups:[...p.groups, grp]}));
    setNewGrp("");
  };

  const tabs = [{id:"businesses",label:"ğŸ¢ ì—…ì²´ ê´€ë¦¬"},{id:"users",label:"ğŸ‘¤ ì‚¬ìš©ì"}];

  return (
    <div style={{display:"flex",height:"100vh",fontFamily:"'Pretendard',sans-serif",background:"#f8f8f8"}}>
      <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet"/>
      <style>{CSS}</style>
      <aside style={{width:220,background:"#fff",borderRight:"1px solid #e0e0e0",display:"flex",flexDirection:"column"}}>
        <div style={{padding:"20px 16px 16px",borderBottom:"1px solid #e0e0e0"}}>
          <div style={{fontSize:20,fontWeight:800,color:"#7c7cc8",letterSpacing:-1}}>Bliss</div>
          <div style={{fontSize:11,color:"#888",marginTop:4}}>ìŠˆí¼ê´€ë¦¬ì Â· {currentUser?.name}</div>
        </div>
        <div style={{flex:1,padding:"12px 0"}}>
          {tabs.map(t=>(
            <button key={t.id} onClick={()=>setTab(t.id)} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 16px",border:"none",cursor:"pointer",fontSize:13,fontWeight:tab===t.id?700:400,
              background:tab===t.id?"#f0f0ff":"transparent",color:tab===t.id?"#5a5ac8":"#555",
              borderLeft:tab===t.id?"3px solid #7c7cc8":"3px solid transparent",
              fontFamily:"inherit",width:"100%",textAlign:"left"}}>{t.label}</button>
          ))}
        </div>
        <div style={{padding:12,borderTop:"1px solid #e0e0e0"}}>
          <button onClick={onLogout} style={{width:"100%",padding:"8px 14px",borderRadius:4,border:"1px solid #d0d0d0",background:"#fff",color:"#888",cursor:"pointer",fontSize:12,fontWeight:600,fontFamily:"inherit"}}>ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </aside>
      <main style={{flex:1,padding:24,overflow:"auto"}}>
        {/* â”€â”€ ì—…ì²´ ê´€ë¦¬ â”€â”€ */}
        {tab==="businesses" && <div>
          <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:20}}>
            <h2 style={{fontSize:20,fontWeight:800,color:"#333"}}>ğŸ¢ ì—…ì²´ ê´€ë¦¬</h2>
            <span style={{fontSize:12,color:"#888"}}>{businesses.length}ê°œ ì—…ì²´</span>
            <button className="btn-p" style={{marginLeft:"auto"}} onClick={()=>setBizForm({name:"",code:"",phone:"",memo:"",groupId:""})}>ï¼‹ ì—…ì²´ ì¶”ê°€</button>
          </div>
          {bizForm && <div className="card" style={{padding:16,marginBottom:16}}>
            <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"end"}}>
              <FLD label="ì—…ì²´ëª…"><input className="inp" style={{width:160}} value={bizForm.name} onChange={e=>setBizForm({...bizForm,name:e.target.value})} placeholder="ì—…ì²´ëª… ì…ë ¥"/></FLD>
              <FLD label="ëŒ€í‘œ ì•„ì´ë””"><input className="inp" style={{width:140}} value={bizForm.code} onChange={e=>setBizForm({...bizForm,code:e.target.value.toLowerCase().replace(/[^a-z0-9]/g,"")})} placeholder="ì˜ë¬¸ì†Œë¬¸ì+ìˆ«ì"/></FLD>
              <FLD label="ì „í™”"><input className="inp" style={{width:140}} value={bizForm.phone||""} onChange={e=>setBizForm({...bizForm,phone:e.target.value})} placeholder="02-0000-0000"/></FLD>
              <FLD label="ê·¸ë£¹">
                <div style={{display:"flex",gap:4}}>
                  <select className="inp" style={{width:130}} value={bizForm.groupId||""} onChange={e=>setBizForm({...bizForm,groupId:e.target.value})}>
                    <option value="">ì—†ìŒ</option>
                    {groups.map(g=><option key={g.id} value={g.id}>{g.name}</option>)}
                  </select>
                  <div style={{display:"flex",gap:2}}>
                    <input className="inp" style={{width:80,fontSize:10,padding:"4px 6px"}} value={newGrp} onChange={e=>setNewGrp(e.target.value)} placeholder="ìƒˆ ê·¸ë£¹" onKeyDown={e=>e.key==="Enter"&&addGroup()}/>
                    <button className="btn-s" style={{padding:"2px 6px",fontSize:10}} onClick={addGroup}>+</button>
                  </div>
                </div>
              </FLD>
              <FLD label="ë©”ëª¨"><input className="inp" style={{width:160}} value={bizForm.memo||""} onChange={e=>setBizForm({...bizForm,memo:e.target.value})} placeholder="ë©”ëª¨"/></FLD>
              <button className="btn-p" onClick={saveBiz}>{bizForm.id?"ì €ì¥":"ì¶”ê°€"}</button>
              <button className="btn-s" onClick={()=>setBizForm(null)}>ì·¨ì†Œ</button>
            </div>
            {!bizForm.id && <div style={{marginTop:8,fontSize:11,color:"#999"}}>* ëŒ€í‘œ ì•„ì´ë””ë¡œ ëŒ€í‘œ ê³„ì •ì´ ìë™ ìƒì„±ë©ë‹ˆë‹¤ (ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸: 1234)</div>}
          </div>}
          <div className="card tw">
            <table><thead><tr>
              <th>ì—…ì²´ëª…</th><th>ëŒ€í‘œ ì•„ì´ë””</th><th>ì „í™”</th><th>ê·¸ë£¹</th><th>ê³„ì •ìˆ˜</th><th>ë©”ëª¨</th><th>ê´€ë¦¬</th>
            </tr></thead><tbody>
              {businesses.map(b=>{
                const bizUsers = users.filter(u=>u.businessId===b.id);
                const grps = groupMembers.filter(m=>m.business_id===b.id).map(m=>groups.find(g=>g.id===m.group_id)?.name).filter(Boolean);
                return <tr key={b.id}>
                  <td style={{fontWeight:700}}>{b.name}</td>
                  <td style={{color:"#7c7cc8",fontFamily:"monospace",fontSize:12}}>{b.code}</td>
                  <td style={{fontSize:12,color:"#888"}}>{b.phone||"-"}</td>
                  <td>{grps.length>0 ? <span style={{fontSize:10,color:"#5cb5c5",background:"#5cb5c520",padding:"2px 8px",borderRadius:8}}>{grps.join(", ")}</span> : <span style={{color:"#ccc"}}>-</span>}</td>
                  <td style={{color:"#888"}}>{bizUsers.length}ëª…</td>
                  <td style={{fontSize:12,color:"#888"}}>{b.memo||"-"}</td>
                  <td style={{display:"flex",gap:4}}>
                    <button className="btn-p" style={{padding:"4px 10px",fontSize:11}} onClick={()=>onEnterBiz(b.id)}>ì ‘ì†</button>
                    <button className="btn-s" style={{padding:"4px 10px",fontSize:11}} onClick={()=>startEditBiz(b)}>ìˆ˜ì •</button>
                    <button className="btn-s" style={{padding:"4px 10px",fontSize:11}} onClick={()=>seedBizTemplates(b.id)}>í…œí”Œë¦¿</button>
                    <button className="btn-d" style={{padding:"4px 10px",fontSize:11}} onClick={()=>deleteBiz(b.id)}>ì‚­ì œ</button>
                  </td>
                </tr>;
              })}
              {businesses.length===0 && <tr><td colSpan={7} style={{textAlign:"center",color:"#999",padding:40}}>ë“±ë¡ëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>}
            </tbody></table>
          </div>
        </div>}

        {/* â”€â”€ ì‚¬ìš©ì â”€â”€ */}
        {tab==="users" && <SuperUsers users={users} businesses={businesses} superData={superData} setSuperData={setSuperData}/>}
      </main>
    </div>
  );
}

// â”€â”€â”€ Super: ì „ì²´ ì‚¬ìš©ì ê´€ë¦¬ â”€â”€â”€
function SuperUsers({ users, businesses, superData, setSuperData }) {
  const [editId, setEditId] = useState(null);
  const [form, setForm] = useState(null);

  const startAdd = () => { setEditId("new"); setForm({name:"", loginId:"", pw:"1234", role:"owner", businessId:businesses[0]?.id||"", branches:[], viewBranches:[]}); };
  const startEdit = (u) => { setEditId(u.id); setForm({...u}); };
  const cancel = () => { setEditId(null); setForm(null); };

  const save = async () => {
    if(!form.name||!form.loginId||!form.pw) { alert("ì´ë¦„, ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
    if(editId==="new") {
      const newU = {...form, id:"acc_"+uid()};
      await sb.insert("app_users", {id:newU.id, business_id:newU.businessId||null, login_id:newU.loginId, password:newU.pw, name:newU.name, role:newU.role, branch_ids:JSON.stringify(newU.branches||[]), view_branch_ids:JSON.stringify(newU.viewBranches||[])}).catch(console.error);
      setSuperData(p=>({...p, users:[...p.users, newU]}));
    } else {
      await sb.update("app_users", editId, {business_id:form.businessId||null, login_id:form.loginId, password:form.pw, name:form.name, role:form.role, branch_ids:JSON.stringify(form.branches||[]), view_branch_ids:JSON.stringify(form.viewBranches||[])}).catch(console.error);
      setSuperData(p=>({...p, users:p.users.map(u=>u.id===editId?{...form}:u)}));
    }
    cancel();
  };
  const remove = async (id) => {
    if(!window.confirm("ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    await sb.del("app_users", id).catch(console.error);
    setSuperData(p=>({...p, users:p.users.filter(u=>u.id!==id)}));
  };

  const roleLabel = (r) => r==="super"?"ìŠˆí¼":r==="owner"?"ëŒ€í‘œ":"ì§ì›";
  const roleBg = (r) => r==="super"?"#e5737315":r==="owner"?"#7c7cc815":"#f5f5f5";
  const roleClr = (r) => r==="super"?"#e57373":r==="owner"?"#7c7cc8":"#888";

  return <div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
      <h2 style={{fontSize:20,fontWeight:800,color:"#333"}}>ğŸ‘¤ ì „ì²´ ì‚¬ìš©ì <span style={{fontSize:13,fontWeight:400,color:"#999"}}>{users.length}ëª…</span></h2>
      <button className="btn-p" onClick={startAdd}>ï¼‹ ì‚¬ìš©ì ì¶”ê°€</button>
    </div>

    {form && <div className="card" style={{padding:20,marginBottom:16}}>
      <h3 style={{fontSize:14,fontWeight:700,marginBottom:12}}>{editId==="new"?"ì‚¬ìš©ì ì¶”ê°€":"ì‚¬ìš©ì ìˆ˜ì •"}</h3>
      <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"flex-end"}}>
        <FLD label="ì´ë¦„"><input className="inp" style={{width:120}} value={form.name} onChange={e=>setForm(p=>({...p,name:e.target.value}))}/></FLD>
        <FLD label="ì•„ì´ë””"><input className="inp" style={{width:120}} value={form.loginId} onChange={e=>setForm(p=>({...p,loginId:e.target.value}))}/></FLD>
        <FLD label="ë¹„ë°€ë²ˆí˜¸"><input className="inp" style={{width:100}} value={form.pw} onChange={e=>setForm(p=>({...p,pw:e.target.value}))}/></FLD>
        <FLD label="ìœ í˜•"><select className="inp" style={{width:90}} value={form.role} onChange={e=>setForm(p=>({...p,role:e.target.value}))}>
          <option value="super">ìŠˆí¼</option><option value="owner">ëŒ€í‘œ</option><option value="staff">ì§ì›</option>
        </select></FLD>
        <FLD label="ì—…ì²´"><select className="inp" style={{width:150}} value={form.businessId||""} onChange={e=>setForm(p=>({...p,businessId:e.target.value}))}>
          <option value="">ì—†ìŒ</option>{businesses.map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
        </select></FLD>
        <div style={{display:"flex",gap:6}}>
          <button className="btn-p" style={{padding:"7px 16px"}} onClick={save}>{editId==="new"?"ì¶”ê°€":"ì €ì¥"}</button>
          <button className="btn-s" style={{padding:"7px 16px"}} onClick={cancel}>ì·¨ì†Œ</button>
        </div>
      </div>
    </div>}

    <div className="card tw">
      <table><thead><tr>
        <th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ìœ í˜•</th><th>ì—…ì²´</th><th>ë¹„ë°€ë²ˆí˜¸</th><th style={{width:120}}>ê´€ë¦¬</th>
      </tr></thead><tbody>
        {users.map(u=>{
          const biz = businesses.find(b=>b.id===u.businessId);
          return <tr key={u.id}>
            <td style={{fontWeight:600}}>{u.name}</td>
            <td style={{color:"#7c7cc8"}}>{u.loginId||u.login_id}</td>
            <td><span style={{fontSize:10,padding:"2px 8px",borderRadius:10,background:roleBg(u.role),color:roleClr(u.role),fontWeight:600}}>{roleLabel(u.role)}</span></td>
            <td style={{fontSize:12,color:"#555"}}>{biz?.name||"-"}</td>
            <td style={{color:"#aaa"}}>{"â€¢".repeat((u.pw||u.password||"").length)}</td>
            <td style={{display:"flex",gap:4}}>
              <button className="btn-s" style={{padding:"4px 10px",fontSize:11}} onClick={()=>startEdit(u)}>ìˆ˜ì •</button>
              {u.role!=="super" && <button className="btn-d" style={{padding:"4px 10px",fontSize:11}} onClick={()=>remove(u.id)}>ì‚­ì œ</button>}
            </td>
          </tr>;
        })}
      </tbody></table>
    </div>
  </div>;
}

// â”€â”€â”€ Login â”€â”€â”€
function Login({ users, onLogin }) {
  const [loginId, setLoginId] = useState(() => {try{return localStorage.getItem("savedLoginId")||"";}catch{return "";}});
  const [pw, setPw] = useState("");
  const [saveId, setSaveId] = useState(() => {try{return localStorage.getItem("savedLoginId")!==null;}catch{return false;}});
  const [err, setErr] = useState("");
  const handleLogin = () => {
    const u = users.find(u => (u.loginId||u.login_id) === loginId && (u.pw||u.password) === pw);
    if (!u) { setErr("ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
    try{if(saveId)localStorage.setItem("savedLoginId",loginId);else localStorage.removeItem("savedLoginId");}catch{}
    onLogin(u);
  };
  return (
    <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg,#e8e8f0 0%,#d8d8e8 50%,#c8c8d8 100%)",fontFamily:"'Pretendard',sans-serif",padding:20}}>
      <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet"/>
      <style>{CSS}</style>
      <div style={{background:"#fff",borderRadius:12,border:"1px solid #e0e0e0",padding:40,width:"100%",maxWidth:420,animation:"fadeIn .5s ease",boxShadow:"0 8px 30px rgba(0,0,0,.1)"}}>
        <div style={{textAlign:"center",marginBottom:32}}>
          <div style={{fontSize:28,fontWeight:800,color:"#7c7cc8",letterSpacing:-1}}>Bliss</div>
          <div style={{fontSize:12,color:"#999",marginTop:8}}>í†µí•© ì˜ˆì•½ & ë§¤ì¶œ ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
        </div>
        <div style={{display:"flex",flexDirection:"column",gap:14}}>
          <FLD label="ì•„ì´ë””"><input className="inp" placeholder="ì•„ì´ë”” ì…ë ¥" value={loginId} onChange={e=>{setLoginId(e.target.value);setErr("")}}/></FLD>
          <FLD label="ë¹„ë°€ë²ˆí˜¸"><input className="inp" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" value={pw} onChange={e=>{setPw(e.target.value);setErr("")}} onKeyDown={e=>e.key==="Enter"&&handleLogin()}/></FLD>
          {err && <div style={{fontSize:12,color:"#e57373",textAlign:"center"}}>{err}</div>}
          <label style={{display:"flex",alignItems:"center",gap:6,fontSize:12,color:"#888",cursor:"pointer"}}>
            <input type="checkbox" checked={saveId} onChange={e=>setSaveId(e.target.checked)} style={{accentColor:"#7c7cc8",width:14,height:14}}/>
            ì•„ì´ë”” ì €ì¥
          </label>
          <button className="btn-p" style={{width:"100%",padding:13,marginTop:4,fontSize:15}} onClick={handleLogin}>ë¡œê·¸ì¸</button>
          <div style={{fontSize:10,color:"#bbb",textAlign:"center",marginTop:4}}>
            ìŠˆí¼ê´€ë¦¬ì: admin / 1234 Â· ì—…ì²´ëŒ€í‘œ: master / 1234
          </div>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ Sidebar â”€â”€â”€
// Logo SVG component
const HW_LOGO = "data:image/png;base64,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";

function HWLogo({ size=1, light=false }) {
  const w = 130*size;
  return <img src={HW_LOGO} alt="HOUSE waxing" style={{width:w,height:"auto",objectFit:"contain",
    filter:light?"brightness(0) invert(1)":"none"}} />;
}

function Sidebar({ nav, page, setPage, role, branchNames, onLogout, bizName="", isSuper=false, onBackToSuper }) {
  const cats = [
    { label:"ì˜ˆì•½ ê´€ë¦¬", items: nav.filter(n=>["timeline","reservations"].includes(n.id)) },
    { label:"ê³ ê° ê´€ë¦¬", items: nav.filter(n=>["customers"].includes(n.id)) },
    { label:"ë§¤ì¶œ ê´€ë¦¬", items: nav.filter(n=>["sales","stats"].includes(n.id)) },
    ...(nav.find(n=>n.id==="admin") ? [{ label:"ì‹œìŠ¤í…œ", items: nav.filter(n=>["users","admin"].includes(n.id)) }] : []),
  ];
  return <>
    <div style={{padding:"16px 16px 12px",borderBottom:"1px solid #e0e0e0"}}>
      {bizName ? <div style={{fontSize:16,fontWeight:800,color:"#7c7cc8",letterSpacing:-.5}}>{bizName}</div>
        : <div style={{fontSize:16,fontWeight:800,color:"#7c7cc8"}}>Bliss</div>}
      <div style={{fontSize:11,color:"#888",marginTop:4}}>{role==="owner"?"ëŒ€í‘œ ê´€ë¦¬ì":role==="super"?"ìŠˆí¼ê´€ë¦¬ì":branchNames||"ì§ì›"}</div>
    </div>
    <div style={{flex:1,padding:"8px 0",overflowY:"auto"}}>
      {cats.map((cat,ci) => (
        <div key={ci}>
          <div style={{fontSize:10,fontWeight:700,color:"#999",padding:"12px 16px 4px",letterSpacing:.5}}>{cat.label}</div>
          {cat.items.map(n=>(
            <button key={n.id} onClick={()=>setPage(n.id)} style={{display:"flex",alignItems:"center",gap:10,padding:"9px 16px",border:"none",cursor:"pointer",fontSize:13,fontWeight:page===n.id?700:400,
              background:page===n.id?"#f0f0ff":"transparent",color:page===n.id?"#5a5ac8":"#555",
              borderLeft:page===n.id?"3px solid #7c7cc8":"3px solid transparent",
              fontFamily:"inherit",width:"100%",textAlign:"left",transition:"all .1s"}}>
              <span style={{fontSize:15,width:20,textAlign:"center"}}>{n.icon}</span>{n.label}
            </button>
          ))}
        </div>
      ))}
    </div>
    <div style={{padding:12,borderTop:"1px solid #e0e0e0",display:"flex",flexDirection:"column",gap:6}}>
      {isSuper && <button onClick={onBackToSuper} style={{width:"100%",padding:"8px 14px",borderRadius:4,border:"1px solid #7c7cc8",background:"#7c7cc810",color:"#7c7cc8",cursor:"pointer",fontSize:12,fontWeight:600,fontFamily:"inherit",textAlign:"center"}}>â¬… ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</button>}
      <button onClick={onLogout} style={{width:"100%",padding:"8px 14px",borderRadius:4,border:"1px solid #d0d0d0",background:"#fff",color:"#888",cursor:"pointer",fontSize:12,fontWeight:600,fontFamily:"inherit",textAlign:"center"}}>ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMELINE VIEW (myCream-style)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Timeline({ data, setData, userBranches, viewBranches=[], isMaster, currentUser, setPage, bizId }) {
  const [selDate, setSelDate] = useState(todayStr());
  const [showModal, setShowModal] = useState(false);
  const [modalData, setModalData] = useState(null);
  const [showSettings, setShowSettings] = useState(false);
  const scrollRef = useRef(null);

  // Branch view: í¸ì§‘ê°€ëŠ¥(userBranches) + ì—´ëŒê°€ëŠ¥(viewBranches)
  const allBranchList = (data.branchSettings || data.branches || []).filter(b => b.useYn !== false);
  const accessibleBids = [...new Set([...userBranches, ...(viewBranches||[])])];
  const [viewBids, setViewBids] = useState(isMaster ? allBranchList.map(b=>b.id) : accessibleBids);
  // Sync viewBids when branches change (e.g. added/removed in admin)
  useEffect(() => {
    const newIds = allBranchList.map(b=>b.id);
    setViewBids(prev => {
      const added = newIds.filter(id => !prev.includes(id) && (isMaster || accessibleBids.includes(id)));
      const filtered = prev.filter(id => newIds.includes(id));
      return added.length > 0 ? [...filtered, ...added] : filtered.length !== prev.length ? filtered : prev;
    });
  }, [allBranchList.length]);
  const toggleView = (bid) => setViewBids(prev => prev.includes(bid) ? prev.filter(x=>x!==bid) : [...prev, bid]);
  const canEdit = (bid) => isMaster || userBranches.includes(bid);

  const branchesToShow = allBranchList.filter(b => viewBids.includes(b.id) && (isMaster || accessibleBids.includes(b.id)));

  // â”€â”€ Alarm system â”€â”€
  const ALARM_TAG_ID = "t72"; // ğŸ”” ì•ŒëŒ
  const [alarmPopup, setAlarmPopup] = useState(null);
  const firedAlarmsRef = useRef(new Set());
  useEffect(() => {
    const check = () => {
      const now = new Date();
      const nowH = now.getHours();
      const nowM = now.getMinutes();
      const today = now.toISOString().split("T")[0];
      const allRes = data.reservations || [];
      allRes.forEach(r => {
        if (!r.isSchedule || r.date !== today) return;
        if (!(r.selectedTags || []).includes(ALARM_TAG_ID)) return;
        if (firedAlarmsRef.current.has(r.id)) return;
        const [rh, rm] = (r.time || "10:00").split(":").map(Number);
        if (nowH === rh && nowM === rm) {
          firedAlarmsRef.current.add(r.id);
          const tags = (data?.serviceTags || []);
          const tagNames = (r.selectedTags || []).filter(tid => tid !== ALARM_TAG_ID).map(tid => tags.find(t => t.id === tid)?.name).filter(Boolean);
          setAlarmPopup({ time: r.time, memo: r.memo || "", tags: tagNames, room: r.roomId, id: r.id });
        }
      });
    };
    const timer = setInterval(check, 10000); // 10ì´ˆë§ˆë‹¤ ì²´í¬
    check();
    return () => clearInterval(timer);
  }, [data.reservations]);

  // â”€â”€ Drag & Drop â”€â”€
  const [dragBlock, setDragBlock] = useState(null);
  const [dragPos, setDragPos] = useState(null);
  const [dragSnap, setDragSnap] = useState(null);
  const dragStartRef = useRef(null);
  const isDragging = useRef(false);
  const dragSnapRef = useRef(null);

  // â”€â”€ Resize â”€â”€
  const [resizeBlock, setResizeBlock] = useState(null);
  const [resizeDur, setResizeDur] = useState(0);
  const isResizing = useRef(false);
  const resizeDurRef = useRef(0);

  const allRooms = branchesToShow.flatMap(br => (data.rooms||ROOMS).filter(r=>r.branch_id===br.id).map(r=>({...r, branchName:br.short||br.name||""})));
  
  const blocks = data.reservations.filter(r => r.date === selDate && branchesToShow.some(b=>b.id===r.bid));

  // Time config - 5min intervals
  const startHour = 8, endHour = 22;
  const [rowH, setRowH] = useState(14);
  const [colW, setColW] = useState(160);
  const [timeUnit, setTimeUnit] = useState(5); // ë¶„ ë‹¨ìœ„: 5,10,15,30,60
  const [blockFs, setBlockFs] = useState(10); // ë¸”ë¡ í…ìŠ¤íŠ¸ í¬ê¸°
  const [blockOp, setBlockOp] = useState(100); // ë¸”ë¡ íˆ¬ëª…ë„ %
  const slotsPerHour = 60 / timeUnit;
  const totalRows = (endHour - startHour) * slotsPerHour;
  const headerH = 40;

  // CSS grid background
  const hourH = rowH * slotsPerHour;
  const halfH = rowH * (slotsPerHour / 2);
  const gridBg = useMemo(() => ({
    backgroundImage: [
      `repeating-linear-gradient(to bottom, #bbb 0px, #bbb 1px, transparent 1px, transparent ${hourH}px)`,
      ...(slotsPerHour >= 2 ? [`repeating-linear-gradient(to bottom, #ddd 0px, #ddd 1px, transparent 1px, transparent ${halfH}px)`] : []),
      ...(slotsPerHour > 2 ? [`repeating-linear-gradient(to bottom, #eee 0px, #eee 1px, transparent 1px, transparent ${rowH}px)`] : []),
    ].join(","),
    backgroundSize: "100% 100%",
  }), [rowH, hourH, halfH, slotsPerHour]);

  // Time label positions
  const timeLabels = useMemo(() => {
    const labels = [];
    for (let i = 0; i < totalRows; i++) {
      const totalMin = i * timeUnit;
      const h = startHour + Math.floor(totalMin / 60);
      const m = totalMin % 60;
      const isHour = m === 0;
      const ampm = h < 12 ? "ì˜¤ì „" : "ì˜¤í›„";
      const h12 = h <= 12 ? h : h - 12;
      labels.push({ i, isHour, m, text: isHour ? `${ampm} ${String(h12).padStart(2,"0")}:00` : `${String(m).padStart(2,"0")}` });
    }
    return labels;
  }, [startHour, endHour, timeUnit, totalRows]);

  const timeToY = (timeStr) => {
    const [h, m] = timeStr.split(":").map(Number);
    return ((h - startHour) * 60 + m) / timeUnit * rowH;
  };

  const yToTime = (y) => {
    const totalMin = Math.floor(y / rowH) * timeUnit;
    const h = startHour + Math.floor(totalMin / 60);
    const m = totalMin % 60;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
  };

  const handleCellClick = (room, y) => {
    if (isDragging.current || isResizing.current) return;
    if (!canEdit(room.branch_id)) return; // read-only
    const time = yToTime(y);
    setModalData({ roomId: room.id, bid: room.branch_id, time, date: selDate });
    setShowModal(true);
  };

  const handleBlockClick = (block, e) => {
    e.stopPropagation();
    if (isDragging.current || isResizing.current) return;
    const readOnly = !canEdit(block.bid);
    setModalData({ ...block, readOnly });
    setShowModal(true);
  };

  const handleSave = (item) => {
    // ì‹ ê·œê³ ê°ì´ë©´ DBì— ê³ ê° ë“±ë¡
    if (item.isNewCust && item.custName && !item.custId) {
      const newCustId = "cust_" + uid();
      item.custId = newCustId;
      const newCust = {
        id: newCustId, bid: item.bid, name: item.custName, phone: item.custPhone || "",
        gender: item.custGender || "F", visits: 0, lastVisit: null, memo: "",
        custNum: String(50000 + Math.floor(Math.random() * 10000))
      };
      setData(prev => ({ ...prev, customers: [...prev.customers, newCust] }));
      sb.insert("customers", toDb("customers", newCust)).catch(console.error);
    }
    const allItems = [];
    setData(prev => {
      const exists = prev.reservations.find(r => r.id === item.id);
      if (exists) {
        sb.update("reservations", item.id, toDb("reservations", item)).catch(console.error);
        return { ...prev, reservations: prev.reservations.map(r => r.id === item.id ? item : r) };
      }
      const items = [item];
      if (item.isSchedule && item.repeat && item.repeat !== "none" && item.repeatUntil) {
        const fmtD = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
        const start = new Date(item.date + "T12:00:00");
        const end = new Date(item.repeatUntil + "T12:00:00");
        const dayOfWeek = start.getDay();
        const dayOfMonth = start.getDate();
        let cur = new Date(start);
        cur.setDate(cur.getDate() + 1);
        while (cur <= end) {
          let match = false;
          if (item.repeat === "daily") match = true;
          else if (item.repeat === "weekly") match = cur.getDay() === dayOfWeek;
          else if (item.repeat === "monthly") match = cur.getDate() === dayOfMonth;
          if (match) {
            const ds = fmtD(cur);
            items.push({ ...item, id: uid(), date: ds, endDate: ds, repeat: item.repeat, repeatUntil: item.repeatUntil, repeatSourceId: item.id });
          }
          cur.setDate(cur.getDate() + 1);
        }
      }
      allItems.push(...items);
      return { ...prev, reservations: [...prev.reservations, ...items] };
    });
    // Async sync to Supabase
    setTimeout(()=>{ if(allItems.length) sb.upsert("reservations", allItems.map(i=>toDb("reservations",i))).catch(console.error); }, 0);
    setShowModal(false); setModalData(null);
  };

  // â”€â”€ Delete with repeat options â”€â”€
  const [deletePopup, setDeletePopup] = useState(null);

  const handleDeleteRequest = (block) => {
    const sourceId = block.repeatSourceId || block.id;
    const hasRepeat = (data.reservations || []).some(r => r.repeatSourceId === sourceId || (r.id === sourceId && r.repeat && r.repeat !== "none"));
    if (hasRepeat) {
      setDeletePopup(block);
    } else {
      handleDelete(block.id);
    }
  };

  const handleDeleteConfirm = (mode) => {
    if (!deletePopup) return;
    const block = deletePopup;
    const sourceId = block.repeatSourceId || block.id;
    const toDelIds = [];
    setData(prev => {
      let res = prev.reservations;
      if (mode === "this") {
        toDelIds.push(block.id);
        res = res.filter(r => r.id !== block.id);
      } else if (mode === "future") {
        res = res.filter(r => {
          if (r.id === block.id) { toDelIds.push(r.id); return false; }
          const sameGroup = r.id === sourceId || r.repeatSourceId === sourceId;
          if (sameGroup && r.date >= block.date) { toDelIds.push(r.id); return false; }
          return true;
        });
      } else if (mode === "all") {
        res.forEach(r => { if(r.id===sourceId||r.repeatSourceId===sourceId) toDelIds.push(r.id); });
        res = res.filter(r => r.id !== sourceId && r.repeatSourceId !== sourceId);
      }
      return { ...prev, reservations: res };
    });
    setTimeout(()=>{ toDelIds.forEach(id=>sb.del("reservations",id).catch(console.error)); }, 0);
    setDeletePopup(null); setShowModal(false); setModalData(null);
  };

  const handleDelete = (id) => {
    setData(prev => ({ ...prev, reservations: prev.reservations.filter(r => r.id !== id) }));
    sb.del("reservations", id).catch(console.error);
    setShowModal(false); setModalData(null);
  };

  // â”€â”€ Drag handlers â”€â”€
  const timeLabelsW = 62;
  const handleDragStart = (block, e) => {
    e.stopPropagation();
    e.preventDefault();
    dragStartRef.current = { x: e.clientX, y: e.clientY };
    isDragging.current = false;

    const onMove = (ev) => {
      const dx = ev.clientX - dragStartRef.current.x;
      const dy = ev.clientY - dragStartRef.current.y;
      if (!isDragging.current && Math.abs(dx) + Math.abs(dy) < 6) return; // threshold
      isDragging.current = true;
      setDragBlock(block);

      const sr = scrollRef.current;
      if (!sr) return;
      const rect = sr.getBoundingClientRect();
      const x = ev.clientX - rect.left + sr.scrollLeft;
      const y = ev.clientY - rect.top + sr.scrollTop;
      setDragPos({ x: ev.clientX - rect.left, y: ev.clientY - rect.top });

      // Snap: determine which room column
      const colX = x - timeLabelsW;
      const roomIdx = Math.max(0, Math.min(allRooms.length - 1, Math.floor(colX / colW)));
      const targetRoom = allRooms[roomIdx];
      // Snap: determine time (accounting for header)
      const gridY = y - headerH;
      const snappedTime = yToTime(Math.max(0, gridY));
      setDragSnap({ roomId: targetRoom?.id, bid: targetRoom?.branch_id, time: snappedTime });
      dragSnapRef.current = { roomId: targetRoom?.id, bid: targetRoom?.branch_id, time: snappedTime };

      // Auto-scroll when near edges
      const edgeZone = 40;
      if (ev.clientY - rect.top < edgeZone) sr.scrollTop -= 8;
      if (rect.bottom - ev.clientY < edgeZone) sr.scrollTop += 8;
    };

    const onUp = () => {
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
      if (isDragging.current && dragSnapRef.current) {
        // Apply move
        const snap = dragSnapRef.current;
        setData(prev => ({
          ...prev,
          reservations: prev.reservations.map(r => {
            if (r.id !== block.id) return r;
            const newTime = snap.time || r.time;
            const newRoomId = snap.roomId || r.roomId;
            const newBid = snap.bid || r.bid;
            const [sh, sm] = newTime.split(":").map(Number);
            const endMin = sh * 60 + sm + (r.dur || 60);
            const endTime = `${String(Math.floor(endMin/60)).padStart(2,"0")}:${String(endMin%60).padStart(2,"0")}`;
            const updated = { ...r, time: newTime, endTime, roomId: newRoomId, bid: newBid };
            sb.update("reservations", block.id, toDb("reservations", updated)).catch(console.error);
            return updated;
          })
        }));
      }
      setDragBlock(null); setDragPos(null); setDragSnap(null); dragSnapRef.current = null;
      // Prevent click from firing after drag
      setTimeout(() => { isDragging.current = false; }, 300);
    };

    document.addEventListener("mousemove", onMove);
    document.addEventListener("mouseup", onUp);
  };

  // â”€â”€ Resize handler â”€â”€
  const handleResizeStart = (block, e) => {
    e.stopPropagation();
    e.preventDefault();
    isResizing.current = true;
    setResizeBlock(block);
    setResizeDur(block.dur);
    resizeDurRef.current = block.dur;
    const startY = e.clientY;
    const startDur = block.dur;

    const onMove = (ev) => {
      const dy = ev.clientY - startY;
      const durDelta = Math.round(dy / rowH) * timeUnit;
      const newDur = Math.max(5, startDur + durDelta);
      setResizeDur(newDur);
      resizeDurRef.current = newDur;
    };

    const onUp = () => {
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
      const finalDur = resizeDurRef.current;
      setData(prev => ({
        ...prev,
        reservations: prev.reservations.map(r => {
          if (r.id !== block.id) return r;
          const [sh, sm] = r.time.split(":").map(Number);
          const endMin = sh * 60 + sm + finalDur;
          const endTime = `${String(Math.floor(endMin/60)).padStart(2,"0")}:${String(endMin%60).padStart(2,"0")}`;
          const updated = { ...r, dur: finalDur, endTime };
          sb.update("reservations", block.id, toDb("reservations", updated)).catch(console.error);
          return updated;
        })
      }));
      setResizeBlock(null); setResizeDur(0);
      setTimeout(() => { isResizing.current = false; }, 300);
    };

    document.addEventListener("mousemove", onMove);
    document.addEventListener("mouseup", onUp);
  };

  const changeDate = (off) => { const d = new Date(selDate); d.setDate(d.getDate()+off); setSelDate(d.toISOString().split("T")[0]); };

  // Scroll to current time on mount
  useEffect(() => {
    if (scrollRef.current) {
      const now = new Date();
      const y = timeToY(`${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`);
      scrollRef.current.scrollTop = Math.max(0, y - 200);
    }
  }, [selDate]);

  // Current time line
  const now = new Date();
  const nowY = selDate === todayStr() ? timeToY(`${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`) : -1;

  // Date helpers
  const DAYS_KR = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
  const sd = new Date(selDate);
  const dateLabel = `${sd.getFullYear()}ë…„ ${String(sd.getMonth()+1).padStart(2,"0")}ì›” ${String(sd.getDate()).padStart(2,"0")}ì¼ (${DAYS_KR[sd.getDay()]})`;
  const daysInMonth = new Date(sd.getFullYear(), sd.getMonth()+1, 0).getDate();

  return (
    <div style={{display:"flex",flexDirection:"column",flex:1,minHeight:0}}>
      {/* Top Bar - single compact row */}
      <div style={{borderBottom:"1px solid #e0e0e0",background:"#fff",flexShrink:0,padding:"6px 12px",display:"flex",alignItems:"center",gap:6,flexWrap:"nowrap",overflowX:"auto",overflowY:"hidden"}}>
        {/* Date nav */}
        <button onClick={()=>changeDate(-1)} style={{background:"none",border:"none",cursor:"pointer",fontSize:12,color:"#666",padding:"2px 4px",flexShrink:0}}>â—</button>
        <span style={{fontSize:13,fontWeight:700,color:"#333",cursor:"pointer",flexShrink:0,whiteSpace:"nowrap"}} onClick={()=>{const el=document.createElement("input");el.type="date";el.value=selDate;el.onchange=e=>setSelDate(e.target.value);el.showPicker?.();el.click()}}>{dateLabel}</span>
        <button onClick={()=>changeDate(1)} style={{background:"none",border:"none",cursor:"pointer",fontSize:12,color:"#666",padding:"2px 4px",flexShrink:0}}>â–·</button>
        <button onClick={()=>setSelDate(todayStr())} style={{padding:"2px 8px",fontSize:10,border:"1px solid #d0d0d0",borderRadius:3,background:"#fff",color:"#666",cursor:"pointer",fontFamily:"inherit",flexShrink:0}}>ì˜¤ëŠ˜</button>
        {/* Settings button */}
        <div style={{position:"relative",flexShrink:0}} ref={el => { if(el) el._settingsBtn = el; }}>
          <button onClick={(e)=>{setShowSettings(!showSettings);}} id="settings-btn"
            style={{width:24,height:24,border:"1px solid #d0d0d0",borderRadius:4,background:showSettings?"#f0f0ff":"#fff",
              cursor:"pointer",fontSize:12,display:"flex",alignItems:"center",justifyContent:"center",padding:0,color:"#888"}}>âš™</button>
        </div>
        <span style={{color:"#e0e0e0",fontSize:12,flexShrink:0}}>â”‚</span>
        {/* Day numbers inline */}
        <div style={{display:"flex",gap:0,overflow:"hidden",flex:1,minWidth:0}}>
          {Array.from({length:daysInMonth},(_,i)=>{
            const d = i+1;
            const dt = new Date(sd.getFullYear(), sd.getMonth(), d);
            const isSun = dt.getDay()===0;
            const isSat = dt.getDay()===6;
            const isToday = d === new Date().getDate() && sd.getMonth() === new Date().getMonth() && sd.getFullYear() === new Date().getFullYear();
            const isSel = d === sd.getDate();
            return <button key={d} onClick={()=>{const ns=new Date(sd.getFullYear(),sd.getMonth(),d);setSelDate(ns.toISOString().split("T")[0])}}
              style={{width:22,height:22,borderRadius:isSel?11:3,border:isToday&&!isSel?"2px solid #7c7cc8":"none",
                background:isSel?"#7c7cc8":"transparent",color:isSel?"#fff":isSun?"#e57373":isSat?"#7c7cc8":"#555",
                fontSize:11,fontWeight:isSel||isToday?700:400,cursor:"pointer",fontFamily:"inherit",padding:0,flexShrink:0}}>
              {d}
            </button>;
          })}
        </div>
        <select value={viewBids.length===(isMaster?allBranchList.length:accessibleBids.length)?"all":viewBids.length===1?viewBids[0]:"custom"}
          onChange={e=>{
            const v=e.target.value;
            if(v==="all") setViewBids(isMaster?allBranchList.map(b=>b.id):accessibleBids);
            else setViewBids([v]);
          }}
          style={{flexShrink:0,padding:"2px 6px",fontSize:10,border:"1px solid #d0d0d0",borderRadius:4,background:"#fff",color:"#555",cursor:"pointer",fontFamily:"inherit",fontWeight:600,maxWidth:120}}>
          <option value="all">ì „ì²´ì§€ì </option>
          {(isMaster?allBranchList:allBranchList.filter(b=>accessibleBids.includes(b.id))).map(b=>
            <option key={b.id} value={b.id}>{b.short||b.name}{!canEdit(b.id)?" ğŸ‘":""}</option>
          )}
        </select>
      </div>

      {/* Timeline Grid */}
      <div ref={scrollRef} className="timeline-scroll" style={{flex:1,overflow:"scroll",position:"relative",minHeight:0}}>
        <div style={{display:"flex",minWidth:"fit-content"}}>
          {/* Time Labels */}
          <div style={{width:62,flexShrink:0,position:"sticky",left:0,zIndex:20,background:"#fff",borderRight:"1px solid #eee",overflow:"hidden"}}>
            <div style={{height:headerH,borderBottom:"1px solid #eee",position:"sticky",top:0,zIndex:25,background:"#fff"}}/>
            <div style={{position:"relative",height:totalRows*rowH,...gridBg}}>
              {timeLabels.map(({i, isHour, m, text}) => {
                return <div key={i} style={{position:"absolute",top:i*rowH,left:0,right:0,height:rowH,display:"flex",alignItems:"center",justifyContent:"flex-end",paddingRight:6}}>
                  <span style={{fontSize:isHour?11:9,fontWeight:isHour?600:400,color:isHour?"#555":"#aaa",whiteSpace:"nowrap",lineHeight:1}}>{text}</span>
                </div>;
              })}
            </div>
          </div>

          {/* Room Columns */}
          {allRooms.map((room, ci) => {
            const roomBlocks = blocks.filter(b => b.roomId === room.id);
            const isNewBranch = ci === 0 || room.branch_id !== allRooms[ci-1]?.branch_id;
            const branchColor = (data.branchSettings || []).find(bs => bs.id === room.branch_id)?.color || "";
            return (
              <div key={room.id} style={{width:colW,flexShrink:0,borderLeft:"1px solid #eee",background:branchColor||"#fff"}}>
                {/* Header */}
                <div style={{height:headerH,borderBottom:"1px solid #eee",position:"sticky",top:0,zIndex:10,background:branchColor||"#fff",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",lineHeight:1.2}}>
                  <span style={{fontSize:12,fontWeight:700,color:"#333"}}>{room.branchName}</span>
                  <span style={{fontSize:9,color:"#999"}}>{room.name}</span>
                </div>
                {/* Grid Area */}
                <div style={{position:"relative",height:totalRows*rowH,cursor:canEdit(room.branch_id)?"pointer":"default",...gridBg}} onClick={e=>{const rect=e.currentTarget.getBoundingClientRect();handleCellClick(room,e.clientY-rect.top)}}>
                  {/* Current time */}
                  {nowY > 0 && <div style={{position:"absolute",top:nowY,left:0,right:0,borderTop:"2px solid #e57373",zIndex:5}}>
                    <div style={{position:"absolute",top:-4,left:-1,width:8,height:8,borderRadius:4,background:"#e57373"}}/>
                  </div>}
                  {/* Blocks */}
                  {roomBlocks.map(block => {
                    const y = timeToY(block.time);
                    const isBeingResized = resizeBlock?.id === block.id;
                    const blockDur = isBeingResized ? resizeDur : block.dur;
                    const h = (blockDur / timeUnit) * rowH;
                    // ì„œë¹„ìŠ¤íƒœê·¸ ìƒ‰ìƒ ìš°ì„  ì ìš©
                    const tags = data?.serviceTags || INIT_SERVICE_TAGS;
                    const tagColor = block.type==="reservation" && block.selectedTags?.length
                      ? (block.selectedTags.map(tid=>tags.find(t=>t.id===tid)).find(t=>t?.color)?.color || "")
                      : "";
                    const color = tagColor || BLOCK_COLORS[block.type] || "#7c7cc8";
                    const staff = STAFF.find(s=>s.id===block.staffId);
                    const isDrag = dragBlock?.id === block.id;
                    const isSch = block.isSchedule;
                    const isEditable = canEdit(block.bid);
                    return (
                      <div key={block.id}
                        onClick={e=>handleBlockClick(block,e)}
                        onMouseDown={e=>{if(isEditable && !isResizing.current)handleDragStart(block,e)}}
                        style={{position:"absolute",top:y,left:2,right:2,height:Math.max(h,rowH*2),
                          background:isSch?`${color}BB`:`${color}18`,
                          border:`1px solid ${isSch?color:color+"60"}`,
                          borderLeft:`3px solid ${color}`,
                          borderRadius:4,padding:"2px 4px",overflow:"hidden",fontSize:blockFs,lineHeight:1.2,
                          cursor:isEditable?"grab":"pointer",zIndex:isDrag?0:3,transition:(isDrag||isBeingResized)?"none":"all .15s",
                          opacity:isDrag?0.3:(blockOp/100),userSelect:"none"}}>
                        {block.type==="reservation" && !block.isSchedule && <>
                          <div style={{display:"flex",alignItems:"center",gap:3,overflow:"hidden",whiteSpace:"nowrap"}}>
                            {block.isNewCust && <span style={{fontSize:Math.max(6,blockFs-2),padding:"1px 3px",borderRadius:2,background:"#e57373",color:"#fff",fontWeight:700,lineHeight:1,flexShrink:0}}>ì‹ ê·œ</span>}
                            <span style={{fontWeight:600,color:"#333",overflow:"hidden",textOverflow:"ellipsis"}}><span style={{color:block.custGender==="M"?"#4a7cc8":"#e57373"}}>{block.custGender==="M"?"ë‚¨":"ì—¬"}</span> {block.custName}</span>
                          </div>
                          {block.selectedTags?.length>0 && <div style={{display:"flex",flexWrap:"wrap",gap:2,marginTop:1}}>
                            {block.selectedTags.slice(0,3).map(tid=>{const tg=tags.find(t=>t.id===tid);return tg?<span key={tid} style={{fontSize:Math.max(6,blockFs-2),padding:"0 3px",borderRadius:2,background:tg.color?tg.color+"25":"#7c7cc815",color:tg.color||"#7c7cc8",fontWeight:600}}>{tg.name}</span>:null})}
                            {block.selectedTags.length>3 && <span style={{fontSize:Math.max(6,blockFs-2),color:"#999"}}>+{block.selectedTags.length-3}</span>}
                          </div>}
                          {block.selectedServices?.length>0 && <div style={{fontSize:Math.max(6,blockFs-2),color:"#6bab9e",fontWeight:600,marginTop:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>
                            {block.selectedServices.map(sid=>INIT_SERVICES.find(s=>s.id===sid)?.name).filter(Boolean).slice(0,2).join(", ")}
                            {block.selectedServices.length>2 && ` +${block.selectedServices.length-2}`}
                          </div>}
                        </>}
                        {block.type==="reservation" && block.isSchedule && <div style={{fontWeight:700,color:"#fff",textShadow:"0 1px 2px rgba(0,0,0,.3)",fontSize:blockFs+1}}>
                          {block.selectedTags?.map(tid=>{const tg=tags.find(t=>t.id===tid);return tg?.name}).filter(Boolean).join(", ")||"ê¸°íƒ€ì¼ì •"}
                        </div>}
                        {block.type==="memo" && <div style={{color:"#ef5350",fontWeight:600}}>ğŸ“ ë©”ëª¨</div>}
                        {block.type==="clockin" && <div style={{color:"#d0d0d0",fontWeight:600}}>ğŸ• {staff?.dn||"ì¶œê·¼"}</div>}
                        {block.type==="cleaning" && <div style={{color:"#5cb5c5",fontWeight:600}}>ğŸ§¹ ì²­ì†Œ</div>}
                        {block.memo && (() => { const clean = block.memo.split("\n").filter(l => !/^\[ë“±ë¡:|^\[ìˆ˜ì •:/.test(l.trim())).join(" ").trim(); return clean ? <div style={{color:"#7c7cc8",marginTop:1}}>ğŸ’¬ {clean}</div> : null; })()}
                        {/* Resize handle */}
                        {isEditable && <div className="resize-handle" onMouseDown={e=>handleResizeStart(block,e)}
                          style={{position:"absolute",bottom:0,left:0,right:0,height:8,cursor:"ns-resize",
                            display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity .15s"}}>
                          <div style={{width:20,height:3,borderRadius:2,background:color}}/>
                        </div>}
                        {isBeingResized && <div style={{position:"absolute",bottom:2,right:4,fontSize:Math.max(6,blockFs-2),fontWeight:700,color,background:"#fff",padding:"0 3px",borderRadius:2}}>
                          {blockDur}ë¶„
                        </div>}
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })}
        </div>

        {/* Snap indicator inside scroll area */}
        {dragBlock && dragSnap && (() => {
          const snapY = timeToY(dragSnap.time);
          const snapH = Math.max((dragBlock.dur / timeUnit) * rowH, rowH * 2);
          const roomIdx = allRooms.findIndex(r => r.id === dragSnap.roomId);
          if (roomIdx < 0) return null;
          const snapLeft = timeLabelsW + roomIdx * colW + 2;
          return <div style={{position:"absolute",top:headerH+snapY,left:snapLeft,width:colW-4,height:snapH,
            background:"#7c7cc820",border:"2px dashed #7c7cc8",borderRadius:4,pointerEvents:"none",zIndex:50}}/>
        })()}
      </div>

      {/* Drag ghost - follows cursor */}
      {dragBlock && dragPos && <div style={{position:"fixed",
        left:scrollRef.current?.getBoundingClientRect().left+dragPos.x-50,
        top:scrollRef.current?.getBoundingClientRect().top+dragPos.y-15,
        width:colW-10,padding:"4px 8px",
        background:"#7c7cc8",color:"#fff",borderRadius:6,fontSize:10,fontWeight:700,
        boxShadow:"0 8px 24px rgba(116,141,174,.35)",pointerEvents:"none",zIndex:100,opacity:.9}}>
        <div>{dragBlock.time} â†’ {dragSnap?.time||"?"}</div>
        <div style={{fontWeight:500,fontSize:9,opacity:.85}}><span style={{color:dragBlock.custGender==="M"?"#4a7cc8":"#e57373"}}>{dragBlock.custGender==="M"?"ë‚¨":"ì—¬"}</span> {dragBlock.custName}</div>
        <div style={{fontSize:8,opacity:.7}}>{allRooms.find(r=>r.id===dragSnap?.roomId)?.name||""}</div>
      </div>}

      {showModal && <TimelineModal item={modalData} onSave={handleSave} onDelete={handleDelete} onDeleteRequest={handleDeleteRequest} onClose={()=>{setShowModal(false);setModalData(null)}} selBranch={userBranches[0]} userBranches={userBranches} data={data} setData={setData} setPage={setPage}/>}

      {/* Settings dropdown (fixed, outside overflow) */}
      {showSettings && <>
        <div style={{position:"fixed",inset:0,zIndex:99}} onClick={()=>setShowSettings(false)}/>
        <div style={{position:"fixed",top:(() => {const btn=document.getElementById("settings-btn");return btn?(btn.getBoundingClientRect().bottom+4)+"px":"40px"})(),
          left:(() => {const btn=document.getElementById("settings-btn");return btn?btn.getBoundingClientRect().left+"px":"200px"})(),
          background:"#fff",border:"1px solid #e0e0e0",borderRadius:8,padding:"12px 14px",boxShadow:"0 8px 24px rgba(0,0,0,.12)",zIndex:100,minWidth:240,display:"flex",flexDirection:"column",gap:8}}>
          <div style={{fontSize:11,fontWeight:700,color:"#888",marginBottom:2}}>íƒ€ì„ë¼ì¸ ì„¤ì •</div>
          {[
            {label:"ì¤„ê°„ê²©",val:rowH,dec:()=>setRowH(h=>Math.max(6,h-2)),inc:()=>setRowH(h=>Math.min(30,h+2))},
            {label:"ì—´ë„ˆë¹„",val:colW,dec:()=>setColW(w=>Math.max(80,w-20)),inc:()=>setColW(w=>Math.min(300,w+20))},
            {label:"ê¸€ìí¬ê¸°",val:blockFs,dec:()=>setBlockFs(f=>Math.max(6,f-1)),inc:()=>setBlockFs(f=>Math.min(16,f+1))},
            {label:"íˆ¬ëª…ë„",val:blockOp,dec:()=>setBlockOp(o=>Math.max(10,o-10)),inc:()=>setBlockOp(o=>Math.min(100,o+10))},
          ].map(r=><div key={r.label} style={{display:"flex",alignItems:"center",borderTop:"1px solid #f0f0f0",paddingTop:6}}>
            <span style={{fontSize:11,color:"#555",width:56,flexShrink:0}}>{r.label}</span>
            <div style={{display:"flex",alignItems:"center",gap:3,marginLeft:"auto"}}>
              <button onClick={r.dec} style={{width:24,height:24,border:"1px solid #ccc",borderRadius:4,background:"#fff",cursor:"pointer",fontSize:14,fontWeight:700,color:"#555",display:"flex",alignItems:"center",justifyContent:"center",padding:0,fontFamily:"inherit"}}>âˆ’</button>
              <span style={{fontSize:11,color:"#7c7cc8",fontWeight:600,width:32,textAlign:"center"}}>{r.val}{r.label==="íˆ¬ëª…ë„"?"%":""}</span>
              <button onClick={r.inc} style={{width:24,height:24,border:"1px solid #ccc",borderRadius:4,background:"#fff",cursor:"pointer",fontSize:14,fontWeight:700,color:"#555",display:"flex",alignItems:"center",justifyContent:"center",padding:0,fontFamily:"inherit"}}>+</button>
            </div>
          </div>)}
          <div style={{display:"flex",alignItems:"center",borderTop:"1px solid #f0f0f0",paddingTop:6}}>
            <span style={{fontSize:11,color:"#555",width:56,flexShrink:0}}>ì‹œê°„ë‹¨ìœ„</span>
            <div style={{display:"flex",gap:3,marginLeft:"auto"}}>
              {[5,10,15,30,60].map(u=><button key={u} onClick={()=>setTimeUnit(u)}
                style={{padding:"3px 8px",fontSize:10,border:"1px solid #ccc",borderRadius:4,background:timeUnit===u?"#7c7cc815":"#fff",
                  color:timeUnit===u?"#7c7cc8":"#888",fontWeight:timeUnit===u?700:400,cursor:"pointer",fontFamily:"inherit"}}>{u}</button>)}
            </div>
          </div>
        </div>
      </>}

      {/* ì•ŒëŒ íŒì—… */}
      {alarmPopup && <div className="ov" onClick={()=>setAlarmPopup(null)} style={{zIndex:9999}}>
        <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:12,padding:0,width:"90%",maxWidth:400,
          boxShadow:"0 16px 48px rgba(0,0,0,.25)",animation:"fadeIn .3s ease",overflow:"hidden"}}>
          <div style={{background:"linear-gradient(135deg,#FF6B00,#FF9800)",padding:"20px 24px",color:"#fff",textAlign:"center"}}>
            <div style={{fontSize:40,marginBottom:8}}>ğŸ””</div>
            <div style={{fontSize:18,fontWeight:800}}>ì•ŒëŒ</div>
            <div style={{fontSize:14,marginTop:4,opacity:.9}}>{alarmPopup.time}</div>
          </div>
          <div style={{padding:"20px 24px"}}>
            {alarmPopup.tags.length > 0 && <div style={{display:"flex",flexWrap:"wrap",gap:4,marginBottom:12}}>
              {alarmPopup.tags.map((t,i)=><span key={i} style={{fontSize:11,padding:"3px 10px",borderRadius:12,background:"#FF6B0015",color:"#FF6B00",fontWeight:600}}>{t}</span>)}
            </div>}
            {alarmPopup.memo ? <div style={{fontSize:14,color:"#333",lineHeight:1.8,whiteSpace:"pre-wrap",
              background:"#FFF8F0",border:"1px solid #FFE0B2",borderRadius:8,padding:16}}>{alarmPopup.memo}</div>
              : <div style={{fontSize:13,color:"#999",textAlign:"center",padding:12}}>ë©”ëª¨ ë‚´ìš© ì—†ìŒ</div>}
          </div>
          <div style={{padding:"0 24px 20px",textAlign:"center"}}>
            <button className="btn-p" onClick={()=>setAlarmPopup(null)}
              style={{width:"100%",padding:12,fontSize:14,background:"#FF6B00",borderRadius:8}}>í™•ì¸</button>
          </div>
        </div>
      </div>}

      {/* ë°˜ë³µì¼ì • ì‚­ì œ ì˜µì…˜ íŒì—… */}
      {deletePopup && <div className="ov" onClick={()=>setDeletePopup(null)} style={{zIndex:9998}}>
        <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:12,width:"90%",maxWidth:340,
          boxShadow:"0 16px 48px rgba(0,0,0,.25)",animation:"fadeIn .2s ease",overflow:"hidden"}}>
          <div style={{padding:"20px 24px 12px",borderBottom:"1px solid #eee"}}>
            <div style={{fontSize:14,fontWeight:700,color:"#333"}}>ë°˜ë³µ ì¼ì • ì‚­ì œ</div>
            <div style={{fontSize:12,color:"#888",marginTop:4}}>ì´ ì¼ì •ì€ ë°˜ë³µ ë“±ë¡ëœ ì¼ì •ì…ë‹ˆë‹¤.</div>
          </div>
          <div style={{padding:"8px 0"}}>
            {[
              {mode:"this", label:"ì´ ì¼ì •ë§Œ ì‚­ì œ", desc:"ì„ íƒí•œ ë‚ ì§œì˜ ì¼ì •ë§Œ ì‚­ì œí•©ë‹ˆë‹¤"},
              {mode:"future", label:"ì´í›„ ëª¨ë“  ì¼ì •ì„ ì‚­ì œ", desc:`${deletePopup.date} ì´í›„ ë°˜ë³µ ì¼ì •ì„ ì‚­ì œí•©ë‹ˆë‹¤`},
              {mode:"all", label:"ëª¨ë“  ì¼ì •ì„ ì‚­ì œ", desc:"ì´ ë°˜ë³µ ì¼ì •ì„ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤"},
            ].map(opt => (
              <button key={opt.mode} onClick={()=>handleDeleteConfirm(opt.mode)}
                style={{width:"100%",padding:"12px 24px",border:"none",background:"transparent",cursor:"pointer",
                  textAlign:"left",fontFamily:"inherit",transition:"background .1s",display:"block"}}
                onMouseOver={e=>e.currentTarget.style.background="#f5f5f5"}
                onMouseOut={e=>e.currentTarget.style.background="transparent"}>
                <div style={{fontSize:13,fontWeight:600,color:opt.mode==="all"?"#e57373":"#333"}}>{opt.label}</div>
                <div style={{fontSize:10,color:"#999",marginTop:2}}>{opt.desc}</div>
              </button>
            ))}
          </div>
          <div style={{padding:"8px 24px 16px"}}>
            <button onClick={()=>setDeletePopup(null)}
              style={{width:"100%",padding:"10px",fontSize:12,border:"1px solid #ddd",borderRadius:6,background:"#fff",
                color:"#888",cursor:"pointer",fontFamily:"inherit"}}>ì·¨ì†Œ</button>
          </div>
        </div>
      </div>}
    </div>
  );
}

function TimelineModal({ item, onSave, onDelete, onDeleteRequest, onClose, selBranch, userBranches, data, setData, setPage }) {
  const isNew = !item?.id || item?.roomId;
  const isReadOnly = item?.readOnly || false;
  const branchId = item?.bid || selBranch;
  const branchRooms = (data.rooms||ROOMS).filter(r=>r.branch_id===branchId);
  const branchStaff = STAFF.filter(s=>s.bid===branchId);
  const [showSaleForm, setShowSaleForm] = useState(false);
  const [isSchedule, setIsSchedule] = useState(item?.isSchedule || false);
  const modalRef = useRef(null);
  const tags = (data?.serviceTags || INIT_SERVICE_TAGS).slice().sort((a,b)=>a.sort-b.sort);
  const visibleTags = tags.filter(tag => tag.useYn !== false && (isSchedule ? tag.scheduleYn === "Y" : tag.scheduleYn !== "Y"));

  const BASE_DUR = 5; // ê¸°ë³¸ ì˜ˆì•½ì‹œê°„ 5ë¶„
  const defaultEnd = () => { const t = item?.time||"10:00"; const [h,m] = t.split(":").map(Number); const em = m + (item?.dur||BASE_DUR); return `${String(h+Math.floor(em/60)).padStart(2,"0")}:${String(em%60).padStart(2,"0")}`; };
  const [f, setF] = useState(isNew && !item?.id ? {
    id: uid(), bid: branchId, roomId: item?.roomId||branchRooms[0]?.id, custId:null, custName:"", custPhone:"", custGender:"F",
    staffId: branchStaff[0]?.id, serviceId: SERVICES[0]?.id, date: item?.date||todayStr(), time: item?.time||"10:00",
    endDate: item?.date||todayStr(), endTime: defaultEnd(),
    dur: BASE_DUR, status:"confirmed", memo:"", type:"reservation",
    selectedTags: [], isNewCust: true, tsLog: [],
    selectedServices: [], repeat: "none", repeatUntil: ""
  } : (() => {
    const existingTs = item?.tsLog || [];
    const memoLines = (item?.memo || "").split("\n");
    const extractedTs = memoLines.filter(l => /^\[ë“±ë¡:|^\[ìˆ˜ì •:/.test(l.trim()));
    const cleanMemo = memoLines.filter(l => !/^\[ë“±ë¡:|^\[ìˆ˜ì •:/.test(l.trim())).join("\n").trim();
    const mergedTs = existingTs.length > 0 ? existingTs : extractedTs;
    return {...item, memo: cleanMemo, custGender: item?.custGender || "F", endDate: item?.date||todayStr(), endTime: defaultEnd(),
      selectedTags: item?.selectedTags || [], isNewCust: false, tsLog: mergedTs,
      selectedServices: item?.selectedServices || [],
      repeat: item?.repeat || "none", repeatUntil: item?.repeatUntil || ""};
  })());
  const set = (k,v) => setF(p=>({...p,[k]:v}));

  // ê³ ê° ê²€ìƒ‰
  const [custSearch, setCustSearch] = useState("");
  const [showCustDropdown, setShowCustDropdown] = useState(false);
  const [custResults, setCustResults] = useState([]);
  // ë””ë°”ìš´ìŠ¤ ê²€ìƒ‰ (300ms, 2ê¸€ì ì´ìƒ)
  useEffect(() => {
    if (custSearch.length < 2) { setCustResults([]); return; }
    const timer = setTimeout(() => {
      const q = custSearch.toLowerCase();
      const results = (data?.customers||[]).filter(c =>
        c.name.toLowerCase().includes(q) || c.phone.includes(q)
      ).slice(0,50);
      setCustResults(results);
    }, 300);
    return () => clearTimeout(timer);
  }, [custSearch]);
  const selectCust = (c) => { setF(p=>({...p, custId:c.id, custName:c.name, custPhone:c.phone, custGender:c.gender, isNewCust:false})); setCustSearch(""); setShowCustDropdown(false); };

  // íƒœê·¸ ì„ íƒ â†’ ê¸°ë³¸ 5ë¶„ + íƒœê·¸ ì†Œìš”ì‹œê°„ í•©ì‚° â†’ ì¢…ë£Œì‹œê°„ ìë™ ê³„ì‚°
  const toggleTag = (tagId) => {
    setF(p => {
      const newTags = p.selectedTags.includes(tagId) ? p.selectedTags.filter(t=>t!==tagId) : [...p.selectedTags, tagId];
      const tagSum = newTags.reduce((sum, tid) => {
        const tag = tags.find(t => t.id === tid);
        return sum + (tag?.dur || 0);
      }, 0);
      const svcSum = (p.selectedServices||[]).reduce((sum, sid) => sum + (INIT_SERVICES.find(s=>s.id===sid)?.dur||0), 0);
      const dur = (tagSum + svcSum) || BASE_DUR;
      const [sh, sm] = p.time.split(":").map(Number);
      const endMin = sh * 60 + sm + dur;
      const endTime = `${String(Math.min(22, Math.floor(endMin/60))).padStart(2,"0")}:${String(endMin%60).padStart(2,"0")}`;
      return { ...p, selectedTags: newTags, dur, endTime };
    });
  };

  // ì„ íƒëœ íƒœê·¸ ì†Œìš”ì‹œê°„ í•©ê³„
  const tagDurTotal = (f.selectedTags||[]).reduce((sum, tid) => {
    const tag = tags.find(t => t.id === tid);
    return sum + (tag?.dur || 0);
  }, 0);

  // ì„ íƒëœ ì‹œìˆ  ì†Œìš”ì‹œê°„ í•©ê³„
  const svcDurTotal = (f.selectedServices||[]).reduce((sum, sid) => {
    const svc = INIT_SERVICES.find(s => s.id === sid);
    return sum + (svc?.dur || 0);
  }, 0);

  // ì‹œìˆ  ì„ íƒ í† ê¸€
  const toggleService = (svcId) => {
    setF(p => {
      const newSvcs = p.selectedServices?.includes(svcId) ? p.selectedServices.filter(s=>s!==svcId) : [...(p.selectedServices||[]), svcId];
      const svcSum = newSvcs.reduce((sum, sid) => sum + (INIT_SERVICES.find(s=>s.id===sid)?.dur||0), 0);
      const tagSum = (p.selectedTags||[]).reduce((sum, tid) => sum + (tags.find(t=>t.id===tid)?.dur||0), 0);
      const dur = (svcSum + tagSum) || BASE_DUR;
      const [sh, sm] = p.time.split(":").map(Number);
      const endMin = sh * 60 + sm + dur;
      const endTime = `${String(Math.min(22, Math.floor(endMin/60))).padStart(2,"0")}:${String(endMin%60).padStart(2,"0")}`;
      return { ...p, selectedServices: newSvcs, dur, endTime };
    });
  };

  // ì‹œìˆ  ì„ íƒ íŒ¨ë„ ì—´ê¸°
  const [showSvcPicker, setShowSvcPicker] = useState(false);

  // ì‹œê°„ìœ¼ë¡œ dur ìë™ ê³„ì‚°
  const calcDur = (startT, endT) => {
    const [sh,sm] = startT.split(":").map(Number);
    const [eh,em] = endT.split(":").map(Number);
    return (eh*60+em) - (sh*60+sm);
  };

  const handleSaleSubmit = (saleData) => {
    const existingSale = (data.sales||[]).find(s => s.reservationId === f.id);
    if (existingSale) {
      // ê¸°ì¡´ ë§¤ì¶œ ìˆ˜ì •
      const updated = {...saleData, id:existingSale.id, reservationId:f.id};
      setData(prev => ({ ...prev, sales: prev.sales.map(s=>s.id===existingSale.id ? updated : s) }));
      sb.update("sales", existingSale.id, toDb("sales", updated)).catch(console.error);
    } else {
      // ì‹ ê·œ ë§¤ì¶œ ë“±ë¡
      const newSale = {...saleData, reservationId: f.id};
      if (setData) setData(prev => ({ ...prev, sales: [...prev.sales, newSale] }));
      sb.insert("sales", toDb("sales", newSale)).catch(console.error);
    }
    setShowSaleForm(false);
    if (setPage) { onClose(); setPage("sales"); }
  };

  // ê¸°ì¡´ ë§¤ì¶œ í™•ì¸
  const existingSale = (data.sales||[]).find(s => s.reservationId === f.id);

  if (showSaleForm) {
    const saleReservation = existingSale
      ? {...f, saleMemo:existingSale.memo||"", _existingSale:existingSale}
      : f;
    return <DetailedSaleForm reservation={saleReservation} branchId={branchId} onSubmit={handleSaleSubmit} onClose={() => setShowSaleForm(false)} data={data} setData={setData} />;
  }

  return (
    <div className="ov" onClick={onClose} style={{alignItems:"flex-start",paddingTop:20,overflow:"auto"}}>
      <div ref={modalRef} onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:"8px",border:"1px solid #e0e0e0",
        width:"95%",maxWidth:960,minHeight:600,maxHeight:"95vh",overflow:"hidden",animation:"fadeIn .2s ease",marginBottom:20,flexShrink:0,
        boxShadow:"0 8px 30px rgba(0,0,0,.15)",display:"flex",flexDirection:"column"}}>
        {/* â•â•â• Chrome-style Tabs â•â•â• */}
        <div style={{display:"flex",alignItems:"flex-end",gap:0,padding:"0",background:"#f5f5f5",borderRadius:"8px 8px 0 0",position:"sticky",top:0,zIndex:10,borderBottom:"1px solid #e0e0e0"}}>
          {/* ì‹ ê·œì˜ˆì•½ íƒ­ */}
          <button onClick={()=>{setIsSchedule(false);setF(p=>({...p,isSchedule:false,selectedTags:[],type:"reservation"}));if(modalRef.current)modalRef.current.scrollTop=0}}
            style={{flex:1,padding:"12px 16px",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:"inherit",
              border:"none",borderBottom:isSchedule?"none":"2px solid #7c7cc8",
              background:isSchedule?"transparent":"#fff",color:isSchedule?"#999":"#7c7cc8",
              transition:"all .15s"}}>
            ğŸ“… ì‹ ê·œì˜ˆì•½
          </button>
          {/* ê¸°íƒ€ì¼ì • íƒ­ */}
          <button onClick={()=>{setIsSchedule(true);setF(p=>({...p,isSchedule:true,selectedTags:[],type:"reservation"}));if(modalRef.current)modalRef.current.scrollTop=0}}
            style={{flex:1,padding:"12px 16px",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:"inherit",
              border:"none",borderBottom:isSchedule?"2px solid #e17055":"none",
              background:isSchedule?"#fff":"transparent",color:isSchedule?"#e17055":"#999",
              transition:"all .15s"}}>
            ğŸ“‹ ê¸°íƒ€ì¼ì •
          </button>
          {/* ë‹«ê¸° */}
          <button onClick={onClose} style={{padding:"8px 14px",background:"transparent",border:"none",color:"#999",cursor:"pointer",
            fontSize:16,fontFamily:"inherit",borderRadius:4}}
            onMouseOver={e=>e.currentTarget.style.color="#e57373"} onMouseOut={e=>e.currentTarget.style.color="#999"}>âœ•</button>
        </div>

        <div style={{padding:"16px 20px",borderTop:"1px solid #e0e0e0",flex:1,overflowY:"auto"}} className="form-col">

          {/* â•â•â• ê¸°íƒ€ì¼ì • ëª¨ë“œ â•â•â• */}
          {isSchedule && <>
            <div>
              <label style={{fontSize:11,fontWeight:600,color:"#888",marginBottom:5,display:"block"}}>ê¸°ê°„ / ì¥ì†ŒÂ·ë‹´ë‹¹ì</label>
              <div style={{display:"flex",gap:4,alignItems:"center",flexWrap:"nowrap"}}>
                <input type="date" className="inp" style={{width:170,fontSize:12,flexShrink:0}} value={f.date} onChange={e=>set("date",e.target.value)}/>
                <select className="inp" style={{width:95,fontSize:12,flexShrink:0}} value={f.time} onChange={e=>{set("time",e.target.value);set("dur",calcDur(e.target.value,f.endTime))}}>
                  {TIMES.filter(t=>{const h=parseInt(t);return h>=8&&h<=21}).map(t=><option key={t} value={t}>{t}</option>)}
                </select>
                <span style={{color:"#999",fontSize:11,flexShrink:0}}>~</span>
                <select className="inp" style={{width:95,fontSize:12,flexShrink:0}} value={f.endTime} onChange={e=>{set("endTime",e.target.value);set("dur",calcDur(f.time,e.target.value))}}>
                  {TIMES.filter(t=>{const h=parseInt(t);return h>=8&&h<=22}).map(t=><option key={t} value={t}>{t}</option>)}
                </select>
                <span style={{color:"#d0d0d0",fontSize:11,flexShrink:0}}>â”‚</span>
                <select className="inp" style={{flex:"0 1 auto",fontSize:11,maxWidth:140,minWidth:80}} value={`${f.roomId}|${f.staffId}`} onChange={e=>{const [r,s]=e.target.value.split("|");set("roomId",r);set("staffId",s)}}>
                  {branchRooms.map(rm => branchStaff.map(st =>
                    <option key={rm.id+st.id} value={`${rm.id}|${st.id}`}>[{(data.branches||[]).find(b=>b.id===branchId)?.short}] {rm.name}-{st.dn}</option>
                  ))}
                </select>
              </div>
            </div>
            {/* ë°˜ë³µ ì„¤ì • */}
            <div style={{marginTop:8}}>
              <label style={{fontSize:11,fontWeight:600,color:"#888",marginBottom:5,display:"block"}}>ë°˜ë³µ ì„¤ì •</label>
              <div style={{display:"flex",gap:6,alignItems:"center",flexWrap:"wrap"}}>
                {[{v:"none",l:"ë°˜ë³µ ì•ˆí•¨"},{v:"daily",l:"ë§¤ì¼ ê°™ì€ì‹œê°„"},{v:"weekly",l:"ë§¤ì£¼ ê°™ì€ìš”ì¼Â·ì‹œê°„"},{v:"monthly",l:"ë§¤ì›” ê°™ì€ì¼Â·ì‹œê°„"}].map(o => (
                  <button key={o.v} onClick={()=>set("repeat",o.v)}
                    style={{padding:"5px 12px",fontSize:11,fontWeight:f.repeat===o.v?700:400,borderRadius:6,cursor:"pointer",fontFamily:"inherit",
                      border:`1px solid ${f.repeat===o.v?"#e17055":"#d0d0d0"}`,
                      background:f.repeat===o.v?"#e1705520":"transparent",
                      color:f.repeat===o.v?"#e17055":"#999",transition:"all .15s"}}>{o.l}</button>
                ))}
              </div>
              {f.repeat !== "none" && <div style={{display:"flex",gap:6,alignItems:"center",marginTop:6}}>
                <span style={{fontSize:11,color:"#888"}}>ë°˜ë³µ ì¢…ë£Œì¼:</span>
                <input type="date" className="inp" style={{width:170,fontSize:12}} value={f.repeatUntil} onChange={e=>set("repeatUntil",e.target.value)}
                  min={f.date}/>
                {f.repeat === "daily" && <span style={{fontSize:10,color:"#e17055"}}>ë§¤ì¼ {f.time}ì— ë°˜ë³µ</span>}
                {f.repeat === "weekly" && <span style={{fontSize:10,color:"#e17055"}}>ë§¤ì£¼ {["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][new Date(f.date+"T00:00").getDay()]}ìš”ì¼ {f.time}ì— ë°˜ë³µ</span>}
                {f.repeat === "monthly" && <span style={{fontSize:10,color:"#e17055"}}>ë§¤ì›” {new Date(f.date+"T00:00").getDate()}ì¼ {f.time}ì— ë°˜ë³µ</span>}
              </div>}
            </div>
            <FLD label={`ê¸°íƒ€ì¼ì • í•­ëª©${tagDurTotal > 0 ? ` â€” ì†Œìš”ì‹œê°„: ${tagDurTotal}ë¶„` : ""}`}>
              <div style={{display:"flex",flexWrap:"wrap",gap:5,padding:10,background:"#fff8f6",borderRadius:8,border:"1px dashed #e17055"}}>
                {visibleTags.length > 0 ? visibleTags.map(tag => {
                  const sel = f.selectedTags?.includes(tag.id);
                  const hasColor = tag.color && tag.color !== "";
                  return <button key={tag.id} onClick={()=>toggleTag(tag.id)}
                    style={{padding:"6px 12px",fontSize:11,fontWeight:sel?700:500,borderRadius:6,cursor:"pointer",fontFamily:"inherit",transition:"all .1s",
                      border:`1px solid ${sel?(hasColor?tag.color:"#e17055"):"#d0d0d0"}`,
                      background:sel?(hasColor?tag.color+"70":"#e1705520"):"transparent",
                      color:sel?(hasColor?"#fff":"#e17055"):"#999",display:"flex",alignItems:"center",gap:4}}>
                    {hasColor && <span style={{width:8,height:8,borderRadius:2,background:sel?"#fff":tag.color}}/>}
                    {tag.name}
                    {tag.dur > 0 && <span style={{fontSize:9,opacity:0.7}}>({tag.dur}ë¶„)</span>}
                  </button>;
                }) : <span style={{fontSize:11,color:"#999",padding:8}}>ì„œë¹„ìŠ¤íƒœê·¸ê´€ë¦¬ì—ì„œ ê¸°íƒ€ì¼ì •(Y) í•­ëª©ì„ ë“±ë¡í•˜ì„¸ìš”</span>}
              </div>
              {(f.selectedTags||[]).length > 0 && <div style={{marginTop:6,display:"flex",flexWrap:"wrap",gap:4,alignItems:"center"}}>
                <span style={{fontSize:10,color:"#999"}}>ì„ íƒ:</span>
                {(f.selectedTags||[]).map(tid=>{const tag=tags.find(t=>t.id===tid);return tag?<span key={tid} style={{fontSize:10,padding:"2px 6px",borderRadius:3,background:tag.color?tag.color+"80":"#e1705530",color:tag.color?"#fff":"#e17055",fontWeight:600}}>{tag.name}{tag.dur>0?` ${tag.dur}ë¶„`:""}</span>:null})}
                {tagDurTotal>0 && <span style={{fontSize:10,color:"#e17055",fontWeight:700,marginLeft:4}}>= {tagDurTotal}ë¶„</span>}
              </div>}
            </FLD>
          </>}

          {/* â•â•â• ì‹ ê·œì˜ˆì•½ ëª¨ë“œ â•â•â• */}
          {!isSchedule && <>
            {/* ê³ ê° ê²€ìƒ‰ */}
            <FLD label="ê³ ê°ê²€ìƒ‰ (ìµœëŒ€50ê±´)">
              <div style={{position:"relative"}}>
                <div style={{display:"flex",gap:6}}>
                  <input className="inp" style={{flex:1}} value={custSearch} onChange={e=>{setCustSearch(e.target.value);setShowCustDropdown(true)}}
                    placeholder="ê³ ê°ëª…, ì „í™”ë²ˆí˜¸, ì°¨ëŸ‰ë²ˆí˜¸ (2ê¸€ì ì´ìƒ)" onFocus={()=>setShowCustDropdown(true)}/>
                  <button className="btn-s btn-sm" onClick={()=>setShowCustDropdown(!showCustDropdown)}>ğŸ”</button>
                </div>
                {showCustDropdown && custSearch.length >= 2 && <div style={{position:"absolute",top:"100%",left:0,right:0,background:"#fff",border:"1px solid #d0d0d0",borderRadius:8,maxHeight:220,overflow:"auto",zIndex:10,marginTop:4,boxShadow:"0 8px 24px rgba(0,0,0,.12)"}}>
                  {custResults.map(c=><div key={c.id} onClick={()=>{selectCust(c);setF(p=>({...p,isNewCust:false}))}}
                    style={{padding:"8px 12px",cursor:"pointer",borderBottom:"1px solid #e0e0e030",display:"flex",gap:8,alignItems:"center",fontSize:12}}
                    onMouseOver={e=>e.currentTarget.style.background="#f0f0f0"} onMouseOut={e=>e.currentTarget.style.background="transparent"}>
                    <span className="badge" style={{background:c.gender==="M"?"#e0edf5":"#fce8e8",color:c.gender==="M"?"#7c7cc8":"#e57373",fontSize:9}}>{c.gender==="M"?"ë‚¨":"ì—¬"}</span>
                    <span style={{fontWeight:600}}>{c.name}</span>
                    <span style={{color:"#888"}}>{c.phone}</span>
                  </div>)}
                  {custResults.length===0 && <div style={{padding:"10px 12px",fontSize:11,color:"#999",textAlign:"center"}}>ê²€ìƒ‰ê²°ê³¼ ì—†ìŒ</div>}
                  <div onClick={()=>{setF(p=>({...p,isNewCust:true,custId:null,custName:custSearch.replace(/[0-9\-]/g,"").trim(),custPhone:custSearch.replace(/[^0-9]/g,"")}));setCustSearch("");setShowCustDropdown(false)}}
                    style={{padding:"10px 12px",cursor:"pointer",display:"flex",gap:8,alignItems:"center",fontSize:12,
                      background:"#d0d0d020",borderTop:"1px solid #e0e0e0",color:"#e57373",fontWeight:700}}
                    onMouseOver={e=>e.currentTarget.style.background="#d0d0d040"} onMouseOut={e=>e.currentTarget.style.background="#d0d0d020"}>
                    <span style={{fontSize:15}}>ï¼‹</span> ì‹ ê·œê³ ê°ìœ¼ë¡œ ë“±ë¡ {custSearch && <span style={{fontWeight:400,color:"#888"}}>"{custSearch}"</span>}
                  </div>
                </div>}
              </div>
            </FLD>

            {/* ê³ ê° ì •ë³´ */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 80px",gap:8}}>
              <FLD label="ê³ ê°ëª…"><input className="inp" value={f.custName} onChange={e=>set("custName",e.target.value)} placeholder="ê³ ê°ëª…"
                style={f.isNewCust?{borderColor:"#e57373",background:"#d0d0d008"}:{}}/></FLD>
              <FLD label="ì—°ë½ì²˜"><input className="inp" value={f.custPhone} onChange={e=>set("custPhone",e.target.value)} placeholder="010"
                style={f.isNewCust?{borderColor:"#e57373",background:"#d0d0d008"}:{}}/></FLD>
              <FLD label="ì„±ë³„">
                <div style={{display:"flex",gap:2,height:34}}>
                  <button onClick={()=>set("custGender","F")} style={{flex:1,fontSize:11,fontWeight:700,border:"1px solid #e57373",borderRadius:"4px 0 0 4px",cursor:"pointer",fontFamily:"inherit",
                    background:f.custGender==="F"?"#e57373":"transparent",color:f.custGender==="F"?"#fff":"#e57373"}}>ì—¬</button>
                  <button onClick={()=>set("custGender","M")} style={{flex:1,fontSize:11,fontWeight:700,border:"1px solid #7c7cc8",borderRadius:"0 4px 4px 0",cursor:"pointer",fontFamily:"inherit",
                    background:f.custGender==="M"?"#7c7cc8":"transparent",color:f.custGender==="M"?"#fff":"#7c7cc8"}}>ë‚¨</button>
                </div>
              </FLD>
            </div>

            {/* ì˜ˆì•½ê¸°ê°„ + ì¥ì†Œ/ë‹´ë‹¹ì í•œ ì¤„ */}
            <div>
              <label style={{fontSize:11,fontWeight:600,color:"#888",marginBottom:5,display:"block"}}>ì˜ˆì•½ê¸°ê°„ / ì¥ì†ŒÂ·ë‹´ë‹¹ì</label>
              <div style={{display:"flex",gap:4,alignItems:"center",flexWrap:"nowrap"}}>
                <input type="date" className="inp" style={{width:170,fontSize:12,flexShrink:0}} value={f.date} onChange={e=>set("date",e.target.value)}/>
                <select className="inp" style={{width:95,fontSize:12,flexShrink:0}} value={f.time} onChange={e=>{set("time",e.target.value);set("dur",calcDur(e.target.value,f.endTime))}}>
                  {TIMES.filter(t=>{const h=parseInt(t);return h>=8&&h<=21}).map(t=><option key={t} value={t}>{t}</option>)}
                </select>
                <span style={{color:"#999",fontSize:11,flexShrink:0}}>~</span>
                <select className="inp" style={{width:95,fontSize:12,flexShrink:0}} value={f.endTime} onChange={e=>{set("endTime",e.target.value);set("dur",calcDur(f.time,e.target.value))}}>
                  {TIMES.filter(t=>{const h=parseInt(t);return h>=8&&h<=22}).map(t=><option key={t} value={t}>{t}</option>)}
                </select>
                <span style={{color:"#d0d0d0",fontSize:11,flexShrink:0}}>â”‚</span>
                <select className="inp" style={{flex:"0 1 auto",fontSize:11,maxWidth:140,minWidth:80}} value={`${f.roomId}|${f.staffId}`} onChange={e=>{const [r,s]=e.target.value.split("|");set("roomId",r);set("staffId",s)}}>
                  {branchRooms.map(rm => branchStaff.map(st =>
                    <option key={rm.id+st.id} value={`${rm.id}|${st.id}`}>[{(data.branches||[]).find(b=>b.id===branchId)?.short}] {rm.name}-{st.dn}</option>
                  ))}
                </select>
              </div>
            </div>

            {/* ìƒí’ˆ/ì„œë¹„ìŠ¤ íƒœê·¸ */}
            <FLD label={`ìƒí’ˆ/ì„œë¹„ìŠ¤${(tagDurTotal+svcDurTotal) > 0 ? ` â€” í•©ì‚° ì†Œìš”ì‹œê°„: ${tagDurTotal+svcDurTotal}ë¶„` : ""}`}>
              <div style={{display:"flex",flexWrap:"wrap",gap:4,padding:8,background:"#f8f8f8",borderRadius:8,border:"1px solid #e0e0e0"}}>
                {visibleTags.map(tag => {
                  const sel = f.selectedTags?.includes(tag.id);
                  const hasColor = tag.color && tag.color !== "";
                  return <button key={tag.id} onClick={()=>toggleTag(tag.id)}
                    style={{padding:"4px 8px",fontSize:10,fontWeight:sel?700:500,borderRadius:4,cursor:"pointer",fontFamily:"inherit",transition:"all .1s",
                      border:`1px solid ${sel?(hasColor?tag.color:"#7c7cc8"):"#d0d0d0"}`,
                      background:sel?(hasColor?tag.color+"40":"#7c7cc820"):"transparent",
                      color:sel?(hasColor?tag.color:"#7c7cc8"):"#999",display:"flex",alignItems:"center",gap:3}}>
                    {tag.name}
                    {tag.dur > 0 && <span style={{fontSize:8,opacity:0.7}}>({tag.dur}ë¶„)</span>}
                  </button>;
                })}
              </div>
              {(f.selectedTags||[]).length > 0 && <div style={{marginTop:6,display:"flex",flexWrap:"wrap",gap:4,alignItems:"center"}}>
                <span style={{fontSize:10,color:"#999"}}>ì„ íƒ:</span>
                {(f.selectedTags||[]).map(tid=>{const tag=tags.find(t=>t.id===tid);return tag?<span key={tid} style={{fontSize:10,padding:"2px 6px",borderRadius:3,background:tag.color?tag.color+"30":"#7c7cc820",color:tag.color||"#7c7cc8",fontWeight:600}}>{tag.name}{tag.dur>0?` ${tag.dur}ë¶„`:""}</span>:null})}
                {tagDurTotal>0 && <span style={{fontSize:10,color:"#ef5350",fontWeight:700,marginLeft:4}}>= {tagDurTotal}ë¶„</span>}
              </div>}
            </FLD>

            {/* ì‹œìˆ  ìƒí’ˆ ì„ íƒ */}
            {(() => {
              const svcPriceTotal = (f.selectedServices||[]).reduce((sum, sid) => {
                const svc = INIT_SERVICES.find(s=>s.id===sid);
                return sum + (svc ? (f.custGender==="M"?svc.priceM:svc.priceF) : 0);
              }, 0);
              return <FLD label={`ì‹œìˆ  ìƒí’ˆ ì„ íƒ${(f.selectedServices||[]).length > 0 ? ` (${(f.selectedServices||[]).length}ê±´, ${svcDurTotal}ë¶„, ${fmt(svcPriceTotal)}ì›)` : ""}`}>
              <button onClick={()=>setShowSvcPicker(!showSvcPicker)}
                style={{width:"100%",padding:"8px 12px",fontSize:11,fontWeight:600,borderRadius:6,cursor:"pointer",fontFamily:"inherit",
                  border:"1px dashed #7c7cc8",background:showSvcPicker?"#7c7cc810":"#fafafa",color:"#7c7cc8",
                  display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                <span>{(f.selectedServices||[]).length > 0 ?
                  (f.selectedServices||[]).map(sid=>INIT_SERVICES.find(s=>s.id===sid)?.name).filter(Boolean).join(", ")
                  : "ì‹œìˆ  ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”"}</span>
                <span style={{fontSize:13}}>{showSvcPicker?"â–²":"â–¼"}</span>
              </button>
              {showSvcPicker && <div style={{marginTop:6,border:"1px solid #e0e0e0",borderRadius:8,background:"#fff",maxHeight:280,overflow:"auto"}}>
                {SERVICE_CATS.map(cat=>{
                  const catSvcs = INIT_SERVICES.filter(s=>s.cat===cat.id);
                  if(catSvcs.length===0) return null;
                  const genderFilter = f.custGender==="M" ? s=>s.priceM>0||s.priceM===0&&s.priceF===0 : s=>s.priceF>0||s.priceF===0&&s.priceM===0;
                  return <div key={cat.id}>
                    <div style={{padding:"6px 10px",background:"#f0f0f0",fontSize:10,fontWeight:700,color:"#666",borderBottom:"1px solid #e0e0e0"}}>{cat.name}</div>
                    {catSvcs.map(svc=>{
                      const sel = (f.selectedServices||[]).includes(svc.id);
                      const price = f.custGender==="M"?svc.priceM:svc.priceF;
                      const disabled = price===0;
                      return <div key={svc.id} onClick={()=>!disabled&&toggleService(svc.id)}
                        style={{padding:"5px 10px",cursor:disabled?"default":"pointer",display:"flex",alignItems:"center",gap:6,
                          borderBottom:"1px solid #f0f0f0",opacity:disabled?0.3:1,background:sel?"#7c7cc810":"transparent"}}>
                        <input type="checkbox" checked={sel} readOnly style={{accentColor:"#7c7cc8",width:14,height:14,pointerEvents:"none"}}/>
                        <span style={{flex:1,fontSize:11,fontWeight:sel?600:400,color:sel?"#333":"#666"}}>{svc.name}</span>
                        <span style={{fontSize:9,color:"#999"}}>{svc.dur}ë¶„</span>
                        <span style={{fontSize:10,color:"#ef5350",fontWeight:600,width:55,textAlign:"right"}}>{price>0?fmt(price):"-"}</span>
                      </div>;
                    })}
                  </div>;
                })}
              </div>}
            </FLD>;
            })()}

          </>}

          {/* ì˜ˆì•½ë©”ëª¨ */}
          <FLD label="ì˜ˆì•½ë©”ëª¨">
            <textarea className="inp" rows={3} value={f.memo} onChange={e=>set("memo",e.target.value)} style={{resize:"vertical"}} placeholder="ì˜ˆì•½ ê´€ë ¨ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"/>
            {(f.tsLog?.length > 0) && <div style={{marginTop:4,fontSize:10,color:"#999",lineHeight:1.6}}>
              {f.tsLog.map((ts,i)=><div key={i}>{ts}</div>)}
            </div>}
          </FLD>

          {/* Action Buttons - í•œ ì¤„ (pinned bottom) */}
        </div>
        <div style={{display:"flex",gap:6,padding:"12px 20px",borderTop:"1px solid #e0e0e0",background:"#fafafa",borderRadius:"0 0 8px 8px",flexShrink:0}}>
            <button className="btn-s" style={{padding:"10px 16px"}} onClick={onClose}>ë‹«ê¸°</button>
            {!isReadOnly && <><button className="btn-p" style={{flex:1,justifyContent:"center",padding:10,
              background:isSchedule?"#e17055":"#7c7cc8"}} onClick={()=>{
                const now = new Date();
                const ts = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")} ${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
                const prevLog = f.tsLog || [];
                const newLog = !item?.id && !isSchedule
                  ? [...prevLog, `[ë“±ë¡: ${ts}]`]
                  : item?.id
                    ? [...prevLog, `[ìˆ˜ì •: ${ts}]`]
                    : prevLog;
                onSave({...f, tsLog: newLog});
              }}>{item?.id?"ìˆ˜ì • ì™„ë£Œ":"ë“±ë¡"}</button>
            {item?.id && <button className="btn-d" style={{padding:"10px 16px"}} onClick={()=>onDeleteRequest?.(item)}>ì‚­ì œ</button>}
            {!isSchedule && f.type === "reservation" && (
              <button onClick={()=>setShowSaleForm(true)}
                style={{padding:"10px 18px",borderRadius:8,border:"none",background:existingSale?"linear-gradient(135deg,#5cb5c5,#6bab9e)":"linear-gradient(135deg,#7c7cc8,#5cb5c5)",color:"#fff",fontWeight:800,fontSize:12,cursor:"pointer",fontFamily:"inherit",whiteSpace:"nowrap"}}>
                {existingSale ? "ğŸ’° ë§¤ì¶œí™•ì¸" : "ğŸ’° ë§¤ì¶œë“±ë¡"}
              </button>
            )}</>}
            {isReadOnly && <span style={{fontSize:12,color:"#999",display:"flex",alignItems:"center",gap:4}}>ğŸ‘ ì—´ëŒ ì „ìš© (íƒ€ ì§€ì )</span>}
          </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAILED SALE FORM (ë§¤ì¶œ ì…ë ¥ - ì‹œìˆ ìƒí’ˆ/ì œí’ˆ ì—°ë™)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function DetailedSaleForm({ reservation, branchId, onSubmit, onClose, data, setData }) {
  const branchStaff = STAFF.filter(s => s.bid === branchId);
  const [manager, setManager] = useState(reservation?.staffId || branchStaff[0]?.id || "");
  const [selBranch, setSelBranch] = useState(branchId);
  const [gender, setGender] = useState(reservation?.custGender || "F");
  const [saleMemo, setSaleMemo] = useState(reservation?.saleMemo || "");

  // ê³ ê° ìƒíƒœ (ì˜ˆì•½ì—ì„œ ë„˜ì–´ì˜¤ë©´ ìë™ ê¸°ì…, ë§¤ì¶œê´€ë¦¬ì—ì„œ ì—´ë©´ ê²€ìƒ‰)
  const [cust, setCust] = useState({
    id: reservation?.custId || null,
    name: reservation?.custName || "",
    phone: reservation?.custPhone || "",
    gender: reservation?.custGender || "F"
  });
  const hasReservationCust = !!(reservation?.custName);

  // ê³ ê° ê²€ìƒ‰ (ë””ë°”ìš´ìŠ¤)
  const [custSearch, setCustSearch] = useState("");
  const [showCustDrop, setShowCustDrop] = useState(false);
  const [custResults, setCustResults] = useState([]);
  useEffect(() => {
    if (custSearch.length < 2) { setCustResults([]); return; }
    const timer = setTimeout(() => {
      const q = custSearch.toLowerCase();
      const results = (data?.customers||[]).filter(c =>
        c.name.toLowerCase().includes(q) || c.phone.includes(q)
      ).slice(0, 30);
      setCustResults(results);
    }, 300);
    return () => clearTimeout(timer);
  }, [custSearch]);
  const selectCust = (c) => {
    setCust({ id: c.id, name: c.name, phone: c.phone, gender: c.gender });
    setGender(c.gender || "F");
    setCustSearch(""); setShowCustDrop(false);
  };

  // State: { [id]: { checked, amount } }
  const [items, setItems] = useState(() => {
    const init = {};
    const selSvcs = reservation?.selectedServices || [];
    INIT_SERVICES.forEach(svc => {
      const preSelected = selSvcs.includes(svc.id);
      const defPrice = (reservation?.custGender||"F")==="M" ? svc.priceM : svc.priceF;
      init[svc.id] = { checked: preSelected, amount: preSelected ? defPrice : 0 };
    });
    PRODUCTS.forEach(p => { init[p.id] = { checked: false, amount: 0 }; });
    init["discount"] = { checked: false, amount: 0 };
    init["extra_svc"] = { checked: false, amount: 0, label: "" };
    init["extra_prod"] = { checked: false, amount: 0, label: "" };
    return init;
  });

  const toggle = (id, defPrice) => {
    setItems(prev => {
      const cur = prev[id] || { checked: false, amount: 0 };
      return { ...prev, [id]: { ...cur, checked: !cur.checked, amount: !cur.checked ? (defPrice || 0) : 0 } };
    });
  };
  const setAmt = (id, v) => setItems(prev => ({ ...prev, [id]: { ...prev[id], amount: Number(v) || 0 } }));
  const setLabel = (id, v) => setItems(prev => ({ ...prev, [id]: { ...prev[id], label: v } }));

  // ì‹ ê·œê³ ê° ë“±ë¡ ëª¨ë“œ
  const [newCustMode, setNewCustMode] = useState(false);
  const [newCustName, setNewCustName] = useState("");
  const [newCustPhone, setNewCustPhone] = useState("");
  const [newCustGender, setNewCustGender] = useState("F");
  const registerNewCust = () => {
    if (!newCustName.trim()) return;
    setCust({ id: "new_" + uid(), name: newCustName.trim(), phone: newCustPhone.trim(), gender: newCustGender });
    setGender(newCustGender);
    setNewCustMode(false); setCustSearch(""); setShowCustDrop(false);
  };

  // Totals
  const svcTotal = INIT_SERVICES.reduce((sum, svc) => sum + (items[svc.id]?.checked ? items[svc.id].amount : 0), 0)
    + (items.extra_svc?.checked ? items.extra_svc.amount : 0);
  const prodTotal = PRODUCTS.reduce((sum, p) => sum + (items[p.id]?.checked ? items[p.id].amount : 0), 0)
    + (items.extra_prod?.checked ? items.extra_prod.amount : 0);
  const discount = items.discount?.checked ? items.discount.amount : 0;
  const grandTotal = svcTotal + prodTotal - discount;

  // Count checked
  const checkedSvc = INIT_SERVICES.filter(s => items[s.id]?.checked).length + (items.extra_svc?.checked ? 1 : 0);
  const checkedProd = PRODUCTS.filter(p => items[p.id]?.checked).length + (items.extra_prod?.checked ? 1 : 0);

  const handleSubmit = () => {
    if (grandTotal <= 0) {
      alert("ë§¤ì¶œ ê¸ˆì•¡ì´ 0ì›ì…ë‹ˆë‹¤. ì‹œìˆ  ë˜ëŠ” ì œí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    const staff = STAFF.find(s => s.id === manager);
    // ì‹ ê·œê³ ê°ì´ë©´ data.customersì— ì¶”ê°€
    const isNewCust = cust.id?.startsWith("new_") || (!cust.id && cust.name);
    if (isNewCust && setData) {
      const custId = cust.id || ("cust_" + uid());
      const newCustObj = {
        id: custId, bid: selBranch, name: cust.name, phone: cust.phone,
        gender: cust.gender, visits: 1, lastVisit: todayStr(), memo: "",
        custNum: String(50000 + Math.floor(Math.random() * 10000))
      };
      // ì´ë¯¸ ë“±ë¡ëœ ê³ ê°ì´ë©´ ìŠ¤í‚µ
      const alreadyExists = (data?.customers||[]).some(c => c.id === custId);
      if (!alreadyExists) {
        setData(prev => ({ ...prev, customers: [...prev.customers, newCustObj] }));
        sb.insert("customers", toDb("customers", newCustObj)).catch(console.error);
      }
      cust.id = custId;
    }
    const sale = {
      id: uid(), bid: selBranch,
      custId: cust.id || null, custName: cust.name || "",
      custPhone: cust.phone || "", custGender: cust.gender || "F",
      custNum: String(50000 + Math.floor(Math.random() * 10000)),
      staffId: manager, staffName: staff?.dn || "",
      date: reservation?.date || todayStr(),
      serviceId: reservation?.serviceId || null, serviceName: INIT_SERVICES.find(s => s.id === reservation?.serviceId)?.name || "",
      productId: null, productName: null,
      svcCash: svcTotal, svcTransfer: 0, svcCard: 0, svcPoint: 0,
      prodCash: prodTotal, prodTransfer: 0, prodCard: 0, prodPoint: 0,
      gift: 0, orderNum: String(252000 + Math.floor(Math.random() * 200)),
      memo: saleMemo || "",
      createdAt: new Date().toISOString(),
    };
    onSubmit(sale);
  };

  // Checkbox row for service
  const SvcRow = ({ svc }) => {
    const it = items[svc.id] || { checked: false, amount: 0 };
    const defPrice = gender === "F" ? svc.priceF : svc.priceM;
    const disabled = defPrice === 0; // í•´ë‹¹ ì„±ë³„ ë¶ˆê°€
    return (
      <div style={{ display: "flex", alignItems: "center", gap: 5, padding: "3px 0", borderBottom: "1px solid #e0e0e030", opacity: disabled ? 0.3 : 1 }}>
        <input type="checkbox" checked={it.checked} disabled={disabled}
          onChange={() => toggle(svc.id, defPrice)}
          style={{ accentColor: "#7c7cc8", width: 14, height: 14, flexShrink: 0, cursor: disabled ? "not-allowed" : "pointer" }} />
        <span style={{ flex: 1, fontSize: 11, color: it.checked ? "#333" : "#999", fontWeight: it.checked ? 600 : 400 }}>
          {svc.name}
        </span>
        <span style={{ fontSize: 9, color: "#d0d0d0", flexShrink: 0, width: 32, textAlign: "center" }}>{svc.dur}ë¶„</span>
        <input className="inp" type="number" value={it.checked ? (it.amount || "") : ""} placeholder={disabled ? "â€”" : fmt(defPrice)}
          onChange={e => setAmt(svc.id, e.target.value)} disabled={!it.checked}
          style={{ width: 72, padding: "3px 5px", fontSize: 11, textAlign: "right",
            background: it.checked ? "#fff" : "transparent", border: `1px solid ${it.checked ? "#d0d0d0" : "#e0e0e0"}`,
            color: it.checked ? "#ef5350" : "#d0d0d0", fontWeight: it.checked ? 700 : 400 }} />
      </div>
    );
  };

  // Checkbox row for product
  const ProdRow = ({ prod }) => {
    const it = items[prod.id] || { checked: false, amount: 0 };
    return (
      <div style={{ display: "flex", alignItems: "center", gap: 5, padding: "3px 0", borderBottom: "1px solid #e0e0e030" }}>
        <input type="checkbox" checked={it.checked} onChange={() => toggle(prod.id, prod.price || 0)}
          style={{ accentColor: "#6bab9e", width: 14, height: 14, flexShrink: 0, cursor: "pointer" }} />
        <span style={{ flex: 1, fontSize: 11, color: it.checked ? "#333" : "#999", fontWeight: it.checked ? 600 : 400 }}>{prod.name}</span>
        <input className="inp" type="number" value={it.checked ? (it.amount || "") : ""} placeholder="0"
          onChange={e => setAmt(prod.id, e.target.value)} disabled={!it.checked}
          style={{ width: 72, padding: "3px 5px", fontSize: 11, textAlign: "right",
            background: it.checked ? "#fff" : "transparent", border: `1px solid ${it.checked ? "#d0d0d0" : "#e0e0e0"}`,
            color: it.checked ? "#ef5350" : "#d0d0d0", fontWeight: it.checked ? 700 : 400 }} />
      </div>
    );
  };

  // Extra row (ì¶”ê°€ - í…ìŠ¤íŠ¸ ì…ë ¥) - local state for label to avoid lag
  const ExtraRow = ({ id, color, placeholder }) => {
    const it = items[id] || { checked: false, amount: 0, label: "" };
    const [localLabel, setLocalLabel] = useState(it.label || "");
    return (
      <div style={{ display: "flex", alignItems: "center", gap: 5, padding: "5px 0", borderTop: "1px solid #d0d0d0", marginTop: 4 }}>
        <input type="checkbox" checked={it.checked} onChange={() => toggle(id, 0)}
          style={{ accentColor: color, width: 14, height: 14, cursor: "pointer" }} />
        <span style={{ fontSize: 10, color: "#ef5350", fontWeight: 700, flexShrink: 0 }}>ì¶”ê°€</span>
        <input className="inp" value={localLabel} onChange={e => setLocalLabel(e.target.value)}
          onBlur={e => setLabel(id, e.target.value)}
          placeholder={placeholder} style={{ flex: 1, padding: "3px 6px", fontSize: 11, background: "transparent", border: "1px solid #d0d0d0" }} />
        <input className="inp" type="number" value={it.amount || ""} placeholder="0"
          onChange={e => { if(!it.checked) toggle(id, 0); setAmt(id, e.target.value); }}
          style={{ width: 72, padding: "3px 5px", fontSize: 11, textAlign: "right",
            border: `1px solid ${it.checked ? "#d0d0d0" : "#e0e0e0"}`,
            color: it.checked ? "#ef5350" : "#999", fontWeight: it.checked ? 700 : 400 }} />
      </div>
    );
  };

  // Split services into 2 columns by categories
  const allCats = SERVICE_CATS;
  const midIdx = Math.ceil(allCats.length / 2);
  const leftCats = allCats.slice(0, midIdx);
  const rightCats = allCats.slice(midIdx);
  const halfProd = Math.ceil(PRODUCTS.length / 2);

  return (
    <div className="ov" onClick={onClose}>
      <div onClick={e => e.stopPropagation()} style={{
        background: "#fff", borderRadius: 14, border: "1px solid #e0e0e0", padding: 0,
        width: "95%", maxWidth: 1200, maxHeight: "92vh", overflow: "hidden", display: "flex", flexDirection: "column",
        animation: "fadeIn .2s ease", boxShadow: "0 25px 60px rgba(0,0,0,.5)"
      }}>
        {/* Header */}
        <div style={{ padding: "10px 20px", borderBottom: "1px solid #e0e0e0", display: "flex", alignItems: "center", justifyContent: "space-between", background: "#f8f8f8", gap: 10 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 14, flexWrap: "wrap", flex: 1 }}>
            <h3 style={{ fontSize: 16, fontWeight: 800, color: "#ef5350", flexShrink: 0 }}>â—† ë§¤ì¶œ ì…ë ¥</h3>
            {cust.name ? (
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <span className="badge" style={{ background: cust.gender === "M" ? "#e0edf5" : "#fce8e8", color: cust.gender === "M" ? "#7c7cc8" : "#e57373", fontSize: 10 }}>{cust.gender === "M" ? "ë‚¨" : "ì—¬"}</span>
                <strong style={{ color: "#444", fontSize: 13 }}>{cust.name}</strong>
                <span style={{ fontSize: 11, color: "#888" }}>{cust.phone}</span>
                {cust.id?.startsWith("new_") && <span style={{ fontSize: 8, padding: "1px 4px", borderRadius: 3, background: "#e57373", color: "#fff", fontWeight: 700 }}>ì‹ ê·œ</span>}
                {!hasReservationCust && <button onClick={() => { setCust({ id: null, name: "", phone: "", gender: "F" }); setCustSearch(""); setNewCustMode(false); }}
                  style={{ fontSize: 10, color: "#e57373", background: "none", border: "none", cursor: "pointer", fontFamily: "inherit", textDecoration: "underline" }}>ë³€ê²½</button>}
              </div>
            ) : newCustMode ? (
              <div style={{ display: "flex", gap: 6, alignItems: "center", flex: 1 }}>
                <div style={{ display: "flex", gap: 2 }}>
                  {["F","M"].map(g => <button key={g} onClick={() => setNewCustGender(g)}
                    style={{ padding: "3px 8px", fontSize: 10, fontWeight: 700, borderRadius: 4, cursor: "pointer", fontFamily: "inherit", border: "1px solid " + (newCustGender === g ? (g === "F" ? "#e57373" : "#7c7cc8") : "#d0d0d0"),
                      background: newCustGender === g ? (g === "F" ? "#e5737320" : "#7c7cc820") : "transparent",
                      color: newCustGender === g ? (g === "F" ? "#e57373" : "#7c7cc8") : "#999"
                    }}>{g === "F" ? "ì—¬" : "ë‚¨"}</button>)}
                </div>
                <input className="inp" style={{ width: 90, fontSize: 11, padding: "4px 8px" }} value={newCustName} onChange={e => setNewCustName(e.target.value)} placeholder="ê³ ê°ëª…" autoFocus />
                <input className="inp" style={{ width: 110, fontSize: 11, padding: "4px 8px" }} value={newCustPhone} onChange={e => setNewCustPhone(e.target.value)} placeholder="ì „í™”ë²ˆí˜¸" />
                <button onClick={registerNewCust} style={{ padding: "4px 12px", fontSize: 10, fontWeight: 700, borderRadius: 5, border: "none", background: "#7c7cc8", color: "#fff", cursor: "pointer", fontFamily: "inherit", whiteSpace: "nowrap" }}>í™•ì¸</button>
                <button onClick={() => setNewCustMode(false)} style={{ padding: "4px 8px", fontSize: 10, border: "none", background: "transparent", color: "#999", cursor: "pointer", fontFamily: "inherit" }}>ì·¨ì†Œ</button>
              </div>
            ) : (
              <div style={{ position: "relative", flex: 1, maxWidth: 280 }}>
                <input className="inp" style={{ fontSize: 11, width: "100%" }} value={custSearch}
                  onChange={e => { setCustSearch(e.target.value); setShowCustDrop(true); }}
                  onFocus={() => setShowCustDrop(true)}
                  placeholder="ê³ ê° ê²€ìƒ‰ (2ê¸€ì ì´ìƒ)" />
                {showCustDrop && custSearch.length >= 2 && (
                  <div style={{ position: "absolute", top: "100%", left: 0, right: 0, background: "#fff", border: "1px solid #d0d0d0", borderRadius: 8,
                    maxHeight: 200, overflow: "auto", zIndex: 20, marginTop: 2, boxShadow: "0 8px 20px rgba(0,0,0,.12)" }}>
                    {custResults.map(c => (
                      <div key={c.id} onClick={() => selectCust(c)}
                        style={{ padding: "7px 10px", cursor: "pointer", borderBottom: "1px solid #e0e0e020", display: "flex", gap: 6, alignItems: "center", fontSize: 11 }}
                        onMouseOver={e => e.currentTarget.style.background = "#f0f0f0"} onMouseOut={e => e.currentTarget.style.background = "transparent"}>
                        <span className="badge" style={{ background: c.gender === "M" ? "#e0edf5" : "#fce8e8", color: c.gender === "M" ? "#7c7cc8" : "#e57373", fontSize: 9 }}>{c.gender === "M" ? "ë‚¨" : "ì—¬"}</span>
                        <span style={{ fontWeight: 600 }}>{c.name}</span>
                        <span style={{ color: "#888" }}>{c.phone}</span>
                      </div>
                    ))}
                    {custResults.length === 0 && <div style={{ padding: "10px", fontSize: 11, color: "#999", textAlign: "center" }}>ê²€ìƒ‰ê²°ê³¼ ì—†ìŒ</div>}
                    <div onClick={() => { setNewCustMode(true); setShowCustDrop(false); setNewCustName(custSearch.replace(/[0-9\-]/g,"").trim()); setNewCustPhone(custSearch.replace(/[^0-9]/g,"")); }}
                      style={{ padding: "8px 10px", cursor: "pointer", borderTop: "1px solid #e0e0e0", display: "flex", alignItems: "center", gap: 6, fontSize: 11, fontWeight: 700, color: "#7c7cc8" }}
                      onMouseOver={e => e.currentTarget.style.background = "#e0edf520"} onMouseOut={e => e.currentTarget.style.background = "transparent"}>
                      <span style={{ fontSize: 14 }}>ï¼‹</span> ì‹ ê·œê³ ê°ìœ¼ë¡œ ë“±ë¡ {custSearch && <span style={{ fontWeight: 400, color: "#888" }}>"{custSearch}"</span>}
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
          <button onClick={onClose} className="close-btn" style={{ fontSize: 18 }}>âœ•</button>
        </div>

        {/* Controls: Manager, Branch, Gender, Live Totals */}
        <div style={{ padding: "8px 16px", borderBottom: "1px solid #e0e0e0", display: "flex", gap: 12, alignItems: "center", flexWrap: "wrap", background: "#f8f0f0" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 5, fontSize: 12 }}>
            <span style={{ color: "#888" }}>Manager</span>
            <select className="inp" style={{ width: 90, padding: "3px 6px", fontSize: 11 }} value={manager} onChange={e => setManager(e.target.value)}>
              {branchStaff.map(s => <option key={s.id} value={s.id}>{s.dn}</option>)}
            </select>
          </div>
          <div style={{ display: "flex", alignItems: "center", gap: 5, fontSize: 12 }}>
            <span style={{ color: "#888" }}>ì§€ì </span>
            <select className="inp" style={{ width: 90, padding: "3px 6px", fontSize: 11 }} value={selBranch} onChange={e => setSelBranch(e.target.value)}>
              {(data.branches||[]).map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
            </select>
          </div>
          {/* Gender - FIXED from customer data, not changeable */}
          <div style={{ display: "flex", alignItems: "center", gap: 2 }}>
            <div style={{ padding: "4px 14px", fontSize: 11, fontWeight: 700, borderRadius: 6, cursor: "default",
              background: gender === "F" ? "#e5737340" : "#7c7cc840",
              color: gender === "F" ? "#e57373" : "#5cb5c5",
              border: `1px solid ${gender === "F" ? "#e57373" : "#7c7cc8"}` }}>
              {gender === "F" ? "ì—¬ì„±" : "ë‚¨ì„±"} ê°€ê²© ì ìš©
            </div>
            <span style={{ fontSize: 9, color: "#d0d0d0" }}>ê³ ê°ì •ë³´ ê¸°ì¤€</span>
          </div>
          {/* Totals */}
          <div style={{ marginLeft: "auto", display: "flex", alignItems: "center", gap: 10 }}>
            <span style={{ fontSize: 11, color: "#888" }}>ì‹œìˆ  <strong style={{ color: "#7c7cc8" }}>{fmt(svcTotal)}</strong> ({checkedSvc})</span>
            <span style={{ fontSize: 11, color: "#888" }}>ì œí’ˆ <strong style={{ color: "#6bab9e" }}>{fmt(prodTotal)}</strong> ({checkedProd})</span>
            {discount > 0 && <span style={{ fontSize: 11, color: "#888" }}>í• ì¸ <strong style={{ color: "#e8a0a0" }}>-{fmt(discount)}</strong></span>}
            <span style={{ fontSize: 17, fontWeight: 900, color: "#ef5350" }}>{fmt(grandTotal)}ì›</span>
          </div>
        </div>

        {/* Main Body - 4 columns: svc left, svc right, prod left, prod right */}
        <div style={{ flex: 1, overflow: "auto", padding: "10px 14px", display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 14, alignContent: "start" }}>

          {/* Col 1: Service categories (left half) */}
          <div>
            {leftCats.map(cat => {
              const svcs = INIT_SERVICES.filter(s => s.cat === cat.id).sort((a,b)=>a.sort-b.sort);
              if (!svcs.length) return null;
              return <div key={cat.id} style={{ marginBottom: 8 }}>
                <div style={{ fontSize: 10, fontWeight: 700, color: "#7c7cc8", padding: "4px 0 3px", borderBottom: "2px solid #7c7cc830", marginBottom: 1 }}>{cat.name} ({svcs.length})</div>
                {svcs.map(svc => <SvcRow key={svc.id} svc={svc} />)}
              </div>;
            })}
            <ExtraRow id="extra_svc" color="#7c7cc8" placeholder="ì¶”ê°€ ì‹œìˆ ëª… ì…ë ¥" />
          </div>

          {/* Col 2: Service categories (right half) */}
          <div>
            {rightCats.map(cat => {
              const svcs = INIT_SERVICES.filter(s => s.cat === cat.id).sort((a,b)=>a.sort-b.sort);
              if (!svcs.length) return null;
              return <div key={cat.id} style={{ marginBottom: 8 }}>
                <div style={{ fontSize: 10, fontWeight: 700, color: "#7c7cc8", padding: "4px 0 3px", borderBottom: "2px solid #7c7cc830", marginBottom: 1 }}>{cat.name} ({svcs.length})</div>
                {svcs.map(svc => <SvcRow key={svc.id} svc={svc} />)}
              </div>;
            })}
            {/* Discount */}
            <div style={{ marginTop: 6, padding: "4px 0", borderTop: "1px solid #d0d0d0" }}>
              <div style={{ display: "flex", alignItems: "center", gap: 5, padding: "3px 0" }}>
                <input type="checkbox" checked={items.discount?.checked} onChange={() => toggle("discount", 0)}
                  style={{ accentColor: "#e8a0a0", width: 14, height: 14, cursor: "pointer" }} />
                <span style={{ flex: 1, fontSize: 11, color: items.discount?.checked ? "#e8a0a0" : "#888", fontWeight: 600 }}>í• ì¸</span>
                <input className="inp" type="number" value={items.discount?.checked ? (items.discount.amount || "") : ""} placeholder="0"
                  onChange={e => setAmt("discount", e.target.value)} disabled={!items.discount?.checked}
                  style={{ width: 72, padding: "3px 5px", fontSize: 11, textAlign: "right",
                    background: items.discount?.checked ? "#fff" : "transparent", border: `1px solid ${items.discount?.checked ? "#d0d0d0" : "#e0e0e0"}`,
                    color: items.discount?.checked ? "#ef5350" : "#d0d0d0", fontWeight: items.discount?.checked ? 700 : 400 }} />
              </div>
            </div>
          </div>

          {/* Col 3: Products (first half) */}
          <div>
            <div style={{ fontSize: 10, fontWeight: 700, color: "#6bab9e", padding: "4px 0 3px", borderBottom: "2px solid #6bab9e30", marginBottom: 1 }}>ì œí’ˆ ({PRODUCTS.length})</div>
            {PRODUCTS.slice(0, halfProd).map(p => <ProdRow key={p.id} prod={p} />)}
          </div>

          {/* Col 4: Products (second half) + extra */}
          <div>
            <div style={{ fontSize: 10, fontWeight: 700, color: "#6bab9e", padding: "4px 0 3px", borderBottom: "2px solid #6bab9e30", marginBottom: 1 }}>&nbsp;</div>
            {PRODUCTS.slice(halfProd).map(p => <ProdRow key={p.id} prod={p} />)}
            <ExtraRow id="extra_prod" color="#6bab9e" placeholder="ì¶”ê°€ ì œí’ˆëª… ì…ë ¥" />
          </div>
        </div>

        {/* ë§¤ì¶œ ë©”ëª¨ */}
        <div style={{padding:"8px 16px",borderTop:"1px solid #eee"}}>
          <textarea className="inp" rows={2} value={saleMemo} onChange={e=>setSaleMemo(e.target.value)}
            placeholder="ë§¤ì¶œ ê´€ë ¨ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style={{resize:"vertical",width:"100%",fontSize:11}}/>
        </div>

        {/* Footer */}
        <div style={{ padding: "10px 16px", borderTop: "1px solid #e0e0e0", display: "flex", gap: 10, alignItems: "center", justifyContent: "space-between", background: "#f8f8f8" }}>
          <div style={{ fontSize: 11, color: "#d0d0d0" }}>
            {gender === "F" ? "ì—¬ì„±" : "ë‚¨ì„±"} ê°€ê²© ì ìš© Â· ì²´í¬í•œ í•­ëª©ë§Œ ë§¤ì¶œ ë°˜ì˜ Â· ê´€ë¦¬ì„¤ì •ì—ì„œ ì‹œìˆ /ì œí’ˆ í¸ì§‘ ê°€ëŠ¥
          </div>
          <div style={{ display: "flex", gap: 8 }}>
            <button className="btn-s" onClick={onClose}>ì·¨ì†Œ</button>
            <button className="btn-p" style={{ padding: "10px 28px", fontSize: 14, fontWeight: 800 }} onClick={handleSubmit}>
              ğŸ’° ë§¤ì¶œ ë“±ë¡ ({fmt(grandTotal)}ì›)
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESERVATION LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ReservationList({ data, setData, userBranches, isMaster }) {
  const [selDate, setSelDate] = useState(todayStr());
  const [vb, setVb] = useState("all");
  const res = data.reservations.filter(r => r.date===selDate && r.type==="reservation" && ((vb==="all"?userBranches.includes(r.bid):r.bid===vb))).sort((a,b)=>a.time.localeCompare(b.time));
  const changeDate = (off) => { const d = new Date(selDate); d.setDate(d.getDate()+off); setSelDate(d.toISOString().split("T")[0]); };
  const updateStatus = (id, status) => { setData(prev=>({...prev,reservations:prev.reservations.map(r=>r.id===id?{...r,status}:r)})); sb.update("reservations",id,{status}).catch(console.error); };
  const deleteRes = (id) => setData(prev=>({...prev,reservations:prev.reservations.filter(r=>r.id!==id)}));

  return <div>
    <h2 className="page-title">ì˜ˆì•½ ëª©ë¡</h2>
    <div style={{display:"flex",gap:10,marginBottom:16,flexWrap:"wrap",alignItems:"center"}}>
      <div style={{display:"flex",alignItems:"center",gap:4}}>
        <button className="btn-s btn-sm" onClick={()=>changeDate(-1)}>â—€</button>
        <input type="date" className="inp" style={{width:150}} value={selDate} onChange={e=>setSelDate(e.target.value)}/>
        <button className="btn-s btn-sm" onClick={()=>changeDate(1)}>â–¶</button>
      </div>
      <button className="btn-s btn-sm" onClick={()=>setSelDate(todayStr())}>ì˜¤ëŠ˜</button>
      {<select className="inp" style={{width:130}} value={vb} onChange={e=>setVb(e.target.value)}>
        <option value="all">ì „ì²´ ë§¤ì¥</option>
        {(data.branches||[]).map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
      </select>}
      <span style={{fontSize:13,color:"#888"}}>ì´ {res.length}ê±´</span>
    </div>
    <div className="card tw">
      <table><thead><tr>
        <th>ì‹œê°„</th><th>ë§¤ì¥</th><th>ë£¸</th><th>ê³ ê°</th><th>ì„±ë³„</th><th>ì—°ë½ì²˜</th><th>ì‹œìˆ </th><th>ì‹œìˆ ì</th><th>ìƒíƒœ</th><th>ì•¡ì…˜</th>
      </tr></thead><tbody>
        {res.length===0?<tr><td colSpan={10} style={{textAlign:"center",color:"#999",padding:40}}>ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>:
          res.map(r=>{
            const svc = SERVICES.find(s=>s.id===r.serviceId);
            const staff = STAFF.find(s=>s.id===r.staffId);
            const br = (data.branches||[]).find(b=>b.id===r.bid);
            const room = ROOMS.find(rm=>rm.id===r.roomId);
            const g = r.custGender || "F";
            return <tr key={r.id}>
              <td style={{fontWeight:700,color:"#7c7cc8"}}>{r.time}</td>
              <td>{br?.short}</td>
              <td>{room?.name||"-"}</td>
              <td style={{fontWeight:600}}>{r.custName||"-"}</td>
              <td><span className="badge" style={{background:g==="M"?"#e0edf5":"#fce8e8",color:g==="M"?"#7c7cc8":"#e57373",fontSize:10}}>{g==="M"?"ë‚¨":"ì—¬"}</span></td>
              <td style={{color:"#7c7cc8"}}>{r.custPhone||"-"}</td>
              <td>{svc?.name||"-"}</td>
              <td>{staff?.dn||"-"}</td>
              <td><span className="badge" style={{background:`${STATUS_CLR[r.status]}20`,color:STATUS_CLR[r.status]}}>{STATUS_LABEL[r.status]}</span></td>
              <td><div style={{display:"flex",gap:3}}>
                {r.status==="confirmed"&&<button className="btn-sm" style={{background:"#e8f5f0",color:"#6bab9e",border:"none",borderRadius:6,padding:"4px 8px",cursor:"pointer",fontSize:11}} onClick={()=>updateStatus(r.id,"completed")}>âœ“ì™„ë£Œ</button>}
                <button className="btn-sm btn-s" onClick={()=>deleteRes(r.id)} style={{padding:"4px 8px"}}>ğŸ—‘</button>
              </div></td>
            </tr>
          })}
      </tbody></table>
    </div>
  </div>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SALES PAGE (ì‹œìˆ /ì œí’ˆ ë¶„ë¦¬, ê²°ì œìˆ˜ë‹¨ ì„¸ë¶„í™”)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function SalesPage({ data, setData, userBranches, isMaster }) {
  const [selDate, setSelDate] = useState(todayStr());
  const [vb, setVb] = useState("all");
  const [tab, setTab] = useState("daily");
  const [showModal, setShowModal] = useState(false);
  const [editSale, setEditSale] = useState(null); // sale being edited
  
  const sales = data.sales.filter(s => {
    const brMatch = (vb==="all"?userBranches.includes(s.bid):s.bid===vb);
    if (tab==="daily") return s.date===selDate && brMatch;
    if (tab==="prev") { const d=new Date(selDate);d.setDate(d.getDate()-1); return s.date===d.toISOString().split("T")[0] && brMatch; }
    return brMatch;
  });

  const totals = sales.reduce((a,s)=>({
    svcCash:a.svcCash+s.svcCash, svcTransfer:a.svcTransfer+s.svcTransfer, svcCard:a.svcCard+s.svcCard, svcPoint:a.svcPoint+s.svcPoint,
    prodCash:a.prodCash+s.prodCash, prodTransfer:a.prodTransfer+s.prodTransfer, prodCard:a.prodCard+s.prodCard, prodPoint:a.prodPoint+s.prodPoint,
    gift:a.gift+s.gift, svcTotal:a.svcTotal+(s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint), prodTotal:a.prodTotal+(s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint),
    total:a.total+(s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint+s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint+s.gift)
  }),{svcCash:0,svcTransfer:0,svcCard:0,svcPoint:0,prodCash:0,prodTransfer:0,prodCard:0,prodPoint:0,gift:0,svcTotal:0,prodTotal:0,total:0});

  const changeDate = (off) => { const d = new Date(selDate); d.setDate(d.getDate()+off); setSelDate(d.toISOString().split("T")[0]); };
  const handleDelete = (id) => { setData(prev=>({...prev,sales:prev.sales.filter(s=>s.id!==id)})); sb.del("sales",id).catch(console.error); };
  const handleSave = (item) => { setData(prev=>({...prev,sales:[...prev.sales,item]})); sb.insert("sales",toDb("sales",item)).catch(console.error); setShowModal(false); };
  const handleEditSave = (item) => {
    const finalItem = {...item, id:editSale.id};
    setData(prev=>({...prev, sales: prev.sales.map(s=>s.id===editSale.id ? finalItem : s)}));
    sb.update("sales",editSale.id,toDb("sales",finalItem)).catch(console.error);
    setEditSale(null);
  };

  return <div>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16,flexWrap:"wrap",gap:10}}>
      <h2 className="page-title" style={{marginBottom:0}}>ë§¤ì¶œ ê´€ë¦¬</h2>
      <button className="btn-p" onClick={()=>setShowModal(true)}>ï¼‹ ë§¤ì¶œë“±ë¡</button>
    </div>
    {/* Tabs */}
    <div style={{display:"flex",gap:2,marginBottom:16,background:"#e0e0e0",borderRadius:8,padding:3,width:"fit-content"}}>
      {[["daily","ì¼ë§¤ì¶œ"],["prev","ì „ì¼ë§¤ì¶œ"],["all","ì „ì²´ë§¤ì¶œ"]].map(([k,v])=>(
        <button key={k} className={tab===k?"btn-p btn-sm":"btn-s btn-sm"} onClick={()=>setTab(k)}>{v}</button>
      ))}
    </div>
    {/* Filters */}
    <div style={{display:"flex",gap:10,marginBottom:16,flexWrap:"wrap",alignItems:"center"}}>
      {tab!=="all"&&<div style={{display:"flex",alignItems:"center",gap:4}}>
        <button className="btn-s btn-sm" onClick={()=>changeDate(-1)}>â—€</button>
        <input type="date" className="inp" style={{width:150}} value={selDate} onChange={e=>setSelDate(e.target.value)}/>
        <button className="btn-s btn-sm" onClick={()=>changeDate(1)}>â–¶</button>
        <button className="btn-s btn-sm" onClick={()=>setSelDate(todayStr())}>ì˜¤ëŠ˜</button>
      </div>}
      {<select className="inp" style={{width:130}} value={vb} onChange={e=>setVb(e.target.value)}>
        <option value="all">ì „ì²´ ë§¤ì¥</option>
        {(data.branches||[]).map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
      </select>}
    </div>
    {/* Sales Table - like existing admin */}
    <div className="card tw">
      <table><thead><tr>
        <th>ë²ˆí˜¸</th><th>ì§€ì </th><th>ê³ ê°ë²ˆí˜¸</th><th>ì´ë¦„</th><th>í•¸ë“œí°</th><th>ë§¤ë‹ˆì €</th>
        <th style={{background:"#e0edf5"}}>ë§¤ì¶œí•©ê³„</th>
        <th style={{background:"#e0edf5"}}>ì‹œìˆ í•©ê³„</th><th style={{background:"#e0edf5"}}>ì‹œìˆ í˜„ê¸ˆ</th><th style={{background:"#e0edf5"}}>ì‹œìˆ ì…ê¸ˆ</th><th style={{background:"#e0edf5"}}>ì‹œìˆ ì¹´ë“œ</th><th style={{background:"#e0edf5"}}>ì‹œìˆ í¬ì¸íŠ¸</th>
        <th style={{background:"#e8f5f0"}}>ì œí’ˆí•©ê³„</th><th style={{background:"#e8f5f0"}}>ì œí’ˆí˜„ê¸ˆ</th><th style={{background:"#e8f5f0"}}>ì œí’ˆì…ê¸ˆ</th><th style={{background:"#e8f5f0"}}>ì œí’ˆì¹´ë“œ</th><th style={{background:"#e8f5f0"}}>ì œí’ˆí¬ì¸íŠ¸</th>
        <th style={{background:"#e57373"}}>ìƒí’ˆê¶Œ</th>
        <th>ë©”ëª¨</th>
        <th>ë“±ë¡ì‹œê°„</th>
        <th style={{width:60}}>ê´€ë¦¬</th>
      </tr></thead><tbody>
        {sales.length===0?<tr><td colSpan={21} style={{textAlign:"center",color:"#999",padding:40}}>ë§¤ì¶œ ê¸°ë¡ ì—†ìŒ</td></tr>:
          sales.map((s,i)=>{
            const br=(data.branches||[]).find(b=>b.id===s.bid);
            const st=s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint;
            const pt=s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint;
            return <tr key={s.id}>
              <td>{i+1}</td><td>{br?.short}</td>
              <td>{s.custNum}</td>
              <td style={{fontWeight:600}}><span style={{color:s.custGender==="M"?"#4a7cc8":"#e57373",marginRight:3}}>{s.custGender==="M"?"ë‚¨":"ì—¬"}</span>{s.custName||"-"}</td>
              <td style={{color:"#7c7cc8",fontSize:11}}>{s.custPhone}</td>
              <td>{s.staffName}</td>
              <td style={{fontWeight:700,color:"#5cb5c5"}}>{fmt(st+pt+(s.gift||0))}</td>
              <td style={{fontWeight:600,color:"#7c7cc8"}}>{fmt(st)}</td>
              <td>{s.svcCash>0?fmt(s.svcCash):<Z/>}</td><td>{s.svcTransfer>0?fmt(s.svcTransfer):<Z/>}</td>
              <td>{s.svcCard>0?fmt(s.svcCard):<Z/>}</td><td>{s.svcPoint>0?fmt(s.svcPoint):<Z/>}</td>
              <td style={{fontWeight:600,color:"#6bab9e"}}>{fmt(pt)}</td>
              <td>{s.prodCash>0?fmt(s.prodCash):<Z/>}</td><td>{s.prodTransfer>0?fmt(s.prodTransfer):<Z/>}</td>
              <td>{s.prodCard>0?fmt(s.prodCard):<Z/>}</td><td>{s.prodPoint>0?fmt(s.prodPoint):<Z/>}</td>
              <td style={{fontWeight:600,color:"#ef5350"}}>{s.gift>0?fmt(s.gift):<Z/>}</td>
              <td style={{fontSize:10,color:"#888",maxWidth:80,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.memo||""}</td>
              <td style={{fontSize:9,color:"#aaa",whiteSpace:"nowrap"}}>{s.createdAt ? new Date(s.createdAt).toLocaleString("ko-KR",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}) : "-"}</td>
              <td style={{whiteSpace:"nowrap"}}>
                <button className="btn-sm btn-s" style={{padding:"3px 5px",fontSize:10,marginRight:2}} onClick={()=>setEditSale(s)}>âœ</button>
                <button className="btn-sm btn-s" style={{padding:"3px 5px",fontSize:10}} onClick={()=>handleDelete(s.id)}>ğŸ—‘</button>
              </td>
            </tr>
          })}
        {/* Totals */}
        {sales.length>0 && <tr style={{background:"#f0f0f0",fontWeight:700}}>
          <td colSpan={6} style={{textAlign:"right",color:"#7c7cc8"}}>í•©ê³„</td>
          <td style={{color:"#5cb5c5"}}>{fmt(totals.total)}</td>
          <td style={{color:"#7c7cc8"}}>{fmt(totals.svcTotal)}</td>
          <td>{fmt(totals.svcCash)}</td><td>{fmt(totals.svcTransfer)}</td><td>{fmt(totals.svcCard)}</td><td>{fmt(totals.svcPoint)}</td>
          <td style={{color:"#6bab9e"}}>{fmt(totals.prodTotal)}</td>
          <td>{fmt(totals.prodCash)}</td><td>{fmt(totals.prodTransfer)}</td><td>{fmt(totals.prodCard)}</td><td>{fmt(totals.prodPoint)}</td>
          <td style={{color:"#ef5350"}}>{fmt(totals.gift)}</td>
          <td colSpan={3}/>
        </tr>}
      </tbody></table>
    </div>
    {showModal && <DetailedSaleForm
      reservation={{id:uid(),bid:userBranches[0],custId:null,custName:"",custPhone:"",custGender:"F",
        staffId:STAFF.find(s=>s.bid===(userBranches[0]))?.id||"",serviceId:null,date:selDate}}
      branchId={userBranches[0]}
      onSubmit={(sale)=>{handleSave(sale);}}
      onClose={()=>setShowModal(false)} data={data} setData={setData} />}
    {editSale && <DetailedSaleForm
      reservation={{...editSale, saleMemo:editSale.memo||""}}
      branchId={editSale.bid}
      onSubmit={handleEditSave}
      onClose={()=>setEditSale(null)} data={data} setData={setData} />}
  </div>;
}

function Z() { return <span style={{color:"#bbb"}}>0</span>; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATISTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function StatsPage({ data, userBranches, isMaster, role }) {
  const [period, setPeriod] = useState("7");
  const [vb, setVb] = useState("all");
  const end = new Date(), start = new Date();
  start.setDate(start.getDate() - parseInt(period));
  
  const filtered = data.sales.filter(s => {
    const d = new Date(s.date);
    return d >= start && d <= end && ((vb==="all"?userBranches.includes(s.bid):s.bid===vb));
  });

  const t = filtered.reduce((a,s)=>({
    svcTotal:a.svcTotal+(s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint),
    prodTotal:a.prodTotal+(s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint),
    gift:a.gift+s.gift,
    total:a.total+(s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint+s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint+s.gift),
    count:a.count+1,
    svcCash:a.svcCash+s.svcCash,svcTransfer:a.svcTransfer+s.svcTransfer,svcCard:a.svcCard+s.svcCard,svcPoint:a.svcPoint+s.svcPoint,
    prodCash:a.prodCash+s.prodCash,prodTransfer:a.prodTransfer+s.prodTransfer,prodCard:a.prodCard+s.prodCard,prodPoint:a.prodPoint+s.prodPoint,
  }),{svcTotal:0,prodTotal:0,gift:0,total:0,count:0,svcCash:0,svcTransfer:0,svcCard:0,svcPoint:0,prodCash:0,prodTransfer:0,prodCard:0,prodPoint:0});

  const days = parseInt(period);

  // By staff
  const byStaff = {};
  filtered.forEach(s => {
    if(!byStaff[s.staffName]) byStaff[s.staffName]={count:0,total:0};
    byStaff[s.staffName].count++;
    byStaff[s.staffName].total+=(s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint+s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint+s.gift);
  });
  const staffRank = Object.entries(byStaff).sort((a,b)=>b[1].total-a[1].total);

  // By branch
  const byBranch = {};
  if (isMaster) {
    filtered.forEach(s => {
      const bn = (data.branches||[]).find(b=>b.id===s.bid)?.short||"";
      if(!byBranch[bn]) byBranch[bn]={count:0,total:0};
      byBranch[bn].count++;
      byBranch[bn].total+=(s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint+s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint+s.gift);
    });
  }
  const branchRank = Object.entries(byBranch).sort((a,b)=>b[1].total-a[1].total);

  // Chart data (7 days)
  const chartDays = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    const ds = d.toISOString().split("T")[0];
    const dayData = data.sales.filter(s=>s.date===ds && ((vb==="all"?userBranches.includes(s.bid):s.bid===vb)));
    const svc = dayData.reduce((a,s)=>a+s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint,0);
    const prod = dayData.reduce((a,s)=>a+s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint,0);
    chartDays.push({label:`${d.getMonth()+1}/${d.getDate()}`,svc,prod,total:svc+prod});
  }
  const maxChart = Math.max(...chartDays.map(d=>d.total),1);

  return <div>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16,flexWrap:"wrap",gap:10}}>
      <h2 className="page-title" style={{marginBottom:0}}>ë§¤ì¶œ í†µê³„</h2>
      <div style={{display:"flex",gap:8}}>
        {<select className="inp" style={{width:120}} value={vb} onChange={e=>setVb(e.target.value)}>
          <option value="all">ì „ì²´ ë§¤ì¥</option>
          {(data.branches||[]).map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
        </select>}
        <select className="inp" style={{width:100}} value={period} onChange={e=>setPeriod(e.target.value)}>
          <option value="7">7ì¼</option><option value="14">14ì¼</option><option value="30">30ì¼</option>
        </select>
      </div>
    </div>
    {/* Summary Cards */}
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(160px,1fr))",gap:12,marginBottom:20}}>
      <SC label="ì´ ë§¤ì¶œ" val={`${fmt(t.total)}ì›`} sub={`${t.count}ê±´`} clr="#5cb5c5"/>
      <SC label="ì‹œìˆ  ë§¤ì¶œ" val={`${fmt(t.svcTotal)}ì›`} sub="ì‹œìˆ  í•©ê³„" clr="#7c7cc8"/>
      <SC label="ì œí’ˆ ë§¤ì¶œ" val={`${fmt(t.prodTotal)}ì›`} sub="ì œí’ˆ í•©ê³„" clr="#6bab9e"/>
      <SC label="ìƒí’ˆê¶Œ" val={`${fmt(t.gift)}ì›`} sub="ìƒí’ˆê¶Œ í•©ê³„" clr="#ef5350"/>
      <SC label="ì¼ í‰ê· " val={`${fmt(Math.round(t.total/days))}ì›`} sub={`${days}ì¼ í‰ê· `} clr="#5cb5c5"/>
      <SC label="ê°ë‹¨ê°€" val={`${fmt(t.count>0?Math.round(t.total/t.count):0)}ì›`} sub="ê±´ë‹¹ í‰ê· " clr="#d0d0d0"/>
    </div>
    {/* Chart */}
    <div className="card" style={{padding:20,marginBottom:16}}>
      <div style={{fontSize:13,fontWeight:700,color:"#888",marginBottom:16}}>ìµœê·¼ 7ì¼ ë§¤ì¶œ (ì‹œìˆ  + ì œí’ˆ)</div>
      <div style={{display:"flex",alignItems:"flex-end",gap:6,height:130}}>
        {chartDays.map((d,i)=>(
          <div key={i} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:4}}>
            <span style={{fontSize:9,color:"#888"}}>{d.total>0?`${fmt(Math.round(d.total/10000))}ë§Œ`:""}</span>
            <div style={{width:"100%",display:"flex",flexDirection:"column",gap:1}}>
              <div style={{width:"100%",height:`${Math.max((d.prod/maxChart)*80,0)}px`,background:"#6bab9e",borderRadius:"4px 4px 0 0",transition:"height .3s"}}/>
              <div style={{width:"100%",height:`${Math.max((d.svc/maxChart)*80,2)}px`,background:"#7c7cc8",borderRadius:"0 0 4px 4px",transition:"height .3s"}}/>
            </div>
            <span style={{fontSize:10,color:"#999"}}>{d.label}</span>
          </div>
        ))}
      </div>
      <div style={{display:"flex",gap:12,justifyContent:"center",marginTop:10}}>
        <span style={{fontSize:10,display:"flex",alignItems:"center",gap:4}}><span style={{width:8,height:8,borderRadius:2,background:"#7c7cc8"}}/>ì‹œìˆ </span>
        <span style={{fontSize:10,display:"flex",alignItems:"center",gap:4}}><span style={{width:8,height:8,borderRadius:2,background:"#6bab9e"}}/>ì œí’ˆ</span>
      </div>
    </div>
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(300px,1fr))",gap:16}}>
      {/* Payment Breakdown */}
      <div className="card" style={{padding:20}}>
        <div style={{fontSize:13,fontWeight:700,color:"#888",marginBottom:14}}>ê²°ì œìˆ˜ë‹¨ë³„ ì‹œìˆ  ë§¤ì¶œ</div>
        {[["í˜„ê¸ˆ",t.svcCash,"#6bab9e"],["ì…ê¸ˆ",t.svcTransfer,"#ef5350"],["ì¹´ë“œ",t.svcCard,"#7c7cc8"],["í¬ì¸íŠ¸",t.svcPoint,"#d0d0d0"]].map(([l,v,c])=>(
          <div key={l} style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,fontSize:13}}>
            <span style={{width:45,color:c,fontWeight:600}}>{l}</span>
            <div style={{flex:1,height:6,background:"#e0e0e0",borderRadius:3,overflow:"hidden"}}>
              <div style={{height:"100%",width:`${t.svcTotal>0?(v/t.svcTotal)*100:0}%`,background:c,borderRadius:3}}/>
            </div>
            <span style={{width:80,textAlign:"right",fontWeight:600}}>{fmt(v)}ì›</span>
          </div>
        ))}
      </div>
      {/* Staff Rank */}
      <div className="card" style={{padding:20}}>
        <div style={{fontSize:13,fontWeight:700,color:"#888",marginBottom:14}}>ë§¤ë‹ˆì €ë³„ ë§¤ì¶œ</div>
        {staffRank.slice(0,8).map(([n,v],i)=>(
          <div key={i} style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,fontSize:13}}>
            <span style={{width:18,color:i<3?"#5cb5c5":"#d0d0d0",fontWeight:700}}>{i+1}</span>
            <span style={{flex:1,fontWeight:500}}>{n}</span>
            <span style={{color:"#888",fontSize:11}}>{v.count}ê±´</span>
            <span style={{fontWeight:700,color:"#5cb5c5",width:80,textAlign:"right"}}>{fmt(v.total)}ì›</span>
          </div>
        ))}
      </div>
      {/* Branch Rank (master) */}
      {isMaster && <div className="card" style={{padding:20}}>
        <div style={{fontSize:13,fontWeight:700,color:"#888",marginBottom:14}}>ë§¤ì¥ë³„ ë§¤ì¶œ</div>
        {branchRank.map(([n,v],i)=>(
          <div key={i} style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,fontSize:13}}>
            <span style={{width:18,color:i<3?"#7c7cc8":"#d0d0d0",fontWeight:700}}>{i+1}</span>
            <span style={{width:55,fontWeight:600}}>{n}</span>
            <div style={{flex:1,height:6,background:"#e0e0e0",borderRadius:3,overflow:"hidden"}}>
              <div style={{height:"100%",width:`${branchRank[0][1].total>0?(v.total/branchRank[0][1].total)*100:0}%`,background:"linear-gradient(90deg,#5cb5c5,#7c7cc8)",borderRadius:3}}/>
            </div>
            <span style={{fontWeight:700,width:85,textAlign:"right"}}>{fmt(v.total)}ì›</span>
          </div>
        ))}
      </div>}
    </div>
  </div>;
}

function SC({label,val,sub,clr}) {
  return <div style={{padding:16,borderRadius:10,background:"linear-gradient(135deg,#fff,#f0f0f0)",border:"1px solid #e0e0e0"}}>
    <div style={{fontSize:11,color:"#999",fontWeight:600}}>{label}</div>
    <div style={{fontSize:20,fontWeight:800,color:clr,letterSpacing:-.5,marginTop:4}}>{val}</div>
    <div style={{fontSize:10,color:"#bbb",marginTop:2}}>{sub}</div>
  </div>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOMERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function CustomersPage({ data, setData, userBranches, isMaster }) {
  const [q, setQ] = useState("");
  const [vb, setVb] = useState("all");
  const [showModal, setShowModal] = useState(false);
  const [editItem, setEditItem] = useState(null);
  const [detailCust, setDetailCust] = useState(null);

  const custs = data.customers.filter(c => {
    const bm = (vb==="all"?userBranches.includes(c.bid):c.bid===vb);
    const sm = !q||c.name.includes(q)||c.phone.includes(q);
    return bm&&sm;
  }).sort((a,b)=>b.visits-a.visits);

  const handleSave = (item) => {
    setData(prev=>{
      const ex=prev.customers.find(c=>c.id===item.id);
      if(ex) { sb.update("customers",item.id,toDb("customers",item)).catch(console.error); return {...prev,customers:prev.customers.map(c=>c.id===item.id?item:c)}; }
      sb.insert("customers",toDb("customers",item)).catch(console.error);
      return {...prev,customers:[...prev.customers,item]};
    }); setShowModal(false); setEditItem(null);
  };

  // ì„ íƒëœ ê³ ê°ì˜ ë§¤ì¶œ ë‚´ì—­
  const custSales = detailCust ? (data.sales||[]).filter(s=>s.custId===detailCust.id).sort((a,b)=>b.date.localeCompare(a.date)) : [];

  return <div>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16,flexWrap:"wrap",gap:10}}>
      <h2 className="page-title" style={{marginBottom:0}}>ê³ ê° ê´€ë¦¬</h2>
      <button className="btn-p" onClick={()=>{setEditItem(null);setShowModal(true)}}>ï¼‹ ê³ ê° ë“±ë¡</button>
    </div>
    <div style={{display:"flex",gap:10,marginBottom:16,flexWrap:"wrap",alignItems:"center"}}>
      <div style={{position:"relative",flex:1,minWidth:180}}>
        <span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",color:"#999",fontSize:14}}>ğŸ”</span>
        <input className="inp" style={{paddingLeft:32}} placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ ê²€ìƒ‰..." value={q} onChange={e=>setQ(e.target.value)}/>
      </div>
      {<select className="inp" style={{width:130}} value={vb} onChange={e=>setVb(e.target.value)}>
        <option value="all">ì „ì²´ ë§¤ì¥</option>{(data.branches||[]).filter(b=>userBranches.includes(b.id)).map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
      </select>}
      <span style={{fontSize:12,color:"#888"}}>{custs.length}ëª…</span>
    </div>
    <div className="card tw">
      <table><thead><tr>
        <th>ë§¤ì¥</th><th>ê³ ê°ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ì„±ë³„</th><th>ë°©ë¬¸ìˆ˜</th><th>ìµœì´ˆë“±ë¡ì¼</th><th>ìµœê·¼ë°©ë¬¸</th><th>ë©”ëª¨</th><th>ê´€ë¦¬</th>
      </tr></thead><tbody>
        {custs.length===0?<tr><td colSpan={10} style={{textAlign:"center",color:"#999",padding:40}}>ê³ ê° ì—†ìŒ</td></tr>:
          custs.map(c=>{
            const br=(data.branches||[]).find(b=>b.id===c.bid);
            const isDetail = detailCust?.id===c.id;
            return <React.Fragment key={c.id}>
              <tr style={{cursor:"pointer",background:isDetail?"#f0f0ff":"transparent"}} onClick={()=>setDetailCust(isDetail?null:c)}>
                <td>{br?.short}</td>
                <td style={{color:"#888"}}>{c.custNum}</td>
                <td style={{fontWeight:600}}>{c.name}</td>
                <td style={{color:"#7c7cc8",fontSize:12}}>{c.phone}</td>
                <td><span style={{color:c.gender==="M"?"#4a7cc8":"#e57373"}}>{c.gender==="F"?"ì—¬":"ë‚¨"}</span></td>
                <td><span style={{fontWeight:700,color:c.visits>=5?"#5cb5c5":"#999"}}>{c.visits}íšŒ</span></td>
                <td style={{color:"#888",fontSize:11}}>{c.createdAt ? new Date(c.createdAt).toLocaleDateString("ko-KR") : "-"}</td>
                <td style={{color:"#888",fontSize:11}}>{c.lastVisit||"-"}</td>
                <td style={{color:"#888",fontSize:12,whiteSpace:"pre-wrap",wordBreak:"break-word",maxWidth:200}}>{c.memo||"-"}</td>
                <td onClick={e=>e.stopPropagation()}>
                  <button className="btn-sm btn-s" onClick={()=>{setEditItem(c);setShowModal(true)}}>âœï¸</button>
                </td>
              </tr>
              {isDetail && <tr><td colSpan={10} style={{padding:0,background:"#f8f8ff"}}>
                <div style={{padding:"12px 16px"}}>
                  <div style={{fontSize:12,fontWeight:700,color:"#7c7cc8",marginBottom:8}}>ğŸ“‹ ë§¤ì¶œ ë‚´ì—­ ({custSales.length}ê±´)</div>
                  {custSales.length===0 ? <div style={{fontSize:11,color:"#999",padding:8}}>ë§¤ì¶œ ê¸°ë¡ ì—†ìŒ</div> :
                    <table style={{width:"100%",fontSize:11}}><thead><tr style={{background:"#e8e8f8"}}>
                      <th>ë‚ ì§œ</th><th>ë§¤ì¥</th><th>ë‹´ë‹¹ì</th><th>ì‹œìˆ í•©ê³„</th><th>ì œí’ˆí•©ê³„</th><th>ì´í•©ê³„</th><th>ë©”ëª¨</th>
                    </tr></thead><tbody>
                      {custSales.map(s=>{
                        const st=s.svcCash+s.svcTransfer+s.svcCard+s.svcPoint;
                        const pt=s.prodCash+s.prodTransfer+s.prodCard+s.prodPoint;
                        return <tr key={s.id}>
                          <td>{s.date}</td>
                          <td>{(data.branches||[]).find(b=>b.id===s.bid)?.short}</td>
                          <td>{s.staffName}</td>
                          <td style={{color:"#7c7cc8",fontWeight:600}}>{fmt(st)}</td>
                          <td style={{color:"#6bab9e",fontWeight:600}}>{fmt(pt)}</td>
                          <td style={{color:"#5cb5c5",fontWeight:700}}>{fmt(st+pt+(s.gift||0))}</td>
                          <td style={{color:"#888",maxWidth:120,overflow:"hidden",textOverflow:"ellipsis"}}>{s.memo||"-"}</td>
                        </tr>;
                      })}
                    </tbody></table>}
                </div>
              </td></tr>}
            </React.Fragment>;
          })}
      </tbody></table>
    </div>
    {showModal && <CustModal item={editItem} onSave={handleSave} onClose={()=>{setShowModal(false);setEditItem(null)}} defBranch={userBranches[0]} userBranches={userBranches}/>}
  </div>;
}

function CustModal({ item, onSave, onClose, defBranch, userBranches }) {
  const [f, setF] = useState(item || { id:uid(), bid:defBranch, name:"", phone:"", gender:"F", visits:0, lastVisit:null, memo:"", custNum:String(50000+Math.floor(Math.random()*10000)) });
  const set = (k,v) => setF(p=>({...p,[k]:v}));
  return <div className="ov" onClick={onClose}>
    <div className="modal" onClick={e=>e.stopPropagation()}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
        <h3 style={{fontSize:16,fontWeight:700}}>{item?"ê³ ê° ìˆ˜ì •":"ìƒˆ ê³ ê°"}</h3>
        <button onClick={onClose} className="close-btn">âœ•</button>
      </div>
      <div className="form-col">
        <FLD label="ë§¤ì¥"><select className="inp" value={f.bid} onChange={e=>set("bid",e.target.value)}>{(data.branches||[]).filter(b=>userBranches.includes(b.id)).map(b=><option key={b.id} value={b.id}>{b.name}</option>)}</select></FLD>
        <div className="grid2">
          <FLD label="ì´ë¦„"><input className="inp" value={f.name} onChange={e=>set("name",e.target.value)}/></FLD>
          <FLD label="ì—°ë½ì²˜"><input className="inp" value={f.phone} onChange={e=>set("phone",e.target.value)} placeholder="010-0000-0000"/></FLD>
        </div>
        <FLD label="ì„±ë³„"><select className="inp" value={f.gender} onChange={e=>set("gender",e.target.value)}><option value="F">ì—¬ì„±</option><option value="M">ë‚¨ì„±</option></select></FLD>
        <FLD label="ë©”ëª¨"><textarea className="inp" rows={2} value={f.memo} onChange={e=>set("memo",e.target.value)}/></FLD>
        <button className="btn-p" style={{width:"100%",justifyContent:"center",padding:12}} onClick={()=>onSave(f)}>{item?"ìˆ˜ì •":"ë“±ë¡"}</button>
      </div>
    </div>
  </div>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USERS MANAGEMENT (ë§ˆìŠ¤í„° ì „ìš©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function UsersPage({ data, setData, bizId }) {
  const [editId, setEditId] = useState(null);
  const [form, setForm] = useState(null);
  const users = data.users || [];
  const regBranches = (data.branchSettings || data.branches || []).filter(b => b.useYn !== false);

  const startAdd = () => { setEditId("new"); setForm({ name:"", loginId:"", pw:"", role:"staff", branches:[], viewBranches:[] }); };
  const startEdit = (u) => { setEditId(u.id); setForm({ ...u, viewBranches: u.viewBranches||[] }); };
  const save = (finalForm) => {
    const f = finalForm || form;
    if (!f.name || !f.loginId || !f.pw) { alert("ì´ë¦„, ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”."); return; }
    if (f.role === "staff" && (!f.branches || f.branches.length === 0)) { alert("ì§ì›ì€ ë‹´ë‹¹ ì§€ì ì„ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”."); return; }
    const userData = { ...f, viewBranches: f.viewBranches||[], businessId: bizId };
    setData(prev => {
      const us = [...(prev.users || [])];
      if (editId === "new") {
        const newUser = { ...userData, id: "acc_" + uid() };
        us.push(newUser);
        sb.insert("app_users", toDb("app_users", newUser)).catch(console.error);
      } else {
        const idx = us.findIndex(u => u.id === editId);
        if (idx >= 0) { us[idx] = { ...userData }; sb.update("app_users", editId, toDb("app_users", userData)).catch(console.error); }
      }
      return { ...prev, users: us };
    });
    setEditId(null); setForm(null);
  };
  const remove = (id) => {
    setData(prev => ({ ...prev, users: (prev.users || []).filter(u => u.id !== id) }));
    sb.del("app_users", id).catch(console.error);
  };

  return <div>
    <h2 className="page-title">ì‚¬ìš©ì ê´€ë¦¬</h2>
    <div style={{display:"flex",gap:8,marginBottom:12}}>
      <button className="btn-p" onClick={startAdd}>ï¼‹ ì‚¬ìš©ì ì¶”ê°€</button>
      <span style={{fontSize:12,color:"#888",display:"flex",alignItems:"center"}}>{users.length}ê°œ ê³„ì •</span>
    </div>
    <div className="card tw">
      <table><thead><tr>
        <th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ë¹„ë°€ë²ˆí˜¸</th><th>ìœ í˜•</th><th>ë‹´ë‹¹ ì§€ì </th><th>ì—´ëŒ ì§€ì </th><th>ê´€ë¦¬</th>
      </tr></thead><tbody>
        {users.map(u => {
          if (editId === u.id && form) return <UserEditRow key={u.id} init={form} regBranches={regBranches} allBranches={data.branches||[]} onSave={save} onCancel={()=>{setEditId(null);setForm(null)}} isNew={false}/>;
          const roleLabel = u.role==="owner" ? "ëŒ€í‘œ" : "ì§ì›";
          const roleBg = u.role==="owner" ? "#7c7cc815" : "#f5f5f5";
          const roleClr = u.role==="owner" ? "#7c7cc8" : "#888";
          return <tr key={u.id}>
            <td style={{fontWeight:600}}>{u.name}</td>
            <td style={{color:"#7c7cc8"}}>{u.loginId||u.login_id}</td>
            <td style={{color:"#aaa"}}>{"â€¢".repeat((u.pw||u.password||"").length)}</td>
            <td><span style={{fontSize:10,padding:"2px 8px",borderRadius:10,background:roleBg,color:roleClr,fontWeight:600}}>{roleLabel}</span></td>
            <td style={{fontSize:11,color:"#555"}}>{u.role==="owner"?"ì „ì²´ ì§€ì ":(u.branches||[]).map(bid=>(data.branches||[]).find(b=>b.id===bid)?.short).filter(Boolean).join(", ")}</td>
            <td style={{fontSize:11,color:"#5cb5c5"}}>{u.role==="owner"?"-":(u.viewBranches||[]).map(bid=>(data.branches||[]).find(b=>b.id===bid)?.short).filter(Boolean).join(", ")||"-"}</td>
            <td style={{display:"flex",gap:4}}>
              <button className="btn-s" style={{padding:"4px 10px",fontSize:11}} onClick={()=>startEdit(u)}>ìˆ˜ì •</button>
              <button className="btn-d" style={{padding:"4px 10px",fontSize:11}} onClick={()=>remove(u.id)}>ì‚­ì œ</button>
            </td>
          </tr>;
        })}
        {editId === "new" && form && <UserEditRow key="new" init={form} regBranches={regBranches} allBranches={data.branches||[]} onSave={save} onCancel={()=>{setEditId(null);setForm(null)}} isNew={true}/>}
      </tbody></table>
    </div>
    <div style={{marginTop:16,padding:12,background:"#f9f9f9",borderRadius:6,fontSize:11,color:"#888",lineHeight:1.8}}>
      <b>ê¶Œí•œ ì•ˆë‚´</b><br/>
      Â· ëŒ€í‘œ: ì „ ì§€ì  ì˜ˆì•½/ë§¤ì¶œ ì¡°íšŒÂ·í¸ì§‘, ì‚¬ìš©ìÂ·ê´€ë¦¬ì„¤ì • ì ‘ê·¼<br/>
      Â· ì§ì›: ë‹´ë‹¹ ì§€ì  ì˜ˆì•½/ë§¤ì¶œ ì¡°íšŒÂ·í¸ì§‘, ì—´ëŒ ì§€ì  íƒ€ì„ë¼ì¸ ì½ê¸° ì „ìš©
    </div>
  </div>;
}

// Separate top-level component â€” won't re-create on parent re-render
function UserEditRow({ init, regBranches, allBranches, onSave, onCancel, isNew }) {
  const [f, setF] = useState({...init});
  const set = (k, v) => setF(p => ({...p, [k]: v}));

  const MultiSelect = ({selected, onChange, color="#7c7cc8"}) => {
    const [open, setOpen] = useState(false);
    const toggle = (bid) => { onChange(selected.includes(bid) ? selected.filter(x=>x!==bid) : [...selected, bid]); };
    const label = selected.length === 0 ? "ì„ íƒ" : regBranches.filter(b=>selected.includes(b.id)).map(b=>b.short||b.name).join(", ");
    return <div style={{position:"relative"}}>
      <div onClick={()=>setOpen(!open)} className="inp" style={{width:140,cursor:"pointer",fontSize:11,display:"flex",justifyContent:"space-between",alignItems:"center",minHeight:30}}>
        <span style={{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:selected.length?"#333":"#aaa"}}>{label}</span>
        <span style={{fontSize:8,color:"#999"}}>{open?"â–²":"â–¼"}</span>
      </div>
      {open && <div style={{position:"absolute",top:"100%",left:0,right:0,background:"#fff",border:"1px solid #d0d0d0",borderRadius:4,zIndex:50,maxHeight:160,overflowY:"auto",boxShadow:"0 4px 12px rgba(0,0,0,.1)"}}>
        {regBranches.map(b => {
          const on = selected.includes(b.id);
          return <div key={b.id} onClick={()=>toggle(b.id)} style={{padding:"6px 10px",fontSize:11,cursor:"pointer",display:"flex",alignItems:"center",gap:6,background:on?color+"10":"transparent"}}>
            <div style={{width:14,height:14,borderRadius:3,border:`1.5px solid ${on?color:"#ccc"}`,background:on?color:"transparent",display:"flex",alignItems:"center",justifyContent:"center"}}>
              {on && <span style={{color:"#fff",fontSize:9,fontWeight:700}}>âœ“</span>}
            </div>
            <span style={{color:on?color:"#555"}}>{b.short||b.name}</span>
          </div>;
        })}
      </div>}
    </div>;
  };

  return <tr style={{background:"#f5f5ff"}}>
    <td><input className="inp" style={{width:80}} placeholder={isNew?"ì´ë¦„":""} value={f.name} onChange={e=>set("name",e.target.value)}/></td>
    <td><input className="inp" style={{width:80}} placeholder={isNew?"ì•„ì´ë””":""} value={f.loginId} onChange={e=>set("loginId",e.target.value)}/></td>
    <td><input className="inp" style={{width:80}} placeholder={isNew?"ë¹„ë°€ë²ˆí˜¸":""} value={f.pw} onChange={e=>set("pw",e.target.value)}/></td>
    <td><select className="inp" style={{width:80}} value={f.role} onChange={e=>set("role",e.target.value)}>
      <option value="owner">ëŒ€í‘œ</option><option value="staff">ì§ì›</option>
    </select></td>
    <td>{f.role==="owner" ? <span style={{fontSize:11,color:"#7c7cc8"}}>ì „ì²´ ì§€ì </span> :
      <MultiSelect selected={f.branches||[]} onChange={v=>set("branches",v)} color="#7c7cc8"/>}</td>
    <td>{f.role==="owner" ? <span style={{fontSize:11,color:"#999"}}>-</span> :
      <MultiSelect selected={f.viewBranches||[]} onChange={v=>set("viewBranches",v)} color="#5cb5c5"/>}</td>
    <td style={{display:"flex",gap:4}}>
      <button className="btn-p" style={{padding:"4px 10px",fontSize:11}} onClick={()=>onSave(f.role==="owner"?{...f,branches:allBranches.map(b=>b.id)}:f)}>{isNew?"ì¶”ê°€":"ì €ì¥"}</button>
      <button className="btn-s" style={{padding:"4px 10px",fontSize:11}} onClick={onCancel}>ì·¨ì†Œ</button>
    </td>
  </tr>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AdminPage({ data, setData, bizId }) {
  const [tab, setTab] = useState("places");
  return <div>
    <h2 className="page-title">ê´€ë¦¬ ì„¤ì •</h2>
    <div style={{display:"flex",gap:2,marginBottom:16,background:"#e0e0e0",borderRadius:8,padding:3,width:"fit-content",flexWrap:"wrap"}}>
      {[["places","ì˜ˆì•½ì¥ì†Œê´€ë¦¬"],["workers","ë‹´ë‹¹ìê´€ë¦¬"],["saleitems","ì‹œìˆ ìƒí’ˆê´€ë¦¬"],["prodmgmt","ì œí’ˆê´€ë¦¬"],["svctags","ì„œë¹„ìŠ¤íƒœê·¸ê´€ë¦¬"]].map(([k,v])=>(
        <button key={k} className={tab===k?"btn-p btn-sm":"btn-s btn-sm"} onClick={()=>setTab(k)}>{v}</button>
      ))}
    </div>
    {tab==="places" && <AdminPlaces data={data} setData={setData} bizId={bizId}/>}
    {tab==="workers" && <AdminWorkers data={data} setData={setData}/>}
    {tab==="saleitems" && <AdminSaleItems data={data} setData={setData}/>}
    {tab==="prodmgmt" && <AdminProductItems data={data} setData={setData}/>}
    {tab==="svctags" && <AdminServiceTags data={data} setData={setData}/>}
  </div>;
}

// â”€â”€â”€ ì˜ˆì•½ì¥ì†Œê´€ë¦¬ (myCream style) â”€â”€â”€
function AdminPlaces({ data, setData, bizId }) {
  const branches = data.branchSettings || (data.branches||[]).map(b => ({...b, color: "#FFFFFF", useYn: true}));
  const [edited, setEdited] = useState({});
  const [deleteId, setDeleteId] = useState(null);
  const [dragIdx, setDragIdx] = useState(null);
  const [dragOverIdx, setDragOverIdx] = useState(null);
  const fileRef = useRef(null);

  const updateField = (id, field, value) => {
    setData(prev => {
      const updated = (prev.branchSettings || (data.branches||[]).map(b=>({...b,color:"#FFFFFF",useYn:true}))).map(b => b.id===id ? {...b, [field]:value} : b);
      return {...prev, branchSettings: updated, branches: updated};
    });
    setEdited(prev => ({...prev, [id]: true}));
  };
  const applyRow = (id) => {
    const b = branches.find(x=>x.id===id);
    if(b) sb.update("branches", id, {name:b.name, short:b.short||b.name, phone:b.phone||"", address:b.address||"", color:b.color||"#FFFFFF", use_yn:b.useYn!==false}).catch(console.error);
    setEdited(prev => { const n={...prev}; delete n[id]; return n; });
  };
  const addBranch = () => {
    const bName = prompt("ì§€ì ëª…ì„ ì…ë ¥í•˜ì„¸ìš”", "");
    if(!bName || !bName.trim()) return;
    const newId = "br_" + uid();
    const newBranch = {id:newId, name:bName.trim(), short:bName.trim(), phone:"", address:"", color:"#FFFFFF", useYn:true, business_id:bizId};
    setData(prev => ({...prev, branchSettings:[...(prev.branchSettings||[]), newBranch], branches:[...(prev.branches||[]), newBranch]}));
    sb.insert("branches", {id:newId, business_id:bizId||_activeBizId, name:bName.trim(), short:bName.trim(), phone:"", address:"", color:"#FFFFFF", sort:branches.length, use_yn:true}).catch(console.error);
    setEdited(prev => ({...prev, [newId]: true}));
  };
  const deleteBranch = (id) => {
    setData(prev => ({...prev, branchSettings:(prev.branchSettings||[]).filter(x=>x.id!==id), branches:(prev.branches||[]).filter(x=>x.id!==id)}));
    sb.del("branches", id).catch(console.error);
    setDeleteId(null);
  };

  // Excel download
  const downloadExcel = () => {
    const rows = branches.map((b,i) => ({ìˆœë²ˆ:i+1, ì§€ì ëª…:b.name, ì•½ì¹­:b.short||"", ì „í™”:b.phone||"", ì£¼ì†Œ:b.address||"", ìƒ‰ìƒ:b.color||"", ì‚¬ìš©:b.useYn!==false?"Y":"N"}));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ì§€ì ");
    XLSX.writeFile(wb, "ì§€ì ëª©ë¡.xlsx");
  };
  // Excel upload
  const uploadExcel = (e) => {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const wb = XLSX.read(ev.target.result, {type:"array"});
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      const newBranches = rows.map((r,i) => ({
        id:"br_"+uid(), name:r["ì§€ì ëª…"]||r["name"]||"", short:r["ì•½ì¹­"]||r["short"]||"", phone:r["ì „í™”"]||r["phone"]||"",
        address:r["ì£¼ì†Œ"]||r["address"]||"", color:r["ìƒ‰ìƒ"]||r["color"]||"#FFFFFF", useYn:(r["ì‚¬ìš©"]||"Y")!=="N", business_id:bizId
      }));
      if(newBranches.length && confirm(`${newBranches.length}ê°œ ì§€ì ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        newBranches.forEach(b => sb.insert("branches", {id:b.id, business_id:bizId||_activeBizId, name:b.name, short:b.short, phone:b.phone, address:b.address, color:b.color, sort:0, use_yn:b.useYn}).catch(console.error));
        setData(prev => ({...prev, branchSettings:[...(prev.branchSettings||[]),...newBranches], branches:[...(prev.branches||[]),...newBranches]}));
      }
    };
    reader.readAsArrayBuffer(file); e.target.value="";
  };

  // Drag reorder
  const handleDragEnd = () => {
    if (dragIdx !== null && dragOverIdx !== null && dragIdx !== dragOverIdx) {
      const reordered = [...branches];
      const [moved] = reordered.splice(dragIdx, 1);
      reordered.splice(dragOverIdx, 0, moved);
      setData(prev => ({...prev, branchSettings: reordered}));
    }
    setDragIdx(null); setDragOverIdx(null);
  };

  // Touch drag
  const touchStartRef = useRef(null);
  const touchRowRef = useRef(null);
  const handleTouchStart = (i, e) => { touchStartRef.current = e.touches[0].clientY; touchRowRef.current = i; setDragIdx(i); };
  const handleTouchMove = (e) => {
    if (touchStartRef.current === null) return;
    const dy = e.touches[0].clientY - touchStartRef.current;
    const newIdx = Math.max(0, Math.min(branches.length - 1, touchRowRef.current + Math.round(dy / 52)));
    setDragOverIdx(newIdx);
  };
  const handleTouchEnd = () => { handleDragEnd(); touchStartRef.current = null; touchRowRef.current = null; };

  return <div>
    <div className="card" style={{padding:20}}>
      <AdminHeader title="ì˜ˆì•½ì¥ì†Œ ê´€ë¦¬" count={branches.length} onAdd={addBranch} addLabel="ï¼‹ ì§€ì  ì¶”ê°€" onDownload={downloadExcel} onUpload={uploadExcel}/>
      <div className="tw">
        <table><thead><tr>
          <th style={{width:30}}></th>
          <th style={{width:40}}>ë²ˆí˜¸</th>
          <th style={{width:100}}>ì§€ì ëª…</th>
          <th>ì£¼ì†Œ</th>
          <th style={{width:140}}>ì „í™”ë²ˆí˜¸</th>
          <th style={{width:80}}>ì‚¬ìš©êµ¬ë¶„</th>
          <th style={{width:140}}>í‘œì‹œìƒ‰ìƒ</th>
          <th style={{width:55}}>ì ìš©</th>
          <th style={{width:50}}>ì‚­ì œ</th>
        </tr></thead>
        <tbody onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
          {branches.map((b,i) => (
            <tr key={b.id}
              draggable onDragStart={()=>setDragIdx(i)} onDragOver={e=>{e.preventDefault();setDragOverIdx(i)}} onDragEnd={handleDragEnd}
              onTouchStart={e=>handleTouchStart(i,e)}
              style={{
                background: dragOverIdx===i ? "#7c7cc815" : edited[b.id] ? "rgba(167,139,250,.05)" : "transparent",
                opacity: dragIdx===i ? 0.4 : 1, cursor:"grab", touchAction:"none"
              }}>
              <td style={{textAlign:"center",fontSize:14,color:"#999"}}>â˜°</td>
              <td style={{color:"#888",textAlign:"center"}}>{i+1}</td>
              <td><input className="inp" value={b.name} onChange={e=>updateField(b.id,"name",e.target.value)} style={{background:"transparent",border:"1px solid #d0d0d0",fontWeight:600}}/></td>
              <td><input className="inp" value={b.address||""} onChange={e=>updateField(b.id,"address",e.target.value)} style={{background:"transparent",border:"1px solid #d0d0d0",width:"100%"}} placeholder="ê³ ê° ì•ˆë‚´ìš© ì£¼ì†Œë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”"/></td>
              <td><input className="inp" value={b.phone||""} onChange={e=>updateField(b.id,"phone",e.target.value)} style={{background:"transparent",border:"1px solid #d0d0d0",fontSize:11}}/></td>
              <td>
                <select className="inp" value={b.useYn!==false?"ì‚¬ìš©":"ë¯¸ì‚¬ìš©"} onChange={e=>updateField(b.id,"useYn",e.target.value==="ì‚¬ìš©")} style={{background:"transparent",border:"1px solid #d0d0d0",fontSize:11}}>
                  <option>ì‚¬ìš©</option><option>ë¯¸ì‚¬ìš©</option>
                </select>
              </td>
              <td>
                <div style={{display:"flex",alignItems:"center",gap:4}}>
                  <input type="color" value={b.color||"#FFFFFF"} onChange={e=>updateField(b.id,"color",e.target.value)} style={{width:24,height:24,border:"none",background:"none",cursor:"pointer",padding:0}}/>
                  <input className="inp" value={b.color||""} onChange={e=>updateField(b.id,"color",e.target.value)}
                    style={{width:72,background:b.color||"transparent",border:"1px solid #d0d0d0",fontSize:10,fontFamily:"monospace",color:"#333"}}/>
                </div>
              </td>
              <td>
                <button className={edited[b.id]?"btn-p btn-sm":"btn-s btn-sm"} onClick={()=>applyRow(b.id)} style={{padding:"4px 10px"}}>ì ìš©</button>
              </td>
              <td>
                {deleteId===b.id ? (
                  <div style={{display:"flex",gap:3,alignItems:"center"}}>
                    <button onClick={()=>deleteBranch(b.id)}
                      style={{padding:"2px 8px",fontSize:10,fontWeight:700,borderRadius:4,border:"none",background:"#e57373",color:"#fff",cursor:"pointer",fontFamily:"inherit"}}>í™•ì¸</button>
                    <button onClick={()=>setDeleteId(null)}
                      style={{padding:"2px 6px",fontSize:10,borderRadius:4,border:"1px solid #d0d0d0",background:"#fff",color:"#888",cursor:"pointer",fontFamily:"inherit"}}>ì·¨ì†Œ</button>
                  </div>
                ) : (
                  <button onClick={()=>setDeleteId(b.id)}
                    style={{background:"none",border:"none",cursor:"pointer",fontSize:13,color:"#e57373"}}>ğŸ—‘ï¸</button>
                )}
              </td>
            </tr>
          ))}
        </tbody></table>
      </div>
    </div>
  </div>;
}


// â”€â”€â”€ Unified Admin Header â”€â”€â”€
function AdminHeader({title, count, color="#7c7cc8", desc="", onAdd, addLabel="ï¼‹ ì¶”ê°€", onDownload, onUpload}) {
  const fileRef = useRef(null);
  return <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14,flexWrap:"wrap",gap:8}}>
    <div>
      <h3 style={{fontSize:14,fontWeight:700,color}}>{title}</h3>
      <p style={{fontSize:11,color:"#999",marginTop:2}}>{desc || `ì´ ${count}ê°œ`}</p>
    </div>
    <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
      {onDownload && <button className="btn-s btn-sm" onClick={onDownload}>ğŸ“¥ ë‚´ë ¤ë°›ê¸°</button>}
      {onUpload && <>
        <button className="btn-s btn-sm" onClick={()=>fileRef.current?.click()}>ğŸ“¤ ì˜¬ë¦¬ê¸°</button>
        <input ref={fileRef} type="file" accept=".xlsx,.xls,.csv" onChange={e=>{onUpload(e);e.target.value=""}} style={{display:"none"}}/>
      </>}
      {onAdd && <button className="btn-p btn-sm" onClick={onAdd}>{addLabel}</button>}
    </div>
  </div>;
}

// â”€â”€â”€ ë‹´ë‹¹ìê´€ë¦¬ (rooms from DB) â”€â”€â”€
function AdminWorkers({ data, setData }) {
  const rooms = data.rooms || [];
  const regBranches = (data.branchSettings || data.branches || []).filter(b => b.useYn !== false);
  const [showAdd, setShowAdd] = useState(false);
  const [newW, setNewW] = useState({name:"", branchId:""});
  const [editId, setEditId] = useState(null);
  const [editData, setEditData] = useState({});
  const [delId, setDelId] = useState(null);

  const addRoom = () => {
    if(!newW.name.trim()||!newW.branchId) return;
    const nr = {id:"rm_"+uid(), branch_id:newW.branchId, name:newW.name, color:"", sort_order:rooms.length};
    setData(p=>({...p, rooms:[...p.rooms, nr]}));
    sb.insert("rooms", {id:nr.id, business_id:_activeBizId, branch_id:nr.branch_id, name:nr.name, color:"", sort_order:nr.sort_order}).catch(console.error);
    setNewW({name:"",branchId:""}); setShowAdd(false);
  };
  const startEdit = (r) => { setEditId(r.id); setEditData({...r}); };
  const saveEdit = () => {
    setData(p=>({...p, rooms:p.rooms.map(r=>r.id===editId?{...r,...editData}:r)}));
    sb.update("rooms", editId, {name:editData.name, branch_id:editData.branch_id, color:editData.color||""}).catch(console.error);
    setEditId(null);
  };
  const deleteRoom = (id) => {
    setData(p=>({...p, rooms:p.rooms.filter(r=>r.id!==id)}));
    sb.del("rooms", id).catch(console.error); setDelId(null);
  };

  const branchName = (bid) => regBranches.find(b=>b.id===bid)?.name || "-";
  const downloadXl = () => XL.download(rooms.map((r,i)=>({ìˆœë²ˆ:i+1, ë‹´ë‹¹ìëª…:r.name, ì§€ì :branchName(r.branch_id), ìƒ‰ìƒ:r.color||""})), "ë‹´ë‹¹ìëª©ë¡.xlsx", "ë‹´ë‹¹ì");
  const uploadXl = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    const rows = await XL.readFile(file);
    const newRooms = rows.map(r => {
      const br = regBranches.find(b=>b.name===(r["ì§€ì "]||r["branch"]));
      return {id:"rm_"+uid(), branch_id:br?.id||regBranches[0]?.id||"", name:r["ë‹´ë‹¹ìëª…"]||r["name"]||"", color:r["ìƒ‰ìƒ"]||"", sort_order:rooms.length};
    }).filter(r=>r.name);
    if(newRooms.length && window.confirm(newRooms.length+"ëª… ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      newRooms.forEach(r=>sb.insert("rooms",{id:r.id,business_id:_activeBizId,branch_id:r.branch_id,name:r.name,color:r.color,sort_order:r.sort_order}).catch(console.error));
      setData(p=>({...p,rooms:[...p.rooms,...newRooms]}));
    }
  };

  return <div>
    <AdminHeader title="ë‹´ë‹¹ì ê´€ë¦¬" count={rooms.length} onAdd={()=>setShowAdd(!showAdd)} addLabel={showAdd?"ì·¨ì†Œ":"ï¼‹ ë‹´ë‹¹ì ì¶”ê°€"} onDownload={downloadXl} onUpload={uploadXl}/>
    {showAdd && <div className="card" style={{padding:14,marginBottom:14}}>
      <div style={{display:"flex",gap:8,alignItems:"flex-end",flexWrap:"wrap"}}>
        <FLD label="ë‹´ë‹¹ìëª…"><input className="inp" style={{width:140}} value={newW.name} onChange={e=>setNewW(p=>({...p,name:e.target.value}))} placeholder="ë‹´ë‹¹ìëª…"/></FLD>
        <FLD label="ì§€ì "><select className="inp" style={{width:140}} value={newW.branchId} onChange={e=>setNewW(p=>({...p,branchId:e.target.value}))}>
          <option value="">ì„ íƒ</option>{regBranches.map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
        </select></FLD>
        <button className="btn-p btn-sm" onClick={addRoom}>ë“±ë¡</button>
      </div>
    </div>}
    <div className="card tw" style={{maxHeight:"calc(100vh - 300px)",overflow:"auto"}}>
      <table><thead><tr>
        <th style={{width:35}}>No</th><th>ë‹´ë‹¹ìëª…</th><th>ì§€ì </th><th style={{width:80}}>ìƒ‰ìƒ</th><th style={{width:100}}>ê´€ë¦¬</th>
      </tr></thead><tbody>
        {rooms.map((r,i) => {
          if(editId===r.id) return <tr key={r.id} style={{background:"#f5f5ff"}}>
            <td style={{color:"#999"}}>{i+1}</td>
            <td><input className="inp" value={editData.name} onChange={e=>setEditData(p=>({...p,name:e.target.value}))} style={{width:"100%"}}/></td>
            <td><select className="inp" value={editData.branch_id} onChange={e=>setEditData(p=>({...p,branch_id:e.target.value}))}>
              {regBranches.map(b=><option key={b.id} value={b.id}>{b.name}</option>)}
            </select></td>
            <td><input type="color" value={editData.color||"#FFFFFF"} onChange={e=>setEditData(p=>({...p,color:e.target.value}))} style={{width:28,height:24,border:"none",cursor:"pointer"}}/></td>
            <td><div style={{display:"flex",gap:3}}><button className="btn-p btn-sm" onClick={saveEdit}>ì €ì¥</button><button className="btn-s btn-sm" onClick={()=>setEditId(null)}>ì·¨ì†Œ</button></div></td>
          </tr>;
          return <tr key={r.id}>
            <td style={{color:"#999"}}>{i+1}</td>
            <td style={{fontWeight:600}}>{r.name}</td>
            <td>{branchName(r.branch_id)}</td>
            <td>{r.color ? <div style={{width:24,height:16,borderRadius:3,background:r.color,border:"1px solid #d0d0d080"}}/> : <span style={{color:"#ccc"}}>-</span>}</td>
            <td><div style={{display:"flex",gap:4}}>
              <button onClick={()=>startEdit(r)} style={{background:"none",border:"none",cursor:"pointer",color:"#7c7cc8",fontSize:13}}>âœï¸</button>
              {delId===r.id
                ? <><button className="btn-d btn-sm" onClick={()=>deleteRoom(r.id)} style={{padding:"1px 6px",fontSize:9}}>í™•ì¸</button><button className="btn-s btn-sm" onClick={()=>setDelId(null)} style={{padding:"1px 5px",fontSize:9}}>ì·¨ì†Œ</button></>
                : <button onClick={()=>setDelId(r.id)} style={{background:"none",border:"none",cursor:"pointer",color:"#e57373",fontSize:13}}>ğŸ—‘ï¸</button>}
            </div></td>
          </tr>;
        })}
      </tbody></table>
    </div>
  </div>;
}

// â”€â”€â”€ Drag Sort Helper â”€â”€â”€
function useDragSort(items, setItems, sortKey="sort") {
  const dragItem = useRef(null);
  const dragOver = useRef(null);
  const onDragStart = (idx) => { dragItem.current = idx; };
  const onDragEnter = (idx) => { dragOver.current = idx; };
  const onDragEnd = () => {
    if (dragItem.current === null || dragOver.current === null) return;
    const copy = [...items];
    const dragged = copy.splice(dragItem.current, 1)[0];
    copy.splice(dragOver.current, 0, dragged);
    setItems(copy.map((it, i) => ({ ...it, [sortKey]: i })));
    dragItem.current = null;
    dragOver.current = null;
  };
  return { onDragStart, onDragEnter, onDragEnd };
}

const DragHandle = () => <span style={{cursor:"grab",color:"#999",fontSize:14,flexShrink:0,userSelect:"none"}}>â ¿</span>;

// â”€â”€â”€ ì‹œìˆ ìƒí’ˆê´€ë¦¬ â”€â”€â”€
function AdminSaleItems({ data, setData }) {
  const [services, setServices] = useState([...(data?.services||INIT_SERVICES)].sort((a,b)=>a.sort-b.sort));
  const cats = data?.categories || SERVICE_CATS;
  const [editId, setEditId] = useState(null);
  const [editData, setEditData] = useState({});
  const [showAdd, setShowAdd] = useState(false);
  const [newSvc, setNewSvc] = useState({ cat:cats[0]?.id||"sc1", name:"", dur:20, priceF:0, priceM:0, note:"" });
  const [filterCat, setFilterCat] = useState("all");
  const [delConfirm, setDelConfirm] = useState(null);
  const drag = useDragSort(services, setServices);

  const startEdit = (svc) => { setEditId(svc.id); setEditData({...svc}); };
  const saveEdit = () => { 
    setServices(p=>p.map(s=>s.id===editId?{...editData}:s)); 
    sb.update("services", editId, {cat:editData.cat, name:editData.name, dur:editData.dur, price_f:editData.priceF, price_m:editData.priceM, note:editData.note||"", sort:editData.sort||0}).catch(console.error);
    setEditId(null); 
  };
  const deleteSvc = (id) => { 
    setServices(p=>p.filter(s=>s.id!==id).map((s,i)=>({...s,sort:i}))); 
    sb.del("services", id).catch(console.error);
    setDelConfirm(null); 
  };
  const addSvc = () => {
    if(!newSvc.name.trim()) return;
    const svc = {...newSvc, id:uid(), priceF:Number(newSvc.priceF)||0, priceM:Number(newSvc.priceM)||0, dur:Number(newSvc.dur)||20, sort:services.length};
    setServices(p=>[...p, svc]);
    sb.insert("services", {id:svc.id, business_id:_activeBizId, cat:svc.cat, name:svc.name, dur:svc.dur, price_f:svc.priceF, price_m:svc.priceM, note:svc.note||"", sort:svc.sort}).catch(console.error);
    setNewSvc({ cat:cats[0]?.id||"sc1", name:"", dur:20, priceF:0, priceM:0, note:"" }); setShowAdd(false);
  };
  const filtered = filterCat === "all" ? services : services.filter(s => s.cat === filterCat);
  const inp = (val, onChange, w, type) => <input className="inp" type={type||"text"} value={val}
    onChange={e => onChange(type==="number" ? Number(e.target.value)||0 : e.target.value)}
    style={{width:w||"100%",padding:"4px 6px",fontSize:11,background:"#f8f0f0",border:"1px solid #d0d0d0",textAlign:type==="number"?"right":"left"}} />;

  const downloadXl = () => XL.download(services.map(s=>({ì¹´í…Œê³ ë¦¬:cats.find(c=>c.id===s.cat)?.name||"",ì‹œìˆ ëª…:s.name,ì—¬ì„±ê°€:s.priceF,ë‚¨ì„±ê°€:s.priceM,ì†Œìš”ë¶„:s.dur,ë¹„ê³ :s.note||""})),"ì‹œìˆ ëª©ë¡.xlsx","ì‹œìˆ ");
  const uploadXl = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    const rows = await XL.readFile(file);
    const newSvcs = rows.map(r=>{
      const cat = cats.find(c=>c.name===(r["ì¹´í…Œê³ ë¦¬"]||r["category"]));
      return {id:uid(), cat:cat?.id||cats[0]?.id||"sc1", name:r["ì‹œìˆ ëª…"]||r["name"]||"", priceF:Number(r["ì—¬ì„±ê°€"]||r["priceF"])||0, priceM:Number(r["ë‚¨ì„±ê°€"]||r["priceM"])||0, dur:Number(r["ì†Œìš”ë¶„"]||r["dur"])||20, note:r["ë¹„ê³ "]||"", sort:services.length};
    }).filter(r=>r.name);
    if(newSvcs.length && window.confirm(newSvcs.length+"ê°œ ì‹œìˆ ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      setServices(p=>[...p,...newSvcs]);
      newSvcs.forEach(s=>sb.insert("services",{id:s.id, business_id:_activeBizId, cat:s.cat, name:s.name, dur:s.dur, price_f:s.priceF, price_m:s.priceM, note:s.note||"", sort:s.sort}).catch(console.error));
    }
  };

  return <div>
    <AdminHeader title="ì‹œìˆ  ìƒí’ˆ ê´€ë¦¬" count={services.length} onAdd={()=>setShowAdd(!showAdd)} addLabel={showAdd?"ì·¨ì†Œ":"ï¼‹ ì‹œìˆ  ì¶”ê°€"} onDownload={downloadXl} onUpload={uploadXl}/>
    {showAdd && <div className="card" style={{padding:14,marginBottom:14}}>
      <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"flex-end"}}>
        <FLD label="ì¹´í…Œê³ ë¦¬"><select className="inp" style={{width:120,padding:"4px 6px",fontSize:11}} value={newSvc.cat} onChange={e=>setNewSvc(p=>({...p,cat:e.target.value}))}>{cats.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></FLD>
        <FLD label="ì‹œìˆ ëª…">{inp(newSvc.name, v=>setNewSvc(p=>({...p,name:v})), 150)}</FLD>
        <FLD label="ì—¬ì„±ê°€">{inp(newSvc.priceF, v=>setNewSvc(p=>({...p,priceF:v})), 90, "number")}</FLD>
        <FLD label="ë‚¨ì„±ê°€">{inp(newSvc.priceM, v=>setNewSvc(p=>({...p,priceM:v})), 90, "number")}</FLD>
        <FLD label="ì†Œìš”(ë¶„)">{inp(newSvc.dur, v=>setNewSvc(p=>({...p,dur:v})), 60, "number")}</FLD>
        <FLD label="ë¹„ê³ ">{inp(newSvc.note||"", v=>setNewSvc(p=>({...p,note:v})), 130)}</FLD>
        <button className="btn-p btn-sm" onClick={addSvc} style={{padding:"6px 16px"}}>ë“±ë¡</button>
      </div>
    </div>}
    <div style={{display:"flex",gap:3,marginBottom:10,flexWrap:"wrap"}}>
      <button className={filterCat==="all"?"btn-p btn-sm":"btn-s btn-sm"} onClick={()=>setFilterCat("all")} style={{fontSize:10}}>ì „ì²´ ({services.length})</button>
      {cats.map(c=><button key={c.id} className={filterCat===c.id?"btn-p btn-sm":"btn-s btn-sm"} onClick={()=>setFilterCat(c.id)} style={{fontSize:10}}>{c.name} ({services.filter(s=>s.cat===c.id).length})</button>)}
    </div>
    <div className="tw" style={{maxHeight:"calc(100vh - 340px)",overflow:"auto"}}>
      <table><thead><tr>
        <th style={{width:25}}></th><th style={{width:30}}>No</th><th style={{width:85}}>ì¹´í…Œê³ ë¦¬</th><th>ì‹œìˆ ëª…</th>
        <th style={{width:85,textAlign:"right"}}>ì—¬ì„±ê°€</th><th style={{width:85,textAlign:"right"}}>ë‚¨ì„±ê°€</th>
        <th style={{width:50,textAlign:"center"}}>ì†Œìš”</th><th style={{width:120}}>ë¹„ê³ </th><th style={{width:75,textAlign:"center"}}>ê´€ë¦¬</th>
      </tr></thead><tbody>
        {filtered.map((svc,i)=>{
          const isEdit = editId === svc.id;
          if (isEdit) return <tr key={svc.id} style={{background:"#f5f5ff"}}>
            <td><DragHandle/></td><td style={{color:"#999"}}>{i+1}</td>
            <td><select className="inp" value={editData.cat} onChange={e=>setEditData(p=>({...p,cat:e.target.value}))} style={{width:"100%",padding:"4px 6px",fontSize:11}}>{cats.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></td>
            <td>{inp(editData.name, v=>setEditData(p=>({...p,name:v})))}</td>
            <td>{inp(editData.priceF, v=>setEditData(p=>({...p,priceF:v})), "100%", "number")}</td>
            <td>{inp(editData.priceM, v=>setEditData(p=>({...p,priceM:v})), "100%", "number")}</td>
            <td>{inp(editData.dur, v=>setEditData(p=>({...p,dur:v})), "100%", "number")}</td>
            <td>{inp(editData.note||"", v=>setEditData(p=>({...p,note:v})))}</td>
            <td style={{textAlign:"center"}}><div style={{display:"flex",gap:3,justifyContent:"center"}}>
              <button className="btn-p btn-sm" onClick={saveEdit} style={{padding:"2px 8px",fontSize:10}}>ì €ì¥</button>
              <button className="btn-s btn-sm" onClick={()=>setEditId(null)} style={{padding:"2px 6px",fontSize:10}}>ì·¨ì†Œ</button>
            </div></td>
          </tr>;
          return <tr key={svc.id} draggable onDragStart={()=>drag.onDragStart(i)} onDragEnter={()=>drag.onDragEnter(i)} onDragEnd={drag.onDragEnd} onDragOver={e=>e.preventDefault()}>
            <td><DragHandle/></td>
            <td style={{color:"#999"}}>{i+1}</td>
            <td><span className="badge" style={{background:"#f0f0ff",color:"#7c7cc8"}}>{cats.find(c=>c.id===svc.cat)?.name||"-"}</span></td>
            <td style={{fontWeight:500,fontSize:12}}>{svc.name}</td>
            <td style={{textAlign:"right",color:"#7c7cc8",fontWeight:600,fontSize:12}}>{svc.priceF>0?fmt(svc.priceF)+"ì›":"-"}</td>
            <td style={{textAlign:"right",color:"#4a7cc8",fontWeight:600,fontSize:12}}>{svc.priceM>0?fmt(svc.priceM)+"ì›":"-"}</td>
            <td style={{textAlign:"center",color:"#888",fontSize:11}}>{svc.dur}ë¶„</td>
            <td style={{fontSize:11,color:"#888"}}>{svc.note||""}</td>
            <td style={{textAlign:"center"}}><div style={{display:"flex",gap:4,justifyContent:"center"}}>
              <button onClick={()=>startEdit(svc)} style={{background:"none",border:"none",cursor:"pointer",color:"#7c7cc8",fontSize:13}}>âœï¸</button>
              {delConfirm===svc.id
                ? <><button className="btn-d btn-sm" onClick={()=>deleteSvc(svc.id)} style={{padding:"1px 6px",fontSize:9}}>í™•ì¸</button><button className="btn-s btn-sm" onClick={()=>setDelConfirm(null)} style={{padding:"1px 5px",fontSize:9}}>ì·¨ì†Œ</button></>
                : <button onClick={()=>setDelConfirm(svc.id)} style={{background:"none",border:"none",cursor:"pointer",color:"#e57373",fontSize:13}}>ğŸ—‘ï¸</button>}
            </div></td>
          </tr>;
        })}
      </tbody></table>
    </div>
  </div>;
}

// â”€â”€â”€ ì œí’ˆê´€ë¦¬ â”€â”€â”€
function AdminProductItems({ data, setData }) {
  const [items, setItems] = useState(()=>[...(data?.products||PRODUCTS)].map((p,i)=>({...p,sort:p.sort??i})).sort((a,b)=>a.sort-b.sort));
  const [editId, setEditId] = useState(null);
  const [editData, setEditData] = useState({});
  const [showAdd, setShowAdd] = useState(false);
  const [newItem, setNewItem] = useState({ name:"", price:0 });
  const [delConfirm, setDelConfirm] = useState(null);
  const drag = useDragSort(items, setItems);

  const startEdit = (it) => { setEditId(it.id); setEditData({...it}); };
  const saveEdit = () => { 
    setItems(p=>p.map(x=>x.id===editId?{...editData}:x)); 
    sb.update("products", editId, {name:editData.name, price:editData.price||0}).catch(console.error);
    setEditId(null); 
  };
  const deleteItem = (id) => { 
    setItems(p=>p.filter(x=>x.id!==id).map((x,i)=>({...x,sort:i}))); 
    sb.del("products", id).catch(console.error);
    setDelConfirm(null); 
  };
  const addItem = () => {
    if(!newItem.name.trim()) return;
    const it = {id:uid(), name:newItem.name, price:Number(newItem.price)||0, cat:"product", sort:items.length};
    setItems(p=>[...p, it]);
    sb.insert("products", {id:it.id, business_id:_activeBizId, name:it.name, price:it.price, cat:"product", sort:it.sort}).catch(console.error);
    setNewItem({name:"",price:0}); setShowAdd(false);
  };

  const downloadXl = () => XL.download(items.map((p,i)=>({ìˆœë²ˆ:i+1, ì œí’ˆëª…:p.name, ê°€ê²©:p.price||0})), "ì œí’ˆëª©ë¡.xlsx", "ì œí’ˆ");
  const uploadXl = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    const rows = await XL.readFile(file);
    const newItems = rows.map(r=>({id:uid(), name:r["ì œí’ˆëª…"]||r["name"]||"", price:Number(r["ê°€ê²©"]||r["price"])||0, cat:"product", sort:items.length})).filter(r=>r.name);
    if(newItems.length && window.confirm(newItems.length+"ê°œ ì œí’ˆì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      setItems(p=>[...p,...newItems]);
      newItems.forEach(it=>sb.insert("products",{id:it.id, business_id:_activeBizId, name:it.name, price:it.price, cat:"product", sort:it.sort}).catch(console.error));
    }
  };

  return <div>
    <AdminHeader title="ì œí’ˆ ê´€ë¦¬" count={items.length} onAdd={()=>setShowAdd(!showAdd)} addLabel={showAdd?"ì·¨ì†Œ":"ï¼‹ ì œí’ˆ ì¶”ê°€"} onDownload={downloadXl} onUpload={uploadXl}/>
    {showAdd && <div className="card" style={{padding:14,marginBottom:14}}>
      <div style={{display:"flex",gap:8,alignItems:"flex-end"}}>
        <FLD label="ì œí’ˆëª…"><input className="inp" style={{width:180}} value={newItem.name} onChange={e=>setNewItem(p=>({...p,name:e.target.value}))} placeholder="ì œí’ˆëª…"/></FLD>
        <FLD label="ê°€ê²©"><input className="inp" type="number" style={{width:100}} value={newItem.price} onChange={e=>setNewItem(p=>({...p,price:e.target.value}))} placeholder="0"/></FLD>
        <button className="btn-p btn-sm" onClick={addItem} style={{padding:"6px 16px"}}>ë“±ë¡</button>
      </div>
    </div>}
    <div className="tw" style={{maxHeight:"calc(100vh - 300px)",overflow:"auto"}}>
      <table><thead><tr>
        <th style={{width:25}}></th><th style={{width:35}}>No</th><th>ì œí’ˆëª…</th><th style={{width:100,textAlign:"right"}}>ê°€ê²©</th><th style={{width:80,textAlign:"center"}}>ê´€ë¦¬</th>
      </tr></thead>
        <tbody>{items.map((it,i)=>{
          if (editId===it.id) return <tr key={it.id} style={{background:"#f5f5ff"}}>
            <td><DragHandle/></td><td style={{color:"#999"}}>{i+1}</td>
            <td><input className="inp" value={editData.name} onChange={e=>setEditData(p=>({...p,name:e.target.value}))} style={{width:"100%"}}/></td>
            <td><input className="inp" type="number" value={editData.price} onChange={e=>setEditData(p=>({...p,price:Number(e.target.value)||0}))} style={{width:"100%",textAlign:"right"}}/></td>
            <td style={{textAlign:"center"}}><div style={{display:"flex",gap:3,justifyContent:"center"}}>
              <button className="btn-p btn-sm" onClick={saveEdit} style={{padding:"2px 8px",fontSize:10}}>ì €ì¥</button>
              <button className="btn-s btn-sm" onClick={()=>setEditId(null)} style={{padding:"2px 6px",fontSize:10}}>ì·¨ì†Œ</button>
            </div></td>
          </tr>;
          return <tr key={it.id} draggable onDragStart={()=>drag.onDragStart(i)} onDragEnter={()=>drag.onDragEnter(i)} onDragEnd={drag.onDragEnd} onDragOver={e=>e.preventDefault()}>
            <td><DragHandle/></td><td style={{color:"#999"}}>{i+1}</td>
            <td style={{fontWeight:500,fontSize:12}}>{it.name}</td>
            <td style={{textAlign:"right",color:"#6bab9e",fontWeight:600,fontSize:12}}>{it.price>0?fmt(it.price)+"ì›":"-"}</td>
            <td style={{textAlign:"center"}}><div style={{display:"flex",gap:4,justifyContent:"center"}}>
              <button onClick={()=>startEdit(it)} style={{background:"none",border:"none",cursor:"pointer",color:"#7c7cc8",fontSize:13}}>âœï¸</button>
              {delConfirm===it.id
                ? <><button className="btn-d btn-sm" onClick={()=>deleteItem(it.id)} style={{padding:"1px 6px",fontSize:9}}>í™•ì¸</button><button className="btn-s btn-sm" onClick={()=>setDelConfirm(null)} style={{padding:"1px 5px",fontSize:9}}>ì·¨ì†Œ</button></>
                : <button onClick={()=>setDelConfirm(it.id)} style={{background:"none",border:"none",cursor:"pointer",color:"#e57373",fontSize:13}}>ğŸ—‘ï¸</button>}
            </div></td>
          </tr>;
        })}</tbody>
      </table>
    </div>
  </div>;
}

// â”€â”€â”€ ì„œë¹„ìŠ¤íƒœê·¸ê´€ë¦¬ â”€â”€â”€
function AdminServiceTags({ data, setData }) {
  const [tags, setTags] = useState(()=>[...(data?.serviceTags || INIT_SERVICE_TAGS)].sort((a,b)=>a.sort-b.sort));
  const [showAdd, setShowAdd] = useState(false);
  const [newTag, setNewTag] = useState({ name:"", dur:0, scheduleYn:"N", color:"" });
  const [editId, setEditId] = useState(null);
  const [editData, setEditData] = useState({});
  const [delConfirm, setDelConfirm] = useState(null);
  const syncTags = (updated) => { setTags(updated); if(setData) setData(prev=>({...prev,serviceTags:updated})); };
  const drag = useDragSort(tags, syncTags);

  const tagToDb = (t) => ({id:t.id, business_id:_activeBizId, name:t.name, dur:t.dur||0, schedule_yn:t.scheduleYn==="Y"||t.scheduleYn===true, color:t.color||"", use_yn:t.useYn!==false, sort:t.sort||0});

  const addTag = () => {
    if(!newTag.name.trim()) return;
    const t = {id:uid(), name:newTag.name.trim(), dur:Number(newTag.dur)||0, scheduleYn:newTag.scheduleYn, color:newTag.color, useYn:true, sort:tags.length};
    syncTags([...tags, t]);
    sb.insert("service_tags", tagToDb(t)).catch(console.error);
    setNewTag({name:"",dur:0,scheduleYn:"N",color:""}); setShowAdd(false);
  };
  const deleteTag = (id) => { 
    syncTags(tags.filter(t=>t.id!==id).map((t,i)=>({...t,sort:i}))); 
    sb.del("service_tags", id).catch(console.error);
    setDelConfirm(null); 
  };
  const startEdit = (tag) => { setEditId(tag.id); setEditData({...tag}); };
  const saveEdit = () => { 
    syncTags(tags.map(t=>t.id===editId?{...editData}:t)); 
    sb.update("service_tags", editId, {name:editData.name, dur:editData.dur||0, schedule_yn:editData.scheduleYn==="Y"||editData.scheduleYn===true, color:editData.color||"", use_yn:editData.useYn!==false, sort:editData.sort||0}).catch(console.error);
    setEditId(null); 
  };
  const toggleUse = (id) => { 
    const tag = tags.find(t=>t.id===id);
    const newUse = tag?.useYn===false;
    syncTags(tags.map(t=>t.id===id?{...t,useYn:!t.useYn}:t)); 
    sb.update("service_tags", id, {use_yn:newUse}).catch(console.error);
  };

  const inpS = {padding:"4px 6px",fontSize:11,background:"#f8f0f0",border:"1px solid #d0d0d0"};

  const downloadXl = () => XL.download(tags.map((t,i)=>({ìˆœë²ˆ:i+1, íƒœê·¸ëª…:t.name, ì†Œìš”ë¶„:t.dur, ê¸°íƒ€ì¼ì •:t.scheduleYn, ìƒ‰ìƒ:t.color||"", ì‚¬ìš©:t.useYn!==false?"Y":"N"})), "ì„œë¹„ìŠ¤íƒœê·¸.xlsx", "íƒœê·¸");
  const uploadXl = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    const rows = await XL.readFile(file);
    const newTags = rows.map(r=>({id:uid(), name:r["íƒœê·¸ëª…"]||r["name"]||"", dur:Number(r["ì†Œìš”ë¶„"]||r["dur"])||0, scheduleYn:r["ê¸°íƒ€ì¼ì •"]||"N", color:r["ìƒ‰ìƒ"]||"", useYn:(r["ì‚¬ìš©"]||"Y")!=="N", sort:tags.length})).filter(r=>r.name);
    if(newTags.length && window.confirm(newTags.length+"ê°œ íƒœê·¸ë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      syncTags([...tags,...newTags]);
      newTags.forEach(t=>sb.insert("service_tags", tagToDb(t)).catch(console.error));
    }
  };

  return <div>
    <AdminHeader title="ì„œë¹„ìŠ¤ íƒœê·¸ ê´€ë¦¬" count={tags.length} onAdd={()=>setShowAdd(!showAdd)} addLabel={showAdd?"ì·¨ì†Œ":"ï¼‹ íƒœê·¸ ì¶”ê°€"} onDownload={downloadXl} onUpload={uploadXl}/>

    {showAdd && <div className="card" style={{padding:14,marginBottom:14}}>
      <div style={{display:"flex",gap:10,flexWrap:"wrap",alignItems:"flex-end"}}>
        <FLD label="íƒœê·¸ëª…"><input className="inp" style={{width:160,...inpS}} value={newTag.name} onChange={e=>setNewTag(p=>({...p,name:e.target.value}))} placeholder="íƒœê·¸ëª…" onKeyDown={e=>e.key==="Enter"&&addTag()}/></FLD>
        <FLD label="ì†Œìš”(ë¶„)"><input className="inp" type="number" style={{width:80,...inpS}} value={newTag.dur} onChange={e=>setNewTag(p=>({...p,dur:e.target.value}))}/></FLD>
        <FLD label="ê¸°íƒ€ì¼ì •"><select className="inp" style={{width:55,...inpS}} value={newTag.scheduleYn} onChange={e=>setNewTag(p=>({...p,scheduleYn:e.target.value}))}><option value="N">N</option><option value="Y">Y</option></select></FLD>
        <FLD label="ìƒ‰ìƒ"><div style={{display:"flex",alignItems:"center",gap:3}}>
          <input type="color" value={newTag.color||"#e0e0e0"} onChange={e=>setNewTag(p=>({...p,color:e.target.value}))} style={{width:22,height:22,border:"none",cursor:"pointer"}}/>
          <input className="inp" style={{width:75,...inpS,fontFamily:"monospace",fontSize:9}} value={newTag.color} onChange={e=>setNewTag(p=>({...p,color:e.target.value}))} placeholder="#000000"/>
        </div></FLD>
        <button className="btn-p btn-sm" onClick={addTag} style={{padding:"6px 18px"}}>ì¶”ê°€</button>
      </div>
    </div>}

    <div className="card" style={{padding:12,marginBottom:14}}>
      <div style={{fontSize:10,color:"#888",marginBottom:6}}>ë¯¸ë¦¬ë³´ê¸°</div>
      <div style={{display:"flex",flexWrap:"wrap",gap:4,padding:8,background:"#f8f8f8",borderRadius:8,border:"1px solid #e0e0e0"}}>
        {tags.filter(t=>t.useYn!==false).map(t=>{
          const hasClr = t.color && t.color!=="";
          return <span key={t.id} style={{padding:"4px 8px",fontSize:10,fontWeight:500,borderRadius:4,display:"flex",alignItems:"center",gap:3,
            border:"1px solid "+(hasClr?t.color+"80":"#d0d0d0"),color:hasClr?t.color:"#7c7cc8",background:hasClr?t.color+"15":"transparent"}}>
            {t.name}{t.dur>0&&<span style={{fontSize:8,opacity:.6}}>({t.dur}ë¶„)</span>}
          </span>;
        })}
      </div>
    </div>

    <div className="tw" style={{maxHeight:"calc(100vh - 400px)",overflow:"auto"}}>
      <table><thead><tr>
        <th style={{width:22}}></th><th style={{width:25}}>No</th><th>íƒœê·¸ëª…</th>
        <th style={{width:55,textAlign:"center"}}>ì†Œìš”</th><th style={{width:45,textAlign:"center"}}>ê¸°íƒ€</th>
        <th style={{width:80,textAlign:"center"}}>ìƒ‰ìƒ</th><th style={{width:55,textAlign:"center"}}>ì‚¬ìš©</th>
        <th style={{width:35,textAlign:"center"}}>ìˆœì„œ</th><th style={{width:65,textAlign:"center"}}>ê´€ë¦¬</th>
      </tr></thead><tbody>
      {tags.map((tag,i) => {
        const isEdit = editId===tag.id;
        if (isEdit) return <tr key={tag.id} style={{background:"#f5f5ff"}}>
          <td><DragHandle/></td><td style={{color:"#999"}}>{i+1}</td>
          <td><input className="inp" value={editData.name} onChange={e=>setEditData(p=>({...p,name:e.target.value}))} style={{width:"100%",...inpS}}/></td>
          <td><input className="inp" type="number" value={editData.dur} onChange={e=>setEditData(p=>({...p,dur:Number(e.target.value)||0}))} style={{width:50,...inpS,textAlign:"center"}}/></td>
          <td><select className="inp" value={editData.scheduleYn} onChange={e=>setEditData(p=>({...p,scheduleYn:e.target.value}))} style={{width:45,...inpS}}><option value="N">N</option><option value="Y">Y</option></select></td>
          <td><div style={{display:"flex",alignItems:"center",gap:2}}>
            <input type="color" value={editData.color||"#e0e0e0"} onChange={e=>setEditData(p=>({...p,color:e.target.value}))} style={{width:20,height:18,border:"none",cursor:"pointer"}}/>
            <input className="inp" value={editData.color||""} onChange={e=>setEditData(p=>({...p,color:e.target.value}))} style={{width:55,...inpS,fontFamily:"monospace",fontSize:8}}/>
          </div></td>
          <td></td><td></td>
          <td style={{textAlign:"center"}}><div style={{display:"flex",gap:3,justifyContent:"center"}}>
            <button className="btn-p btn-sm" onClick={saveEdit} style={{padding:"1px 6px",fontSize:9}}>ì €ì¥</button>
            <button className="btn-s btn-sm" onClick={()=>setEditId(null)} style={{padding:"1px 5px",fontSize:9}}>ì·¨ì†Œ</button>
          </div></td>
        </tr>;
        return <tr key={tag.id} draggable onDragStart={()=>drag.onDragStart(i)} onDragEnter={()=>drag.onDragEnter(i)} onDragEnd={drag.onDragEnd} onDragOver={e=>e.preventDefault()}
          style={{opacity:tag.useYn===false?0.45:1}}>
          <td><DragHandle/></td>
          <td style={{color:"#999"}}>{i+1}</td>
          <td style={{fontWeight:600,fontSize:12}}>
            <span style={{padding:"2px 6px",borderRadius:4,border:"1px solid "+(tag.color||"#d0d0d0")+"50",background:tag.color?tag.color+"12":"transparent",color:tag.color||"#333"}}>{tag.name}</span>
          </td>
          <td style={{textAlign:"center",fontSize:11,color:tag.dur>0?"#ef5350":"#d0d0d0",fontWeight:tag.dur>0?600:400}}>{tag.dur>0?tag.dur+"ë¶„":"-"}</td>
          <td style={{textAlign:"center",fontSize:10,color:tag.scheduleYn==="Y"?"#ef5350":"#d0d0d0"}}>{tag.scheduleYn}</td>
          <td style={{textAlign:"center"}}>{tag.color?<div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:4}}>
            <div style={{width:24,height:16,borderRadius:3,background:tag.color,border:"1px solid #d0d0d080"}}/>
            <span style={{fontSize:8,color:"#888",fontFamily:"monospace"}}>{tag.color}</span>
          </div>:<span style={{color:"#bbb",fontSize:10}}>â€”</span>}</td>
          <td style={{textAlign:"center"}}><button onClick={()=>toggleUse(tag.id)}
            style={{fontSize:10,padding:"2px 6px",borderRadius:4,border:"1px solid "+(tag.useYn===false?"#e57373":"#d0d0d0"),cursor:"pointer",fontFamily:"inherit",
              background:tag.useYn===false?"#e5737320":"transparent",color:tag.useYn===false?"#e8a0a0":"#888"}}>{tag.useYn===false?"ë¯¸ì‚¬ìš©":"ì‚¬ìš©"}</button></td>
          <td style={{textAlign:"center",color:"#bbb",fontSize:10}}>{i+1}</td>
          <td style={{textAlign:"center"}}><div style={{display:"flex",gap:3,justifyContent:"center"}}>
            <button onClick={()=>startEdit(tag)} style={{background:"none",border:"none",cursor:"pointer",color:"#7c7cc8",fontSize:12}}>âœï¸</button>
            {delConfirm===tag.id
              ? <><button className="btn-d btn-sm" onClick={()=>deleteTag(tag.id)} style={{padding:"1px 5px",fontSize:9}}>í™•ì¸</button><button className="btn-s btn-sm" onClick={()=>setDelConfirm(null)} style={{padding:"1px 4px",fontSize:9}}>ì·¨ì†Œ</button></>
              : <button onClick={()=>setDelConfirm(tag.id)} style={{background:"none",border:"none",cursor:"pointer",color:"#e57373",fontSize:12}}>ğŸ—‘ï¸</button>}
          </div></td>
        </tr>;
      })}</tbody></table>
    </div>
  </div>;
}

// â”€â”€â”€ Shared â”€â”€â”€
function FLD({ label, children }) {
  return <div><label style={{fontSize:11,fontWeight:600,color:"#888",marginBottom:5,display:"block"}}>{label}</label>{children}</div>;
}

// â”€â”€â”€ Styles â”€â”€â”€
// Palette: #5cb5c5(teal) #7c7cc8(slate) #d0d0d0(pink) #f0f0f0(blush)
const S = {
  root: { display:"flex", height:"100vh", fontFamily:"'Pretendard',-apple-system,BlinkMacSystemFont,'Noto Sans KR',sans-serif", background:"#f8f8f8", color:"#333", overflow:"hidden" },
  sidebar: { width:200, background:"#fff", borderRight:"1px solid #e0e0e0", display:"flex", flexDirection:"column", position:"fixed", top:0, left:0, bottom:0, zIndex:50 },
  main: { flex:1, marginLeft:200, display:"flex", flexDirection:"column", height:"100vh", minHeight:0, overflow:"hidden" },
  mobHdr: { padding:"10px 16px", background:"#fff", borderBottom:"1px solid #e0e0e0", display:"flex", alignItems:"center", gap:12 },
  menuBtn: { background:"none", border:"none", color:"#333", cursor:"pointer", fontSize:20, fontFamily:"inherit" },
};

const CSS = `
  *{box-sizing:border-box;margin:0;padding:0}
  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}
  ::-webkit-scrollbar{width:10px;height:10px}
  ::-webkit-scrollbar-track{background:#eee}
  ::-webkit-scrollbar-thumb{background:#aaa;border-radius:5px;border:2px solid #eee}
  ::-webkit-scrollbar-thumb:hover{background:#888}
  .ov>div::-webkit-scrollbar{display:none}
  .timeline-scroll{scrollbar-width:auto;scrollbar-color:#999 #e0e0e0;overflow:scroll !important;scrollbar-gutter:stable}
  .timeline-scroll::-webkit-scrollbar{width:14px !important;height:14px !important;display:block !important}
  .timeline-scroll::-webkit-scrollbar-track{background:#e0e0e0 !important}
  .timeline-scroll::-webkit-scrollbar-thumb{background:#999 !important;border-radius:7px !important;border:3px solid #e0e0e0 !important}
  .timeline-scroll::-webkit-scrollbar-thumb:hover{background:#666 !important}
  .timeline-scroll::-webkit-scrollbar-corner{background:#d0d0d0 !important}
  div:hover>.resize-handle{opacity:1 !important}
  input,select,textarea{font-family:inherit}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideIn{from{transform:translateX(-100%)}to{transform:translateX(0)}}
  .fade-in{animation:fadeIn .25s ease}
  .card{background:#fff;border-radius:4px;border:1px solid #e0e0e0;box-shadow:none}
  .tw{overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th{text-align:left;padding:8px 10px;color:#555;font-weight:600;font-size:11px;letter-spacing:.3px;border-bottom:2px solid #e0e0e0;white-space:nowrap;position:sticky;top:0;background:#fff;z-index:1}
  td{padding:7px 10px;border-bottom:1px solid #eee;white-space:nowrap;color:#333}
  tr:hover td{background:#f5f5ff}
  .inp{background:#fff;border:1px solid #d0d0d0;color:#333;padding:7px 10px;border-radius:4px;font-size:13px;width:100%;font-family:inherit;outline:none;transition:border-color .15s}
  .inp:focus{border-color:#7c7cc8;box-shadow:0 0 0 2px rgba(124,124,200,.15)}
  select.inp{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:26px}
  .badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:99px;font-size:10px;font-weight:600}
  .btn-p{background:#7c7cc8;color:#fff;padding:7px 14px;border-radius:4px;border:none;cursor:pointer;font-size:12px;font-weight:700;font-family:inherit;display:inline-flex;align-items:center;gap:5px;transition:all .15s}
  .btn-p:hover{background:#6a6ab8}
  .btn-p:active{transform:scale(.97)}
  .btn-s{background:#f5f5f5;color:#555;padding:7px 14px;border-radius:4px;border:1px solid #d0d0d0;cursor:pointer;font-size:12px;font-weight:600;font-family:inherit;display:inline-flex;align-items:center;gap:5px;transition:all .15s}
  .btn-s:hover{background:#ebebeb}
  .btn-d{background:#e57373;color:#fff;padding:7px 14px;border-radius:4px;border:none;cursor:pointer;font-size:12px;font-weight:600;font-family:inherit;transition:all .15s}
  .btn-d:hover{background:#d32f2f}
  .btn-sm{padding:5px 10px;font-size:11px}
  .ov{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);z-index:200;display:flex;align-items:center;justify-content:center;padding:16px}
  .modal{background:#fff;border-radius:8px;border:1px solid #ddd;padding:22px;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;animation:fadeIn .2s ease;box-shadow:0 8px 30px rgba(0,0,0,.15)}
  .close-btn{background:none;border:none;color:#999;cursor:pointer;font-size:16px;font-family:inherit}
  .form-col{display:flex;flex-direction:column;gap:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .page-title{font-size:18px;font-weight:800;color:#333;margin-bottom:16px}
  @media(max-width:768px){
    .sidebar-d{display:none!important}
    .main-c{margin-left:0!important}
  }
  @media(min-width:769px){
    .mob-hdr{display:none!important}
    .sidebar-m{display:none!important}
  }
`;

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
</script>
</body>
</html>
