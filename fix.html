<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Bliss - ì´ë¦„ ìˆ˜ì • ë„êµ¬</title>
<style>body{font-family:sans-serif;max-width:800px;margin:40px auto;padding:20px;background:#f5f5f5}
.card{background:#fff;border-radius:12px;padding:24px;margin:16px 0;box-shadow:0 2px 8px rgba(0,0,0,.08)}
h1{color:#333;font-size:22px}
pre{background:#1a1a2e;color:#e0e0e0;padding:16px;border-radius:8px;font-size:13px;max-height:400px;overflow:auto;white-space:pre-wrap}
button{background:#7c7cc8;color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:15px;font-weight:600}
button:hover{background:#6b6bb8}
.fix{background:#4CAF50}.fix:hover{background:#43A047}
.warn{color:#E65100;font-size:13px}
.ok{color:#2E7D32;font-weight:600}
.row{display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:14px}
.old{color:#999;text-decoration:line-through}.new{color:#2E7D32;font-weight:600}
</style></head><body>
<h1>ğŸ”§ ë„¤ì´ë²„ ì˜ˆì•½ ì´ë¦„ ìˆ˜ì • ë„êµ¬</h1>
<div class="card">
<p>memo í•„ë“œì—ì„œ <code>ì˜ˆì•½ì: ì´ë¦„</code>ì„ ë‹¤ì‹œ ì¶”ì¶œí•˜ì—¬ cust_nameì„ ìˆ˜ì •í•©ë‹ˆë‹¤.</p>
<p class="warn">âš ï¸ ìˆ˜ì • ì „ì— ë°˜ë“œì‹œ "1. ìŠ¤ìº”"ì„ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.</p>
<div style="display:flex;gap:12px;margin-top:16px">
  <button onclick="scan()">1. ìŠ¤ìº” (í™•ì¸ë§Œ)</button>
  <button class="fix" onclick="fix()" id="fixBtn" disabled>2. ìˆ˜ì • ì‹¤í–‰</button>
</div>
</div>
<div class="card"><h3>ê²°ê³¼</h3><div id="result">ì•„ì§ ìŠ¤ìº”í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div></div>
<div class="card"><h3>ë¡œê·¸</h3><pre id="log"></pre></div>

<script>
const SB_URL = "https://dpftlrsuqxqqeouwbfjd.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwZnRscnN1cXhxcWVvdXdiZmpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MDU4MjQsImV4cCI6MjA4NzQ4MTgyNH0.iydEkjtPjZ0jXpUUPJben4IWWneDqLomv-HDlcFayE4";
const H = {"apikey":SB_KEY,"Authorization":`Bearer ${SB_KEY}`,"Content-Type":"application/json"};

let fixes = [];

function log(msg) {
  document.getElementById('log').textContent += msg + '\n';
}

function extractNameFromMemo(memo) {
  if (!memo) return null;
  // Pattern: ì˜ˆì•½ì: ì´ë¦„ (with possible * masking like ì•ˆ*í¬)
  const m = memo.match(/ì˜ˆì•½ì:\s*([^\s\n]+)/);
  return m ? m[1].trim() : null;
}

function detectGenderFromMemo(memo) {
  if (!memo) return null;
  if (/ì—¬\)/.test(memo)) return "F";
  if (/ë‚¨\)/.test(memo)) return "M";
  return null;
}

async function scan() {
  fixes = [];
  document.getElementById('log').textContent = '';
  document.getElementById('result').innerHTML = 'ìŠ¤ìº” ì¤‘...';
  log('ë„¤ì´ë²„ ì˜ˆì•½ ë°ì´í„° ë¡œë”©...');

  try {
    // Get all naver reservations (ones with memo containing ë„¤ì´ë²„)
    const r = await fetch(`${SB_URL}/rest/v1/reservations?select=id,cust_name,cust_gender,memo,date&memo=like.*ë„¤ì´ë²„*&order=date.desc&limit=500`, {headers: H});
    const data = await r.json();
    log(`ì´ ${data.length}ê±´ì˜ ë„¤ì´ë²„ ì˜ˆì•½ ë°œê²¬`);

    for (const row of data) {
      const nameFromMemo = extractNameFromMemo(row.memo);
      const genderFromMemo = detectGenderFromMemo(row.memo);
      
      const currentName = row.cust_name || '';
      const currentGender = row.cust_gender || '';
      
      const needNameFix = nameFromMemo && currentName !== nameFromMemo;
      const needGenderFix = genderFromMemo && currentGender !== genderFromMemo;
      
      if (needNameFix || needGenderFix) {
        fixes.push({
          id: row.id,
          date: row.date,
          oldName: currentName,
          newName: needNameFix ? nameFromMemo : currentName,
          oldGender: currentGender,
          newGender: needGenderFix ? genderFromMemo : currentGender,
          fixName: needNameFix,
          fixGender: needGenderFix
        });
        const parts = [];
        if (needNameFix) parts.push(`ì´ë¦„: "${currentName}" â†’ "${nameFromMemo}"`);
        if (needGenderFix) parts.push(`ì„±ë³„: "${currentGender||'ì—†ìŒ'}" â†’ "${genderFromMemo}"`);
        log(`âŒ [${row.date}] ${parts.join(' | ')}`);
      }
    }

    if (fixes.length === 0) {
      document.getElementById('result').innerHTML = '<span class="ok">âœ… ëª¨ë“  ì´ë¦„ì´ ì •ìƒì…ë‹ˆë‹¤. ìˆ˜ì •í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
      document.getElementById('fixBtn').disabled = true;
    } else {
      let html = `<p><strong>${fixes.length}ê±´</strong>ì˜ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤:</p>`;
      html += fixes.map(f => {
        let detail = '';
        if (f.fixName) detail += `<span class="old">${f.oldName || '(ë¹ˆê°’)'}</span> â†’ <span class="new">${f.newName}</span>`;
        if (f.fixGender) detail += (f.fixName ? ' | ' : '') + `ì„±ë³„: <span class="old">${f.oldGender||'-'}</span> â†’ <span class="new">${f.newGender==='F'?'ì—¬':'ë‚¨'}</span>`;
        return `<div class="row"><span style="width:90px;flex-shrink:0">${f.date}</span>${detail}</div>`;
      }).join('');
      document.getElementById('result').innerHTML = html;
      document.getElementById('fixBtn').disabled = false;
    }
    log(`\nìŠ¤ìº” ì™„ë£Œ: ${fixes.length}ê±´ ìˆ˜ì • í•„ìš”`);
  } catch(e) {
    log('ì—ëŸ¬: ' + e.message);
    document.getElementById('result').innerHTML = '<span style="color:red">ì—ëŸ¬ ë°œìƒ - ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”</span>';
  }
}

async function fix() {
  if (fixes.length === 0) return;
  if (!confirm(`${fixes.length}ê±´ì˜ ì´ë¦„ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  log('\nìˆ˜ì • ì‹œì‘...');
  let ok = 0, fail = 0;

  for (const f of fixes) {
    try {
      const patch = {};
      if (f.fixName) patch.cust_name = f.newName;
      if (f.fixGender) patch.cust_gender = f.newGender;
      const r = await fetch(`${SB_URL}/rest/v1/reservations?id=eq.${f.id}`, {
        method: 'PATCH',
        headers: H,
        body: JSON.stringify(patch)
      });
      if (r.ok) {
        ok++;
        const parts = [];
        if (f.fixName) parts.push(`ì´ë¦„: ${f.oldName} â†’ ${f.newName}`);
        if (f.fixGender) parts.push(`ì„±ë³„: ${f.oldGender||'-'} â†’ ${f.newGender}`);
        log(`âœ… [${f.date}] ${parts.join(' | ')}`);
      } else {
        fail++;
        const e = await r.text();
        log(`âŒ [${f.date}] ì‹¤íŒ¨: ${e}`);
      }
    } catch(e) {
      fail++;
      log(`âŒ [${f.date}] ì—ëŸ¬: ${e.message}`);
    }
  }

  log(`\nì™„ë£Œ: ì„±ê³µ ${ok}ê±´, ì‹¤íŒ¨ ${fail}ê±´`);
  document.getElementById('result').innerHTML = `<span class="ok">âœ… ìˆ˜ì • ì™„ë£Œ! ì„±ê³µ ${ok}ê±´` + (fail ? `, ì‹¤íŒ¨ ${fail}ê±´` : '') + '</span><br><br>Blissë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ë°˜ì˜ë©ë‹ˆë‹¤.';
  document.getElementById('fixBtn').disabled = true;
  fixes = [];
}
</script>
</body></html>
